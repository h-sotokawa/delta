<!-- form-creator-functions.html - フォーム作成ページの機能 -->
<script>
  // ========================================
  // ページ読み込み後の初期化
  // ========================================
  function onFormCreatorPageShow() {
    // フォーム作成ページ表示時の処理
    if (DEBUG_MODE) {
      showDebugInfo('フォーム作成ページ初期化開始', {});
    }
    
    // 拠点マスタを読み込み
    loadLocationMasterForForm();
  }

  // ========================================
  // フォーム作成モード切り替え機能
  // ========================================
  function switchFormCreationMode(mode) {
    // タブの状態を更新
    document.querySelectorAll('.form-type-tab').forEach(function(tab) {
      tab.classList.remove('active');
    });
    document.getElementById(mode + '-tab').classList.add('active');
    
    // フォームセクションの表示を切り替え
    document.querySelectorAll('.form-section').forEach(function(section) {
      section.classList.remove('active');
    });
    document.getElementById(mode + '-form').classList.add('active');
    
    // 管理モードの場合、フォーム一覧を読み込み
    if (mode === 'manage') {
      loadFormsList();
    }
    
    if (DEBUG_MODE) {
      showDebugInfo('フォーム作成モード切り替え', { mode });
    }
  }

  // ========================================
  // 機種マスタ関連機能
  // ========================================
  
  // 機種カテゴリ一覧を読み込む（詳細カテゴリに基づいてフィルタリング）
  function loadModelCategories() {
    const modelCategorySelect = document.getElementById('model-category');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!modelCategorySelect || !deviceCategorySelect) {
      console.error('必要な選択要素が見つかりません');
      return;
    }
    
    const deviceCategory = deviceCategorySelect.value;
    
    if (!deviceCategory) {
      modelCategorySelect.innerHTML = '<option value="">まず詳細カテゴリを選択してください</option>';
      modelCategorySelect.disabled = true;
      return;
    }
    
    // 詳細カテゴリと機種カテゴリのマッピング
    const categoryMapping = {
      'SV': ['サーバー'], // SVにはサーバーのみ表示
      'CL': ['ノートPC', 'デスクトップPC'], // CLにはノートPCとデスクトップPCを表示
      'プリンタ': ['プリンタ'], // プリンタにはプリンタのみ表示
      'その他': ['その他', 'プリンタ'] // その他にはその他とプリンタを表示
    };
    
    const allowedCategories = categoryMapping[deviceCategory] || [];
    
    console.log('詳細カテゴリに基づくフィルタリング:', {
      deviceCategory: deviceCategory,
      allowedCategories: allowedCategories
    });
    
    // Google Apps Scriptから機種カテゴリを取得
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種カテゴリ取得結果:', result);
        
        if (result.success) {
          modelCategorySelect.innerHTML = '<option value="">機種カテゴリを選択してください</option>';
          
          // 詳細カテゴリに基づいてフィルタリング
          const filteredCategories = result.categories.filter(function(category) {
            return allowedCategories.includes(category);
          });
          
          console.log('フィルタリング後のカテゴリ:', filteredCategories);
          
          if (filteredCategories.length === 0) {
            modelCategorySelect.innerHTML = '<option value="">該当する機種カテゴリがありません</option>';
            modelCategorySelect.disabled = true;
            return;
          }
          
          filteredCategories.forEach(function(category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            modelCategorySelect.appendChild(option);
          });
          
          modelCategorySelect.disabled = false;
        } else {
          console.error('機種カテゴリの取得に失敗:', result.error);
          modelCategorySelect.innerHTML = '<option value="">機種カテゴリの読み込みに失敗しました</option>';
          modelCategorySelect.disabled = true;
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種カテゴリ取得でエラー:', error);
        modelCategorySelect.innerHTML = '<option value="">エラーが発生しました</option>';
        modelCategorySelect.disabled = true;
      })
      .getAvailableCategories();
  }
  
  // カテゴリ別機種一覧を更新
  function updateModelsByCategory() {
    const modelCategorySelect = document.getElementById('model-category');
    const modelSelect = document.getElementById('model-select');
    
    if (!modelCategorySelect || !modelSelect) {
      console.error('必要な要素が見つかりません');
      return;
    }
    
    const selectedCategory = modelCategorySelect.value;
    console.log('選択されたカテゴリ:', selectedCategory);
    
    if (!selectedCategory) {
      modelSelect.innerHTML = '<option value="">まず機種カテゴリを選択してください</option>';
      modelSelect.disabled = true;
      // 機種選択がクリアされた場合も拠点管理番号を更新
      // 拠点管理番号は属性内で処理
      return;
    }
    
    // Google Apps Scriptからカテゴリ別機種を取得
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('カテゴリ別機種取得結果:', result);
        
        if (result.success) {
          modelSelect.innerHTML = '<option value="">機種を選択してください</option>';
          
          result.models.forEach(function(model) {
            const option = document.createElement('option');
            option.value = JSON.stringify({
              modelName: model.modelName,
              manufacturer: model.manufacturer,
              category: model.category
            });
            option.textContent = model.displayName;
            modelSelect.appendChild(option);
          });
          
          modelSelect.disabled = false;
        } else {
          console.error('カテゴリ別機種の取得に失敗:', result.error);
          modelSelect.innerHTML = '<option value="">機種の読み込みに失敗しました</option>';
        }
      })
      .withFailureHandler(function(error) {
        console.error('カテゴリ別機種取得でエラー:', error);
        modelSelect.innerHTML = '<option value="">エラーが発生しました</option>';
      })
      .getModelMasterByCategory(selectedCategory);
  }
  
  // 機種選択時の処理
  function updateSelectedModel() {
    const modelSelect = document.getElementById('model-select');
    
    if (!modelSelect) {
      console.error('機種選択要素が見つかりません');
      return;
    }
    
    const selectedValue = modelSelect.value;
    console.log('選択された機種:', selectedValue);
    
    if (selectedValue) {
      try {
        const modelData = JSON.parse(selectedValue);
        console.log('選択された機種データ:', modelData);
        
        // 選択された機種情報をフォームに反映する処理をここに追加
        // 例: 型番フィールドがあれば自動入力など
        
        // 機種が選択されたら拠点管理番号を更新
        // 拠点管理番号は属性内で処理
        
        // 属性内の拠点管理番号も更新
        setTimeout(() => {
          updateAttributeLocationNumber();
        }, 100);
        
      } catch (error) {
        console.error('機種データの解析エラー:', error);
      }
    } else {
      // 機種選択がクリアされた場合も拠点管理番号を更新
      // 拠点管理番号は属性内で処理
      
      // 属性内の拠点管理番号も更新
      setTimeout(() => {
        updateAttributeLocationNumber();
      }, 100);
    }
  }

  // ========================================
  // 拠点選択機能
  // ========================================
  
  // 拠点マスタから拠点一覧を取得
  function loadLocationMasterForForm() {
    console.log('拠点マスタ読み込み開始...');
    
    google.script.run
      .withSuccessHandler(function(locations) {
        console.log('拠点マスタ取得成功:', locations);
        if (locations && locations.length > 0) {
          updateLocationOptions(locations);
        } else {
          console.warn('拠点マスタが空、フォールバックを使用');
          initializeLocationOptions();
        }
      })
      .withFailureHandler(function(error) {
        console.error('拠点マスタ取得エラー:', error);
        console.log('フォールバック拠点選択肢を使用します');
        if (DEBUG_MODE) {
          showDebugInfo('拠点マスタ取得エラー', { error: error.toString() });
        }
        // エラー時は従来のハードコードされた拠点を使用
        initializeLocationOptions();
      })
      .getLocationMaster();
  }
  
  // 拠点オプションを更新
  function updateLocationOptions(locations) {
    console.log('拠点オプション更新開始。受信データ:', locations);
    
    // アクティブな拠点のみフィルタ
    const activeLocations = locations.filter(location => location.status === 'active');
    
    console.log('アクティブ拠点:', activeLocations);
    
    if (DEBUG_MODE) {
      showDebugInfo('アクティブ拠点一覧', activeLocations);
    }
    
    // グローバル変数として保存（他の関数で使用）
    window.formCreatorLocations = activeLocations;
    
    // 拠点選択を更新
    console.log('initializeLocationOptions呼び出し...');
    initializeLocationOptions();
  }
  
  function getLocationDisplayName(locationValue) {
    // 新しい拠点マスタベースの表示名取得
    if (window.formCreatorLocations) {
      const location = window.formCreatorLocations.find(loc => loc.locationId === locationValue);
      if (location) {
        return location.locationName;
      }
    }
    
    // フォールバック: 従来のハードコードされた名前
    const locationNames = {
      'osaka-desktop': '大阪(デスクトップ)',
      'osaka-server': '大阪(サーバー、ノート)',
      'kobe-terminal': '神戸(端末)',
      'himeji-terminal': '姫路(端末)',
      'osaka-printer': '大阪(プリンタ、その他)',
      'hyogo-printer': '兵庫(プリンタ、その他)'
    };
    
    return locationNames[locationValue] || '未選択拠点';
  }
  
  // 拠点コード（プレフィックス）を取得
  function getLocationPrefix(locationValue) {
    console.log('getLocationPrefix called with:', locationValue);
    console.log('Available locations:', window.formCreatorLocations);
    
    // 拠点マスタからプレフィックス取得
    if (window.formCreatorLocations) {
      const location = window.formCreatorLocations.find(loc => loc.locationId === locationValue);
      console.log('Found location:', location);
      if (location && location.locationCode) {
        console.log('Using location code from master:', location.locationCode);
        return location.locationCode;
      }
    }
    
    // フォールバック: 従来のハードコードされたプレフィックス
    console.log('Using fallback prefix for:', locationValue);
    const locationPrefixes = {
      'osaka-desktop': 'OSA',
      'osaka-server': 'OSA', 
      'kobe-terminal': 'KOB',
      'himeji-terminal': 'HIM',
      'osaka-printer': 'OSA',
      'hyogo-printer': 'HYO'
    };
    
    const prefix = locationPrefixes[locationValue] || 'UNK';
    console.log('Fallback prefix result:', prefix);
    return prefix;
  }
  // 拠点選択肢を初期化する処理
  function initializeLocationOptions() {
    console.log('initializeLocationOptions開始');
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!locationSelect || !deviceCategorySelect) {
      console.error('必要な要素が見つかりません');
      return;
    }
    
    console.log('拠点データ確認:', window.formCreatorLocations);
    
    if (DEBUG_MODE) {
      showDebugInfo('拠点選択肢初期化開始', {});
    }
    
    // 拠点選択肢を構築（拠点マスタベース）
    let locationOptions = [];
    
    if (window.formCreatorLocations && window.formCreatorLocations.length > 0) {
      // 拠点マスタから取得した拠点を使用
      console.log('拠点マスタデータを使用:', window.formCreatorLocations.length, '件');
      locationOptions = window.formCreatorLocations.map(location => ({
        value: location.locationId,
        text: location.locationName
      }));
      
      console.log('生成された拠点選択肢:', locationOptions);
      
      if (DEBUG_MODE) {
        showDebugInfo('拠点マスタから拠点選択肢を生成', locationOptions);
      }
    } else {
      // フォールバック: 従来のハードコードされた拠点
      console.log('フォールバック拠点選択肢を使用');
      locationOptions = [
        { value: 'osaka-desktop', text: '大阪(デスクトップ)' },
        { value: 'osaka-server', text: '大阪(サーバー、ノート)' },
        { value: 'kobe-terminal', text: '神戸(端末)' },
        { value: 'himeji-terminal', text: '姫路(端末)' },
        { value: 'osaka-printer', text: '大阪(プリンタ、その他)' },
        { value: 'hyogo-printer', text: '兵庫(プリンタ、その他)' }
      ];
      
      console.log('フォールバック拠点選択肢:', locationOptions);
      
      if (DEBUG_MODE) {
        showDebugInfo('フォールバック拠点選択肢を使用', locationOptions);
      }
    }
    
    // 拠点選択肢を更新
    console.log('拠点選択肢の更新開始。オプション数:', locationOptions.length);
    locationSelect.innerHTML = '<option value="">拠点を選択してください</option>';
    
    if (locationOptions.length > 0) {
      locationOptions.forEach(function(option) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        locationSelect.appendChild(optionElement);
      });
      locationSelect.disabled = false;
      
      console.log('拠点選択肢更新完了。', locationOptions.length, '個の選択肢を追加');
      
      if (DEBUG_MODE) {
        showDebugInfo('拠点選択肢更新完了', { count: locationOptions.length });
      }
    } else {
      locationSelect.disabled = true;
      console.error('拠点選択肢が空のため、拠点選択を無効化');
      
      if (DEBUG_MODE) {
        showDebugInfo('拠点選択肢なし', { locationOptionsLength: locationOptions.length });
      }
    }
    
    // 詳細カテゴリをリセット
    deviceCategorySelect.innerHTML = '<option value="">拠点を選択してください</option>';
    deviceCategorySelect.disabled = true;
    
    // 属性フォームを更新
    updateAttributesForm();
     
     // 拠点管理番号を更新
     // 拠点管理番号は属性内で処理
     
     if (DEBUG_MODE) {
       showDebugInfo('代替機種別選択更新', { 
        selectedType, 
        locationOptionsCount: locationOptions.length
      });
    }
  }

  // 拠点選択時の処理
  function updateLocationNumber() {
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!locationSelect || !deviceCategorySelect) return;
    
    const selectedLocation = locationSelect.value;
    
    if (DEBUG_MODE) {
      showDebugInfo('拠点選択時の処理', { selectedLocation });
    }
    
    // 全ての詳細カテゴリオプション
    const allDeviceCategoryOptions = [
      { value: 'SV', text: 'SV（サーバー）' },
      { value: 'CL', text: 'CL（クライアント）' },
      { value: 'プリンタ', text: 'プリンタ' },
      { value: 'その他', text: 'その他' }
    ];
    
    // 詳細カテゴリの選択肢を更新
    deviceCategorySelect.innerHTML = '<option value="">詳細カテゴリを選択してください</option>';
    
    // 機種カテゴリと機種選択をリセット
    const modelCategorySelect = document.getElementById('model-category');
    const modelSelect = document.getElementById('model-select');
    
    if (modelCategorySelect) {
      modelCategorySelect.innerHTML = '<option value="">まず詳細カテゴリを選択してください</option>';
      modelCategorySelect.disabled = true;
    }
    
    if (modelSelect) {
      modelSelect.innerHTML = '<option value="">まず機種カテゴリを選択してください</option>';
      modelSelect.disabled = true;
    }
    
    // 拠点が選択されている場合、全ての詳細カテゴリを有効化
    if (selectedLocation) {
      allDeviceCategoryOptions.forEach(function(option) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        deviceCategorySelect.appendChild(optionElement);
      });
      deviceCategorySelect.disabled = false;
      
      if (DEBUG_MODE) {
        showDebugInfo('詳細カテゴリ選択肢更新', { 
          selectedLocation, 
          options: allDeviceCategoryOptions 
        });
      }
    } else {
      deviceCategorySelect.disabled = true;
      
      if (DEBUG_MODE) {
        showDebugInfo('詳細カテゴリ無効化', { selectedLocation });
      }
    }
    
    // 属性フォームを更新
    updateAttributesForm();
    
    if (DEBUG_MODE) {
      showDebugInfo('拠点選択更新', { 
        selectedLocation,
        categoriesAvailable: allDeviceCategoryOptions.length
      });
    }
  }

  // 旧拠点管理番号関数は削除済み - 属性内で処理
  

  // ========================================
  // 代替機属性プレビュー機能
  // ========================================
  function updateAttributesForm() {
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    const attributesContainer = document.getElementById('attributes-form');
    
    if (!locationSelect || !deviceCategorySelect || !attributesContainer) return;
    
    const location = locationSelect.value;
    const deviceCategory = deviceCategorySelect.value;
    
    // 詳細カテゴリに基づく判定
    const isTerminal = deviceCategory === 'SV' || deviceCategory === 'CL';
    const isPrinter = deviceCategory === 'プリンタ' || deviceCategory === 'その他';
    
    if (!location) {
      attributesContainer.innerHTML = `
        <div class="attributes-placeholder">
          <i class="fas fa-info-circle"></i>
          <p>拠点を選択すると、入力フィールドが表示されます</p>
        </div>
      `;
      return;
    }
    
    if (!deviceCategory) {
      attributesContainer.innerHTML = `
        <div class="attributes-placeholder">
          <i class="fas fa-info-circle"></i>
          <p>詳細カテゴリを選択すると、入力フィールドが表示されます</p>
        </div>
      `;
      return;
    }
    
    let attributeFields = [];
    
    if (isTerminal) {
      attributeFields = [
        { name: 'assetNumber', label: '資産管理番号', type: 'text', required: true, placeholder: '例: AS001234' },
        { name: 'serial', label: 'シリアル(製造番号)', type: 'text', required: true, placeholder: '例: ABC12345' },
        { name: 'software', label: 'ソフト', type: 'text', required: true, placeholder: '例: Recepty NEXT, MRN' },
        { name: 'os', label: 'OS', type: 'text', required: true, placeholder: '例: Windows 11' },
        { name: 'locationNumber', label: '拠点管理番号', type: 'special', required: true }
      ];
    } else if (isPrinter) {
      attributeFields = [
        { name: 'serial', label: 'シリアル(製造番号)', type: 'text', required: true, placeholder: '例: XYZ98765' },
        { name: 'locationNumber', label: '拠点管理番号', type: 'special', required: true }
      ];
    }
    
    const deviceTypeDisplayName = isTerminal ? '端末' : 'プリンタ・その他';
    
    // 属性フィールドのHTMLを生成
    var attributeFieldsHtml = '';
    for (var i = 0; i < attributeFields.length; i++) {
      var field = attributeFields[i];
      if (field.type === 'select') {
        var optionsHtml = '';
        for (var j = 0; j < field.options.length; j++) {
          optionsHtml += '<option value="' + field.options[j] + '">' + field.options[j] + '</option>';
        }
        attributeFieldsHtml += `
          <div class="form-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <select id="attr-${field.name}" name="attributes[${field.name}]" ${field.required ? 'required' : ''}>
              <option value="">選択してください</option>
              ${optionsHtml}
            </select>
          </div>
        `;
      } else if (field.type === 'special' && field.name === 'locationNumber') {
        // 拠点管理番号の特別な入力欄
        attributeFieldsHtml += `
          <div class="form-group location-number-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <div class="attr-location-number-preview">
              <div id="attr-location-number-display" class="attr-location-number-display">
                上記の項目を入力すると自動生成されます
              </div>
              <div class="attr-location-number-input" id="attr-location-number-input" style="display: none;">
                <span id="attr-location-prefix-generated" class="attr-location-prefix-generated"></span>
                <input type="text" id="attr-location-suffix" name="attributes[locationNumberSuffix]" required
                       placeholder="001" maxlength="50" disabled onchange="updateAttributeLocationNumber()" oninput="updateFinalAttributeLocationNumber()">
              </div>
              <input type="hidden" id="attr-location-number" name="attributes[${field.name}]">
            </div>
            <small class="help-text">シリアル番号を入力後、拠点管理番号が自動生成されます。最後に固有の番号を入力してください</small>
          </div>
        `;
      } else {
        attributeFieldsHtml += `
          <div class="form-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <input type="${field.type}" 
                   id="attr-${field.name}" 
                   name="attributes[${field.name}]" 
                   placeholder="${field.placeholder}"
                   ${field.required ? 'required' : ''}
                   ${field.readonly ? 'readonly' : ''}
                   ${field.name === 'serial' ? 'onchange="updateAttributeLocationNumber()" oninput="updateAttributeLocationNumber()"' : ''}>
          </div>
        `;
      }
    }
    
    attributesContainer.innerHTML = `
      <div class="attributes-input-section">
        <h4><i class="fas fa-edit"></i> 代替機属性入力（${deviceTypeDisplayName}）</h4>
        <div class="attributes-grid">
          ${attributeFieldsHtml}
        </div>
        <div class="attributes-note">
          <i class="fas fa-info-circle"></i>
          <span>これらの属性情報がフォームの初期値として設定されます</span>
        </div>
      </div>
    `;
    

    
    if (DEBUG_MODE) {
      showDebugInfo('属性フォーム更新', { 
        deviceType,
        location, 
        deviceCategory, 
        isTerminal, 
        isPrinter, 
        attributeFields 
      });
    }
    
    // 属性フォーム更新後、拠点管理番号を更新
    setTimeout(() => {
      updateAttributeLocationNumber();
      
      // 拠点管理番号のsuffix入力欄にイベントリスナーを追加
      const attrLocationSuffixInput = document.getElementById('attr-location-suffix');
      if (attrLocationSuffixInput) {
        attrLocationSuffixInput.addEventListener('input', function() {
          updateFinalAttributeLocationNumber();
        });
      }
    }, 100);
  }

  // 代替機種別選択時の処理
  function updateDeviceCategory() {
    // 機種カテゴリと機種選択をリセット
    const modelCategorySelect = document.getElementById('model-category');
    const modelSelect = document.getElementById('model-select');
    
    if (modelCategorySelect) {
      modelCategorySelect.innerHTML = '<option value="">まず詳細カテゴリを選択してください</option>';
      modelCategorySelect.disabled = true;
    }
    
    if (modelSelect) {
      modelSelect.innerHTML = '<option value="">まず機種カテゴリを選択してください</option>';
      modelSelect.disabled = true;
    }
    
    // 詳細カテゴリに基づいて機種カテゴリを読み込み
    loadModelCategories();
    
    updateAttributesForm();
    
    if (DEBUG_MODE) {
      const deviceCategorySelect = document.getElementById('device-category');
      showDebugInfo('詳細カテゴリ変更', { selectedCategory: deviceCategorySelect.value });
    }
  }

  // 詳細カテゴリに応じた質問項目を生成
  function getDeviceQuestions(location, deviceCategory, attributeData = {}) {
    console.log('getDeviceQuestions called with:', { location, deviceCategory, attributeData });
    
    // 詳細カテゴリに基づく判定
    const isTerminal = deviceCategory === 'SV' || deviceCategory === 'CL';
    const isPrinter = deviceCategory === 'プリンタ' || deviceCategory === 'その他';
    
    let questions = [];
    
    if (isTerminal) {
      questions = [
        { 
          type: 'TEXT', 
          title: '資産管理番号', 
          required: true,
          defaultValue: attributeData.assetNumber || ''
        },
        { 
          type: 'TEXT', 
          title: 'シリアル(製造番号)', 
          required: true,
          defaultValue: attributeData.serial || ''
        },
        { 
          type: 'TEXT', 
          title: 'ソフト', 
          required: true,
          defaultValue: attributeData.software || ''
        },
        { 
          type: 'TEXT', 
          title: 'OS', 
          required: true,
          defaultValue: attributeData.os || ''
        },
        { 
          type: 'DROPDOWN', 
          title: '代替機種別', 
          required: true,
          options: ['SV', 'CL'],
          defaultValue: attributeData.deviceCategory || ''
        },
        { 
          type: 'TEXT', 
          title: '拠点管理番号', 
          required: true,
          defaultValue: attributeData.locationNumber || ''
        }
      ];
    } else if (isPrinter) {
      questions = [
        { 
          type: 'TEXT', 
          title: 'シリアル(製造番号)', 
          required: true,
          defaultValue: attributeData.serial || ''
        },
        { 
          type: 'DROPDOWN', 
          title: '代替機種別', 
          required: true,
          options: ['プリンタ', 'その他'],
          defaultValue: attributeData.deviceCategory || ''
        },
        { 
          type: 'TEXT', 
          title: '拠点管理番号', 
          required: true,
          defaultValue: attributeData.locationNumber || ''
        }
      ];
    }
    
    if (DEBUG_MODE) {
      showDebugInfo('質問項目生成', { location, deviceCategory, attributeData, isTerminal, isPrinter, questions });
    }
    
    return questions;
  }

  // ========================================
  // フォーム作成機能（簡素化）
  // ========================================

  function addQuestion() {
    const container = document.getElementById('questions-container');
    const newIndex = questionCount;
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.setAttribute('data-index', newIndex);
    
    questionDiv.innerHTML = `
      <div class="question-header">
        <span class="question-number">質問 ${newIndex + 1}</span>
        <button type="button" class="btn-remove-question" onclick="removeQuestion(${newIndex})">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="question-config">
        <div class="form-row">
          <div class="form-group">
            <label>質問タイトル <span class="required">*</span></label>
            <input type="text" name="questions[${newIndex}][title]" required
                   placeholder="質問を入力してください">
          </div>
          
          <div class="form-group">
            <label>質問タイプ</label>
            <select name="questions[${newIndex}][type]" onchange="updateQuestionOptions(${newIndex})">
              <option value="TEXT">短答式テキスト</option>
              <option value="PARAGRAPH">長答式テキスト</option>
              <option value="MULTIPLE_CHOICE">ラジオボタン</option>
              <option value="CHECKBOX">チェックボックス</option>
              <option value="DROPDOWN">プルダウン</option>
              <option value="SCALE">評価スケール</option>
              <option value="DATE">日付</option>
              <option value="TIME">時刻</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <input type="checkbox" name="questions[${newIndex}][required]" value="true">
              必須項目にする
            </label>
          </div>
        </div>

        <div class="question-options" id="question-options-${newIndex}" style="display: none;">
          <label>選択肢（1行に1つずつ入力）</label>
          <textarea name="questions[${newIndex}][options]" rows="4"
                    placeholder="選択肢1&#10;選択肢2&#10;選択肢3"></textarea>
        </div>
      </div>
    `;
    
    container.appendChild(questionDiv);
    questionCount++;
    
    if (DEBUG_MODE) {
      showDebugInfo('質問を追加', { newIndex });
    }
  }

  function removeQuestion(index) {
    const questionDiv = document.querySelector(`[data-index="${index}"]`);
    if (questionDiv) {
      questionDiv.remove();
      updateQuestionNumbers();
      
      if (DEBUG_MODE) {
        showDebugInfo('質問を削除', { index });
      }
    }
  }

  function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.question-item');
    questions.forEach(function(question, index) {
      const numberSpan = question.querySelector('.question-number');
      if (numberSpan) {
        numberSpan.textContent = 'Q' + (index + 1);
      }
    });
  }

  function updateQuestionOptions(index) {
    const typeSelect = document.querySelector(`[name="questions[${index}][type]"]`);
    const optionsDiv = document.getElementById(`question-options-${index}`);
    
    if (typeSelect && optionsDiv) {
      const selectedType = typeSelect.value;
      const showOptions = ['MULTIPLE_CHOICE', 'CHECKBOX', 'DROPDOWN'].includes(selectedType);
      
      optionsDiv.style.display = showOptions ? 'block' : 'none';
      
      if (DEBUG_MODE) {
        showDebugInfo('質問タイプ変更', { index, selectedType, showOptions });
      }
    }
  }

  function resetFormCreation() {
    const form = document.getElementById('googleFormCreationForm');
    if (!form) {
      console.warn('フォーム要素が見つかりません');
      return;
    }
    
    try {
      form.reset();
      
      // 質問項目を初期化（最初の1つだけ残す）
      const container = document.getElementById('questions-container');
      if (container) {
        const questions = container.querySelectorAll('.question-item');
        
        questions.forEach(function(question, index) {
          if (index > 0) {
            question.remove();
          }
        });
      }
      
      questionCount = 1;
      updateQuestionNumbers();
      
      // エラー状態をクリア（存在確認してから実行）
      if (form && form.querySelectorAll) {
        form.querySelectorAll('.error').forEach(function(element) {
          element.classList.remove('error');
        });
      }
      
      if (DEBUG_MODE) {
        showDebugInfo('フォーム作成をリセット');
      }
      
      showMessage('フォームをリセットしました', 'success');
    } catch (error) {
      console.error('resetFormCreation エラー:', error);
      showMessage('フォームリセット中にエラーが発生しました', 'error');
    }
  }

  // ========================================
  // Google Form作成処理
  // ========================================
  function handleGoogleFormCreation(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    if (DEBUG_MODE) {
      showDebugInfo('Google Form作成開始', Array.from(formData.entries()));
    }
    
    // フォームデータを整理
    const locationNumber = formData.get('attributes[locationNumber]'); // 属性から取得
    const location = formData.get('location');
    const deviceCategory = formData.get('deviceCategory');
    
    // 詳細カテゴリから代替機種別を推定
    const deviceType = (deviceCategory === 'SV' || deviceCategory === 'CL') ? 'terminal' : 'printer';
    
    // デバッグ: フォームデータの確認
    console.log('フォームデータ確認:', {
      deviceType: deviceType,
      deviceCategory: deviceCategory,
      locationNumber: locationNumber,
      location: location
    });
    
    // 属性データを解析
    const attributeData = {};
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('attributes[')) {
        const match = key.match(/attributes\[(\w+)\]/);
        if (match) {
          const [, attrName] = match;
          attributeData[attrName] = value;
        }
      }
    }

    // 拠点管理番号をタイトルとして使用
    const formTitle = locationNumber; // 拠点管理番号をタイトルに設定
    
    const formConfig = {
      title: formTitle, // 拠点管理番号をタイトルとして使用
      description: `${getLocationDisplayName(location)} 代替機依頼フォーム`,
      deviceType: deviceType,
      locationNumber: locationNumber,
      location: location,
      deviceCategory: deviceCategory,
      attributes: attributeData,
      questions: getDeviceQuestions(location, deviceCategory, attributeData)
    };
    
    if (DEBUG_MODE) {
      showDebugInfo('フォーム設定データ', {
        deviceCategory: deviceCategory,
        targetSheet: getTargetSheetByCategory(deviceCategory),
        location: location,
        locationNumber: locationNumber
      });
    }
    
    // 詳細カテゴリに基づくマスタシート分岐の説明
    function getTargetSheetByCategory(category) {
      if (category === 'SV' || category === 'CL') {
        return '端末マスタ';
      } else if (category === 'プリンタ') {
        return 'プリンタマスタ';
      } else if (category === 'その他') {
        return 'その他マスタ';
      }
      return '端末マスタ';
    }
    
    // 質問データを解析
    const questionData = {};
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('questions[')) {
        const match = key.match(/questions\[(\d+)\]\[(\w+)\]/);
        if (match) {
          const [, index, field] = match;
          if (!questionData[index]) questionData[index] = {};
          
          if (field === 'options') {
            questionData[index][field] = value.split('\n').filter(opt => opt.trim());
          } else if (field === 'required') {
            questionData[index][field] = value === 'true';
          } else {
            questionData[index][field] = value;
          }
        }
      }
    }
    
    // 質問配列を作成
    Object.keys(questionData).forEach(function(index) {
      const question = questionData[index];
      if (question.title) {
        formConfig.questions.push(question);
      }
    });
    
    // フォーム送信前のデバッグ情報
    console.log('=== フォーム送信データ確認 ===');
    console.log('formData entries:', Array.from(formData.entries()));
    console.log('生成されたformConfig:', formConfig);
    
    // バリデーション
    if (!validateGoogleFormConfig(formConfig)) {
      console.error('バリデーション失敗 - フォーム送信を中止');
      return;
    }
    
    console.log('バリデーション成功 - フォーム送信を開始');
    
    // 送信ボタンをローディング状態に
    const submitButton = form.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    // Google Apps Scriptに送信
    createGoogleFormAPI(formConfig)
      .then(function(result) {
        console.log('Google Apps Script result:', result);
        if (result.success) {
          console.log('result.data:', result.data);
          showFormCreationSuccess(result.data);
          // フォームリセットはresetFormCreation内で実行されるため重複呼び出しを避ける
          resetFormCreation();
          
          if (DEBUG_MODE) {
            showDebugInfo('Google Form作成成功', result);
          }
        } else {
          throw new Error(result.error || 'フォーム作成に失敗しました');
        }
      })
      .catch(function(error) {
        showMessage('エラー: ' + error.message, 'error');
        
        if (DEBUG_MODE) {
          showDebugInfo('Google Form作成エラー', { error: error.message });
        }
      })
      .finally(function() {
        setButtonLoading(submitButton, false);
      });
  }

  function validateGoogleFormConfig(formConfig) {
    let isValid = true;
    let validationErrors = [];
    
    // デバッグ情報を表示
    console.log('=== フォーム設定バリデーション開始 ===');
    console.log('formConfig:', formConfig);
    
    // 必須フィールドチェック
    if (!formConfig.title || formConfig.title.trim() === '') {
      validationErrors.push('拠点管理番号からタイトルを生成できませんでした');
      isValid = false;
    } else {
      console.log('✓ フォームタイトル（拠点管理番号から生成）:', formConfig.title);
    }
    
    if (!formConfig.locationNumber || formConfig.locationNumber.trim() === '') {
      validationErrors.push('拠点管理番号が未設定です');
      isValid = false;
    } else {
      console.log('✓ 拠点管理番号:', formConfig.locationNumber);
    }
    
    // 拠点管理番号の形式チェック（プレフィックスのみ検証）
    if (formConfig.locationNumber) {
      // アンダースコアで分割
      const parts = formConfig.locationNumber.split('_');
      if (parts.length < 2) {
        validationErrors.push('拠点管理番号は「プレフィックス_サフィックス」の形式で入力してください（例：Osaka_001）');
        console.log('✗ 拠点管理番号の形式エラー（アンダースコアなし）:', formConfig.locationNumber);
        isValid = false;
      } else {
        // プレフィックス（アンダースコア前の部分）のみ検証
        const prefix = parts[0];
        const prefixPattern = /^[A-Za-z]+$/;
        
        if (!prefixPattern.test(prefix) || prefix.length < 2) {
          validationErrors.push('プレフィックスは2文字以上の英字で入力してください（例：Osaka、Hime）');
          console.log('✗ プレフィックスの形式エラー:', prefix);
          isValid = false;
        } else {
          console.log('✓ 拠点管理番号の形式OK:', formConfig.locationNumber, '（プレフィックス:', prefix, '）');
        }
      }
    }
    
    // 基本情報のチェック
    if (!formConfig.deviceType) {
      validationErrors.push('代替機種別が未選択です');
      isValid = false;
    } else {
      console.log('✓ 代替機種別:', formConfig.deviceType);
    }
    
    if (!formConfig.location) {
      validationErrors.push('拠点が未選択です');
      isValid = false;
    } else {
      console.log('✓ 拠点:', formConfig.location);
    }
    
    if (!formConfig.deviceCategory) {
      validationErrors.push('詳細カテゴリが未選択です');
      isValid = false;
    } else {
      console.log('✓ 詳細カテゴリ:', formConfig.deviceCategory);
    }
    
    // 質問が1つ以上あるかチェック
    if (!formConfig.questions || formConfig.questions.length === 0) {
      validationErrors.push('質問項目が設定されていません');
      isValid = false;
    } else {
      console.log('✓ 質問項目数:', formConfig.questions.length);
      formConfig.questions.forEach(function(question, index) {
        console.log('質問' + (index + 1) + ':', question);
      });
    }
    
    // 属性データのチェック
    if (formConfig.attributes) {
      console.log('✓ 属性データ:', formConfig.attributes);
      
      // 端末の場合の必須属性チェック
      if (formConfig.deviceType === 'terminal') {
        const requiredTerminalAttrs = ['assetNumber', 'serial', 'software', 'os'];
        requiredTerminalAttrs.forEach(function(attr) {
          if (!formConfig.attributes[attr] || formConfig.attributes[attr].trim() === '') {
            validationErrors.push('端末の必須属性「' + attr + '」が未入力です');
            isValid = false;
          }
        });
      }
      
      // プリンタの場合の必須属性チェック
      if (formConfig.deviceType === 'printer') {
        const requiredPrinterAttrs = ['serial'];
        requiredPrinterAttrs.forEach(function(attr) {
          if (!formConfig.attributes[attr] || formConfig.attributes[attr].trim() === '') {
            validationErrors.push('プリンタの必須属性「' + attr + '」が未入力です');
            isValid = false;
          }
        });
      }
    } else {
      validationErrors.push('属性データが設定されていません');
      isValid = false;
    }
    
    console.log('=== バリデーション結果 ===');
    console.log('isValid:', isValid);
    if (validationErrors.length > 0) {
      console.log('エラー一覧:', validationErrors);
    }
    
    // エラーがある場合は詳細メッセージを表示
    if (!isValid) {
      showValidationErrors(validationErrors);
    }
    
    return isValid;
  }

  // バリデーションエラーの詳細表示
  function showValidationErrors(errors) {
    var errorMessage = 'フォーム作成でエラーが発生しました:\n\n';
    for (var i = 0; i < errors.length; i++) {
      errorMessage += '• ' + errors[i] + '\n';
    }
    
    // コンソールにも出力
    console.error('バリデーションエラー詳細:', errors);
    
    // アラートで詳細エラーを表示
    alert(errorMessage);
    
    // 通常のエラーメッセージも表示
    showMessage('入力内容に不備があります（詳細はコンソールを確認してください）', 'error');
  }

  function showFormCreationSuccess(formData) {
    // デバッグ用: formDataの内容を確認
    console.log('showFormCreationSuccess - formData:', formData);
    
    // タイトルが存在しない場合のフォールバック
    var title = formData.title || formData.name || 'フォーム';
    console.log('使用するタイトル:', title);
    
    // QRコード画像の表示部分を構築
    let qrCodeSection = '';
    
    // デバッグ: QRコードデータを詳細にログ出力
    console.log('QRコードデータ確認:', {
      qrCodeExists: !!formData.qrCode,
      qrCodeSuccess: formData.qrCode ? formData.qrCode.success : 'undefined',
      publicImageUrl: formData.qrCode ? formData.qrCode.publicImageUrl : 'undefined',
      fullQrCodeData: formData.qrCode
    });
    
    if (formData.qrCode && formData.qrCode.success) {
      // Base64データがある場合は優先して使用（CORS制限回避）
      let primaryImageSrc = '';
      let fallbackSrcs = [];
      
      if (formData.qrCode.base64ImageData) {
        primaryImageSrc = formData.qrCode.base64ImageData;
        console.log('Base64データを使用します');
      } else if (formData.qrCode.publicImageUrl) {
        primaryImageSrc = formData.qrCode.publicImageUrl;
        if (formData.qrCode.thumbnailUrl) {
          fallbackSrcs.push(formData.qrCode.thumbnailUrl);
        }
      }
      
      console.log('QRコード画像URL:', {
        primary: primaryImageSrc ? 'Base64データ' : primaryImageSrc,
        hasBase64: !!formData.qrCode.base64ImageData,
        publicUrl: formData.qrCode.publicImageUrl,
        thumbnailUrl: formData.qrCode.thumbnailUrl,
        fallbacks: fallbackSrcs
      });
      
      if (primaryImageSrc) {
        // エラーハンドリング用のJavaScriptを構築
        let onErrorHandler = 'this.onerror=null; ';
        fallbackSrcs.forEach((url, index) => {
          onErrorHandler += `if(!this.dataset.tried${index}) { this.dataset.tried${index}='true'; this.src='${url}'; return; } `;
        });
        onErrorHandler += `this.style.display='none'; document.getElementById('qr-error-msg').style.display='block';`;
        
        qrCodeSection = 
          '<div class="qr-code-section">' +
            '<h4><i class="fas fa-qrcode"></i> QRコード</h4>' +
            '<div class="qr-code-container">' +
              '<img src="' + primaryImageSrc + '" alt="QRコード" class="qr-code-image" ' +
              'onerror="' + onErrorHandler + '" />' +
              '<div id="qr-error-msg" style="display:none; color: #dc2626; margin-top: 10px;">' +
                '<p>⚠️ QRコード画像の読み込みに失敗しました</p>' +
                '<p>ファイルID: ' + (formData.qrCode.fileId || 'なし') + '</p>' +
                (formData.qrCode.publicImageUrl ? 
                  '<p><a href="' + formData.qrCode.publicImageUrl + '" target="_blank" style="color: #3b82f6;">直接リンクで確認</a></p>' : '') +
              '</div>' +
              '<p class="qr-code-note">📱 <strong>読み取りテストをお願いします</strong></p>' +
              '<p class="qr-code-instruction">上記QRコードをスマートフォンで読み取って、リンク先の共通フォームよりステータス変更テストを行ってください。</p>' +
            '</div>' +
          '</div>';
      } else {
        qrCodeSection = 
          '<div class="qr-code-section error">' +
            '<h4><i class="fas fa-exclamation-triangle"></i> QRコード画像データなし</h4>' +
            '<p>QRコード画像のURLまたはデータが取得できませんでした。</p>' +
          '</div>';
      }
    } else {
      // QRコード生成失敗時の詳細情報を表示
      const errorDetails = formData.qrCode ? 
        `成功フラグ: ${formData.qrCode.success}, URL: ${formData.qrCode.publicImageUrl || 'なし'}` :
        'QRコードデータが存在しません';
        
      qrCodeSection = 
        '<div class="qr-code-section error">' +
          '<h4><i class="fas fa-exclamation-triangle"></i> QRコード生成エラー</h4>' +
          '<p>QRコードの生成に失敗しました。フォーム作成は正常に完了しています。</p>' +
          '<details style="margin-top: 10px;">' +
            '<summary style="cursor: pointer; color: #6b7280;">詳細情報</summary>' +
            '<p style="font-family: monospace; font-size: 0.8rem; color: #6b7280; margin-top: 5px;">' + errorDetails + '</p>' +
          '</details>' +
        '</div>';
    }
    
    // 成功ダイアログを表示
    const successHtml = 
      '<div class="form-success-dialog">' +
        '<div class="success-content">' +
          '<h3><i class="fas fa-check-circle"></i> フォーム作成完了</h3>' +
          '<p><strong>' + title + '</strong> を正常に作成しました。</p>' +
          
          '<div class="form-links">' +
            '<div class="link-item">' +
              '<label>公開URL（回答用）:</label>' +
              '<div class="url-display">' +
                '<input type="text" value="' + formData.publicUrl + '" readonly>' +
                '<button onclick="copyToClipboard(\'' + formData.publicUrl + '\')">' +
                  '<i class="fas fa-copy"></i>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          
          qrCodeSection +
          
          '<div class="dialog-actions">' +
            '<button class="btn btn-secondary" onclick="closeSuccessDialog()">' +
              '閉じる' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    
    // ダイアログを表示
    const dialogDiv = document.createElement('div');
    dialogDiv.className = 'success-dialog-overlay';
    dialogDiv.innerHTML = successHtml;
    
    // HTMLが正しく作成されているか確認
    console.log('生成されたHTML:', successHtml.substring(0, 200));
    
    document.body.appendChild(dialogDiv);
  }

  // ========================================
  // フォームバリデーション
  // ========================================
  function validateForm(form, formType) {
    let isValid = true;
    
    // フォーム要素の存在確認
    if (!form || !form.querySelectorAll) {
      console.error('validateForm: 無効なフォーム要素', form);
      return false;
    }
    
    // 必須フィールドのチェック
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
      field.classList.remove('error');
      
      if (!field.value.trim()) {
        field.classList.add('error');
        isValid = false;
      }
    });
    
    // フォームタイプ別の追加バリデーション
    if (formType === 'terminal') {
      isValid &= validateTerminalForm(form);
    } else if (formType === 'printer') {
      isValid &= validatePrinterForm(form);
    }
    
    return isValid;
  }
  
  function validateTerminalForm(form) {
    let isValid = true;
    
    // 資産管理番号の形式チェック
    const assetNumber = form.querySelector('[name="assetNumber"]');
    if (assetNumber && assetNumber.value) {
      const assetPattern = /^[A-Z]{2,4}-\d{6}$/;
      if (!assetPattern.test(assetNumber.value)) {
        assetNumber.classList.add('error');
        isValid = false;
      }
    }
    
    // 拠点管理番号は統一検証関数で処理されるためここでは削除
    
    return isValid;
  }
  
  function validatePrinterForm(form) {
    let isValid = true;
    
    // 拠点管理番号は統一検証関数で処理されるためここでは削除
    
    return isValid;
  }

  // ========================================
  // Google Apps Scriptとの通信
  // ========================================
  function createGoogleFormAPI(formConfig) {
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .createGoogleForm(formConfig);
      } catch (error) {
        // Google Apps Script環境でない場合（開発環境）
        if (DEBUG_MODE) {
          setTimeout(function() {
            resolve({ 
              success: true, 
              message: 'テストモード: フォームが正常に作成されました',
              data: {
                formId: 'test-form-id',
                title: formConfig.title,
                editUrl: 'https://docs.google.com/forms/d/test-form-id/edit',
                publicUrl: 'https://docs.google.com/forms/d/test-form-id/viewform',
                responseSheetId: 'test-sheet-id',
                responseSheetUrl: 'https://docs.google.com/spreadsheets/d/test-sheet-id',
                locationNumber: formConfig.locationNumber,
                qrCode: {
                  success: true,
                  publicImageUrl: 'https://via.placeholder.com/200x200/0ea5e9/ffffff?text=TEST+QR',
                  thumbnailUrl: 'https://via.placeholder.com/400x400/0ea5e9/ffffff?text=TEST+QR+THUMB',
                  base64ImageData: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP8/5+hnoEIwDiqkL4KAcT9GO0U4BxoAAAAAElFTkSuQmCC',
                  fileName: 'qr_test_001.png',
                  fileId: 'test-file-id',
                  qrCodeUrl: 'https://docs.google.com/forms/d/test-form-id/viewform'
                }
              }
            });
          }, 1000);
        } else {
          reject(new Error('Google Apps Script環境が必要です'));
        }
      }
    });
  }

  function loadFormsList() {
    const loadingIndicator = document.getElementById('forms-loading');
    const formsList = document.getElementById('forms-list');
    
    loadingIndicator.style.display = 'block';
    
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            displayFormsList(result);
            resolve(result);
          })
          .withFailureHandler(function(error) {
            showMessage('フォーム一覧の取得に失敗しました: ' + error.message, 'error');
            reject(error);
          })
          .getCreatedFormsList();
      } catch (error) {
        // Google Apps Script環境でない場合（開発環境）
        if (DEBUG_MODE) {
          setTimeout(function() {
            const testResult = {
              success: true,
              forms: [
                {
                  id: 'test-form-1',
                  title: 'テスト フォーム 1',
                  description: 'テスト用のフォームです',
                  editUrl: 'https://docs.google.com/forms/d/test-form-1/edit',
                  publicUrl: 'https://docs.google.com/forms/d/test-form-1/viewform',
                  createdDate: new Date(),
                  responseCount: 5
                }
              ],
              totalCount: 1
            };
            displayFormsList(testResult);
            resolve(testResult);
          }, 1000);
        } else {
          showMessage('Google Apps Script環境が必要です', 'error');
          reject(new Error('Google Apps Script環境が必要です'));
        }
      }
    }).finally(function() {
      loadingIndicator.style.display = 'none';
    });
  }

  function displayFormsList(result) {
    const formsList = document.getElementById('forms-list');
    
    if (!result.success || !result.forms || result.forms.length === 0) {
      formsList.innerHTML = 
        '<div class="no-forms">' +
          '<i class="fas fa-inbox"></i>' +
          '<p>作成済みフォームがありません</p>' +
        '</div>';
      return;
    }
    
    var formsHtml = '';
    for (var i = 0; i < result.forms.length; i++) {
      var form = result.forms[i];
      formsHtml += 
        '<div class="form-item">' +
          '<div class="form-info">' +
            '<h4>' + form.title + '</h4>' +
            '<p>' + (form.description || '説明なし') + '</p>' +
            '<div class="form-meta">' +
              '<span><i class="fas fa-calendar"></i> ' + new Date(form.createdDate).toLocaleDateString() + '</span>' +
              '<span><i class="fas fa-chart-bar"></i> 回答: ' + form.responseCount + '件</span>' +
            '</div>' +
          '</div>' +
          '<div class="form-actions">' +
            '<button class="btn btn-sm btn-primary" onclick="window.open(\'' + form.editUrl + '\', \'_blank\')">' +
              '<i class="fas fa-edit"></i> 編集' +
            '</button>' +
            '<button class="btn btn-sm btn-secondary" onclick="window.open(\'' + form.publicUrl + '\', \'_blank\')">' +
              '<i class="fas fa-external-link-alt"></i> 表示' +
            '</button>' +
            '<button class="btn btn-sm btn-danger" onclick="deleteForm(\'' + form.id + '\', \'' + form.title + '\')">' +
              '<i class="fas fa-trash"></i> 削除' +
            '</button>' +
          '</div>' +
        '</div>';
    }
    
    formsList.innerHTML = formsHtml;
  }

  function deleteForm(formId, formTitle) {
    if (!confirm('フォーム「' + formTitle + '」を削除しますか？\n\nこの操作は取り消せません。')) {
      return;
    }
    
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('フォームを削除しました', 'success');
              loadFormsList(); // 一覧を更新
            } else {
              showMessage('削除に失敗しました: ' + result.error, 'error');
            }
            resolve(result);
          })
          .withFailureHandler(function(error) {
            showMessage('削除中にエラーが発生しました: ' + error.message, 'error');
            reject(error);
          })
          .deleteGoogleForm(formId);
      } catch (error) {
        if (DEBUG_MODE) {
          setTimeout(function() {
            showMessage('テストモード: フォームを削除しました', 'success');
            loadFormsList();
            resolve({ success: true });
          }, 500);
        } else {
          showMessage('Google Apps Script環境が必要です', 'error');
          reject(new Error('Google Apps Script環境が必要です'));
        }
      }
    });
  }

  // ========================================
  // UI ヘルパー関数
  // ========================================
  function setButtonLoading(button, isLoading) {
    if (!button) return;
    
    if (isLoading) {
      button.classList.add('loading');
      button.disabled = true;
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-spinner';
      }
    } else {
      button.classList.remove('loading');
      button.disabled = false;
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-save';
      }
    }
  }
  
  function showMessage(message, type) {
    try {
      // DOM が利用可能かチェック
      if (typeof document === 'undefined' || !document || !document.body) {
        console.log('showMessage: DOM未対応環境', { message, type });
        return;
      }
      
      // 既存のメッセージを削除
      try {
        const existingMessages = document.querySelectorAll('.success-message, .error-message');
        if (existingMessages && existingMessages.length > 0) {
          existingMessages.forEach(function(msg) {
            if (msg && msg.remove) {
              msg.remove();
            }
          });
        }
      } catch (queryError) {
        console.log('showMessage: 既存メッセージの削除でエラー', queryError);
        // エラーが発生しても処理を続行
      }
      
      // 新しいメッセージを作成
      const messageDiv = document.createElement('div');
      if (!messageDiv) {
        console.error('showMessage: メッセージ要素の作成に失敗');
        return;
      }
      
      messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
      var iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
      
      // エラーメッセージの場合は閉じるボタンを追加
      if (type === 'error') {
        messageDiv.innerHTML = 
          '<div class="message-content">' +
            '<i class="fas ' + iconClass + '"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button class="message-close-btn" onclick="this.parentElement.remove()">' +
            '×' +
          '</button>';
      } else {
        messageDiv.innerHTML = 
          '<i class="fas ' + iconClass + '"></i>' +
          '<span>' + message + '</span>';
      }
      
      if (document.body) {
        document.body.appendChild(messageDiv);
        
        // 成功メッセージのみ自動削除（エラーメッセージは手動削除）
        if (type === 'success') {
          setTimeout(function() {
            if (messageDiv && messageDiv.parentNode) {
              messageDiv.remove();
            }
          }, 3000);
        }
      }
      
    } catch (error) {
      console.error('showMessage エラー:', error, { message, type });
      // フォールバック: コンソールに出力
      console.log('[' + type.toUpperCase() + '] ' + message);
    }
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
      showMessage('URLをクリップボードにコピーしました', 'success');
    }).catch(function(err) {
      showMessage('コピーに失敗しました', 'error');
    });
  }

  function closeSuccessDialog() {
    const dialog = document.querySelector('.success-dialog-overlay');
    if (dialog) {
      dialog.remove();
    }
  }

  // ========================================
  // イベントリスナーの設定
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    // Google Form作成フォームの送信イベント
    const googleFormCreationForm = document.getElementById('googleFormCreationForm');
    if (googleFormCreationForm) {
      googleFormCreationForm.addEventListener('submit', handleGoogleFormCreation);
    }
    
    // 拠点管理番号suffix入力のイベントリスナー
    const locationSuffixInput = document.getElementById('location-suffix');
    if (locationSuffixInput) {
      locationSuffixInput.addEventListener('input', function() {
        // 拠点管理番号は属性内で処理
      });
    }
    
    // 初期の質問タイプ変更イベント
    updateQuestionOptions(0);
    
    if (DEBUG_MODE) {
      showDebugInfo('フォーム作成ページ初期化完了', {});
    }
  });

  // ========================================
  // 属性内での拠点管理番号生成機能
  // ========================================
  
  function updateAttributeLocationNumber() {
    console.log('updateAttributeLocationNumber called');
    
    const attrLocationNumberDisplay = document.getElementById('attr-location-number-display');
    const attrLocationNumberInputContainer = document.getElementById('attr-location-number-input');
    const attrLocationPrefixGenerated = document.getElementById('attr-location-prefix-generated');
    const attrLocationSuffixInput = document.getElementById('attr-location-suffix');
    const attrLocationNumberHidden = document.getElementById('attr-location-number');
    
    if (!attrLocationNumberDisplay || !attrLocationNumberInputContainer) {
      console.log('属性拠点管理番号要素が見つかりません');
      return;
    }
    
    // 必要な情報を取得
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    const modelSelect = document.getElementById('model-select');
    const serialInput = document.getElementById('attr-serial');
    
    const location = locationSelect ? locationSelect.value : '';
    const deviceCategory = deviceCategorySelect ? deviceCategorySelect.value : '';
    const serialNumber = serialInput ? serialInput.value.trim() : '';
    
    console.log('属性拠点管理番号生成データ:', {
      location,
      deviceCategory,
      serialNumber
    });
    
    // 拠点プレフィックスを取得（拠点マスタベース）
    const locationPrefix = getLocationPrefix(location);
    console.log('取得した拠点プレフィックス:', locationPrefix, 'for location:', location);
    
    const categoryMapping = {
      'SV': 'SV',
      'CL': 'CL', 
      'プリンタ': 'Printer',
      'その他': 'Other'
    };
    
    // 機種情報を取得
    let modelInfo = '';
    if (modelSelect && modelSelect.value) {
      try {
        const modelData = JSON.parse(modelSelect.value);
        let modelName = modelData.modelName || '';
        
        // 機種名の日本語→英語変換
        const modelNameMapping = {
          'サーバー': 'Server',
          'デスクトップ': 'Desktop', 
          'ノートパソコン': 'Laptop',
          'ノートPC': 'Laptop',
          'プリンタ': 'Printer',
          '複合機': 'MFP',
          'タブレット': 'Tablet',
          'モニター': 'Monitor',
          'ディスプレイ': 'Display'
        };
        
        Object.keys(modelNameMapping).forEach(function(japanese) {
          const regex = new RegExp(japanese, 'gi');
          modelName = modelName.replace(regex, modelNameMapping[japanese]);
        });
        
        modelInfo = modelName.length > 10 ? modelName.substring(0, 10) : modelName;
        modelInfo = modelInfo.replace(/[\s\-ー]/g, '_');
        
      } catch (error) {
        console.error('機種データの解析エラー:', error);
      }
    }
    
    // プレビュー表示を更新
    let previewText = '';
    let isComplete = false;
    
    console.log('プレビュー生成の条件確認:', {
      location: !!location,
      deviceCategory: !!deviceCategory,
      modelInfo: !!modelInfo,
      serialNumber: !!serialNumber,
      locationPrefix: locationPrefix
    });
    
    if (!location) {
      previewText = '拠点を選択してください';
    } else if (!deviceCategory) {
      previewText = `${locationPrefix}_[Category]_[Model]_[Serial]_[Number]`;
    } else if (!modelInfo) {
      const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
      previewText = `${locationPrefix}_${englishCategory}_[Model]_[Serial]_[Number]`;
    } else if (!serialNumber) {
      const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
      previewText = `${locationPrefix}_${englishCategory}_${modelInfo}_[Serial]_[Number]`;
    } else {
      const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
      previewText = `${locationPrefix}_${englishCategory}_${modelInfo}_${serialNumber}_[Number]`;
      isComplete = true;
    }
    
    console.log('生成されたプレビューテキスト:', previewText);
    
    // プレビュー表示を更新
    attrLocationNumberDisplay.textContent = previewText;
    if (isComplete) {
      attrLocationNumberDisplay.classList.add('has-content');
    } else {
      attrLocationNumberDisplay.classList.remove('has-content');
    }
    
    // 入力欄の表示・非表示を切り替え
    if (isComplete && attrLocationNumberInputContainer) {
      attrLocationNumberInputContainer.style.display = 'flex';
      
      // プレフィックス部分を設定
      if (attrLocationPrefixGenerated) {
        const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
        attrLocationPrefixGenerated.textContent = `${locationPrefix}_${englishCategory}_${modelInfo}_${serialNumber}_`;
      }
      
      // 入力欄を有効化
      if (attrLocationSuffixInput) {
        attrLocationSuffixInput.disabled = false;
        attrLocationSuffixInput.placeholder = '001';
        
        console.log('入力欄を有効化しました:', {
          disabled: attrLocationSuffixInput.disabled,
          placeholder: attrLocationSuffixInput.placeholder,
          type: attrLocationSuffixInput.type
        });
        
        // デフォルト値設定
        if (!attrLocationSuffixInput.value) {
          attrLocationSuffixInput.value = '001';
        }
        
        console.log('入力欄の最終状態:', {
          value: attrLocationSuffixInput.value,
          readOnly: attrLocationSuffixInput.readOnly,
          style: attrLocationSuffixInput.style.cssText
        });
        
        // 最終的な拠点管理番号を生成
        updateFinalAttributeLocationNumber();
      } else {
        console.error('入力欄が見つかりませんでした');
      }
    } else {
      if (attrLocationNumberInputContainer) {
        attrLocationNumberInputContainer.style.display = 'none';
      }
      if (attrLocationSuffixInput) {
        attrLocationSuffixInput.disabled = true;
        attrLocationSuffixInput.value = '';
      }
      if (attrLocationNumberHidden) {
        attrLocationNumberHidden.value = '';
      }
    }
  }
  
  function updateFinalAttributeLocationNumber() {
    const attrLocationPrefixGenerated = document.getElementById('attr-location-prefix-generated');
    const attrLocationSuffixInput = document.getElementById('attr-location-suffix');
    const attrLocationNumberHidden = document.getElementById('attr-location-number');
    
    if (attrLocationPrefixGenerated && attrLocationSuffixInput && attrLocationNumberHidden) {
      const prefix = attrLocationPrefixGenerated.textContent || '';
      const suffix = attrLocationSuffixInput.value || '';
      const finalLocationNumber = prefix + suffix;
      
      attrLocationNumberHidden.value = finalLocationNumber;
      
      console.log('最終拠点管理番号（属性）:', finalLocationNumber);
    }
  }

  // グローバルスコープに関数を公開
  window.initializeLocationOptions = initializeLocationOptions;
  window.updateLocationNumber = updateLocationNumber;
  window.updateDeviceCategory = updateDeviceCategory;
  window.switchFormCreationMode = switchFormCreationMode;
  window.deleteForm = deleteForm;
  window.closeSuccessDialog = closeSuccessDialog;
  window.copyToClipboard = copyToClipboard;
  window.updateAttributeLocationNumber = updateAttributeLocationNumber;
  window.updateFinalAttributeLocationNumber = updateFinalAttributeLocationNumber;
  
  // フォームタイトル自動生成機能は削除済み
  // タイトルは拠点管理番号から自動設定されます

</script> 