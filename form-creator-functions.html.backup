<!-- form-creator-functions.html - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½ -->
<script>
  // ========================================
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–
  // ========================================
  function onFormCreatorPageShow() {
    // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®å‡¦ç†
    if (DEBUG_MODE) {
      showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹', {});
    }
    
    // æ‹ ç‚¹ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿
    loadLocationMasterForForm();
  }

  // ========================================
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
  // ========================================
  function switchFormCreationMode(mode) {
    // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.form-type-tab').forEach(function(tab) {
      tab.classList.remove('active');
    });
    document.getElementById(mode + '-tab').classList.add('active');
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.form-section').forEach(function(section) {
      section.classList.remove('active');
    });
    document.getElementById(mode + '-form').classList.add('active');
    
    // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    if (mode === 'manage') {
      loadFormsList();
    }
    
    if (DEBUG_MODE) {
      showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ', { mode });
    }
  }

  // ========================================
  // æ©Ÿç¨®ãƒã‚¹ã‚¿é–¢é€£æ©Ÿèƒ½
  // ========================================
  
  // æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€ï¼ˆè©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
  function loadModelCategories() {
    const modelCategorySelect = document.getElementById('model-category');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!modelCategorySelect || !deviceCategorySelect) {
      console.error('å¿…è¦ãªé¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const deviceCategory = deviceCategorySelect.value;
    
    if (!deviceCategory) {
      modelCategorySelect.innerHTML = '<option value="">ã¾ãšè©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      modelCategorySelect.disabled = true;
      return;
    }
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã¨æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const categoryMapping = {
      'SV': ['ã‚µãƒ¼ãƒãƒ¼'], // SVã«ã¯ã‚µãƒ¼ãƒãƒ¼ã®ã¿è¡¨ç¤º
      'CL': ['ãƒãƒ¼ãƒˆPC', 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—PC'], // CLã«ã¯ãƒãƒ¼ãƒˆPCã¨ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—PCã‚’è¡¨ç¤º
      'ãƒ—ãƒªãƒ³ã‚¿': ['ãƒ—ãƒªãƒ³ã‚¿'], // ãƒ—ãƒªãƒ³ã‚¿ã«ã¯ãƒ—ãƒªãƒ³ã‚¿ã®ã¿è¡¨ç¤º
      'ãã®ä»–': ['ãã®ä»–', 'ãƒ—ãƒªãƒ³ã‚¿'] // ãã®ä»–ã«ã¯ãã®ä»–ã¨ãƒ—ãƒªãƒ³ã‚¿ã‚’è¡¨ç¤º
    };
    
    const allowedCategories = categoryMapping[deviceCategory] || [];
    
    console.log('è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ããƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:', {
      deviceCategory: deviceCategory,
      allowedCategories: allowedCategories
    });
    
    // Google Apps Scriptã‹ã‚‰æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªå–å¾—çµæœ:', result);
        
        if (result.success) {
          modelCategorySelect.innerHTML = '<option value="">æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
          
          // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          const filteredCategories = result.categories.filter(function(category) {
            return allowedCategories.includes(category);
          });
          
          console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ã‚«ãƒ†ã‚´ãƒª:', filteredCategories);
          
          if (filteredCategories.length === 0) {
            modelCategorySelect.innerHTML = '<option value="">è©²å½“ã™ã‚‹æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“</option>';
            modelCategorySelect.disabled = true;
            return;
          }
          
          filteredCategories.forEach(function(category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            modelCategorySelect.appendChild(option);
          });
          
          modelCategorySelect.disabled = false;
        } else {
          console.error('æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã®å–å¾—ã«å¤±æ•—:', result.error);
          modelCategorySelect.innerHTML = '<option value="">æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
          modelCategorySelect.disabled = true;
        }
      })
      .withFailureHandler(function(error) {
        console.error('æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªå–å¾—ã§ã‚¨ãƒ©ãƒ¼:', error);
        modelCategorySelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</option>';
        modelCategorySelect.disabled = true;
      })
      .getAvailableCategories();
  }
  
  // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ©Ÿç¨®ä¸€è¦§ã‚’æ›´æ–°
  function updateModelsByCategory() {
    const modelCategorySelect = document.getElementById('model-category');
    const modelSelect = document.getElementById('model-select');
    
    if (!modelCategorySelect || !modelSelect) {
      console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const selectedCategory = modelCategorySelect.value;
    console.log('é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒª:', selectedCategory);
    
    if (!selectedCategory) {
      modelSelect.innerHTML = '<option value="">ã¾ãšæ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      modelSelect.disabled = true;
      // æ©Ÿç¨®é¸æŠãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸå ´åˆã‚‚æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’æ›´æ–°
      // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯å±æ€§å†…ã§å‡¦ç†
      return;
    }
    
    // Google Apps Scriptã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªåˆ¥æ©Ÿç¨®ã‚’å–å¾—
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('ã‚«ãƒ†ã‚´ãƒªåˆ¥æ©Ÿç¨®å–å¾—çµæœ:', result);
        
        if (result.success) {
          modelSelect.innerHTML = '<option value="">æ©Ÿç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
          
          result.models.forEach(function(model) {
            const option = document.createElement('option');
            option.value = JSON.stringify({
              modelName: model.modelName,
              manufacturer: model.manufacturer,
              category: model.category
            });
            option.textContent = model.displayName;
            modelSelect.appendChild(option);
          });
          
          modelSelect.disabled = false;
        } else {
          console.error('ã‚«ãƒ†ã‚´ãƒªåˆ¥æ©Ÿç¨®ã®å–å¾—ã«å¤±æ•—:', result.error);
          modelSelect.innerHTML = '<option value="">æ©Ÿç¨®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
        }
      })
      .withFailureHandler(function(error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªåˆ¥æ©Ÿç¨®å–å¾—ã§ã‚¨ãƒ©ãƒ¼:', error);
        modelSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</option>';
      })
      .getModelMasterByCategory(selectedCategory);
  }
  
  // æ©Ÿç¨®é¸æŠæ™‚ã®å‡¦ç†
  function updateSelectedModel() {
    const modelSelect = document.getElementById('model-select');
    
    if (!modelSelect) {
      console.error('æ©Ÿç¨®é¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const selectedValue = modelSelect.value;
    console.log('é¸æŠã•ã‚ŒãŸæ©Ÿç¨®:', selectedValue);
    
    if (selectedValue) {
      try {
        const modelData = JSON.parse(selectedValue);
        console.log('é¸æŠã•ã‚ŒãŸæ©Ÿç¨®ãƒ‡ãƒ¼ã‚¿:', modelData);
        
        // é¸æŠã•ã‚ŒãŸæ©Ÿç¨®æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã™ã‚‹å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
        // ä¾‹: å‹ç•ªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°è‡ªå‹•å…¥åŠ›ãªã©
        
        // æ©Ÿç¨®ãŒé¸æŠã•ã‚ŒãŸã‚‰æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’æ›´æ–°
        // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯å±æ€§å†…ã§å‡¦ç†
        
        // å±æ€§å†…ã®æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚‚æ›´æ–°
        setTimeout(() => {
          updateAttributeLocationNumber();
        }, 100);
        
      } catch (error) {
        console.error('æ©Ÿç¨®ãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
      }
    } else {
      // æ©Ÿç¨®é¸æŠãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸå ´åˆã‚‚æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’æ›´æ–°
      // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯å±æ€§å†…ã§å‡¦ç†
      
      // å±æ€§å†…ã®æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚‚æ›´æ–°
      setTimeout(() => {
        updateAttributeLocationNumber();
      }, 100);
    }
  }

  // ========================================
  // æ‹ ç‚¹é¸æŠæ©Ÿèƒ½
  // ========================================
  
  // æ‹ ç‚¹ãƒã‚¹ã‚¿ã‹ã‚‰æ‹ ç‚¹ä¸€è¦§ã‚’å–å¾—
  function loadLocationMasterForForm() {
    console.log('æ‹ ç‚¹ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
    
    google.script.run
      .withSuccessHandler(function(locations) {
        console.log('æ‹ ç‚¹ãƒã‚¹ã‚¿å–å¾—æˆåŠŸ:', locations);
        if (locations && locations.length > 0) {
          updateLocationOptions(locations);
        } else {
          console.warn('æ‹ ç‚¹ãƒã‚¹ã‚¿ãŒç©ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨');
          initializeLocationOptions();
        }
      })
      .withFailureHandler(function(error) {
        console.error('æ‹ ç‚¹ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‹ ç‚¹é¸æŠè‚¢ã‚’ä½¿ç”¨ã—ã¾ã™');
        if (DEBUG_MODE) {
          showDebugInfo('æ‹ ç‚¹ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼', { error: error.toString() });
        }
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ‹ ç‚¹ã‚’ä½¿ç”¨
        initializeLocationOptions();
      })
      .getLocationMaster();
  }
  
  // æ‹ ç‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
  function updateLocationOptions(locations) {
    console.log('æ‹ ç‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°é–‹å§‹ã€‚å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', locations);
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ‹ ç‚¹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
    const activeLocations = locations.filter(location => location.status === 'active');
    
    console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ‹ ç‚¹:', activeLocations);
    
    if (DEBUG_MODE) {
      showDebugInfo('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ‹ ç‚¹ä¸€è¦§', activeLocations);
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜ï¼ˆä»–ã®é–¢æ•°ã§ä½¿ç”¨ï¼‰
    window.formCreatorLocations = activeLocations;
    
    // æ‹ ç‚¹é¸æŠã‚’æ›´æ–°
    console.log('initializeLocationOptionså‘¼ã³å‡ºã—...');
    initializeLocationOptions();
  }
  
  function getLocationDisplayName(locationValue) {
    // æ–°ã—ã„æ‹ ç‚¹ãƒã‚¹ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¡¨ç¤ºåå–å¾—
    if (window.formCreatorLocations) {
      const location = window.formCreatorLocations.find(loc => loc.locationId === locationValue);
      if (location) {
        return location.locationName;
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸåå‰
    const locationNames = {
      'osaka-desktop': 'å¤§é˜ª(ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—)',
      'osaka-server': 'å¤§é˜ª(ã‚µãƒ¼ãƒãƒ¼ã€ãƒãƒ¼ãƒˆ)',
      'kobe-terminal': 'ç¥æˆ¸(ç«¯æœ«)',
      'himeji-terminal': 'å§«è·¯(ç«¯æœ«)',
      'osaka-printer': 'å¤§é˜ª(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)',
      'hyogo-printer': 'å…µåº«(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)'
    };
    
    return locationNames[locationValue] || 'æœªé¸æŠæ‹ ç‚¹';
  }
  
  // æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰ã‚’å–å¾—
  function getLocationPrefix(locationValue) {
    console.log('getLocationPrefix called with:', locationValue);
    console.log('Available locations:', window.formCreatorLocations);
    
    // æ‹ ç‚¹ãƒã‚¹ã‚¿ã‹ã‚‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹å–å¾—
    if (window.formCreatorLocations) {
      const location = window.formCreatorLocations.find(loc => loc.locationId === locationValue);
      console.log('Found location:', location);
      if (location && location.locationCode) {
        console.log('Using location code from master:', location.locationCode);
        return location.locationCode;
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
    console.log('Using fallback prefix for:', locationValue);
    const locationPrefixes = {
      'osaka-desktop': 'OSA',
      'osaka-server': 'OSA', 
      'kobe-terminal': 'KOB',
      'himeji-terminal': 'HIM',
      'osaka-printer': 'OSA',
      'hyogo-printer': 'HYO'
    };
    
    const prefix = locationPrefixes[locationValue] || 'UNK';
    console.log('Fallback prefix result:', prefix);
    return prefix;
  }
  // æ‹ ç‚¹é¸æŠè‚¢ã‚’åˆæœŸåŒ–ã™ã‚‹å‡¦ç†
  function initializeLocationOptions() {
    console.log('initializeLocationOptionsé–‹å§‹');
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!locationSelect || !deviceCategorySelect) {
      console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    console.log('æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', window.formCreatorLocations);
    
    if (DEBUG_MODE) {
      showDebugInfo('æ‹ ç‚¹é¸æŠè‚¢åˆæœŸåŒ–é–‹å§‹', {});
    }
    
    // æ‹ ç‚¹é¸æŠè‚¢ã‚’æ§‹ç¯‰ï¼ˆæ‹ ç‚¹ãƒã‚¹ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
    let locationOptions = [];
    
    if (window.formCreatorLocations && window.formCreatorLocations.length > 0) {
      // æ‹ ç‚¹ãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ã—ãŸæ‹ ç‚¹ã‚’ä½¿ç”¨
      console.log('æ‹ ç‚¹ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', window.formCreatorLocations.length, 'ä»¶');
      locationOptions = window.formCreatorLocations.map(location => ({
        value: location.locationId,
        text: location.locationName
      }));
      
      console.log('ç”Ÿæˆã•ã‚ŒãŸæ‹ ç‚¹é¸æŠè‚¢:', locationOptions);
      
      if (DEBUG_MODE) {
        showDebugInfo('æ‹ ç‚¹ãƒã‚¹ã‚¿ã‹ã‚‰æ‹ ç‚¹é¸æŠè‚¢ã‚’ç”Ÿæˆ', locationOptions);
      }
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ‹ ç‚¹
      console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‹ ç‚¹é¸æŠè‚¢ã‚’ä½¿ç”¨');
      locationOptions = [
        { value: 'osaka-desktop', text: 'å¤§é˜ª(ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—)' },
        { value: 'osaka-server', text: 'å¤§é˜ª(ã‚µãƒ¼ãƒãƒ¼ã€ãƒãƒ¼ãƒˆ)' },
        { value: 'kobe-terminal', text: 'ç¥æˆ¸(ç«¯æœ«)' },
        { value: 'himeji-terminal', text: 'å§«è·¯(ç«¯æœ«)' },
        { value: 'osaka-printer', text: 'å¤§é˜ª(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)' },
        { value: 'hyogo-printer', text: 'å…µåº«(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)' }
      ];
      
      console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‹ ç‚¹é¸æŠè‚¢:', locationOptions);
      
      if (DEBUG_MODE) {
        showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‹ ç‚¹é¸æŠè‚¢ã‚’ä½¿ç”¨', locationOptions);
      }
    }
    
    // æ‹ ç‚¹é¸æŠè‚¢ã‚’æ›´æ–°
    console.log('æ‹ ç‚¹é¸æŠè‚¢ã®æ›´æ–°é–‹å§‹ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°:', locationOptions.length);
    locationSelect.innerHTML = '<option value="">æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    
    if (locationOptions.length > 0) {
      locationOptions.forEach(function(option) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        locationSelect.appendChild(optionElement);
      });
      locationSelect.disabled = false;
      
      console.log('æ‹ ç‚¹é¸æŠè‚¢æ›´æ–°å®Œäº†ã€‚', locationOptions.length, 'å€‹ã®é¸æŠè‚¢ã‚’è¿½åŠ ');
      
      if (DEBUG_MODE) {
        showDebugInfo('æ‹ ç‚¹é¸æŠè‚¢æ›´æ–°å®Œäº†', { count: locationOptions.length });
      }
    } else {
      locationSelect.disabled = true;
      console.error('æ‹ ç‚¹é¸æŠè‚¢ãŒç©ºã®ãŸã‚ã€æ‹ ç‚¹é¸æŠã‚’ç„¡åŠ¹åŒ–');
      
      if (DEBUG_MODE) {
        showDebugInfo('æ‹ ç‚¹é¸æŠè‚¢ãªã—', { locationOptionsLength: locationOptions.length });
      }
    }
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’ãƒªã‚»ãƒƒãƒˆ
    deviceCategorySelect.innerHTML = '<option value="">æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    deviceCategorySelect.disabled = true;
    
    // å±æ€§ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–°
    updateAttributesForm();
     
     // æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’æ›´æ–°
     // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯å±æ€§å†…ã§å‡¦ç†
     
     if (DEBUG_MODE) {
       showDebugInfo('ä»£æ›¿æ©Ÿç¨®åˆ¥é¸æŠæ›´æ–°', { 
        selectedType, 
        locationOptionsCount: locationOptions.length
      });
    }
  }

  // æ‹ ç‚¹é¸æŠæ™‚ã®å‡¦ç†
  function updateLocationNumber() {
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!locationSelect || !deviceCategorySelect) return;
    
    const selectedLocation = locationSelect.value;
    
    if (DEBUG_MODE) {
      showDebugInfo('æ‹ ç‚¹é¸æŠæ™‚ã®å‡¦ç†', { selectedLocation });
    }
    
    // å…¨ã¦ã®è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³
    const allDeviceCategoryOptions = [
      { value: 'SV', text: 'SVï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰' },
      { value: 'CL', text: 'CLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰' },
      { value: 'ãƒ—ãƒªãƒ³ã‚¿', text: 'ãƒ—ãƒªãƒ³ã‚¿' },
      { value: 'ãã®ä»–', text: 'ãã®ä»–' }
    ];
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã®é¸æŠè‚¢ã‚’æ›´æ–°
    deviceCategorySelect.innerHTML = '<option value="">è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    
    // æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã¨æ©Ÿç¨®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    const modelCategorySelect = document.getElementById('model-category');
    const modelSelect = document.getElementById('model-select');
    
    if (modelCategorySelect) {
      modelCategorySelect.innerHTML = '<option value="">ã¾ãšè©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      modelCategorySelect.disabled = true;
    }
    
    if (modelSelect) {
      modelSelect.innerHTML = '<option value="">ã¾ãšæ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      modelSelect.disabled = true;
    }
    
    // æ‹ ç‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€å…¨ã¦ã®è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’æœ‰åŠ¹åŒ–
    if (selectedLocation) {
      allDeviceCategoryOptions.forEach(function(option) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        deviceCategorySelect.appendChild(optionElement);
      });
      deviceCategorySelect.disabled = false;
      
      if (DEBUG_MODE) {
        showDebugInfo('è©³ç´°ã‚«ãƒ†ã‚´ãƒªé¸æŠè‚¢æ›´æ–°', { 
          selectedLocation, 
          options: allDeviceCategoryOptions 
        });
      }
    } else {
      deviceCategorySelect.disabled = true;
      
      if (DEBUG_MODE) {
        showDebugInfo('è©³ç´°ã‚«ãƒ†ã‚´ãƒªç„¡åŠ¹åŒ–', { selectedLocation });
      }
    }
    
    // å±æ€§ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–°
    updateAttributesForm();
    
    if (DEBUG_MODE) {
      showDebugInfo('æ‹ ç‚¹é¸æŠæ›´æ–°', { 
        selectedLocation,
        categoriesAvailable: allDeviceCategoryOptions.length
      });
    }
  }

  // æ—§æ‹ ç‚¹ç®¡ç†ç•ªå·é–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿ - å±æ€§å†…ã§å‡¦ç†
  

  // ========================================
  // ä»£æ›¿æ©Ÿå±æ€§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
  // ========================================
  function updateAttributesForm() {
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    const attributesContainer = document.getElementById('attributes-form');
    
    if (!locationSelect || !deviceCategorySelect || !attributesContainer) return;
    
    const location = locationSelect.value;
    const deviceCategory = deviceCategorySelect.value;
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ãåˆ¤å®š
    const isTerminal = deviceCategory === 'SV' || deviceCategory === 'CL';
    const isPrinter = deviceCategory === 'ãƒ—ãƒªãƒ³ã‚¿' || deviceCategory === 'ãã®ä»–';
    
    if (!location) {
      attributesContainer.innerHTML = `
        <div class="attributes-placeholder">
          <i class="fas fa-info-circle"></i>
          <p>æ‹ ç‚¹ã‚’é¸æŠã™ã‚‹ã¨ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
      `;
      return;
    }
    
    if (!deviceCategory) {
      attributesContainer.innerHTML = `
        <div class="attributes-placeholder">
          <i class="fas fa-info-circle"></i>
          <p>è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã™ã‚‹ã¨ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
      `;
      return;
    }
    
    let attributeFields = [];
    
    if (isTerminal) {
      attributeFields = [
        { name: 'assetNumber', label: 'è³‡ç”£ç®¡ç†ç•ªå·', type: 'text', required: true, placeholder: 'ä¾‹: AS001234' },
        { name: 'serial', label: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', type: 'text', required: true, placeholder: 'ä¾‹: ABC12345' },
        { name: 'software', label: 'ã‚½ãƒ•ãƒˆ', type: 'text', required: true, placeholder: 'ä¾‹: Recepty NEXT, MRN' },
        { name: 'os', label: 'OS', type: 'text', required: true, placeholder: 'ä¾‹: Windows 11' },
        { name: 'locationNumber', label: 'æ‹ ç‚¹ç®¡ç†ç•ªå·', type: 'special', required: true }
      ];
    } else if (isPrinter) {
      attributeFields = [
        { name: 'serial', label: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', type: 'text', required: true, placeholder: 'ä¾‹: XYZ98765' },
        { name: 'locationNumber', label: 'æ‹ ç‚¹ç®¡ç†ç•ªå·', type: 'special', required: true }
      ];
    }
    
    const deviceTypeDisplayName = isTerminal ? 'ç«¯æœ«' : 'ãƒ—ãƒªãƒ³ã‚¿ãƒ»ãã®ä»–';
    
    // å±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
    var attributeFieldsHtml = '';
    for (var i = 0; i < attributeFields.length; i++) {
      var field = attributeFields[i];
      if (field.type === 'select') {
        var optionsHtml = '';
        for (var j = 0; j < field.options.length; j++) {
          optionsHtml += '<option value="' + field.options[j] + '">' + field.options[j] + '</option>';
        }
        attributeFieldsHtml += `
          <div class="form-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <select id="attr-${field.name}" name="attributes[${field.name}]" ${field.required ? 'required' : ''}>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              ${optionsHtml}
            </select>
          </div>
        `;
      } else if (field.type === 'special' && field.name === 'locationNumber') {
        // æ‹ ç‚¹ç®¡ç†ç•ªå·ã®ç‰¹åˆ¥ãªå…¥åŠ›æ¬„
        attributeFieldsHtml += `
          <div class="form-group location-number-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <div class="attr-location-number-preview">
              <div id="attr-location-number-display" class="attr-location-number-display">
                ä¸Šè¨˜ã®é …ç›®ã‚’å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™
              </div>
              <div class="attr-location-number-input" id="attr-location-number-input" style="display: none;">
                <span id="attr-location-prefix-generated" class="attr-location-prefix-generated"></span>
                <input type="text" id="attr-location-suffix" name="attributes[locationNumberSuffix]" required
                       placeholder="001" maxlength="50" disabled onchange="updateAttributeLocationNumber()" oninput="updateFinalAttributeLocationNumber()">
              </div>
              <input type="hidden" id="attr-location-number" name="attributes[${field.name}]">
            </div>
            <small class="help-text">ã‚·ãƒªã‚¢ãƒ«ç•ªå·ã‚’å…¥åŠ›å¾Œã€æ‹ ç‚¹ç®¡ç†ç•ªå·ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚æœ€å¾Œã«å›ºæœ‰ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
          </div>
        `;
      } else {
        attributeFieldsHtml += `
          <div class="form-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <input type="${field.type}" 
                   id="attr-${field.name}" 
                   name="attributes[${field.name}]" 
                   placeholder="${field.placeholder}"
                   ${field.required ? 'required' : ''}
                   ${field.readonly ? 'readonly' : ''}
                   ${field.name === 'serial' ? 'onchange="updateAttributeLocationNumber()" oninput="updateAttributeLocationNumber()"' : ''}>
          </div>
        `;
      }
    }
    
    attributesContainer.innerHTML = `
      <div class="attributes-input-section">
        <h4><i class="fas fa-edit"></i> ä»£æ›¿æ©Ÿå±æ€§å…¥åŠ›ï¼ˆ${deviceTypeDisplayName}ï¼‰</h4>
        <div class="attributes-grid">
          ${attributeFieldsHtml}
        </div>
        <div class="attributes-note">
          <i class="fas fa-info-circle"></i>
          <span>ã“ã‚Œã‚‰ã®å±æ€§æƒ…å ±ãŒãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™</span>
        </div>
      </div>
    `;
    

    
    if (DEBUG_MODE) {
      showDebugInfo('å±æ€§ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°', { 
        deviceType,
        location, 
        deviceCategory, 
        isTerminal, 
        isPrinter, 
        attributeFields 
      });
    }
    
    // å±æ€§ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°å¾Œã€æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’æ›´æ–°
    setTimeout(() => {
      updateAttributeLocationNumber();
      
      // æ‹ ç‚¹ç®¡ç†ç•ªå·ã®suffixå…¥åŠ›æ¬„ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const attrLocationSuffixInput = document.getElementById('attr-location-suffix');
      if (attrLocationSuffixInput) {
        attrLocationSuffixInput.addEventListener('input', function() {
          updateFinalAttributeLocationNumber();
        });
      }
    }, 100);
  }

  // ä»£æ›¿æ©Ÿç¨®åˆ¥é¸æŠæ™‚ã®å‡¦ç†
  function updateDeviceCategory() {
    // æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã¨æ©Ÿç¨®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    const modelCategorySelect = document.getElementById('model-category');
    const modelSelect = document.getElementById('model-select');
    
    if (modelCategorySelect) {
      modelCategorySelect.innerHTML = '<option value="">ã¾ãšè©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      modelCategorySelect.disabled = true;
    }
    
    if (modelSelect) {
      modelSelect.innerHTML = '<option value="">ã¾ãšæ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      modelSelect.disabled = true;
    }
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ã„ã¦æ©Ÿç¨®ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã¿
    loadModelCategories();
    
    updateAttributesForm();
    
    if (DEBUG_MODE) {
      const deviceCategorySelect = document.getElementById('device-category');
      showDebugInfo('è©³ç´°ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´', { selectedCategory: deviceCategorySelect.value });
    }
  }

  // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸè³ªå•é …ç›®ã‚’ç”Ÿæˆ
  function getDeviceQuestions(location, deviceCategory, attributeData = {}) {
    console.log('getDeviceQuestions called with:', { location, deviceCategory, attributeData });
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ãåˆ¤å®š
    const isTerminal = deviceCategory === 'SV' || deviceCategory === 'CL';
    const isPrinter = deviceCategory === 'ãƒ—ãƒªãƒ³ã‚¿' || deviceCategory === 'ãã®ä»–';
    
    let questions = [];
    
    if (isTerminal) {
      questions = [
        { 
          type: 'TEXT', 
          title: 'è³‡ç”£ç®¡ç†ç•ªå·', 
          required: true,
          defaultValue: attributeData.assetNumber || ''
        },
        { 
          type: 'TEXT', 
          title: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', 
          required: true,
          defaultValue: attributeData.serial || ''
        },
        { 
          type: 'TEXT', 
          title: 'ã‚½ãƒ•ãƒˆ', 
          required: true,
          defaultValue: attributeData.software || ''
        },
        { 
          type: 'TEXT', 
          title: 'OS', 
          required: true,
          defaultValue: attributeData.os || ''
        },
        { 
          type: 'DROPDOWN', 
          title: 'ä»£æ›¿æ©Ÿç¨®åˆ¥', 
          required: true,
          options: ['SV', 'CL'],
          defaultValue: attributeData.deviceCategory || ''
        },
        { 
          type: 'TEXT', 
          title: 'æ‹ ç‚¹ç®¡ç†ç•ªå·', 
          required: true,
          defaultValue: attributeData.locationNumber || ''
        }
      ];
    } else if (isPrinter) {
      questions = [
        { 
          type: 'TEXT', 
          title: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', 
          required: true,
          defaultValue: attributeData.serial || ''
        },
        { 
          type: 'DROPDOWN', 
          title: 'ä»£æ›¿æ©Ÿç¨®åˆ¥', 
          required: true,
          options: ['ãƒ—ãƒªãƒ³ã‚¿', 'ãã®ä»–'],
          defaultValue: attributeData.deviceCategory || ''
        },
        { 
          type: 'TEXT', 
          title: 'æ‹ ç‚¹ç®¡ç†ç•ªå·', 
          required: true,
          defaultValue: attributeData.locationNumber || ''
        }
      ];
    }
    
    if (DEBUG_MODE) {
      showDebugInfo('è³ªå•é …ç›®ç”Ÿæˆ', { location, deviceCategory, attributeData, isTerminal, isPrinter, questions });
    }
    
    return questions;
  }

  // ========================================
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ï¼ˆç°¡ç´ åŒ–ï¼‰
  // ========================================

  function addQuestion() {
    const container = document.getElementById('questions-container');
    const newIndex = questionCount;
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.setAttribute('data-index', newIndex);
    
    questionDiv.innerHTML = `
      <div class="question-header">
        <span class="question-number">è³ªå• ${newIndex + 1}</span>
        <button type="button" class="btn-remove-question" onclick="removeQuestion(${newIndex})">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="question-config">
        <div class="form-row">
          <div class="form-group">
            <label>è³ªå•ã‚¿ã‚¤ãƒˆãƒ« <span class="required">*</span></label>
            <input type="text" name="questions[${newIndex}][title]" required
                   placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
          </div>
          
          <div class="form-group">
            <label>è³ªå•ã‚¿ã‚¤ãƒ—</label>
            <select name="questions[${newIndex}][type]" onchange="updateQuestionOptions(${newIndex})">
              <option value="TEXT">çŸ­ç­”å¼ãƒ†ã‚­ã‚¹ãƒˆ</option>
              <option value="PARAGRAPH">é•·ç­”å¼ãƒ†ã‚­ã‚¹ãƒˆ</option>
              <option value="MULTIPLE_CHOICE">ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³</option>
              <option value="CHECKBOX">ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹</option>
              <option value="DROPDOWN">ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³</option>
              <option value="SCALE">è©•ä¾¡ã‚¹ã‚±ãƒ¼ãƒ«</option>
              <option value="DATE">æ—¥ä»˜</option>
              <option value="TIME">æ™‚åˆ»</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <input type="checkbox" name="questions[${newIndex}][required]" value="true">
              å¿…é ˆé …ç›®ã«ã™ã‚‹
            </label>
          </div>
        </div>

        <div class="question-options" id="question-options-${newIndex}" style="display: none;">
          <label>é¸æŠè‚¢ï¼ˆ1è¡Œã«1ã¤ãšã¤å…¥åŠ›ï¼‰</label>
          <textarea name="questions[${newIndex}][options]" rows="4"
                    placeholder="é¸æŠè‚¢1&#10;é¸æŠè‚¢2&#10;é¸æŠè‚¢3"></textarea>
        </div>
      </div>
    `;
    
    container.appendChild(questionDiv);
    questionCount++;
    
    if (DEBUG_MODE) {
      showDebugInfo('è³ªå•ã‚’è¿½åŠ ', { newIndex });
    }
  }

  function removeQuestion(index) {
    const questionDiv = document.querySelector(`[data-index="${index}"]`);
    if (questionDiv) {
      questionDiv.remove();
      updateQuestionNumbers();
      
      if (DEBUG_MODE) {
        showDebugInfo('è³ªå•ã‚’å‰Šé™¤', { index });
      }
    }
  }

  function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.question-item');
    questions.forEach(function(question, index) {
      const numberSpan = question.querySelector('.question-number');
      if (numberSpan) {
        numberSpan.textContent = 'Q' + (index + 1);
      }
    });
  }

  function updateQuestionOptions(index) {
    const typeSelect = document.querySelector(`[name="questions[${index}][type]"]`);
    const optionsDiv = document.getElementById(`question-options-${index}`);
    
    if (typeSelect && optionsDiv) {
      const selectedType = typeSelect.value;
      const showOptions = ['MULTIPLE_CHOICE', 'CHECKBOX', 'DROPDOWN'].includes(selectedType);
      
      optionsDiv.style.display = showOptions ? 'block' : 'none';
      
      if (DEBUG_MODE) {
        showDebugInfo('è³ªå•ã‚¿ã‚¤ãƒ—å¤‰æ›´', { index, selectedType, showOptions });
      }
    }
  }

  function resetFormCreation() {
    const form = document.getElementById('googleFormCreationForm');
    if (!form) {
      console.warn('ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    try {
      form.reset();
      
      // è³ªå•é …ç›®ã‚’åˆæœŸåŒ–ï¼ˆæœ€åˆã®1ã¤ã ã‘æ®‹ã™ï¼‰
      const container = document.getElementById('questions-container');
      if (container) {
        const questions = container.querySelectorAll('.question-item');
        
        questions.forEach(function(question, index) {
          if (index > 0) {
            question.remove();
          }
        });
      }
      
      questionCount = 1;
      updateQuestionNumbers();
      
      // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼ˆå­˜åœ¨ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
      if (form && form.querySelectorAll) {
        form.querySelectorAll('.error').forEach(function(element) {
          element.classList.remove('error');
        });
      }
      
      if (DEBUG_MODE) {
        showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’ãƒªã‚»ãƒƒãƒˆ');
      }
      
      showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
    } catch (error) {
      console.error('resetFormCreation ã‚¨ãƒ©ãƒ¼:', error);
      showMessage('ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  }

  // ========================================
  // Google Formä½œæˆå‡¦ç†
  // ========================================
  function handleGoogleFormCreation(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    if (DEBUG_MODE) {
      showDebugInfo('Google Formä½œæˆé–‹å§‹', Array.from(formData.entries()));
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
    const locationNumber = formData.get('attributes[locationNumber]'); // å±æ€§ã‹ã‚‰å–å¾—
    const location = formData.get('location');
    const deviceCategory = formData.get('deviceCategory');
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ä»£æ›¿æ©Ÿç¨®åˆ¥ã‚’æ¨å®š
    const deviceType = (deviceCategory === 'SV' || deviceCategory === 'CL') ? 'terminal' : 'printer';
    
    // ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
    console.log('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
      deviceType: deviceType,
      deviceCategory: deviceCategory,
      locationNumber: locationNumber,
      location: location
    });
    
    // å±æ€§ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
    const attributeData = {};
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('attributes[')) {
        const match = key.match(/attributes\[(\w+)\]/);
        if (match) {
          const [, attrName] = match;
          attributeData[attrName] = value;
        }
      }
    }

    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦ä½¿ç”¨
    const formTitle = locationNumber; // æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«è¨­å®š
    
    const formConfig = {
      title: formTitle, // æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦ä½¿ç”¨
      description: `${getLocationDisplayName(location)} ä»£æ›¿æ©Ÿä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ `,
      deviceType: deviceType,
      locationNumber: locationNumber,
      location: location,
      deviceCategory: deviceCategory,
      attributes: attributeData,
      questions: getDeviceQuestions(location, deviceCategory, attributeData)
    };
    
    if (DEBUG_MODE) {
      showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ‡ãƒ¼ã‚¿', {
        deviceCategory: deviceCategory,
        targetSheet: getTargetSheetByCategory(deviceCategory),
        location: location,
        locationNumber: locationNumber
      });
    }
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ããƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆåˆ†å²ã®èª¬æ˜
    function getTargetSheetByCategory(category) {
      if (category === 'SV' || category === 'CL') {
        return 'ç«¯æœ«ãƒã‚¹ã‚¿';
      } else if (category === 'ãƒ—ãƒªãƒ³ã‚¿') {
        return 'ãƒ—ãƒªãƒ³ã‚¿ãƒã‚¹ã‚¿';
      } else if (category === 'ãã®ä»–') {
        return 'ãã®ä»–ãƒã‚¹ã‚¿';
      }
      return 'ç«¯æœ«ãƒã‚¹ã‚¿';
    }
    
    // è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
    const questionData = {};
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('questions[')) {
        const match = key.match(/questions\[(\d+)\]\[(\w+)\]/);
        if (match) {
          const [, index, field] = match;
          if (!questionData[index]) questionData[index] = {};
          
          if (field === 'options') {
            questionData[index][field] = value.split('\n').filter(opt => opt.trim());
          } else if (field === 'required') {
            questionData[index][field] = value === 'true';
          } else {
            questionData[index][field] = value;
          }
        }
      }
    }
    
    // è³ªå•é…åˆ—ã‚’ä½œæˆ
    Object.keys(questionData).forEach(function(index) {
      const question = questionData[index];
      if (question.title) {
        formConfig.questions.push(question);
      }
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª ===');
    console.log('formData entries:', Array.from(formData.entries()));
    console.log('ç”Ÿæˆã•ã‚ŒãŸformConfig:', formConfig);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateGoogleFormConfig(formConfig)) {
      console.error('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ä¸­æ­¢');
      return;
    }
    
    console.log('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é–‹å§‹');
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
    const submitButton = form.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    // Google Apps Scriptã«é€ä¿¡
    createGoogleFormAPI(formConfig)
      .then(function(result) {
        console.log('Google Apps Script result:', result);
        if (result.success) {
          console.log('result.data:', result.data);
          showFormCreationSuccess(result.data);
          // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆã¯resetFormCreationå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚é‡è¤‡å‘¼ã³å‡ºã—ã‚’é¿ã‘ã‚‹
          resetFormCreation();
          
          if (DEBUG_MODE) {
            showDebugInfo('Google Formä½œæˆæˆåŠŸ', result);
          }
        } else {
          throw new Error(result.error || 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(function(error) {
        showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        
        if (DEBUG_MODE) {
          showDebugInfo('Google Formä½œæˆã‚¨ãƒ©ãƒ¼', { error: error.message });
        }
      })
      .finally(function() {
        setButtonLoading(submitButton, false);
      });
  }

  function validateGoogleFormConfig(formConfig) {
    let isValid = true;
    let validationErrors = [];
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===');
    console.log('formConfig:', formConfig);
    
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
    if (!formConfig.title || formConfig.title.trim() === '') {
      validationErrors.push('æ‹ ç‚¹ç®¡ç†ç•ªå·ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ');
      isValid = false;
    } else {
      console.log('âœ“ ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ‹ ç‚¹ç®¡ç†ç•ªå·ã‹ã‚‰ç”Ÿæˆï¼‰:', formConfig.title);
    }
    
    if (!formConfig.locationNumber || formConfig.locationNumber.trim() === '') {
      validationErrors.push('æ‹ ç‚¹ç®¡ç†ç•ªå·ãŒæœªè¨­å®šã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ æ‹ ç‚¹ç®¡ç†ç•ªå·:', formConfig.locationNumber);
    }
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ã¿æ¤œè¨¼ï¼‰
    if (formConfig.locationNumber) {
      // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã§åˆ†å‰²
      const parts = formConfig.locationNumber.split('_');
      if (parts.length < 2) {
        validationErrors.push('æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯ã€Œãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹_ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šOsaka_001ï¼‰');
        console.log('âœ— æ‹ ç‚¹ç®¡ç†ç•ªå·ã®å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãªã—ï¼‰:', formConfig.locationNumber);
        isValid = false;
      } else {
        // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢å‰ã®éƒ¨åˆ†ï¼‰ã®ã¿æ¤œè¨¼
        const prefix = parts[0];
        const prefixPattern = /^[A-Za-z]+$/;
        
        if (!prefixPattern.test(prefix) || prefix.length < 2) {
          validationErrors.push('ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯2æ–‡å­—ä»¥ä¸Šã®è‹±å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šOsakaã€Himeï¼‰');
          console.log('âœ— ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®å½¢å¼ã‚¨ãƒ©ãƒ¼:', prefix);
          isValid = false;
        } else {
          console.log('âœ“ æ‹ ç‚¹ç®¡ç†ç•ªå·ã®å½¢å¼OK:', formConfig.locationNumber, 'ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹:', prefix, 'ï¼‰');
        }
      }
    }
    
    // åŸºæœ¬æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
    if (!formConfig.deviceType) {
      validationErrors.push('ä»£æ›¿æ©Ÿç¨®åˆ¥ãŒæœªé¸æŠã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ ä»£æ›¿æ©Ÿç¨®åˆ¥:', formConfig.deviceType);
    }
    
    if (!formConfig.location) {
      validationErrors.push('æ‹ ç‚¹ãŒæœªé¸æŠã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ æ‹ ç‚¹:', formConfig.location);
    }
    
    if (!formConfig.deviceCategory) {
      validationErrors.push('è©³ç´°ã‚«ãƒ†ã‚´ãƒªãŒæœªé¸æŠã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ è©³ç´°ã‚«ãƒ†ã‚´ãƒª:', formConfig.deviceCategory);
    }
    
    // è³ªå•ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!formConfig.questions || formConfig.questions.length === 0) {
      validationErrors.push('è³ªå•é …ç›®ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      isValid = false;
    } else {
      console.log('âœ“ è³ªå•é …ç›®æ•°:', formConfig.questions.length);
      formConfig.questions.forEach(function(question, index) {
        console.log('è³ªå•' + (index + 1) + ':', question);
      });
    }
    
    // å±æ€§ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
    if (formConfig.attributes) {
      console.log('âœ“ å±æ€§ãƒ‡ãƒ¼ã‚¿:', formConfig.attributes);
      
      // ç«¯æœ«ã®å ´åˆã®å¿…é ˆå±æ€§ãƒã‚§ãƒƒã‚¯
      if (formConfig.deviceType === 'terminal') {
        const requiredTerminalAttrs = ['assetNumber', 'serial', 'software', 'os'];
        requiredTerminalAttrs.forEach(function(attr) {
          if (!formConfig.attributes[attr] || formConfig.attributes[attr].trim() === '') {
            validationErrors.push('ç«¯æœ«ã®å¿…é ˆå±æ€§ã€Œ' + attr + 'ã€ãŒæœªå…¥åŠ›ã§ã™');
            isValid = false;
          }
        });
      }
      
      // ãƒ—ãƒªãƒ³ã‚¿ã®å ´åˆã®å¿…é ˆå±æ€§ãƒã‚§ãƒƒã‚¯
      if (formConfig.deviceType === 'printer') {
        const requiredPrinterAttrs = ['serial'];
        requiredPrinterAttrs.forEach(function(attr) {
          if (!formConfig.attributes[attr] || formConfig.attributes[attr].trim() === '') {
            validationErrors.push('ãƒ—ãƒªãƒ³ã‚¿ã®å¿…é ˆå±æ€§ã€Œ' + attr + 'ã€ãŒæœªå…¥åŠ›ã§ã™');
            isValid = false;
          }
        });
      }
    } else {
      validationErrors.push('å±æ€§ãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      isValid = false;
    }
    
    console.log('=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ ===');
    console.log('isValid:', isValid);
    if (validationErrors.length > 0) {
      console.log('ã‚¨ãƒ©ãƒ¼ä¸€è¦§:', validationErrors);
    }
    
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    if (!isValid) {
      showValidationErrors(validationErrors);
    }
    
    return isValid;
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è©³ç´°è¡¨ç¤º
  function showValidationErrors(errors) {
    var errorMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n';
    for (var i = 0; i < errors.length; i++) {
      errorMessage += 'â€¢ ' + errors[i] + '\n';
    }
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
    console.error('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', errors);
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆã§è©³ç´°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    alert(errorMessage);
    
    // é€šå¸¸ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¡¨ç¤º
    showMessage('å…¥åŠ›å†…å®¹ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ï¼ˆè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'error');
  }

  function showFormCreationSuccess(formData) {
    // ãƒ‡ãƒãƒƒã‚°ç”¨: formDataã®å†…å®¹ã‚’ç¢ºèª
    console.log('showFormCreationSuccess - formData:', formData);
    
    // ã‚¿ã‚¤ãƒˆãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    var title = formData.title || formData.name || 'ãƒ•ã‚©ãƒ¼ãƒ ';
    console.log('ä½¿ç”¨ã™ã‚‹ã‚¿ã‚¤ãƒˆãƒ«:', title);
    
    // QRã‚³ãƒ¼ãƒ‰ç”»åƒã®è¡¨ç¤ºéƒ¨åˆ†ã‚’æ§‹ç¯‰
    let qrCodeSection = '';
    
    // ãƒ‡ãƒãƒƒã‚°: QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›
    console.log('QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
      qrCodeExists: !!formData.qrCode,
      qrCodeSuccess: formData.qrCode ? formData.qrCode.success : 'undefined',
      publicImageUrl: formData.qrCode ? formData.qrCode.publicImageUrl : 'undefined',
      fullQrCodeData: formData.qrCode
    });
    
    if (formData.qrCode && formData.qrCode.success) {
      // Base64ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆã—ã¦ä½¿ç”¨ï¼ˆCORSåˆ¶é™å›é¿ï¼‰
      let primaryImageSrc = '';
      let fallbackSrcs = [];
      
      if (formData.qrCode.base64ImageData) {
        primaryImageSrc = formData.qrCode.base64ImageData;
        console.log('Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
      } else if (formData.qrCode.publicImageUrl) {
        primaryImageSrc = formData.qrCode.publicImageUrl;
        if (formData.qrCode.thumbnailUrl) {
          fallbackSrcs.push(formData.qrCode.thumbnailUrl);
        }
      }
      
      console.log('QRã‚³ãƒ¼ãƒ‰ç”»åƒURL:', {
        primary: primaryImageSrc ? 'Base64ãƒ‡ãƒ¼ã‚¿' : primaryImageSrc,
        hasBase64: !!formData.qrCode.base64ImageData,
        publicUrl: formData.qrCode.publicImageUrl,
        thumbnailUrl: formData.qrCode.thumbnailUrl,
        fallbacks: fallbackSrcs
      });
      
      if (primaryImageSrc) {
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®JavaScriptã‚’æ§‹ç¯‰
        let onErrorHandler = 'this.onerror=null; ';
        fallbackSrcs.forEach((url, index) => {
          onErrorHandler += `if(!this.dataset.tried${index}) { this.dataset.tried${index}='true'; this.src='${url}'; return; } `;
        });
        onErrorHandler += `this.style.display='none'; document.getElementById('qr-error-msg').style.display='block';`;
        
        qrCodeSection = 
          '<div class="qr-code-section">' +
            '<h4><i class="fas fa-qrcode"></i> QRã‚³ãƒ¼ãƒ‰</h4>' +
            '<div class="qr-code-container">' +
              '<img src="' + primaryImageSrc + '" alt="QRã‚³ãƒ¼ãƒ‰" class="qr-code-image" ' +
              'onerror="' + onErrorHandler + '" />' +
              '<div id="qr-error-msg" style="display:none; color: #dc2626; margin-top: 10px;">' +
                '<p>âš ï¸ QRã‚³ãƒ¼ãƒ‰ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>' +
                '<p>ãƒ•ã‚¡ã‚¤ãƒ«ID: ' + (formData.qrCode.fileId || 'ãªã—') + '</p>' +
                (formData.qrCode.publicImageUrl ? 
                  '<p><a href="' + formData.qrCode.publicImageUrl + '" target="_blank" style="color: #3b82f6;">ç›´æ¥ãƒªãƒ³ã‚¯ã§ç¢ºèª</a></p>' : '') +
              '</div>' +
              '<p class="qr-code-note">ğŸ“± <strong>èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™</strong></p>' +
              '<p class="qr-code-instruction">ä¸Šè¨˜QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§èª­ã¿å–ã£ã¦ã€ãƒªãƒ³ã‚¯å…ˆã®å…±é€šãƒ•ã‚©ãƒ¼ãƒ ã‚ˆã‚Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</p>' +
            '</div>' +
          '</div>';
      } else {
        qrCodeSection = 
          '<div class="qr-code-section error">' +
            '<h4><i class="fas fa-exclamation-triangle"></i> QRã‚³ãƒ¼ãƒ‰ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—</h4>' +
            '<p>QRã‚³ãƒ¼ãƒ‰ç”»åƒã®URLã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>' +
          '</div>';
      }
    } else {
      // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¤±æ•—æ™‚ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
      const errorDetails = formData.qrCode ? 
        `æˆåŠŸãƒ•ãƒ©ã‚°: ${formData.qrCode.success}, URL: ${formData.qrCode.publicImageUrl || 'ãªã—'}` :
        'QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
        
      qrCodeSection = 
        '<div class="qr-code-section error">' +
          '<h4><i class="fas fa-exclamation-triangle"></i> QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼</h4>' +
          '<p>QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã¯æ­£å¸¸ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚</p>' +
          '<details style="margin-top: 10px;">' +
            '<summary style="cursor: pointer; color: #6b7280;">è©³ç´°æƒ…å ±</summary>' +
            '<p style="font-family: monospace; font-size: 0.8rem; color: #6b7280; margin-top: 5px;">' + errorDetails + '</p>' +
          '</details>' +
        '</div>';
    }
    
    // æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    const successHtml = 
      '<div class="form-success-dialog">' +
        '<div class="success-content">' +
          '<h3><i class="fas fa-check-circle"></i> ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†</h3>' +
          '<p><strong>' + title + '</strong> ã‚’æ­£å¸¸ã«ä½œæˆã—ã¾ã—ãŸã€‚</p>' +
          
          '<div class="form-links">' +
            '<div class="link-item">' +
              '<label>å…¬é–‹URLï¼ˆå›ç­”ç”¨ï¼‰:</label>' +
              '<div class="url-display">' +
                '<input type="text" value="' + formData.publicUrl + '" readonly>' +
                '<button onclick="copyToClipboard(\'' + formData.publicUrl + '\')">' +
                  '<i class="fas fa-copy"></i>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          
          qrCodeSection +
          
          '<div class="dialog-actions">' +
            '<button class="btn btn-secondary" onclick="closeSuccessDialog()">' +
              'é–‰ã˜ã‚‹' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    const dialogDiv = document.createElement('div');
    dialogDiv.className = 'success-dialog-overlay';
    dialogDiv.innerHTML = successHtml;
    
    // HTMLãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    console.log('ç”Ÿæˆã•ã‚ŒãŸHTML:', successHtml.substring(0, 200));
    
    document.body.appendChild(dialogDiv);
  }

  // ========================================
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================
  function validateForm(form, formType) {
    let isValid = true;
    
    // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å­˜åœ¨ç¢ºèª
    if (!form || !form.querySelectorAll) {
      console.error('validateForm: ç„¡åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ', form);
      return false;
    }
    
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
      field.classList.remove('error');
      
      if (!field.value.trim()) {
        field.classList.add('error');
        isValid = false;
      }
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—åˆ¥ã®è¿½åŠ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (formType === 'terminal') {
      isValid &= validateTerminalForm(form);
    } else if (formType === 'printer') {
      isValid &= validatePrinterForm(form);
    }
    
    return isValid;
  }
  
  function validateTerminalForm(form) {
    let isValid = true;
    
    // è³‡ç”£ç®¡ç†ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    const assetNumber = form.querySelector('[name="assetNumber"]');
    if (assetNumber && assetNumber.value) {
      const assetPattern = /^[A-Z]{2,4}-\d{6}$/;
      if (!assetPattern.test(assetNumber.value)) {
        assetNumber.classList.add('error');
        isValid = false;
      }
    }
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯çµ±ä¸€æ¤œè¨¼é–¢æ•°ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã“ã“ã§ã¯å‰Šé™¤
    
    return isValid;
  }
  
  function validatePrinterForm(form) {
    let isValid = true;
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯çµ±ä¸€æ¤œè¨¼é–¢æ•°ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã“ã“ã§ã¯å‰Šé™¤
    
    return isValid;
  }

  // ========================================
  // Google Apps Scriptã¨ã®é€šä¿¡
  // ========================================
  function createGoogleFormAPI(formConfig) {
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .createGoogleForm(formConfig);
      } catch (error) {
        // Google Apps Scriptç’°å¢ƒã§ãªã„å ´åˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
        if (DEBUG_MODE) {
          setTimeout(function() {
            resolve({ 
              success: true, 
              message: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ',
              data: {
                formId: 'test-form-id',
                title: formConfig.title,
                editUrl: 'https://docs.google.com/forms/d/test-form-id/edit',
                publicUrl: 'https://docs.google.com/forms/d/test-form-id/viewform',
                responseSheetId: 'test-sheet-id',
                responseSheetUrl: 'https://docs.google.com/spreadsheets/d/test-sheet-id',
                locationNumber: formConfig.locationNumber,
                qrCode: {
                  success: true,
                  publicImageUrl: 'https://via.placeholder.com/200x200/0ea5e9/ffffff?text=TEST+QR',
                  thumbnailUrl: 'https://via.placeholder.com/400x400/0ea5e9/ffffff?text=TEST+QR+THUMB',
                  base64ImageData: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP8/5+hnoEIwDiqkL4KAcT9GO0U4BxoAAAAAElFTkSuQmCC',
                  fileName: 'qr_test_001.png',
                  fileId: 'test-file-id',
                  qrCodeUrl: 'https://docs.google.com/forms/d/test-form-id/viewform'
                }
              }
            });
          }, 1000);
        } else {
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™'));
        }
      }
    });
  }

  function loadFormsList() {
    const loadingIndicator = document.getElementById('forms-loading');
    const formsList = document.getElementById('forms-list');
    
    loadingIndicator.style.display = 'block';
    
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            displayFormsList(result);
            resolve(result);
          })
          .withFailureHandler(function(error) {
            showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            reject(error);
          })
          .getCreatedFormsList();
      } catch (error) {
        // Google Apps Scriptç’°å¢ƒã§ãªã„å ´åˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
        if (DEBUG_MODE) {
          setTimeout(function() {
            const testResult = {
              success: true,
              forms: [
                {
                  id: 'test-form-1',
                  title: 'ãƒ†ã‚¹ãƒˆ ãƒ•ã‚©ãƒ¼ãƒ  1',
                  description: 'ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã™',
                  editUrl: 'https://docs.google.com/forms/d/test-form-1/edit',
                  publicUrl: 'https://docs.google.com/forms/d/test-form-1/viewform',
                  createdDate: new Date(),
                  responseCount: 5
                }
              ],
              totalCount: 1
            };
            displayFormsList(testResult);
            resolve(testResult);
          }, 1000);
        } else {
          showMessage('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™', 'error');
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™'));
        }
      }
    }).finally(function() {
      loadingIndicator.style.display = 'none';
    });
  }

  function displayFormsList(result) {
    const formsList = document.getElementById('forms-list');
    
    if (!result.success || !result.forms || result.forms.length === 0) {
      formsList.innerHTML = 
        '<div class="no-forms">' +
          '<i class="fas fa-inbox"></i>' +
          '<p>ä½œæˆæ¸ˆã¿ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>' +
        '</div>';
      return;
    }
    
    var formsHtml = '';
    for (var i = 0; i < result.forms.length; i++) {
      var form = result.forms[i];
      formsHtml += 
        '<div class="form-item">' +
          '<div class="form-info">' +
            '<h4>' + form.title + '</h4>' +
            '<p>' + (form.description || 'èª¬æ˜ãªã—') + '</p>' +
            '<div class="form-meta">' +
              '<span><i class="fas fa-calendar"></i> ' + new Date(form.createdDate).toLocaleDateString() + '</span>' +
              '<span><i class="fas fa-chart-bar"></i> å›ç­”: ' + form.responseCount + 'ä»¶</span>' +
            '</div>' +
          '</div>' +
          '<div class="form-actions">' +
            '<button class="btn btn-sm btn-primary" onclick="window.open(\'' + form.editUrl + '\', \'_blank\')">' +
              '<i class="fas fa-edit"></i> ç·¨é›†' +
            '</button>' +
            '<button class="btn btn-sm btn-secondary" onclick="window.open(\'' + form.publicUrl + '\', \'_blank\')">' +
              '<i class="fas fa-external-link-alt"></i> è¡¨ç¤º' +
            '</button>' +
            '<button class="btn btn-sm btn-danger" onclick="deleteForm(\'' + form.id + '\', \'' + form.title + '\')">' +
              '<i class="fas fa-trash"></i> å‰Šé™¤' +
            '</button>' +
          '</div>' +
        '</div>';
    }
    
    formsList.innerHTML = formsHtml;
  }

  function deleteForm(formId, formTitle) {
    if (!confirm('ãƒ•ã‚©ãƒ¼ãƒ ã€Œ' + formTitle + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
      return;
    }
    
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
              loadFormsList(); // ä¸€è¦§ã‚’æ›´æ–°
            } else {
              showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'error');
            }
            resolve(result);
          })
          .withFailureHandler(function(error) {
            showMessage('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            reject(error);
          })
          .deleteGoogleForm(formId);
      } catch (error) {
        if (DEBUG_MODE) {
          setTimeout(function() {
            showMessage('ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            loadFormsList();
            resolve({ success: true });
          }, 500);
        } else {
          showMessage('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™', 'error');
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™'));
        }
      }
    });
  }

  // ========================================
  // UI ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  // ========================================
  function setButtonLoading(button, isLoading) {
    if (!button) return;
    
    if (isLoading) {
      button.classList.add('loading');
      button.disabled = true;
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-spinner';
      }
    } else {
      button.classList.remove('loading');
      button.disabled = false;
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-save';
      }
    }
  }
  
  function showMessage(message, type) {
    try {
      // DOM ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof document === 'undefined' || !document || !document.body) {
        console.log('showMessage: DOMæœªå¯¾å¿œç’°å¢ƒ', { message, type });
        return;
      }
      
      // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      try {
        const existingMessages = document.querySelectorAll('.success-message, .error-message');
        if (existingMessages && existingMessages.length > 0) {
          existingMessages.forEach(function(msg) {
            if (msg && msg.remove) {
              msg.remove();
            }
          });
        }
      } catch (queryError) {
        console.log('showMessage: æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼', queryError);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
      }
      
      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      const messageDiv = document.createElement('div');
      if (!messageDiv) {
        console.error('showMessage: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã®ä½œæˆã«å¤±æ•—');
        return;
      }
      
      messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
      var iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (type === 'error') {
        messageDiv.innerHTML = 
          '<div class="message-content">' +
            '<i class="fas ' + iconClass + '"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button class="message-close-btn" onclick="this.parentElement.remove()">' +
            'Ã—' +
          '</button>';
      } else {
        messageDiv.innerHTML = 
          '<i class="fas ' + iconClass + '"></i>' +
          '<span>' + message + '</span>';
      }
      
      if (document.body) {
        document.body.appendChild(messageDiv);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è‡ªå‹•å‰Šé™¤ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ‰‹å‹•å‰Šé™¤ï¼‰
        if (type === 'success') {
          setTimeout(function() {
            if (messageDiv && messageDiv.parentNode) {
              messageDiv.remove();
            }
          }, 3000);
        }
      }
      
    } catch (error) {
      console.error('showMessage ã‚¨ãƒ©ãƒ¼:', error, { message, type });
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('[' + type.toUpperCase() + '] ' + message);
    }
  }

  // ========================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // ========================================
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
      showMessage('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    }).catch(function(err) {
      showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  }

  function closeSuccessDialog() {
    const dialog = document.querySelector('.success-dialog-overlay');
    if (dialog) {
      dialog.remove();
    }
  }

  // ========================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    // Google Formä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    const googleFormCreationForm = document.getElementById('googleFormCreationForm');
    if (googleFormCreationForm) {
      googleFormCreationForm.addEventListener('submit', handleGoogleFormCreation);
    }
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·suffixå…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const locationSuffixInput = document.getElementById('location-suffix');
    if (locationSuffixInput) {
      locationSuffixInput.addEventListener('input', function() {
        // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯å±æ€§å†…ã§å‡¦ç†
      });
    }
    
    // åˆæœŸã®è³ªå•ã‚¿ã‚¤ãƒ—å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    updateQuestionOptions(0);
    
    if (DEBUG_MODE) {
      showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†', {});
    }
  });

  // ========================================
  // å±æ€§å†…ã§ã®æ‹ ç‚¹ç®¡ç†ç•ªå·ç”Ÿæˆæ©Ÿèƒ½
  // ========================================
  
  function updateAttributeLocationNumber() {
    console.log('updateAttributeLocationNumber called');
    
    const attrLocationNumberDisplay = document.getElementById('attr-location-number-display');
    const attrLocationNumberInputContainer = document.getElementById('attr-location-number-input');
    const attrLocationPrefixGenerated = document.getElementById('attr-location-prefix-generated');
    const attrLocationSuffixInput = document.getElementById('attr-location-suffix');
    const attrLocationNumberHidden = document.getElementById('attr-location-number');
    
    if (!attrLocationNumberDisplay || !attrLocationNumberInputContainer) {
      console.log('å±æ€§æ‹ ç‚¹ç®¡ç†ç•ªå·è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // å¿…è¦ãªæƒ…å ±ã‚’å–å¾—
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    const modelSelect = document.getElementById('model-select');
    const serialInput = document.getElementById('attr-serial');
    
    const location = locationSelect ? locationSelect.value : '';
    const deviceCategory = deviceCategorySelect ? deviceCategorySelect.value : '';
    const serialNumber = serialInput ? serialInput.value.trim() : '';
    
    console.log('å±æ€§æ‹ ç‚¹ç®¡ç†ç•ªå·ç”Ÿæˆãƒ‡ãƒ¼ã‚¿:', {
      location,
      deviceCategory,
      serialNumber
    });
    
    // æ‹ ç‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆæ‹ ç‚¹ãƒã‚¹ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
    const locationPrefix = getLocationPrefix(location);
    console.log('å–å¾—ã—ãŸæ‹ ç‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹:', locationPrefix, 'for location:', location);
    
    const categoryMapping = {
      'SV': 'SV',
      'CL': 'CL', 
      'ãƒ—ãƒªãƒ³ã‚¿': 'Printer',
      'ãã®ä»–': 'Other'
    };
    
    // æ©Ÿç¨®æƒ…å ±ã‚’å–å¾—
    let modelInfo = '';
    if (modelSelect && modelSelect.value) {
      try {
        const modelData = JSON.parse(modelSelect.value);
        let modelName = modelData.modelName || '';
        
        // æ©Ÿç¨®åã®æ—¥æœ¬èªâ†’è‹±èªå¤‰æ›
        const modelNameMapping = {
          'ã‚µãƒ¼ãƒãƒ¼': 'Server',
          'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—': 'Desktop', 
          'ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³': 'Laptop',
          'ãƒãƒ¼ãƒˆPC': 'Laptop',
          'ãƒ—ãƒªãƒ³ã‚¿': 'Printer',
          'è¤‡åˆæ©Ÿ': 'MFP',
          'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ': 'Tablet',
          'ãƒ¢ãƒ‹ã‚¿ãƒ¼': 'Monitor',
          'ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤': 'Display'
        };
        
        Object.keys(modelNameMapping).forEach(function(japanese) {
          const regex = new RegExp(japanese, 'gi');
          modelName = modelName.replace(regex, modelNameMapping[japanese]);
        });
        
        modelInfo = modelName.length > 10 ? modelName.substring(0, 10) : modelName;
        modelInfo = modelInfo.replace(/[\s\-ãƒ¼]/g, '_');
        
      } catch (error) {
        console.error('æ©Ÿç¨®ãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
    let previewText = '';
    let isComplete = false;
    
    console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã®æ¡ä»¶ç¢ºèª:', {
      location: !!location,
      deviceCategory: !!deviceCategory,
      modelInfo: !!modelInfo,
      serialNumber: !!serialNumber,
      locationPrefix: locationPrefix
    });
    
    if (!location) {
      previewText = 'æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„';
    } else if (!deviceCategory) {
      previewText = `${locationPrefix}_[Category]_[Model]_[Serial]_[Number]`;
    } else if (!modelInfo) {
      const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
      previewText = `${locationPrefix}_${englishCategory}_[Model]_[Serial]_[Number]`;
    } else if (!serialNumber) {
      const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
      previewText = `${locationPrefix}_${englishCategory}_${modelInfo}_[Serial]_[Number]`;
    } else {
      const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
      previewText = `${locationPrefix}_${englishCategory}_${modelInfo}_${serialNumber}_[Number]`;
      isComplete = true;
    }
    
    console.log('ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ:', previewText);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
    attrLocationNumberDisplay.textContent = previewText;
    if (isComplete) {
      attrLocationNumberDisplay.classList.add('has-content');
    } else {
      attrLocationNumberDisplay.classList.remove('has-content');
    }
    
    // å…¥åŠ›æ¬„ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    if (isComplete && attrLocationNumberInputContainer) {
      attrLocationNumberInputContainer.style.display = 'flex';
      
      // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹éƒ¨åˆ†ã‚’è¨­å®š
      if (attrLocationPrefixGenerated) {
        const englishCategory = categoryMapping[deviceCategory] || deviceCategory;
        attrLocationPrefixGenerated.textContent = `${locationPrefix}_${englishCategory}_${modelInfo}_${serialNumber}_`;
      }
      
      // å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–
      if (attrLocationSuffixInput) {
        attrLocationSuffixInput.disabled = false;
        attrLocationSuffixInput.placeholder = '001';
        
        console.log('å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ:', {
          disabled: attrLocationSuffixInput.disabled,
          placeholder: attrLocationSuffixInput.placeholder,
          type: attrLocationSuffixInput.type
        });
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
        if (!attrLocationSuffixInput.value) {
          attrLocationSuffixInput.value = '001';
        }
        
        console.log('å…¥åŠ›æ¬„ã®æœ€çµ‚çŠ¶æ…‹:', {
          value: attrLocationSuffixInput.value,
          readOnly: attrLocationSuffixInput.readOnly,
          style: attrLocationSuffixInput.style.cssText
        });
        
        // æœ€çµ‚çš„ãªæ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’ç”Ÿæˆ
        updateFinalAttributeLocationNumber();
      } else {
        console.error('å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      }
    } else {
      if (attrLocationNumberInputContainer) {
        attrLocationNumberInputContainer.style.display = 'none';
      }
      if (attrLocationSuffixInput) {
        attrLocationSuffixInput.disabled = true;
        attrLocationSuffixInput.value = '';
      }
      if (attrLocationNumberHidden) {
        attrLocationNumberHidden.value = '';
      }
    }
  }
  
  function updateFinalAttributeLocationNumber() {
    const attrLocationPrefixGenerated = document.getElementById('attr-location-prefix-generated');
    const attrLocationSuffixInput = document.getElementById('attr-location-suffix');
    const attrLocationNumberHidden = document.getElementById('attr-location-number');
    
    if (attrLocationPrefixGenerated && attrLocationSuffixInput && attrLocationNumberHidden) {
      const prefix = attrLocationPrefixGenerated.textContent || '';
      const suffix = attrLocationSuffixInput.value || '';
      const finalLocationNumber = prefix + suffix;
      
      attrLocationNumberHidden.value = finalLocationNumber;
      
      console.log('æœ€çµ‚æ‹ ç‚¹ç®¡ç†ç•ªå·ï¼ˆå±æ€§ï¼‰:', finalLocationNumber);
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’å…¬é–‹
  window.initializeLocationOptions = initializeLocationOptions;
  window.updateLocationNumber = updateLocationNumber;
  window.updateDeviceCategory = updateDeviceCategory;
  window.switchFormCreationMode = switchFormCreationMode;
  window.deleteForm = deleteForm;
  window.closeSuccessDialog = closeSuccessDialog;
  window.copyToClipboard = copyToClipboard;
  window.updateAttributeLocationNumber = updateAttributeLocationNumber;
  window.updateFinalAttributeLocationNumber = updateFinalAttributeLocationNumber;
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿
  // ã‚¿ã‚¤ãƒˆãƒ«ã¯æ‹ ç‚¹ç®¡ç†ç•ªå·ã‹ã‚‰è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™

</script> 