<!-- url-generator-functions.html - URL生成ページの機能 -->
<script>
  // ========================================
  // ページ初期化
  // ========================================
  function onUrlGeneratorPageShow() {
    console.log('URL生成ページ初期化開始');
    console.log('onUrlGeneratorPageShow関数が呼び出されました');
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('URL生成ページ初期化開始', {});
    }
    
    // 共通フォームURL設定の確認
    console.log('共通フォームURL設定の確認を開始');
    checkCommonFormSettings();
    
    // 拠点一覧の読み込み
    console.log('拠点一覧の読み込みを開始');
    loadLocations();
    
    // カテゴリ一覧の読み込み
    console.log('カテゴリ一覧の読み込みを開始');
    loadCategories();
    
    // 拠点データ読み込みのフォールバック（5秒後）
    setTimeout(function() {
      const locationSelect = document.getElementById('location');
      if (locationSelect && locationSelect.options.length <= 1) {
        console.warn('拠点データが読み込まれていません。手動で追加します。');
        addStaticLocations();
      }
      
      // 初期化時に拠点管理番号の更新を試行
      setTimeout(function() {
        updateLocationNumber();
      }, 1000);
    }, 5000);
    
    // デバッグ：ページ要素の存在確認
    const locationElement = document.getElementById('location');
    console.log('拠点選択要素の存在:', locationElement ? '存在する' : '存在しない');
    if (locationElement) {
      console.log('拠点選択要素の初期状態:', {
        tagName: locationElement.tagName,
        id: locationElement.id,
        childrenCount: locationElement.children.length,
        disabled: locationElement.disabled
      });
    }
  }

  // ========================================
  // 共通フォーム設定確認
  // ========================================
  function checkCommonFormSettings() {
    console.log('共通フォーム設定確認開始');
    
    google.script.run
      .withSuccessHandler(function(settings) {
        console.log('共通フォーム設定取得成功:', settings);
        updateSettingsStatus(settings);
      })
      .withFailureHandler(function(error) {
        console.error('共通フォーム設定取得エラー:', error);
        showErrorMessage('共通フォーム設定の確認に失敗しました: ' + error.message);
      })
      .getCommonFormsSettings();
  }

  // ========================================
  // 設定状況の表示更新
  // ========================================
  function updateSettingsStatus(settings) {
    const hasTerminalUrl = !!(settings.terminalCommonFormUrl);
    const hasPrinterUrl = !!(settings.printerCommonFormUrl);
    
    console.log('設定状況:', { hasTerminalUrl, hasPrinterUrl });
    
    // 設定状況を保存（カテゴリ選択時に使用）
    window.commonFormSettings = {
      terminal: hasTerminalUrl,
      printer: hasPrinterUrl,
      terminalUrl: settings.terminalCommonFormUrl,
      printerUrl: settings.printerCommonFormUrl
    };
    
    if (!hasTerminalUrl && !hasPrinterUrl) {
      showErrorMessage('共通フォームURLが設定されていません。設定画面で設定してください。');
      disableForm();
    }
  }

  // ========================================
  // カテゴリ選択時の情報表示
  // ========================================
  function updateCategoryInfo() {
    const categorySelect = document.getElementById('deviceCategory');
    const categoryInfo = document.getElementById('categoryInfo');
    const formTypeText = document.getElementById('formTypeText');
    const masterTypeText = document.getElementById('masterTypeText');
    const urlStatusText = document.getElementById('urlStatusText');
    const categoryHelp = document.getElementById('categoryHelp');
    const assetNumberGroup = document.getElementById('assetNumberGroup');
    const assetNumberInput = document.getElementById('assetNumber');
    
    if (!categorySelect.value) {
      categoryInfo.style.display = 'none';
      categoryHelp.textContent = '選択したカテゴリに応じた共通フォームURLが使用されます';
      assetNumberGroup.style.display = 'none';
      return;
    }
    
    const category = categorySelect.value;
    let formType, masterType, hasUrl;
    let isTerminal = false;
    
    // カテゴリをマスタタイプにマッピング（英語カテゴリベース）
    if (category === 'desktop' || category === 'laptop' || category === 'server') {
      formType = '端末用共通フォーム';
      masterType = '端末マスタ';
      hasUrl = window.commonFormSettings?.terminal || false;
      isTerminal = true;
    } else if (category === 'printer') {
      formType = 'プリンタ・その他用共通フォーム';
      masterType = 'プリンタマスタ';
      hasUrl = window.commonFormSettings?.printer || false;
    } else {
      // その他のカテゴリ
      formType = 'プリンタ・その他用共通フォーム';
      masterType = 'その他マスタ';
      hasUrl = window.commonFormSettings?.printer || false;
    }
    
    // 資産管理番号フィールドの表示制御
    if (isTerminal) {
      assetNumberGroup.style.display = 'block';
      assetNumberInput.setAttribute('required', 'required');
    } else {
      assetNumberGroup.style.display = 'none';
      assetNumberInput.removeAttribute('required');
      assetNumberInput.value = ''; // 非表示時は値をクリア
    }
    
    formTypeText.textContent = formType;
    masterTypeText.textContent = masterType;
    urlStatusText.textContent = hasUrl ? '✅ 設定済み' : '❌ 未設定';
    urlStatusText.className = hasUrl ? 'status-ok' : 'status-error';
    
    categoryHelp.textContent = hasUrl 
      ? `${formType}を使用してURLを生成します`
      : `⚠️ ${formType}のURLが未設定です`;
    
    categoryInfo.style.display = 'block';
  }

  // ========================================
  // 拠点一覧の読み込み
  // ========================================
  function loadLocations() {
    console.log('========================================');
    console.log('loadLocations関数開始');
    console.log('========================================');
    console.log('拠点一覧の読み込み開始');
    
    // デバッグ用: 拠点選択要素の存在確認
    // onchange="updateLocationNumber()"を持つ正しい要素を探す
    let locationSelect = document.querySelector('select#location[onchange="updateLocationNumber()"]');
    
    if (!locationSelect) {
      // 属性なしで再度検索
      locationSelect = document.getElementById('location');
      if (locationSelect && locationSelect.tagName === 'SELECT') {
        console.log('location要素は見つかったが、onchange属性が異なる:', locationSelect.getAttribute('onchange'));
      }
    }
    
    console.log('location要素の検索結果:', locationSelect);
    
    if (!locationSelect) {
      console.error('拠点選択要素が見つかりません');
      console.error('現在のDOM構造を確認してください');
      
      // 全てのselect要素を探してみる
      const allSelects = document.querySelectorAll('select');
      console.log('ページ内の全select要素数:', allSelects.length);
      allSelects.forEach((select, index) => {
        console.log(`select[${index}]:`, {
          id: select.id,
          name: select.name,
          onchange: select.getAttribute('onchange'),
          className: select.className,
          parent: select.parentElement.tagName
        });
      });
      
      showErrorMessage('拠点選択要素が見つかりません');
      return;
    }
    
    // 読み込み中の表示
    locationSelect.innerHTML = '<option value="">読み込み中...</option>';
    locationSelect.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(locations) {
        console.log('拠点一覧取得成功:', locations);
        console.log('データ型:', typeof locations);
        console.log('配列かどうか:', Array.isArray(locations));
        console.log('データ長:', locations ? locations.length : 'null');
        
        locationSelect.innerHTML = '<option value="">拠点を選択してください</option>';
        locationSelect.disabled = false;
        
        if (locations && Array.isArray(locations) && locations.length > 0) {
          console.log('拠点データを追加開始');
          let addedCount = 0;
          
          locations.forEach(function(location, index) {
            console.log(`拠点 ${index}:`, location);
            console.log(`  - locationId: "${location.locationId}"`);
            console.log(`  - locationName: "${location.locationName}"`);
            console.log(`  - locationCode: "${location.locationCode}"`);
            console.log(`  - status: "${location.status}"`);
            console.log(`  - statusがactiveか: ${location.status === 'active'}`);
            
            // ステータスのチェックを一時的に緩和してデバッグ
            if (location && location.locationId && location.locationName) {
              const option = document.createElement('option');
              option.value = location.locationId;
              option.textContent = location.locationName;
              if (location.locationCode) {
                option.setAttribute('data-code', location.locationCode);
              }
              
              // optionが正しく作成されたか確認
              console.log(`作成されたoption:`, {
                value: option.value,
                text: option.textContent,
                dataCode: option.getAttribute('data-code')
              });
              
              // DOM操作前の状態を確認
              console.log(`追加前のselect要素の子要素数: ${locationSelect.children.length}`);
              
              locationSelect.appendChild(option);
              
              // DOM操作後の状態を確認
              console.log(`追加後のselect要素の子要素数: ${locationSelect.children.length}`);
              
              addedCount++;
              console.log(`追加成功: ${location.locationName} (${location.locationId})`);
            } else {
              console.log(`スキップ: 必要なデータが不足`, location);
            }
          });
          
          console.log(`合計 ${addedCount} 件の拠点を追加`);
          console.log(`最終的なselect要素の状態:`, {
            childrenCount: locationSelect.children.length,
            disabled: locationSelect.disabled,
            innerHTML: locationSelect.innerHTML.substring(0, 500) + '...'
          });
          
          // 拠点が読み込まれた後、最初のデフォルトオプションを強調
          if (addedCount > 0) {
            const firstOption = locationSelect.options[0];
            if (firstOption && firstOption.value === '') {
              firstOption.textContent = `拠点を選択してください (${addedCount}件の拠点が利用可能)`;
            }
          }
          
          // 追加直後に要素が存在するか再確認
          setTimeout(() => {
            const checkSelect = document.getElementById('location');
            console.log('=== 1秒後の確認 ===');
            console.log('select要素:', checkSelect);
            console.log('オプション数:', checkSelect ? checkSelect.options.length : 'select要素なし');
            if (checkSelect) {
              console.log('innerHTML:', checkSelect.innerHTML);
              
              // 全てのオプションを表示
              for (let i = 0; i < checkSelect.options.length; i++) {
                console.log(`option[${i}]: value="${checkSelect.options[i].value}", text="${checkSelect.options[i].text}"`);
              }
            }
          }, 1000);
          
          if (addedCount === 0) {
            showErrorMessage('有効な拠点データがありません');
          }
        } else {
          console.log('拠点データが空または無効です');
          locationSelect.innerHTML = '<option value="">拠点データがありません</option>';
          showErrorMessage('拠点データが見つかりません。拠点マスタを確認してください。');
        }
      })
      .withFailureHandler(function(error) {
        console.error('拠点一覧取得エラー:', error);
        console.error('エラー詳細:', error.toString());
        console.error('エラースタック:', error.stack);
        
        locationSelect.innerHTML = '<option value="">エラーが発生しました</option>';
        locationSelect.disabled = false;
        
        showErrorMessage('拠点一覧の取得に失敗しました: ' + error.toString());
        
        // エラー時は静的データを使用
        console.log('エラーのため静的拠点データを使用します');
        setTimeout(function() {
          addStaticLocations();
        }, 1000);
      })
      .getLocationMaster();
  }

  // ========================================
  // カテゴリ一覧の読み込み
  // ========================================
  function loadCategories() {
    console.log('カテゴリ一覧の読み込み開始');
    
    const categorySelect = document.getElementById('deviceCategory');
    if (!categorySelect) {
      console.error('deviceCategory要素が見つかりません');
      return;
    }
    
    // 読み込み中の表示
    categorySelect.innerHTML = '<option value="">カテゴリを読み込み中...</option>';
    categorySelect.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('カテゴリ一覧取得成功:', result);
        categorySelect.innerHTML = '<option value="">カテゴリを選択してください</option>';
        categorySelect.disabled = false;
        
        if (result.success && result.categories && result.categories.length > 0) {
          // カテゴリ表示名のマッピング（英語→日本語表示）
          const displayMapping = {
            'desktop': 'デスクトップ',
            'laptop': 'ノートパソコン',
            'server': 'サーバー',
            'printer': 'プリンタ',
            'other': 'その他'
          };
          
          result.categories.forEach(function(category) {
            const option = document.createElement('option');
            // 値と内部処理は英語のまま
            option.value = category;
            // 表示のみ日本語にする
            option.textContent = displayMapping[category] || category;
            
            categorySelect.appendChild(option);
            console.log(`カテゴリ追加: ${displayMapping[category] || category} (値: ${category})`);
          });
          
          console.log(`合計 ${result.categories.length} 件のカテゴリを追加`);
        } else {
          console.log('カテゴリデータがありません');
          categorySelect.innerHTML = '<option value="">カテゴリデータがありません</option>';
          showErrorMessage('カテゴリデータが見つかりません。機種マスタを確認してください。');
        }
      })
      .withFailureHandler(function(error) {
        console.error('カテゴリ一覧取得エラー:', error);
        categorySelect.innerHTML = '<option value="">エラーが発生しました</option>';
        categorySelect.disabled = false;
        showErrorMessage('カテゴリ一覧の取得に失敗しました: ' + error.toString());
      })
      .getAvailableCategories();
  }

  // ========================================
  // モデル一覧の読み込み
  // ========================================
  function loadModels() {
    const category = document.getElementById('deviceCategory').value;
    const modelSelect = document.getElementById('model');
    
    if (!category) {
      modelSelect.innerHTML = '<option value="">先にカテゴリを選択してください</option>';
      modelSelect.disabled = true;
      return;
    }
    
    console.log('モデル一覧の読み込み開始:', category);
    modelSelect.innerHTML = '<option value="">読み込み中...</option>';
    modelSelect.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('モデル一覧取得成功:', result);
        modelSelect.innerHTML = '<option value="">モデルを選択してください</option>';
        modelSelect.disabled = false;
        
        if (result.success && result.models && result.models.length > 0) {
          // カテゴリに応じてフィルタリング（英語カテゴリで直接マッチング）
          console.log('モデルフィルタリング:', {
            selectedCategory: category,
            totalModels: result.models.length
          });
          
          const filteredModels = result.models.filter(function(model) {
            return model.category === category;
          });
          
          filteredModels.forEach(function(model) {
            const option = document.createElement('option');
            option.value = model.modelName;
            option.textContent = model.modelName + ' (' + model.manufacturer + ')';
            modelSelect.appendChild(option);
          });
          
          if (filteredModels.length === 0) {
            modelSelect.innerHTML = '<option value="">該当するモデルがありません</option>';
          }
        } else {
          modelSelect.innerHTML = '<option value="">モデルデータがありません</option>';
        }
      })
      .withFailureHandler(function(error) {
        console.error('モデル一覧取得エラー:', error);
        modelSelect.innerHTML = '<option value="">エラーが発生しました</option>';
        showErrorMessage('モデル一覧の取得に失敗しました: ' + error.message);
      })
      .getModelMasterForForm();
  }

  // ========================================
  // 拠点管理番号の自動生成
  // ========================================
  function updateLocationNumber() {
    console.log('updateLocationNumber関数が呼び出されました');
    
    const location = document.getElementById('location').value;
    const category = document.getElementById('deviceCategory').value;
    const model = document.getElementById('model').value;
    const serialNumber = document.getElementById('serialNumber').value.trim();
    const sequenceNumber = document.getElementById('sequenceNumber').value;
    
    console.log('フィールドの値:', {
      location: location,
      category: category,
      model: model,
      serialNumber: serialNumber,
      sequenceNumber: sequenceNumber
    });
    
    const locationNumberInput = document.getElementById('locationNumber');
    
    // すべての必須項目が入力されているかチェック
    if (!location || !category || !model || !serialNumber || !sequenceNumber) {
      console.log('必須項目が不足しています');
      locationNumberInput.value = '';
      return;
    }
    
    // 拠点コードを取得
    const locationSelect = document.getElementById('location');
    const selectedOption = locationSelect.options[locationSelect.selectedIndex];
    const locationCode = selectedOption ? selectedOption.getAttribute('data-code') || location : location;
    
    console.log('拠点コード取得:', {
      selectedIndex: locationSelect.selectedIndex,
      selectedOption: selectedOption,
      dataCode: selectedOption ? selectedOption.getAttribute('data-code') : 'なし',
      locationCode: locationCode
    });
    
    // カテゴリは既に英語形式で取得されているので、そのまま使用
    const englishCategory = category;
    
    console.log('カテゴリ情報:', {
      selectedCategory: category,
      englishCategory: englishCategory
    });
    
    // 拠点管理番号を生成（形式: 拠点コード_カテゴリ_モデル_製造番号_連番）
    const locationNumber = `${locationCode}_${englishCategory}_${model}_${serialNumber}_${String(sequenceNumber).padStart(3, '0')}`;
    
    locationNumberInput.value = locationNumber;
    console.log('拠点管理番号生成完了:', locationNumber);
  }

  // ========================================
  // URL生成・保存処理
  // ========================================
  function generateAndSaveUrl() {
    const form = document.getElementById('urlGenerationForm');
    if (!form) return;
    
    console.log('URL生成処理開始');
    
    // 拠点データが読み込まれているか確認
    const locationSelect = document.getElementById('location');
    if (locationSelect && locationSelect.options.length <= 1) {
      console.warn('拠点データが読み込まれていません。手動で追加します。');
      addStaticLocations();
      
      // データ追加後、少し待ってから処理を続行
      setTimeout(function() {
        generateAndSaveUrlInternal();
      }, 100);
      return;
    }
    
    // 拠点選択状態を事前確認
    if (locationSelect) {
      const currentLocation = locationSelect.value;
      const selectedIndex = locationSelect.selectedIndex;
      
      console.log('拠点選択状態の事前確認:', {
        value: currentLocation,
        selectedIndex: selectedIndex,
        optionsLength: locationSelect.options.length,
        selectedOptionText: selectedIndex >= 0 ? locationSelect.options[selectedIndex].textContent : null
      });
      
      // 選択はされているが値が空の場合の修復
      if (!currentLocation && selectedIndex > 0) {
        const selectedOption = locationSelect.options[selectedIndex];
        if (selectedOption && selectedOption.value) {
          console.log('拠点選択の自動修復を実行:', selectedOption.value);
          locationSelect.value = selectedOption.value;
          
          // 拠点管理番号を更新
          updateLocationNumber();
        }
      }
    }
    
    generateAndSaveUrlInternal();
  }
  
  function generateAndSaveUrlInternal() {
    const form = document.getElementById('urlGenerationForm');
    if (!form) return;
    
    // フォームデータを収集
    const locationNumber = document.getElementById('locationNumber').value.trim();
    const deviceCategory = document.getElementById('deviceCategory').value;
    const model = document.getElementById('model').value;
    const serialNumber = document.getElementById('serialNumber').value.trim();
    const sequenceNumber = document.getElementById('sequenceNumber').value;
    
    console.log('生成前の値確認:', {
      locationNumber: locationNumber,
      deviceCategory: deviceCategory,
      location: document.getElementById('location').value,
      model: model,
      serialNumber: serialNumber,
      sequenceNumber: sequenceNumber
    });
    
    // バリデーション
    if (!validateGenerationForm(locationNumber, deviceCategory)) {
      return;
    }
    
    // 共通フォーム設定確認
    if (!checkCategorySettings(deviceCategory)) {
      return;
    }
    
    // デバイス情報を取得（モデル選択から詳細情報を取得）
    const modelSelect = document.getElementById('model');
    const selectedOption = modelSelect.options[modelSelect.selectedIndex];
    let manufacturer = '';
    
    // モデル選択のtextContentから機種名とメーカーを分離
    if (selectedOption && selectedOption.textContent) {
      const parts = selectedOption.textContent.split(' (');
      if (parts.length > 1) {
        manufacturer = parts[1].replace(')', '');
      }
    }
    
    // 資産管理番号の取得（端末の場合のみ）
    const assetNumberInput = document.getElementById('assetNumber');
    const assetNumber = assetNumberInput && assetNumberInput.hasAttribute('required') 
      ? assetNumberInput.value.trim() 
      : '';
    
    const deviceInfo = {
      modelName: model,
      manufacturer: manufacturer,
      category: deviceCategory,
      serialNumber: serialNumber,
      sequenceNumber: sequenceNumber,
      assetNumber: assetNumber  // 資産管理番号を追加
    };
    
    const requestData = {
      locationNumber: locationNumber,
      deviceCategory: deviceCategory,
      deviceInfo: deviceInfo
    };
    
    console.log('送信データ:', requestData);
    
    showLoadingMessage('URL生成・保存中...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        console.log('URL生成・保存成功:', result);
        
        if (result.success) {
          showGenerationResult(result);
          
          if (result.isNewEntry) {
            showSuccessMessage('新規デバイス情報を登録し、URLの生成と保存が完了しました');
          } else {
            showSuccessMessage('URLの生成と保存が完了しました');
          }
        } else {
          showErrorMessage('URL生成・保存に失敗しました: ' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        console.error('URL生成・保存エラー:', error);
        showErrorMessage('URL生成・保存に失敗しました: ' + error.message);
      })
      .generateAndSaveCommonFormUrl(requestData);
  }

  // ========================================
  // フォームバリデーション
  // ========================================
  function validateGenerationForm(locationNumber, deviceCategory) {
    // 全フィールドのバリデーション
    const locationSelect = document.getElementById('location');
    
    // 拠点選択の値を複数の方法で取得を試行
    let location = '';
    if (locationSelect) {
      location = locationSelect.value;
      
      // valueが空の場合、selectedIndexから値を取得を試行
      if (!location && locationSelect.selectedIndex > 0) {
        const selectedOption = locationSelect.options[locationSelect.selectedIndex];
        if (selectedOption) {
          location = selectedOption.value;
          // selectの値を更新
          locationSelect.value = location;
          console.log('selectedIndexから拠点値を復元:', location);
        }
      }
    }
    
    const model = document.getElementById('model').value;
    const serialNumber = document.getElementById('serialNumber').value.trim();
    const sequenceNumber = document.getElementById('sequenceNumber').value;
    
    console.log('バリデーション詳細:', {
      location: location,
      model: model,
      serialNumber: serialNumber,
      sequenceNumber: sequenceNumber,
      locationNumber: locationNumber,
      deviceCategory: deviceCategory,
      locationSelectExists: !!locationSelect,
      selectedIndex: locationSelect ? locationSelect.selectedIndex : null,
      optionsCount: locationSelect ? locationSelect.options.length : null
    });
    
    if (!location || location === '') {
      const locationSelect = document.getElementById('location');
      console.error('拠点選択エラー詳細:', {
        selectElement: locationSelect,
        optionsLength: locationSelect ? locationSelect.options.length : 'null',
        selectedIndex: locationSelect ? locationSelect.selectedIndex : 'null',
        value: locationSelect ? locationSelect.value : 'null',
        allOptions: locationSelect ? Array.from(locationSelect.options).map((opt, index) => ({
          index: index,
          value: opt.value,
          text: opt.textContent,
          selected: opt.selected
        })) : 'null'
      });
      
      // より詳細なエラーメッセージを提供
      if (locationSelect && locationSelect.options.length > 1) {
        const availableLocations = Array.from(locationSelect.options)
          .filter(opt => opt.value !== '')
          .map(opt => opt.textContent);
        console.log('拠点データは読み込まれています。利用可能な拠点:', availableLocations);
        
        // 実際に選択されているかチェック
        const selectedOption = locationSelect.options[locationSelect.selectedIndex];
        const isProperlySelected = selectedOption && selectedOption.value !== '';
        
        if (isProperlySelected) {
          console.log('拠点は選択されていますが、値が取得できません:', {
            selectedValue: selectedOption.value,
            selectedText: selectedOption.textContent,
            selectedIndex: locationSelect.selectedIndex
          });
          
          // 自動修復を試行
          console.log('自動修復を試行中...');
          locationSelect.value = selectedOption.value;
          
          // changeイベントを手動で発火
          const changeEvent = new Event('change', { bubbles: true });
          locationSelect.dispatchEvent(changeEvent);
          
          // 拠点管理番号を再生成
          setTimeout(() => {
            updateLocationNumber();
            // 再度バリデーションを実行
            const newLocation = locationSelect.value;
            if (newLocation && newLocation !== '') {
              console.log('自動修復が成功しました。新しい拠点値:', newLocation);
              showSuccessMessage('拠点の選択を自動修復しました: ' + selectedOption.textContent);
              // バリデーションを再実行
              return validateGenerationForm(document.getElementById('locationNumber').value, deviceCategory);
            } else {
              showErrorMessage('拠点の選択修復に失敗しました。手動で再選択してください。');
            }
          }, 100);
          
          return false; // 修復処理中のため一旦false返却
        } else {
          showErrorMessage('拠点を選択してください。利用可能な拠点: ' + availableLocations.join(', '));
        }
      } else {
        showErrorMessage('拠点を選択してください（拠点データが読み込まれていません）');
        // 拠点データの再読み込みを試行
        setTimeout(() => {
          console.log('拠点データの再読み込みを試行中...');
          loadLocations();
        }, 1000);
      }
      return false;
    }
    
    if (!deviceCategory) {
      showErrorMessage('デバイスカテゴリを選択してください');
      return false;
    }
    
    if (!model) {
      showErrorMessage('モデルを選択してください');
      return false;
    }
    
    if (!serialNumber) {
      showErrorMessage('製造番号を入力してください');
      return false;
    }
    
    // 資産管理番号のバリデーション（端末の場合のみ）
    const assetNumberInput = document.getElementById('assetNumber');
    if (assetNumberInput && assetNumberInput.hasAttribute('required')) {
      const assetNumber = assetNumberInput.value.trim();
      if (!assetNumber) {
        showErrorMessage('資産管理番号を入力してください');
        return false;
      }
      
      // パターンのバリデーション
      const assetPattern = /^[A-Za-z0-9_-]+$/;
      if (!assetPattern.test(assetNumber)) {
        showErrorMessage('資産管理番号は英数字、ハイフン、アンダースコアのみ使用可能です');
        return false;
      }
    }
    
    if (!sequenceNumber) {
      showErrorMessage('連番を入力してください');
      return false;
    }
    
    if (!locationNumber) {
      showErrorMessage('拠点管理番号が生成されていません');
      return false;
    }
    
    // 拠点管理番号の形式チェック
    const locationNumberPattern = /^[A-Za-z0-9_-]+$/;
    if (!locationNumberPattern.test(locationNumber)) {
      showErrorMessage('拠点管理番号は英数字、アンダースコア、ハイフンのみ使用可能です');
      return false;
    }
    
    return true;
  }

  // ========================================
  // カテゴリ設定確認
  // ========================================
  function checkCategorySettings(deviceCategory) {
    if (!window.commonFormSettings) {
      showErrorMessage('共通フォーム設定が確認できていません');
      return false;
    }
    
    // カテゴリに応じて必要なURL設定を確認
    if (deviceCategory === 'デスクトップPC' || deviceCategory === 'サーバー' || 
        deviceCategory === 'ノートPC' || deviceCategory === 'SV' || 
        deviceCategory === 'CL' || deviceCategory === '端末') {
      if (!window.commonFormSettings.terminal) {
        showErrorMessage('端末用共通フォームURLが設定されていません。設定画面で設定してください。');
        return false;
      }
    } else if (deviceCategory === 'プリンタ') {
      if (!window.commonFormSettings.printer) {
        showErrorMessage('プリンタ・その他用共通フォームURLが設定されていません。設定画面で設定してください。');
        return false;
      }
    } else {
      // その他のカテゴリ
      if (!window.commonFormSettings.printer) {
        showErrorMessage('プリンタ・その他用共通フォームURLが設定されていません。設定画面で設定してください。');
        return false;
      }
    }
    
    return true;
  }

  // ========================================
  // 生成結果表示
  // ========================================
  function showGenerationResult(result) {
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const qrSection = document.getElementById('qrCodeSection');
    const printBtn = document.getElementById('printQrBtn');
    
    if (!resultSection || !resultContent) return;
    
    // 結果データをグローバルに保存
    window.generatedResult = result;
    
    // QRコードセクションを非表示（新しい結果のため）
    if (qrSection) qrSection.style.display = 'none';
    if (printBtn) printBtn.style.display = 'none';
    
    resultContent.innerHTML = `
      <div class="result-item">
        <div class="result-label">
          <i class="fas fa-map-marker-alt"></i>
          拠点管理番号
        </div>
        <div class="result-value">${result.locationNumber}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">
          <i class="fas fa-tag"></i>
          デバイスカテゴリ
        </div>
        <div class="result-value">${result.deviceCategory}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">
          <i class="fas fa-database"></i>
          保存先
        </div>
        <div class="result-value">${result.savedTo} (行: ${result.savedRow})</div>
      </div>
      
      <div class="result-item full-width">
        <div class="result-label">
          <i class="fas fa-link"></i>
          生成されたURL
        </div>
        <div class="result-value url-display">
          <input type="text" id="generatedUrl" value="${result.generatedUrl}" readonly>
        </div>
      </div>
      
      <div class="result-item">
        <div class="result-label">
          <i class="fas fa-clock"></i>
          処理時刻
        </div>
        <div class="result-value">${new Date().toLocaleString('ja-JP')}</div>
      </div>
    `;
    
    resultSection.style.display = 'block';
    resultSection.scrollIntoView({ behavior: 'smooth' });
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function resetForm() {
    const form = document.getElementById('urlGenerationForm');
    if (form) {
      form.reset();
      updateCategoryInfo(); // カテゴリ情報を非表示にする
      
      // モデル選択を無効化
      const modelSelect = document.getElementById('model');
      if (modelSelect) {
        modelSelect.innerHTML = '<option value="">先にカテゴリを選択してください</option>';
        modelSelect.disabled = true;
      }
      
      // 拠点管理番号をクリア
      const locationNumberInput = document.getElementById('locationNumber');
      if (locationNumberInput) {
        locationNumberInput.value = '';
      }
    }
    
    const resultSection = document.getElementById('resultSection');
    if (resultSection) {
      resultSection.style.display = 'none';
    }
    
    showSuccessMessage('フォームをリセットしました');
  }

  function disableForm() {
    const form = document.getElementById('urlGenerationForm');
    if (form) {
      const inputs = form.querySelectorAll('input, select, button');
      inputs.forEach(input => {
        input.disabled = true;
      });
    }
  }

  function copyUrlToClipboard() {
    const urlInput = document.getElementById('generatedUrl');
    if (urlInput) {
      urlInput.select();
      document.execCommand('copy');
      showSuccessMessage('URLをクリップボードにコピーしました');
    }
  }

  function openGeneratedUrl() {
    if (window.generatedResult && window.generatedResult.generatedUrl) {
      window.open(window.generatedResult.generatedUrl, '_blank');
    }
  }

  // ========================================
  // メッセージ表示関数
  // ========================================
  // 共通UIコンポーネントを使用する通知関数
  // ========================================
  function showSuccessMessage(message) {
    CommonUI.showSuccess(message, { duration: 3000 });
  }

  function showErrorMessage(message) {
    CommonUI.showError(message, { duration: 5000 });
  }

  function showLoadingMessage(message) {
    CommonUI.showLoading(message);
  }

  function hideLoadingMessage() {
    CommonUI.hideLoading();
  }

  // ========================================
  // デバッグ関数
  // ========================================
  function showDebugInfo(message, data) {
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      console.log('[URL Generator Debug]', message, data);
    }
  }

  // ========================================
  // グローバル関数登録
  // ========================================
  window.onUrlGeneratorPageShow = onUrlGeneratorPageShow;
  window.updateCategoryInfo = updateCategoryInfo;
  window.generateAndSaveUrl = generateAndSaveUrl;
  window.resetForm = resetForm;
  window.copyUrlToClipboard = copyUrlToClipboard;
  window.openGeneratedUrl = openGeneratedUrl;
  window.loadLocations = loadLocations;
  window.loadModels = loadModels;
  window.updateLocationNumber = updateLocationNumber;
  window.generateQRCode = generateQRCode;
  window.printQRCode = printQRCode;
  window.toggleDebugPanel = toggleDebugPanel;
  window.checkMasterDataExists = checkMasterDataExists;
  
  // 静的な拠点データを追加するフォールバック関数
  function addStaticLocations() {
    console.log('静的な拠点データを追加します');
    const locationSelect = document.getElementById('location');
    
    if (!locationSelect) {
      console.error('拠点選択要素が見つかりません');
      return;
    }
    
    // 既存のオプションをクリア
    locationSelect.innerHTML = '<option value="">拠点を選択してください</option>';
    
    // 静的な拠点データ
    const staticLocations = [
      { locationId: 'himeji', locationName: '姫路', locationCode: 'HMJ' },
      { locationId: 'nara', locationName: '奈良', locationCode: 'NAR' },
      { locationId: 'keiji', locationName: '京滋', locationCode: 'KEI' },
      { locationId: 'osaka', locationName: '大阪', locationCode: 'OSK' },
      { locationId: 'kobe', locationName: '神戸', locationCode: 'KOB' }
    ];
    
    staticLocations.forEach(function(location) {
      const option = document.createElement('option');
      option.value = location.locationId;
      option.textContent = location.locationName;
      option.setAttribute('data-code', location.locationCode);
      locationSelect.appendChild(option);
    });
    
    console.log('静的拠点データを追加しました。オプション数:', locationSelect.options.length);
    showErrorMessage('拠点データの読み込みに失敗したため、既定の拠点リストを使用しています');
  }
  
  // デバッグパネルの表示/非表示切り替え
  function toggleDebugPanel() {
    const debugButtons = document.getElementById('debugButtons');
    const debugToggleIcon = document.getElementById('debugToggleIcon');
    
    if (debugButtons.style.display === 'none') {
      debugButtons.style.display = 'block';
      debugToggleIcon.className = 'fas fa-chevron-down';
    } else {
      debugButtons.style.display = 'none';
      debugToggleIcon.className = 'fas fa-chevron-up';
    }
  }
  
  // マスタデータの存在確認
  function checkMasterDataExists() {
    const debugOutput = document.getElementById('debugOutput');
    const debugContent = document.getElementById('debugContent');
    
    debugOutput.style.display = 'block';
    debugContent.textContent = 'マスタデータを確認中...\n';
    
    google.script.run
      .withSuccessHandler(function(result) {
        debugContent.textContent = '=== マスタデータ確認結果 ===\n';
        debugContent.textContent += JSON.stringify(result, null, 2);
      })
      .withFailureHandler(function(error) {
        debugContent.textContent = 'エラー: ' + error;
      })
      .checkSystemHealth();
  }
  
  // デバッグ用関数
  window.testLoadLocations = function() {
    console.log('=== 拠点データ再読み込みテスト開始 ===');
    const debugOutput = document.getElementById('debugOutput');
    const debugContent = document.getElementById('debugContent');
    
    debugOutput.style.display = 'block';
    debugContent.textContent = '拠点データを読み込み中...\n';
    
    // 拠点データを強制的に再読み込み
    loadLocations();
    
    // 3秒後に選択肢の状態を確認
    setTimeout(function() {
      const locationSelect = document.getElementById('location');
      const options = locationSelect.options;
      
      debugContent.textContent += '\n=== 拠点選択ドロップダウンの状態 ===\n';
      debugContent.textContent += `オプション数: ${options.length}\n`;
      
      for (let i = 0; i < options.length; i++) {
        debugContent.textContent += `オプション${i}: value="${options[i].value}", text="${options[i].text}", data-code="${options[i].getAttribute('data-code')}"\n`;
      }
      
      console.log('=== テスト完了 ===');
    }, 3000);
  };
  
  // 手動でデータを追加する関数
  window.manuallyAddLocations = function() {
    console.log('=== 手動で拠点データを追加 ===');
    
    // 全てのlocation IDを持つ要素を検索
    const allLocationElements = document.querySelectorAll('#location');
    console.log(`ID="location"の要素数: ${allLocationElements.length}`);
    
    allLocationElements.forEach((elem, index) => {
      console.log(`location要素[${index}]:`, {
        tagName: elem.tagName,
        onchange: elem.getAttribute('onchange'),
        parent: elem.parentElement,
        innerHTML: elem.innerHTML
      });
    });
    
    // onchange="updateLocationNumber()"を持つ要素を特定
    const correctSelect = document.querySelector('select#location[onchange="updateLocationNumber()"]');
    
    if (!correctSelect) {
      console.error('onchange="updateLocationNumber()"を持つlocation要素が見つかりません');
      // 別の方法で探す
      const allSelects = document.querySelectorAll('select');
      console.log('全select要素:', allSelects.length);
      allSelects.forEach((s, i) => {
        console.log(`select[${i}]:`, {
          id: s.id,
          onchange: s.getAttribute('onchange'),
          optionsCount: s.options.length
        });
      });
      return;
    }
    
    console.log('正しいselect要素を発見:', correctSelect);
    
    // 既存のオプションをクリア
    correctSelect.innerHTML = '<option value="">拠点を選択してください</option>';
    
    // 手動でオプションを追加
    const locations = [
      { id: 'himeji', name: '姫路', code: 'HIMEJI' },
      { id: 'nara', name: '奈良', code: 'NARA' },
      { id: 'keiji', name: '京滋', code: 'KEIJI' },
      { id: 'osaka', name: '大阪', code: 'OSAKA' }
    ];
    
    locations.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc.id;
      option.textContent = loc.name;
      option.setAttribute('data-code', loc.code);
      correctSelect.appendChild(option);
      console.log(`追加: ${loc.name}`);
    });
    
    console.log('完了。現在のオプション数:', correctSelect.options.length);
    console.log('現在のHTML:', correctSelect.outerHTML);
  };
  
  window.testLocationMasterBackend = function() {
    console.log('=== バックエンド拠点マスタテスト開始 ===');
    const debugOutput = document.getElementById('debugOutput');
    const debugContent = document.getElementById('debugContent');
    
    debugOutput.style.display = 'block';
    debugContent.textContent = 'バックエンドの拠点マスタをテスト中...\n';
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('テスト結果:', result);
        debugContent.textContent += '\n=== バックエンドテスト結果 ===\n';
        debugContent.textContent += JSON.stringify(result, null, 2);
      })
      .withFailureHandler(function(error) {
        console.error('テストエラー:', error);
        debugContent.textContent += '\n=== エラー ===\n';
        debugContent.textContent += error.toString();
      })
      .testLocationMaster();
  };
  
  // 機種マスタのカテゴリを英語に変換する関数
  window.convertCategoriesToEnglish = function() {
    console.log('=== 機種マスタカテゴリ英語変換開始 ===');
    const debugOutput = document.getElementById('debugOutput');
    const debugContent = document.getElementById('debugContent');
    
    debugOutput.style.display = 'block';
    debugContent.textContent = '機種マスタのカテゴリを英語に変換中...\n';
    
    if (!confirm('機種マスタのカテゴリを日本語から英語に変換します。\n\n例: SV → server, CL → desktop\n\n実行してもよろしいですか？')) {
      debugContent.textContent += 'キャンセルされました。\n';
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('変換結果:', result);
        debugContent.textContent += '\n=== 変換結果 ===\n';
        debugContent.textContent += `成功: ${result.success}\n`;
        debugContent.textContent += `メッセージ: ${result.message}\n`;
        debugContent.textContent += `更新件数: ${result.updatedCount}\n`;
        
        if (result.updates && result.updates.length > 0) {
          debugContent.textContent += '\n=== 変更内容 ===\n';
          result.updates.forEach(update => {
            debugContent.textContent += `行${update.row}: "${update.currentCategory}" → "${update.newCategory}"\n`;
          });
        }
        
        // 変換後にカテゴリ一覧を再読み込み
        setTimeout(() => {
          debugContent.textContent += '\nカテゴリ一覧を再読み込み中...\n';
          loadCategories();
        }, 1000);
        
        showSuccessMessage('カテゴリの英語変換が完了しました');
      })
      .withFailureHandler(function(error) {
        console.error('変換エラー:', error);
        debugContent.textContent += '\n=== エラー ===\n';
        debugContent.textContent += error.toString();
        showErrorMessage('カテゴリ変換に失敗しました: ' + error.message);
      })
      .convertModelMasterCategoriesToEnglish();
  };
  
  // 直接オプションを追加するテスト関数
  window.testDirectAddOption = function() {
    console.log('=== 直接オプション追加テスト ===');
    const locationSelect = document.getElementById('location');
    
    if (!locationSelect) {
      console.error('location要素が見つかりません');
      return;
    }
    
    console.log('現在のオプション数:', locationSelect.options.length);
    
    // テスト用のオプションを追加
    const testOption = document.createElement('option');
    testOption.value = 'test';
    testOption.textContent = 'テスト拠点';
    locationSelect.appendChild(testOption);
    
    console.log('追加後のオプション数:', locationSelect.options.length);
    console.log('select要素のHTML:', locationSelect.outerHTML);
  };
  
  // select要素を再作成する関数
  window.recreateLocationSelect = function() {
    console.log('=== SELECT要素の再作成 ===');
    
    const oldSelect = document.getElementById('location');
    if (!oldSelect) {
      console.error('既存のlocation要素が見つかりません');
      return;
    }
    
    // 親要素を取得
    const parent = oldSelect.parentElement;
    console.log('親要素:', parent);
    
    // 既存のオプションを保存
    const options = [];
    for (let i = 0; i < oldSelect.options.length; i++) {
      options.push({
        value: oldSelect.options[i].value,
        text: oldSelect.options[i].text,
        dataCode: oldSelect.options[i].getAttribute('data-code')
      });
    }
    console.log('保存されたオプション:', options);
    
    // 新しいselect要素を作成
    const newSelect = document.createElement('select');
    newSelect.id = 'location';
    newSelect.name = 'location';
    newSelect.required = true;
    newSelect.setAttribute('onchange', 'updateLocationNumber()');
    newSelect.className = oldSelect.className;
    
    // オプションを追加
    options.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt.value;
      option.textContent = opt.text;
      if (opt.dataCode && opt.dataCode !== 'null') {
        option.setAttribute('data-code', opt.dataCode);
      }
      newSelect.appendChild(option);
    });
    
    // 古い要素を置き換え
    parent.replaceChild(newSelect, oldSelect);
    
    console.log('新しいselect要素が作成されました');
    console.log('新しい要素のHTML:', newSelect.outerHTML);
  };
  
  // select要素の表示状態をチェックする関数
  window.checkSelectVisibility = function() {
    console.log('=== SELECT要素の表示状態チェック ===');
    const locationSelect = document.getElementById('location');
    
    if (!locationSelect) {
      console.error('location要素が見つかりません');
      return;
    }
    
    // 現在の選択状態を詳細チェック
    const debugOutput = document.getElementById('debugOutput');
    const debugContent = document.getElementById('debugContent');
    
    debugOutput.style.display = 'block';
    
    const currentState = {
      value: locationSelect.value,
      selectedIndex: locationSelect.selectedIndex,
      optionsLength: locationSelect.options.length,
      disabled: locationSelect.disabled,
      display: window.getComputedStyle(locationSelect).display,
      visibility: window.getComputedStyle(locationSelect).visibility,
      selectedOption: locationSelect.selectedIndex >= 0 ? {
        value: locationSelect.options[locationSelect.selectedIndex].value,
        text: locationSelect.options[locationSelect.selectedIndex].text,
        dataCode: locationSelect.options[locationSelect.selectedIndex].getAttribute('data-code')
      } : null
    };
    
    debugContent.textContent = '=== SELECT要素の詳細状態 ===\n';
    debugContent.textContent += JSON.stringify(currentState, null, 2);
    debugContent.textContent += '\n\n=== 全オプション一覧 ===\n';
    
    for (let i = 0; i < locationSelect.options.length; i++) {
      const opt = locationSelect.options[i];
      debugContent.textContent += `${i}: value="${opt.value}", text="${opt.text}", selected=${opt.selected}\n`;
    }
    
    console.log('現在の選択状態:', currentState);
    
    // 手動で姫路を選択してテスト
    setTimeout(() => {
      console.log('=== 手動で姫路を選択してテスト ===');
      
      // 姫路のオプションを探す
      let himejiiOption = null;
      for (let i = 0; i < locationSelect.options.length; i++) {
        if (locationSelect.options[i].text.includes('姫路') || locationSelect.options[i].value === 'himeji') {
          himejiiOption = locationSelect.options[i];
          locationSelect.selectedIndex = i;
          break;
        }
      }
      
      if (himejiiOption) {
        console.log('姫路オプションを選択しました:', himejiiOption);
        
        // 手動でchangeイベントをトリガー
        const changeEvent = new Event('change', { bubbles: true });
        locationSelect.dispatchEvent(changeEvent);
        
        // onchangeを手動で呼び出し
        if (typeof updateLocationNumber === 'function') {
          updateLocationNumber();
        }
        
        setTimeout(() => {
          console.log('選択後の状態:');
          console.log('value:', locationSelect.value);
          console.log('selectedIndex:', locationSelect.selectedIndex);
          console.log('拠点管理番号フィールド:', document.getElementById('locationNumber').value);
          
          debugContent.textContent += '\n\n=== 姫路選択後の状態 ===\n';
          debugContent.textContent += `value: ${locationSelect.value}\n`;
          debugContent.textContent += `selectedIndex: ${locationSelect.selectedIndex}\n`;
          debugContent.textContent += `拠点管理番号: ${document.getElementById('locationNumber').value}\n`;
        }, 500);
      } else {
        console.log('姫路オプションが見つかりません');
        debugContent.textContent += '\n\n=== エラー ===\n姫路オプションが見つかりません\n';
      }
    }, 1000);
    
    // 要素のスタイルを確認
    const computedStyle = window.getComputedStyle(locationSelect);
    console.log('Computed Style:', {
      display: computedStyle.display,
      visibility: computedStyle.visibility,
      opacity: computedStyle.opacity,
      width: computedStyle.width,
      height: computedStyle.height,
      position: computedStyle.position,
      zIndex: computedStyle.zIndex,
      overflow: computedStyle.overflow
    });
    
    // 要素のサイズと位置
    const rect = locationSelect.getBoundingClientRect();
    console.log('Element Rect:', {
      top: rect.top,
      left: rect.left,
      width: rect.width,
      height: rect.height,
      visible: rect.width > 0 && rect.height > 0
    });
    
    // 親要素の確認
    let parent = locationSelect.parentElement;
    let depth = 0;
    while (parent && depth < 5) {
      const parentStyle = window.getComputedStyle(parent);
      console.log(`Parent ${depth}:`, {
        tagName: parent.tagName,
        id: parent.id,
        className: parent.className,
        display: parentStyle.display,
        visibility: parentStyle.visibility,
        overflow: parentStyle.overflow
      });
      parent = parent.parentElement;
      depth++;
    }
    
    // 強制的にスタイルをリセット
    console.log('スタイルをリセットしています...');
    locationSelect.style.display = 'block';
    locationSelect.style.visibility = 'visible';
    locationSelect.style.opacity = '1';
    locationSelect.style.width = 'auto';
    locationSelect.style.height = 'auto';
    
    // 再度チェック
    const newRect = locationSelect.getBoundingClientRect();
    console.log('リセット後のRect:', {
      width: newRect.width,
      height: newRect.height,
      visible: newRect.width > 0 && newRect.height > 0
    });
  };
  
  // ========================================
  // QRコード関連機能
  // ========================================
  
  /**
   * QRコードを生成して表示
   */
  function generateQRCode() {
    if (!window.generatedResult || !window.generatedResult.locationNumber) {
      showErrorMessage('QRコードを生成できません。先にURLを生成してください。');
      return;
    }
    
    const result = window.generatedResult;
    const locationNumber = result.locationNumber;
    const deviceCategory = result.deviceCategory;
    
    showLoadingMessage('QRコードを生成中...');
    
    // QRコード用URLを生成
    google.script.run
      .withSuccessHandler(function(qrResult) {
        hideLoadingMessage();
        
        if (qrResult.success) {
          displayQRCode(qrResult, locationNumber);
          showSuccessMessage('QRコードを生成しました');
        } else {
          showErrorMessage('QRコード生成に失敗しました: ' + qrResult.error);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        showErrorMessage('QRコード生成中にエラーが発生しました: ' + error);
      })
      .generateCommonFormUrl(locationNumber, deviceCategory, true);
  }
  
  /**
   * QRコードを表示
   */
  function displayQRCode(qrResult, locationNumber) {
    const qrSection = document.getElementById('qrCodeSection');
    const qrImage = document.getElementById('qrCodeImage');
    const qrLocationNumber = document.getElementById('qrLocationNumber');
    const qrUrl = document.getElementById('qrUrl');
    const printBtn = document.getElementById('printQrBtn');
    
    // QRコード画像のURLを作成（Google Charts APIを使用）
    const qrCodeUrl = 'https://chart.googleapis.com/chart?' + 
      'chs=200x200&' +  // サイズ
      'cht=qr&' +        // QRコード
      'chl=' + encodeURIComponent(qrResult.url) + '&' +  // データ
      'choe=UTF-8';      // エンコーディング
    
    // QRコード画像を表示
    qrImage.innerHTML = `<img src="${qrCodeUrl}" alt="QRコード" />`;
    
    // 情報を表示
    qrLocationNumber.textContent = locationNumber;
    qrUrl.textContent = qrResult.url;
    
    // QRコードセクションと印刷ボタンを表示
    qrSection.style.display = 'block';
    printBtn.style.display = 'inline-block';
    
    // QRコードデータを保存
    window.qrCodeData = {
      url: qrResult.url,
      imageUrl: qrCodeUrl,
      locationNumber: locationNumber
    };
  }
  
  /**
   * QRコードを印刷
   */
  function printQRCode() {
    if (!window.qrCodeData) {
      showErrorMessage('QRコードが生成されていません');
      return;
    }
    
    const printWindow = window.open('', 'QRコード印刷', 'width=600,height=600');
    const qrData = window.qrCodeData;
    
    const printContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>QRコード - ${qrData.locationNumber}</title>
        <style>
          body {
            font-family: 'メイリオ', Meiryo, 'ヒラギノ角ゴ Pro W3', sans-serif;
            text-align: center;
            padding: 20px;
          }
          h1 {
            font-size: 24px;
            margin-bottom: 20px;
          }
          .qr-container {
            margin: 20px auto;
          }
          .info {
            margin-top: 20px;
            font-size: 14px;
          }
          .info p {
            margin: 5px 0;
          }
          .url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
          }
          @media print {
            body {
              margin: 0;
            }
          }
        </style>
      </head>
      <body>
        <div class="qr-print-container">
          <h1>代替機管理システム</h1>
          <div class="qr-container">
            <img src="${qrData.imageUrl}" alt="QRコード" />
          </div>
          <div class="info">
            <p><strong>拠点管理番号:</strong></p>
            <p>${qrData.locationNumber}</p>
            <p class="url"><strong>URL:</strong> ${qrData.url}</p>
          </div>
          <p style="margin-top: 30px; font-size: 12px; color: #999;">
            印刷日時: ${new Date().toLocaleString('ja-JP')}
          </p>
        </div>
      </body>
      </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // 画像が読み込まれた後に印刷
    printWindow.onload = function() {
      setTimeout(function() {
        printWindow.print();
        printWindow.close();
      }, 500);
    };
  }
  
  console.log('URL生成機能が登録されました');
  
  // ページ読み込み時にも初期化を実行（念のため）
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded: URL生成ページ');
    // URL生成ページが表示されている場合のみ初期化
    const urlGeneratorPage = document.getElementById('url-generator');
    if (urlGeneratorPage && urlGeneratorPage.classList.contains('active')) {
      console.log('URL生成ページがアクティブなので初期化を実行');
      onUrlGeneratorPageShow();
    }
  });
</script>