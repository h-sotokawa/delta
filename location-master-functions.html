<!-- location-master-functions.html - 拠点マスタ管理ページの機能 -->
<script>
  // ========================================
  // ページ初期化
  // ========================================
  function onLocationMasterPageShow() {
    loadLocationList();
  }

  // ========================================
  // 拠点一覧の読み込み
  // ========================================
  function loadLocationList() {
    showLoading('拠点一覧を読み込み中...');
    
    google.script.run
      .withSuccessHandler(function(locations) {
        hideLoading();
        console.log('取得した拠点データ:', locations); // デバッグ用
        displayLocationList(locations);
      })
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('拠点一覧読み込みエラー:', error); // デバッグ用
        showError('拠点一覧の読み込みに失敗しました: ' + error.message);
      })
      .getLocationMaster();
  }

  // ========================================
  // 拠点一覧の表示
  // ========================================
  function displayLocationList(locations) {
    const tbody = document.getElementById('locationTableBody');
    tbody.innerHTML = '';

    if (!locations || locations.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">拠点データがありません</td></tr>';
      return;
    }

    locations.forEach(function(location) {
      const row = document.createElement('tr');
      row.setAttribute('data-location-id', location.locationId);
      
      const statusBadge = location.status === 'active' 
        ? '<span class="badge badge-success">有効</span>'
        : '<span class="badge badge-secondary">無効</span>';

      row.innerHTML = `
        <td>${escapeHtml(location.locationId)}</td>
        <td>${escapeHtml(location.locationName)}</td>
        <td>${escapeHtml(location.locationCode)}</td>
        <td>${escapeHtml(location.groupEmail || '')}</td>
        <td>${statusBadge}</td>
        <td>${location.createdAt || '-'}</td>
        <td>${location.updatedAt || '-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editLocation('${location.locationId}')">
            <i class="fas fa-edit"></i> 編集
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteLocation('${location.locationId}')">
            <i class="fas fa-trash"></i> 削除
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // ========================================
  // 新規拠点追加モーダル表示
  // ========================================
  function showAddLocationModal() {
    document.getElementById('modalTitle').textContent = '新規拠点追加';
    document.getElementById('locationForm').reset();
    document.getElementById('editLocationId').value = '';
    document.getElementById('locationId').disabled = false;
    document.getElementById('locationModal').style.display = 'block';
  }

  // ========================================
  // 拠点編集モーダル表示
  // ========================================
  function editLocation(locationId) {
    showLoading('拠点情報を読み込み中...');
    
    google.script.run
      .withSuccessHandler(function(location) {
        hideLoading();
        if (location) {
          showEditLocationModal(location);
        } else {
          showError('拠点情報が見つかりません');
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showError('拠点情報の読み込みに失敗しました: ' + error.message);
      })
      .getLocationById(locationId);
  }

  function showEditLocationModal(location) {
    document.getElementById('modalTitle').textContent = '拠点編集';
    document.getElementById('editLocationId').value = location.locationId;
    document.getElementById('locationId').value = location.locationId;
    document.getElementById('locationId').disabled = true;
    document.getElementById('locationName').value = location.locationName;
    document.getElementById('locationCode').value = location.locationCode;
    document.getElementById('groupEmail').value = location.groupEmail || '';
    document.getElementById('locationStatus').value = location.status;
    document.getElementById('locationModal').style.display = 'block';
  }

  // ========================================
  // モーダルを閉じる
  // ========================================
  function closeLocationModal() {
    document.getElementById('locationModal').style.display = 'none';
  }

  // ========================================
  // 拠点保存
  // ========================================
  function saveLocation() {
    console.log('saveLocation関数が呼び出されました');
    
    // 保存処理開始をユーザーに知らせる
    showLocationPopupMessage('保存処理を開始しています...', 'info');
    
    const form = document.getElementById('locationForm');
    const formData = new FormData(form);
    
    // 編集時はdisabledフィールドから値を取得できないため、editLocationIdまたは要素から直接取得
    const isEdit = formData.get('editLocationId');
    const locationId = isEdit ? formData.get('editLocationId') : formData.get('locationId');
    
    console.log('FormData取得完了:', {
      isEdit: !!isEdit,
      locationId: locationId,
      locationIdFromForm: formData.get('locationId'),
      editLocationId: formData.get('editLocationId'),
      locationName: formData.get('locationName'),
      locationCode: formData.get('locationCode'),
      groupEmail: formData.get('groupEmail'),
      status: formData.get('status')
    });
    
    // バリデーション
    console.log('バリデーション開始');
    if (!validateLocationForm(formData)) {
      console.log('バリデーションエラーで処理終了');
      return;
    }
    console.log('バリデーション成功');

    const locationData = {
      locationId: locationId, // 上で取得した正しい拠点IDを使用
      locationName: formData.get('locationName'),
      locationCode: formData.get('locationCode'),
      groupEmail: formData.get('groupEmail'),
      status: formData.get('status')
    };
    const operation = isEdit ? '更新' : '追加';
    
    showLoading(`拠点を${operation}中...`);

    const apiCall = isEdit ? 'updateLocation' : 'addLocation';
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Google Apps Script成功:', result);
        hideLoading();
        closeLocationModal();
        
        const successMessage = `拠点が正常に${operation}されました`;
        showSuccess(successMessage);
        
        // 成功をユーザーに確実に伝える
        setTimeout(() => {
          alert('成功: ' + successMessage);
        }, 100);
        
        loadLocationList();
        
        // 少し遅延してから該当行をハイライト
        setTimeout(() => {
          highlightLocationRow(locationData.locationId);
        }, 500);
      })
      .withFailureHandler(function(error) {
        console.error('Google Apps Scriptエラー:', error);
        hideLoading();
        
        let errorMessage = `拠点の${operation}に失敗しました`;
        if (error && error.message) {
          errorMessage += ': ' + error.message;
        } else if (error) {
          errorMessage += ': ' + error.toString();
        }
        
        showError(errorMessage);
        
        // フォールバック用のalert
        setTimeout(() => {
          alert('エラー: ' + errorMessage);
        }, 200);
      })
      [apiCall](locationData);
  }

  // ========================================
  // フォームバリデーション
  // ========================================
  function validateLocationForm(formData) {
    console.log('validateLocationForm開始');
    
    // 編集時はdisabledフィールドから値を取得できないため、editLocationIdを使用
    const isEdit = formData.get('editLocationId');
    const locationId = isEdit ? formData.get('editLocationId') : formData.get('locationId');
    const locationName = formData.get('locationName');
    const locationCode = formData.get('locationCode');
    const groupEmail = formData.get('groupEmail');

    console.log('バリデーション対象データ:', {
      isEdit: !!isEdit,
      locationId,
      locationIdFromForm: formData.get('locationId'),
      editLocationId: formData.get('editLocationId'),
      locationName,
      locationCode,
      groupEmail
    });

    if (!locationId || !locationId.match(/^[a-z0-9_-]+$/)) {
      console.log('拠点IDバリデーションエラー:', locationId);
      const errorMsg = '拠点IDは小文字英数字、ハイフン、アンダースコアのみ使用可能です';
      showError(errorMsg);
      // 緊急時のフォールバック
      setTimeout(() => alert('エラー: ' + errorMsg), 100);
      return false;
    }

    if (!locationName) {
      console.log('拠点名バリデーションエラー:', locationName);
      const errorMsg = '拠点名を入力してください';
      showError(errorMsg);
      setTimeout(() => alert('エラー: ' + errorMsg), 100);
      return false;
    }

    if (!locationCode || !locationCode.match(/^[A-Z0-9]+$/)) {
      console.log('拠点コードバリデーションエラー:', locationCode);
      const errorMsg = '拠点コードは大文字英数字のみ使用可能です';
      showError(errorMsg);
      setTimeout(() => alert('エラー: ' + errorMsg), 100);
      return false;
    }

    if (!groupEmail) {
      console.log('グループメールアドレスバリデーションエラー（未入力）:', groupEmail);
      const errorMsg = 'グループメールアドレスを入力してください';
      showError(errorMsg);
      setTimeout(() => alert('エラー: ' + errorMsg), 100);
      return false;
    }

    // メールアドレスの形式チェック
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(groupEmail)) {
      console.log('グループメールアドレス形式エラー:', groupEmail);
      const errorMsg = '正しいメールアドレス形式で入力してください';
      showError(errorMsg);
      setTimeout(() => alert('エラー: ' + errorMsg), 100);
      return false;
    }

    console.log('バリデーション全て成功');
    return true;
  }

  // ========================================
  // 拠点削除
  // ========================================
  function deleteLocation(locationId) {
    if (!confirm(`拠点「${locationId}」を削除してもよろしいですか？\n\nこの操作は元に戻せません。`)) {
      return;
    }

    showLoading('拠点を削除中...');

    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        showSuccess('拠点が正常に削除されました');
        loadLocationList();
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showError('拠点の削除に失敗しました: ' + error.message);
      })
      .deleteLocation(locationId);
  }

  // ========================================
  // 拠点行のハイライト
  // ========================================
  function highlightLocationRow(locationId) {
    const targetRow = document.querySelector(`tr[data-location-id="${locationId}"]`);
    if (targetRow) {
      targetRow.classList.add('highlight');
      
      // 3秒後にハイライトを解除
      setTimeout(() => {
        targetRow.classList.remove('highlight');
      }, 3000);
    }
  }

  // ========================================
  // 拠点一覧更新
  // ========================================
  function refreshLocationList() {
    console.log('refreshLocationList called'); // デバッグ用
    
    // 更新ボタンにアニメーション効果を追加
    const refreshButton = document.querySelector('.btn-info');
    console.log('refreshButton found:', refreshButton); // デバッグ用
    
    if (refreshButton) {
      refreshButton.disabled = true;
      
      // アイコンを回転するように変更
      const icon = refreshButton.querySelector('i');
      console.log('icon found:', icon); // デバッグ用
      
      if (icon) {
        icon.classList.add('fa-spin');
        console.log('fa-spin added to icon'); // デバッグ用
      }
      
      // データを更新
      loadLocationList();
      
      // 1秒後にボタンを元に戻す
      setTimeout(() => {
        refreshButton.disabled = false;
        if (icon) {
          icon.classList.remove('fa-spin');
          console.log('fa-spin removed from icon'); // デバッグ用
        }
      }, 1000);
    } else {
      console.error('refresh button not found!'); // デバッグ用
    }
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateValue) {
    if (!dateValue) return '';
    
    try {
      // 既に文字列の場合はそのまま返す
      if (typeof dateValue === 'string') {
        return dateValue;
      }
      
      // Dateオブジェクトの場合は年月日形式にフォーマット
      if (dateValue instanceof Date) {
        const year = dateValue.getFullYear();
        const month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
        const day = dateValue.getDate().toString().padStart(2, '0');
        return `${year}/${month}/${day}`;
      }
      
      return dateValue.toString();
    } catch (error) {
      console.error('日付フォーマットエラー:', error, dateValue);
      return '';
    }
  }

  // ========================================
  // UI通知関数（共通UIコンポーネントを使用）
  // ========================================
  // showLocationPopupMessage関数を共通UIのshowNotificationにマッピング
  function showLocationPopupMessage(message, type = 'info') {
    const options = {
      duration: 5000,
      immediate: true
    };
    
    switch(type) {
      case 'success':
        CommonUI.showSuccess(message, options);
        break;
      case 'error':
        CommonUI.showError(message, options);
        break;
      case 'info':
      default:
        CommonUI.showInfo(message, options);
        break;
    }
  }

  // showLoading関数をカスタマイズ（フォーム無効化機能を維持）
  function showLoading(message) {
    // 共通UIのローディング表示
    CommonUI.showLoading(message);
    
    // 保存ボタンをローディング状態に変更
    const saveButton = document.querySelector('#locationModal .modal-footer .btn-primary');
    if (saveButton) {
      saveButton.disabled = true;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';
    }
    
    // フォーム全体を無効化
    const form = document.getElementById('locationForm');
    if (form) {
      const inputs = form.querySelectorAll('input, select');
      inputs.forEach(input => input.disabled = true);
    }
  }

  // hideLoading関数をカスタマイズ（フォーム有効化機能を維持）
  function hideLoading() {
    // 共通UIのローディング非表示
    CommonUI.hideLoading();
    
    // 保存ボタンを元の状態に戻す
    const saveButton = document.querySelector('#locationModal .modal-footer .btn-primary');
    if (saveButton) {
      saveButton.disabled = false;
      saveButton.innerHTML = '<i class="fas fa-save"></i> 保存';
    }
    
    // フォームの無効化を解除
    const form = document.getElementById('locationForm');
    if (form) {
      const inputs = form.querySelectorAll('input, select');
      inputs.forEach(input => input.disabled = false);
      
      // 編集モードの場合、拠点IDは無効のまま
      const editLocationId = document.getElementById('editLocationId').value;
      if (editLocationId) {
        document.getElementById('locationId').disabled = true;
      }
    }
  }

  // ========================================
  // モーダル外クリックで閉じる
  // ========================================
  window.onclick = function(event) {
    const modal = document.getElementById('locationModal');
    if (event.target === modal) {
      closeLocationModal();
    }
  };
</script>