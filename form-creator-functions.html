<!-- form-creator-functions.html - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½ -->
<script>
  // ========================================
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–
  // ========================================
  function onFormCreatorPageShow() {
    // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®å‡¦ç†
  }

  // ========================================
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
  // ========================================
  function switchFormCreationMode(mode) {
    // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.form-type-tab').forEach(function(tab) {
      tab.classList.remove('active');
    });
    document.getElementById(mode + '-tab').classList.add('active');
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.form-section').forEach(function(section) {
      section.classList.remove('active');
    });
    document.getElementById(mode + '-form').classList.add('active');
    
    // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    if (mode === 'manage') {
      loadFormsList();
    }
    
    if (DEBUG_MODE) {
      showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ', { mode });
    }
  }

  // ========================================
  // æ‹ ç‚¹é¸æŠæ©Ÿèƒ½
  // ========================================
  function getLocationDisplayName(locationValue) {
    const locationNames = {
      'osaka-desktop': 'å¤§é˜ª(ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—)',
      'osaka-server': 'å¤§é˜ª(ã‚µãƒ¼ãƒãƒ¼ã€ãƒãƒ¼ãƒˆ)',
      'kobe-terminal': 'ç¥æˆ¸(ç«¯æœ«)',
      'himeji-terminal': 'å§«è·¯(ç«¯æœ«)',
      'osaka-printer': 'å¤§é˜ª(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)',
      'hyogo-printer': 'å…µåº«(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)'
    };
    
    return locationNames[locationValue] || 'æœªé¸æŠæ‹ ç‚¹';
  }
  // ä»£æ›¿æ©Ÿç¨®åˆ¥é¸æŠæ™‚ã®å‡¦ç†
  function updateDeviceType() {
    // console.log('updateDeviceType é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
    
    const deviceTypeSelect = document.getElementById('device-type');
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    
    // console.log('è¦ç´ å–å¾—çµæœ:', { 
    //   deviceTypeSelect: !!deviceTypeSelect,
    //   locationSelect: !!locationSelect,
    //   deviceCategorySelect: !!deviceCategorySelect
    // });
    
    if (!deviceTypeSelect || !locationSelect || !deviceCategorySelect) {
      // console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const selectedType = deviceTypeSelect.value;
    // console.log('é¸æŠã•ã‚ŒãŸä»£æ›¿æ©Ÿç¨®åˆ¥:', selectedType);
    
    // ä»£æ›¿æ©Ÿç¨®åˆ¥ã«åŸºã¥ãæ‹ ç‚¹ã®é¸æŠè‚¢ãƒãƒƒãƒ”ãƒ³ã‚°
    const locationOptions = {
      'terminal': [
        { value: 'osaka-desktop', text: 'å¤§é˜ª(ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—)' },
        { value: 'osaka-server', text: 'å¤§é˜ª(ã‚µãƒ¼ãƒãƒ¼ã€ãƒãƒ¼ãƒˆ)' },
        { value: 'kobe-terminal', text: 'ç¥æˆ¸(ç«¯æœ«)' },
        { value: 'himeji-terminal', text: 'å§«è·¯(ç«¯æœ«)' }
      ],
      'printer': [
        { value: 'osaka-printer', text: 'å¤§é˜ª(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)' },
        { value: 'hyogo-printer', text: 'å…µåº«(ãƒ—ãƒªãƒ³ã‚¿ã€ãã®ä»–)' }
      ]
    };
    
    // æ‹ ç‚¹é¸æŠè‚¢ã‚’æ›´æ–°
    // console.log('æ‹ ç‚¹é¸æŠè‚¢ã‚’æ›´æ–°ä¸­...');
    locationSelect.innerHTML = '<option value="">æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    
    if (selectedType && locationOptions[selectedType]) {
      // console.log('åˆ©ç”¨å¯èƒ½ãªæ‹ ç‚¹:', locationOptions[selectedType]);
      locationOptions[selectedType].forEach(function(option) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        locationSelect.appendChild(optionElement);
      });
      locationSelect.disabled = false;
      // console.log('æ‹ ç‚¹é¸æŠã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
    } else {
      // console.log('é¸æŠã•ã‚ŒãŸä»£æ›¿æ©Ÿç¨®åˆ¥ã«å¯¾å¿œã™ã‚‹æ‹ ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“');
      locationSelect.disabled = true;
    }
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã¨ç®¡ç†ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆ
    deviceCategorySelect.innerHTML = '<option value="">æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    deviceCategorySelect.disabled = true;
    
    const locationNumberInput = document.getElementById('location-number');
    if (locationNumberInput) {
      locationNumberInput.value = '';
    }
    
         // å±æ€§ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–°
     updateAttributesForm();
     
     if (DEBUG_MODE) {
       showDebugInfo('ä»£æ›¿æ©Ÿç¨®åˆ¥é¸æŠæ›´æ–°', { 
        selectedType, 
        locationOptions: locationOptions[selectedType] || []
      });
    }
  }

  // æ‹ ç‚¹é¸æŠæ™‚ã®å‡¦ç†
  function updateLocationNumber() {
    const deviceTypeSelect = document.getElementById('device-type');
    const locationSelect = document.getElementById('location-select');
    const locationPrefixSpan = document.getElementById('location-prefix');
    const locationSuffixInput = document.getElementById('location-suffix');
    const locationNumberInput = document.getElementById('location-number');
    const deviceCategorySelect = document.getElementById('device-category');
    
    if (!deviceTypeSelect || !locationSelect || !locationPrefixSpan || !locationSuffixInput || !locationNumberInput || !deviceCategorySelect) return;
    
    const deviceType = deviceTypeSelect.value;
    const selectedLocation = locationSelect.value;
    
    // æ‹ ç‚¹ã«åŸºã¥ãç®¡ç†ç•ªå·ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°
    const locationPrefixes = {
      'osaka-desktop': 'Osaka',
      'osaka-server': 'Osaka', 
      'kobe-terminal': 'Kobe',
      'himeji-terminal': 'Hime',
      'osaka-printer': 'Osaka',
      'hyogo-printer': 'Kobe'
    };
    
    // æ‹ ç‚¹ã«åŸºã¥ãè©³ç´°ã‚«ãƒ†ã‚´ãƒªã®é¸æŠè‚¢ãƒãƒƒãƒ”ãƒ³ã‚°
    const deviceCategoryOptions = {
      'osaka-desktop': [
        { value: 'SV', text: 'SVï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰' },
        { value: 'CL', text: 'CLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰' }
      ],
      'osaka-server': [
        { value: 'SV', text: 'SVï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰' },
        { value: 'CL', text: 'CLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰' }
      ],
      'kobe-terminal': [
        { value: 'SV', text: 'SVï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰' },
        { value: 'CL', text: 'CLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰' }
      ],
      'himeji-terminal': [
        { value: 'SV', text: 'SVï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰' },
        { value: 'CL', text: 'CLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰' }
      ],
      'osaka-printer': [
        { value: 'ãƒ—ãƒªãƒ³ã‚¿', text: 'ãƒ—ãƒªãƒ³ã‚¿' },
        { value: 'ãã®ä»–', text: 'ãã®ä»–' }
      ],
      'hyogo-printer': [
        { value: 'ãƒ—ãƒªãƒ³ã‚¿', text: 'ãƒ—ãƒªãƒ³ã‚¿' },
        { value: 'ãã®ä»–', text: 'ãã®ä»–' }
      ]
    };
    
    // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®æ›´æ–°
    if (selectedLocation && locationPrefixes[selectedLocation]) {
      locationPrefixSpan.textContent = locationPrefixes[selectedLocation] + '_';
      locationSuffixInput.disabled = false;
      locationSuffixInput.placeholder = '001';
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆã¾ã å…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
      if (!locationSuffixInput.value) {
        locationSuffixInput.value = '001';
      }
      
      // çµåˆã•ã‚ŒãŸæ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’æ›´æ–°
      updateCombinedLocationNumber();
    } else {
      locationPrefixSpan.textContent = 'é¸æŠã—ã¦ãã ã•ã„_';
      locationSuffixInput.disabled = true;
      locationSuffixInput.value = '';
      locationNumberInput.value = '';
    }
    
    // è©³ç´°ã‚«ãƒ†ã‚´ãƒªã®é¸æŠè‚¢ã‚’æ›´æ–°
    deviceCategorySelect.innerHTML = '<option value="">è©³ç´°ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    
    if (selectedLocation && deviceCategoryOptions[selectedLocation]) {
      deviceCategoryOptions[selectedLocation].forEach(function(option) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        deviceCategorySelect.appendChild(optionElement);
      });
      deviceCategorySelect.disabled = false;
    } else {
      deviceCategorySelect.disabled = true;
    }
    
             // å±æ€§ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–°
    updateAttributesForm();
    

    
    if (DEBUG_MODE) {
      showDebugInfo('æ‹ ç‚¹é¸æŠæ›´æ–°', { 
        deviceType,
        selectedLocation, 
        newLocationNumber: locationNumberInput.value,
        deviceOptions: deviceCategoryOptions[selectedLocation] || []
      });
    }
  }

  // æ‹ ç‚¹ç®¡ç†ç•ªå·ã®çµåˆå‡¦ç†
  function updateCombinedLocationNumber() {
    const locationPrefixSpan = document.getElementById('location-prefix');
    const locationSuffixInput = document.getElementById('location-suffix');
    const locationNumberInput = document.getElementById('location-number');
    
    if (locationPrefixSpan && locationSuffixInput && locationNumberInput) {
      const prefix = locationPrefixSpan.textContent.replace('_', '');
      const suffix = locationSuffixInput.value.trim();
      
      console.log('æ‹ ç‚¹ç®¡ç†ç•ªå·çµåˆå‡¦ç†:', {
        prefix: prefix,
        suffix: suffix,
        prefixValid: prefix !== 'é¸æŠã—ã¦ãã ã•ã„',
        suffixValid: suffix !== ''
      });
      
      if (prefix !== 'é¸æŠã—ã¦ãã ã•ã„' && suffix) {
        const combinedNumber = prefix + '_' + suffix;
        locationNumberInput.value = combinedNumber;
        console.log('æ‹ ç‚¹ç®¡ç†ç•ªå·è¨­å®šå®Œäº†:', combinedNumber);
      } else {
        locationNumberInput.value = '';
        console.log('æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚¯ãƒªã‚¢ï¼ˆæ¡ä»¶æœªæº€è¶³ï¼‰');
      }
    } else {
      console.error('æ‹ ç‚¹ç®¡ç†ç•ªå·ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', {
        locationPrefixSpan: !!locationPrefixSpan,
        locationSuffixInput: !!locationSuffixInput,
        locationNumberInput: !!locationNumberInput
      });
    }
  }

  // ========================================
  // ä»£æ›¿æ©Ÿå±æ€§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
  // ========================================
  function updateAttributesForm() {
    const deviceTypeSelect = document.getElementById('device-type');
    const locationSelect = document.getElementById('location-select');
    const deviceCategorySelect = document.getElementById('device-category');
    const attributesContainer = document.getElementById('attributes-form');
    
    if (!deviceTypeSelect || !locationSelect || !deviceCategorySelect || !attributesContainer) return;
    
    const deviceType = deviceTypeSelect.value;
    const location = locationSelect.value;
    const deviceCategory = deviceCategorySelect.value;
    
    // ä»£æ›¿æ©Ÿç¨®åˆ¥ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
    const isTerminal = deviceType === 'terminal';
    const isPrinter = deviceType === 'printer';
    
    if (!deviceType) {
      attributesContainer.innerHTML = `
        <div class="attributes-placeholder">
          <i class="fas fa-info-circle"></i>
          <p>ä»£æ›¿æ©Ÿç¨®åˆ¥ã‚’é¸æŠã™ã‚‹ã¨ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
      `;
      return;
    }
    
    if (!location) {
      attributesContainer.innerHTML = `
        <div class="attributes-placeholder">
          <i class="fas fa-info-circle"></i>
          <p>æ‹ ç‚¹ã‚’é¸æŠã™ã‚‹ã¨ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
      `;
      return;
    }
    
    let attributeFields = [];
    
    if (isTerminal) {
      attributeFields = [
        { name: 'assetNumber', label: 'è³‡ç”£ç®¡ç†ç•ªå·', type: 'text', required: true, placeholder: 'ä¾‹: AS001234' },
        { name: 'model', label: 'å‹ç•ª', type: 'text', required: true, placeholder: 'ä¾‹: ST210E' },
        { name: 'serial', label: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', type: 'text', required: true, placeholder: 'ä¾‹: ABC12345' },
        { name: 'software', label: 'ã‚½ãƒ•ãƒˆ', type: 'text', required: true, placeholder: 'ä¾‹: Recepty NEXT, MRN' },
        { name: 'os', label: 'OS', type: 'text', required: true, placeholder: 'ä¾‹: Windows 11' }
      ];
    } else if (isPrinter) {
      attributeFields = [
        { name: 'model', label: 'å‹ç•ª', type: 'text', required: true, placeholder: 'ä¾‹: PX-S887' },
        { name: 'serial', label: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', type: 'text', required: true, placeholder: 'ä¾‹: XYZ98765' }
      ];
    }
    
    const deviceTypeDisplayName = deviceType === 'terminal' ? 'ç«¯æœ«' : 'ãƒ—ãƒªãƒ³ã‚¿ãƒ»ãã®ä»–';
    
    // å±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
    var attributeFieldsHtml = '';
    for (var i = 0; i < attributeFields.length; i++) {
      var field = attributeFields[i];
      if (field.type === 'select') {
        var optionsHtml = '';
        for (var j = 0; j < field.options.length; j++) {
          optionsHtml += '<option value="' + field.options[j] + '">' + field.options[j] + '</option>';
        }
        attributeFieldsHtml += `
          <div class="form-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <select id="attr-${field.name}" name="attributes[${field.name}]" ${field.required ? 'required' : ''}>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              ${optionsHtml}
            </select>
          </div>
        `;
      } else {
        attributeFieldsHtml += `
          <div class="form-group">
            <label for="attr-${field.name}">
              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
            </label>
            <input type="${field.type}" 
                   id="attr-${field.name}" 
                   name="attributes[${field.name}]" 
                   placeholder="${field.placeholder}"
                   ${field.required ? 'required' : ''}
                   ${field.readonly ? 'readonly' : ''}>
          </div>
        `;
      }
    }
    
    attributesContainer.innerHTML = `
      <div class="attributes-input-section">
        <h4><i class="fas fa-edit"></i> ä»£æ›¿æ©Ÿå±æ€§å…¥åŠ›ï¼ˆ${deviceTypeDisplayName}ï¼‰</h4>
        <div class="attributes-grid">
          ${attributeFieldsHtml}
        </div>
        <div class="attributes-note">
          <i class="fas fa-info-circle"></i>
          <span>ã“ã‚Œã‚‰ã®å±æ€§æƒ…å ±ãŒãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™</span>
        </div>
      </div>
    `;
    

    
    if (DEBUG_MODE) {
      showDebugInfo('å±æ€§ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°', { 
        deviceType,
        location, 
        deviceCategory, 
        isTerminal, 
        isPrinter, 
        attributeFields 
      });
    }
  }

  // ä»£æ›¿æ©Ÿç¨®åˆ¥é¸æŠæ™‚ã®å‡¦ç†
  function updateDeviceCategory() {
    updateAttributesForm();
    
    if (DEBUG_MODE) {
      const deviceCategorySelect = document.getElementById('device-category');
      showDebugInfo('ä»£æ›¿æ©Ÿç¨®åˆ¥å¤‰æ›´', { selectedCategory: deviceCategorySelect.value });
    }
  }

  // ä»£æ›¿æ©Ÿç¨®åˆ¥ã«å¿œã˜ãŸè³ªå•é …ç›®ã‚’ç”Ÿæˆ
  function getDeviceQuestions(location, deviceCategory, attributeData = {}) {
    const deviceTypeSelect = document.getElementById('device-type');
    const deviceType = deviceTypeSelect ? deviceTypeSelect.value : '';
    
    const isTerminal = deviceType === 'terminal';
    const isPrinter = deviceType === 'printer';
    
    let questions = [];
    
    if (isTerminal) {
      questions = [
        { 
          type: 'TEXT', 
          title: 'è³‡ç”£ç®¡ç†ç•ªå·', 
          required: true,
          defaultValue: attributeData.assetNumber || ''
        },
        { 
          type: 'TEXT', 
          title: 'æ‹ ç‚¹ç®¡ç†ç•ªå·', 
          required: true,
          defaultValue: attributeData.locationNumber || ''
        },
        { 
          type: 'TEXT', 
          title: 'å‹ç•ª', 
          required: true,
          defaultValue: attributeData.model || ''
        },
        { 
          type: 'TEXT', 
          title: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', 
          required: true,
          defaultValue: attributeData.serial || ''
        },
        { 
          type: 'TEXT', 
          title: 'ã‚½ãƒ•ãƒˆ', 
          required: true,
          defaultValue: attributeData.software || ''
        },
        { 
          type: 'TEXT', 
          title: 'OS', 
          required: true,
          defaultValue: attributeData.os || ''
        },
        { 
          type: 'DROPDOWN', 
          title: 'ä»£æ›¿æ©Ÿç¨®åˆ¥', 
          required: true,
          options: ['SV', 'CL'],
          defaultValue: attributeData.deviceCategory || ''
        }
      ];
    } else if (isPrinter) {
      questions = [
        { 
          type: 'TEXT', 
          title: 'æ‹ ç‚¹ç®¡ç†ç•ªå·', 
          required: true,
          defaultValue: attributeData.locationNumber || ''
        },
        { 
          type: 'TEXT', 
          title: 'å‹ç•ª', 
          required: true,
          defaultValue: attributeData.model || ''
        },
        { 
          type: 'TEXT', 
          title: 'ã‚·ãƒªã‚¢ãƒ«(è£½é€ ç•ªå·)', 
          required: true,
          defaultValue: attributeData.serial || ''
        },
        { 
          type: 'DROPDOWN', 
          title: 'ä»£æ›¿æ©Ÿç¨®åˆ¥', 
          required: true,
          options: ['ãƒ—ãƒªãƒ³ã‚¿', 'ãã®ä»–'],
          defaultValue: attributeData.deviceCategory || ''
        }
      ];
    }
    
    if (DEBUG_MODE) {
      showDebugInfo('è³ªå•é …ç›®ç”Ÿæˆ', { location, deviceCategory, attributeData, isTerminal, isPrinter, questions });
    }
    
    return questions;
  }

  // ========================================
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ï¼ˆç°¡ç´ åŒ–ï¼‰
  // ========================================

  function addQuestion() {
    const container = document.getElementById('questions-container');
    const newIndex = questionCount;
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.setAttribute('data-index', newIndex);
    
    questionDiv.innerHTML = `
      <div class="question-header">
        <span class="question-number">è³ªå• ${newIndex + 1}</span>
        <button type="button" class="btn-remove-question" onclick="removeQuestion(${newIndex})">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="question-config">
        <div class="form-row">
          <div class="form-group">
            <label>è³ªå•ã‚¿ã‚¤ãƒˆãƒ« <span class="required">*</span></label>
            <input type="text" name="questions[${newIndex}][title]" required
                   placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
          </div>
          
          <div class="form-group">
            <label>è³ªå•ã‚¿ã‚¤ãƒ—</label>
            <select name="questions[${newIndex}][type]" onchange="updateQuestionOptions(${newIndex})">
              <option value="TEXT">çŸ­ç­”å¼ãƒ†ã‚­ã‚¹ãƒˆ</option>
              <option value="PARAGRAPH">é•·ç­”å¼ãƒ†ã‚­ã‚¹ãƒˆ</option>
              <option value="MULTIPLE_CHOICE">ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³</option>
              <option value="CHECKBOX">ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹</option>
              <option value="DROPDOWN">ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³</option>
              <option value="SCALE">è©•ä¾¡ã‚¹ã‚±ãƒ¼ãƒ«</option>
              <option value="DATE">æ—¥ä»˜</option>
              <option value="TIME">æ™‚åˆ»</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <input type="checkbox" name="questions[${newIndex}][required]" value="true">
              å¿…é ˆé …ç›®ã«ã™ã‚‹
            </label>
          </div>
        </div>

        <div class="question-options" id="question-options-${newIndex}" style="display: none;">
          <label>é¸æŠè‚¢ï¼ˆ1è¡Œã«1ã¤ãšã¤å…¥åŠ›ï¼‰</label>
          <textarea name="questions[${newIndex}][options]" rows="4"
                    placeholder="é¸æŠè‚¢1&#10;é¸æŠè‚¢2&#10;é¸æŠè‚¢3"></textarea>
        </div>
      </div>
    `;
    
    container.appendChild(questionDiv);
    questionCount++;
    
    if (DEBUG_MODE) {
      showDebugInfo('è³ªå•ã‚’è¿½åŠ ', { newIndex });
    }
  }

  function removeQuestion(index) {
    const questionDiv = document.querySelector(`[data-index="${index}"]`);
    if (questionDiv) {
      questionDiv.remove();
      updateQuestionNumbers();
      
      if (DEBUG_MODE) {
        showDebugInfo('è³ªå•ã‚’å‰Šé™¤', { index });
      }
    }
  }

  function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.question-item');
    questions.forEach(function(question, index) {
      const numberSpan = question.querySelector('.question-number');
      if (numberSpan) {
        numberSpan.textContent = 'Q' + (index + 1);
      }
    });
  }

  function updateQuestionOptions(index) {
    const typeSelect = document.querySelector(`[name="questions[${index}][type]"]`);
    const optionsDiv = document.getElementById(`question-options-${index}`);
    
    if (typeSelect && optionsDiv) {
      const selectedType = typeSelect.value;
      const showOptions = ['MULTIPLE_CHOICE', 'CHECKBOX', 'DROPDOWN'].includes(selectedType);
      
      optionsDiv.style.display = showOptions ? 'block' : 'none';
      
      if (DEBUG_MODE) {
        showDebugInfo('è³ªå•ã‚¿ã‚¤ãƒ—å¤‰æ›´', { index, selectedType, showOptions });
      }
    }
  }

  function resetFormCreation() {
    const form = document.getElementById('googleFormCreationForm');
    if (!form) {
      console.warn('ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    try {
      form.reset();
      
      // è³ªå•é …ç›®ã‚’åˆæœŸåŒ–ï¼ˆæœ€åˆã®1ã¤ã ã‘æ®‹ã™ï¼‰
      const container = document.getElementById('questions-container');
      if (container) {
        const questions = container.querySelectorAll('.question-item');
        
        questions.forEach(function(question, index) {
          if (index > 0) {
            question.remove();
          }
        });
      }
      
      questionCount = 1;
      updateQuestionNumbers();
      
      // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼ˆå­˜åœ¨ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
      if (form && form.querySelectorAll) {
        form.querySelectorAll('.error').forEach(function(element) {
          element.classList.remove('error');
        });
      }
      
      if (DEBUG_MODE) {
        showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’ãƒªã‚»ãƒƒãƒˆ');
      }
      
      showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
    } catch (error) {
      console.error('resetFormCreation ã‚¨ãƒ©ãƒ¼:', error);
      showMessage('ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  }

  // ========================================
  // Google Formä½œæˆå‡¦ç†
  // ========================================
  function handleGoogleFormCreation(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    if (DEBUG_MODE) {
      showDebugInfo('Google Formä½œæˆé–‹å§‹', Array.from(formData.entries()));
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
    const deviceType = formData.get('deviceType');
    const locationNumber = formData.get('locationNumber');
    const location = formData.get('location');
    const deviceCategory = formData.get('deviceCategory');
    
    // å±æ€§ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
    const attributeData = {};
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('attributes[')) {
        const match = key.match(/attributes\[(\w+)\]/);
        if (match) {
          const [, attrName] = match;
          attributeData[attrName] = value;
        }
      }
    }

    const formConfig = {
      title: locationNumber, // æ‹ ç‚¹ç®¡ç†ç•ªå·ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦ä½¿ç”¨
      description: `${getLocationDisplayName(location)} ä»£æ›¿æ©Ÿä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ `,
      deviceType: deviceType,
      locationNumber: locationNumber,
      location: location,
      deviceCategory: deviceCategory,
      attributes: attributeData,
      questions: getDeviceQuestions(location, deviceCategory, attributeData)
    };
    
    // è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
    const questionData = {};
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('questions[')) {
        const match = key.match(/questions\[(\d+)\]\[(\w+)\]/);
        if (match) {
          const [, index, field] = match;
          if (!questionData[index]) questionData[index] = {};
          
          if (field === 'options') {
            questionData[index][field] = value.split('\n').filter(opt => opt.trim());
          } else if (field === 'required') {
            questionData[index][field] = value === 'true';
          } else {
            questionData[index][field] = value;
          }
        }
      }
    }
    
    // è³ªå•é…åˆ—ã‚’ä½œæˆ
    Object.keys(questionData).forEach(function(index) {
      const question = questionData[index];
      if (question.title) {
        formConfig.questions.push(question);
      }
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª ===');
    console.log('formData entries:', Array.from(formData.entries()));
    console.log('ç”Ÿæˆã•ã‚ŒãŸformConfig:', formConfig);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateGoogleFormConfig(formConfig)) {
      console.error('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ä¸­æ­¢');
      return;
    }
    
    console.log('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é–‹å§‹');
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
    const submitButton = form.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    // Google Apps Scriptã«é€ä¿¡
    createGoogleFormAPI(formConfig)
      .then(function(result) {
        console.log('Google Apps Script result:', result);
        if (result.success) {
          console.log('result.data:', result.data);
          showFormCreationSuccess(result.data);
          // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆã¯resetFormCreationå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚é‡è¤‡å‘¼ã³å‡ºã—ã‚’é¿ã‘ã‚‹
          resetFormCreation();
          
          if (DEBUG_MODE) {
            showDebugInfo('Google Formä½œæˆæˆåŠŸ', result);
          }
        } else {
          throw new Error(result.error || 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(function(error) {
        showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        
        if (DEBUG_MODE) {
          showDebugInfo('Google Formä½œæˆã‚¨ãƒ©ãƒ¼', { error: error.message });
        }
      })
      .finally(function() {
        setButtonLoading(submitButton, false);
      });
  }

  function validateGoogleFormConfig(formConfig) {
    let isValid = true;
    let validationErrors = [];
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===');
    console.log('formConfig:', formConfig);
    
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
    if (!formConfig.title || formConfig.title.trim() === '') {
      validationErrors.push('ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ãŒæœªè¨­å®šã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«:', formConfig.title);
    }
    
    if (!formConfig.locationNumber || formConfig.locationNumber.trim() === '') {
      validationErrors.push('æ‹ ç‚¹ç®¡ç†ç•ªå·ãŒæœªè¨­å®šã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ æ‹ ç‚¹ç®¡ç†ç•ªå·:', formConfig.locationNumber);
    }
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ã¿æ¤œè¨¼ï¼‰
    if (formConfig.locationNumber) {
      // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã§åˆ†å‰²
      const parts = formConfig.locationNumber.split('_');
      if (parts.length < 2) {
        validationErrors.push('æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯ã€Œãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹_ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šOsaka_001ï¼‰');
        console.log('âœ— æ‹ ç‚¹ç®¡ç†ç•ªå·ã®å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãªã—ï¼‰:', formConfig.locationNumber);
        isValid = false;
      } else {
        // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢å‰ã®éƒ¨åˆ†ï¼‰ã®ã¿æ¤œè¨¼
        const prefix = parts[0];
        const prefixPattern = /^[A-Za-z]+$/;
        
        if (!prefixPattern.test(prefix) || prefix.length < 2) {
          validationErrors.push('ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯2æ–‡å­—ä»¥ä¸Šã®è‹±å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šOsakaã€Himeï¼‰');
          console.log('âœ— ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®å½¢å¼ã‚¨ãƒ©ãƒ¼:', prefix);
          isValid = false;
        } else {
          console.log('âœ“ æ‹ ç‚¹ç®¡ç†ç•ªå·ã®å½¢å¼OK:', formConfig.locationNumber, 'ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹:', prefix, 'ï¼‰');
        }
      }
    }
    
    // åŸºæœ¬æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
    if (!formConfig.deviceType) {
      validationErrors.push('ä»£æ›¿æ©Ÿç¨®åˆ¥ãŒæœªé¸æŠã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ ä»£æ›¿æ©Ÿç¨®åˆ¥:', formConfig.deviceType);
    }
    
    if (!formConfig.location) {
      validationErrors.push('æ‹ ç‚¹ãŒæœªé¸æŠã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ æ‹ ç‚¹:', formConfig.location);
    }
    
    if (!formConfig.deviceCategory) {
      validationErrors.push('è©³ç´°ã‚«ãƒ†ã‚´ãƒªãŒæœªé¸æŠã§ã™');
      isValid = false;
    } else {
      console.log('âœ“ è©³ç´°ã‚«ãƒ†ã‚´ãƒª:', formConfig.deviceCategory);
    }
    
    // è³ªå•ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!formConfig.questions || formConfig.questions.length === 0) {
      validationErrors.push('è³ªå•é …ç›®ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      isValid = false;
    } else {
      console.log('âœ“ è³ªå•é …ç›®æ•°:', formConfig.questions.length);
      formConfig.questions.forEach(function(question, index) {
        console.log('è³ªå•' + (index + 1) + ':', question);
      });
    }
    
    // å±æ€§ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
    if (formConfig.attributes) {
      console.log('âœ“ å±æ€§ãƒ‡ãƒ¼ã‚¿:', formConfig.attributes);
      
      // ç«¯æœ«ã®å ´åˆã®å¿…é ˆå±æ€§ãƒã‚§ãƒƒã‚¯
      if (formConfig.deviceType === 'terminal') {
        const requiredTerminalAttrs = ['assetNumber', 'model', 'serial', 'software', 'os'];
        requiredTerminalAttrs.forEach(function(attr) {
          if (!formConfig.attributes[attr] || formConfig.attributes[attr].trim() === '') {
            validationErrors.push('ç«¯æœ«ã®å¿…é ˆå±æ€§ã€Œ' + attr + 'ã€ãŒæœªå…¥åŠ›ã§ã™');
            isValid = false;
          }
        });
      }
      
      // ãƒ—ãƒªãƒ³ã‚¿ã®å ´åˆã®å¿…é ˆå±æ€§ãƒã‚§ãƒƒã‚¯
      if (formConfig.deviceType === 'printer') {
        const requiredPrinterAttrs = ['model', 'serial'];
        requiredPrinterAttrs.forEach(function(attr) {
          if (!formConfig.attributes[attr] || formConfig.attributes[attr].trim() === '') {
            validationErrors.push('ãƒ—ãƒªãƒ³ã‚¿ã®å¿…é ˆå±æ€§ã€Œ' + attr + 'ã€ãŒæœªå…¥åŠ›ã§ã™');
            isValid = false;
          }
        });
      }
    } else {
      validationErrors.push('å±æ€§ãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      isValid = false;
    }
    
    console.log('=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ ===');
    console.log('isValid:', isValid);
    if (validationErrors.length > 0) {
      console.log('ã‚¨ãƒ©ãƒ¼ä¸€è¦§:', validationErrors);
    }
    
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    if (!isValid) {
      showValidationErrors(validationErrors);
    }
    
    return isValid;
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è©³ç´°è¡¨ç¤º
  function showValidationErrors(errors) {
    var errorMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n';
    for (var i = 0; i < errors.length; i++) {
      errorMessage += 'â€¢ ' + errors[i] + '\n';
    }
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
    console.error('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', errors);
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆã§è©³ç´°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    alert(errorMessage);
    
    // é€šå¸¸ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¡¨ç¤º
    showMessage('å…¥åŠ›å†…å®¹ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ï¼ˆè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'error');
  }

  function showFormCreationSuccess(formData) {
    // ãƒ‡ãƒãƒƒã‚°ç”¨: formDataã®å†…å®¹ã‚’ç¢ºèª
    console.log('showFormCreationSuccess - formData:', formData);
    
    // ã‚¿ã‚¤ãƒˆãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    var title = formData.title || formData.name || 'ãƒ•ã‚©ãƒ¼ãƒ ';
    console.log('ä½¿ç”¨ã™ã‚‹ã‚¿ã‚¤ãƒˆãƒ«:', title);
    
    // QRã‚³ãƒ¼ãƒ‰ç”»åƒã®è¡¨ç¤ºéƒ¨åˆ†ã‚’æ§‹ç¯‰
    let qrCodeSection = '';
    
    // ãƒ‡ãƒãƒƒã‚°: QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›
    console.log('QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
      qrCodeExists: !!formData.qrCode,
      qrCodeSuccess: formData.qrCode ? formData.qrCode.success : 'undefined',
      publicImageUrl: formData.qrCode ? formData.qrCode.publicImageUrl : 'undefined',
      fullQrCodeData: formData.qrCode
    });
    
    if (formData.qrCode && formData.qrCode.success) {
      // Base64ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆã—ã¦ä½¿ç”¨ï¼ˆCORSåˆ¶é™å›é¿ï¼‰
      let primaryImageSrc = '';
      let fallbackSrcs = [];
      
      if (formData.qrCode.base64ImageData) {
        primaryImageSrc = formData.qrCode.base64ImageData;
        console.log('Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
      } else if (formData.qrCode.publicImageUrl) {
        primaryImageSrc = formData.qrCode.publicImageUrl;
        if (formData.qrCode.thumbnailUrl) {
          fallbackSrcs.push(formData.qrCode.thumbnailUrl);
        }
      }
      
      console.log('QRã‚³ãƒ¼ãƒ‰ç”»åƒURL:', {
        primary: primaryImageSrc ? 'Base64ãƒ‡ãƒ¼ã‚¿' : primaryImageSrc,
        hasBase64: !!formData.qrCode.base64ImageData,
        publicUrl: formData.qrCode.publicImageUrl,
        thumbnailUrl: formData.qrCode.thumbnailUrl,
        fallbacks: fallbackSrcs
      });
      
      if (primaryImageSrc) {
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®JavaScriptã‚’æ§‹ç¯‰
        let onErrorHandler = 'this.onerror=null; ';
        fallbackSrcs.forEach((url, index) => {
          onErrorHandler += `if(!this.dataset.tried${index}) { this.dataset.tried${index}='true'; this.src='${url}'; return; } `;
        });
        onErrorHandler += `this.style.display='none'; document.getElementById('qr-error-msg').style.display='block';`;
        
        qrCodeSection = 
          '<div class="qr-code-section">' +
            '<h4><i class="fas fa-qrcode"></i> QRã‚³ãƒ¼ãƒ‰</h4>' +
            '<div class="qr-code-container">' +
              '<img src="' + primaryImageSrc + '" alt="QRã‚³ãƒ¼ãƒ‰" class="qr-code-image" ' +
              'onerror="' + onErrorHandler + '" />' +
              '<div id="qr-error-msg" style="display:none; color: #dc2626; margin-top: 10px;">' +
                '<p>âš ï¸ QRã‚³ãƒ¼ãƒ‰ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>' +
                '<p>ãƒ•ã‚¡ã‚¤ãƒ«ID: ' + (formData.qrCode.fileId || 'ãªã—') + '</p>' +
                (formData.qrCode.publicImageUrl ? 
                  '<p><a href="' + formData.qrCode.publicImageUrl + '" target="_blank" style="color: #3b82f6;">ç›´æ¥ãƒªãƒ³ã‚¯ã§ç¢ºèª</a></p>' : '') +
              '</div>' +
              '<p class="qr-code-note">ğŸ“± <strong>èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™</strong></p>' +
              '<p class="qr-code-instruction">ä¸Šè¨˜QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§èª­ã¿å–ã£ã¦ã€æ­£ã—ããƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>' +
            '</div>' +
          '</div>';
      } else {
        qrCodeSection = 
          '<div class="qr-code-section error">' +
            '<h4><i class="fas fa-exclamation-triangle"></i> QRã‚³ãƒ¼ãƒ‰ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—</h4>' +
            '<p>QRã‚³ãƒ¼ãƒ‰ç”»åƒã®URLã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>' +
          '</div>';
      }
    } else {
      // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¤±æ•—æ™‚ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
      const errorDetails = formData.qrCode ? 
        `æˆåŠŸãƒ•ãƒ©ã‚°: ${formData.qrCode.success}, URL: ${formData.qrCode.publicImageUrl || 'ãªã—'}` :
        'QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
        
      qrCodeSection = 
        '<div class="qr-code-section error">' +
          '<h4><i class="fas fa-exclamation-triangle"></i> QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼</h4>' +
          '<p>QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã¯æ­£å¸¸ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚</p>' +
          '<details style="margin-top: 10px;">' +
            '<summary style="cursor: pointer; color: #6b7280;">è©³ç´°æƒ…å ±</summary>' +
            '<p style="font-family: monospace; font-size: 0.8rem; color: #6b7280; margin-top: 5px;">' + errorDetails + '</p>' +
          '</details>' +
        '</div>';
    }
    
    // æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    const successHtml = 
      '<div class="form-success-dialog">' +
        '<div class="success-content">' +
          '<h3><i class="fas fa-check-circle"></i> ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†</h3>' +
          '<p><strong>' + title + '</strong> ã‚’æ­£å¸¸ã«ä½œæˆã—ã¾ã—ãŸã€‚</p>' +
          
          '<div class="form-links">' +
            '<div class="link-item">' +
              '<label>å…¬é–‹URLï¼ˆå›ç­”ç”¨ï¼‰:</label>' +
              '<div class="url-display">' +
                '<input type="text" value="' + formData.publicUrl + '" readonly>' +
                '<button onclick="copyToClipboard(\'' + formData.publicUrl + '\')">' +
                  '<i class="fas fa-copy"></i>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          
          qrCodeSection +
          
          '<div class="dialog-actions">' +
            '<button class="btn btn-secondary" onclick="closeSuccessDialog()">' +
              'é–‰ã˜ã‚‹' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    const dialogDiv = document.createElement('div');
    dialogDiv.className = 'success-dialog-overlay';
    dialogDiv.innerHTML = successHtml;
    
    // HTMLãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    console.log('ç”Ÿæˆã•ã‚ŒãŸHTML:', successHtml.substring(0, 200));
    
    document.body.appendChild(dialogDiv);
  }

  // ========================================
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================
  function validateForm(form, formType) {
    let isValid = true;
    
    // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å­˜åœ¨ç¢ºèª
    if (!form || !form.querySelectorAll) {
      console.error('validateForm: ç„¡åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ', form);
      return false;
    }
    
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
      field.classList.remove('error');
      
      if (!field.value.trim()) {
        field.classList.add('error');
        isValid = false;
      }
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—åˆ¥ã®è¿½åŠ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (formType === 'terminal') {
      isValid &= validateTerminalForm(form);
    } else if (formType === 'printer') {
      isValid &= validatePrinterForm(form);
    }
    
    return isValid;
  }
  
  function validateTerminalForm(form) {
    let isValid = true;
    
    // è³‡ç”£ç®¡ç†ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    const assetNumber = form.querySelector('[name="assetNumber"]');
    if (assetNumber && assetNumber.value) {
      const assetPattern = /^[A-Z]{2,4}-\d{6}$/;
      if (!assetPattern.test(assetNumber.value)) {
        assetNumber.classList.add('error');
        isValid = false;
      }
    }
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯çµ±ä¸€æ¤œè¨¼é–¢æ•°ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã“ã“ã§ã¯å‰Šé™¤
    
    return isValid;
  }
  
  function validatePrinterForm(form) {
    let isValid = true;
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·ã¯çµ±ä¸€æ¤œè¨¼é–¢æ•°ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã“ã“ã§ã¯å‰Šé™¤
    
    return isValid;
  }

  // ========================================
  // Google Apps Scriptã¨ã®é€šä¿¡
  // ========================================
  function createGoogleFormAPI(formConfig) {
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .createGoogleForm(formConfig);
      } catch (error) {
        // Google Apps Scriptç’°å¢ƒã§ãªã„å ´åˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
        if (DEBUG_MODE) {
          setTimeout(function() {
            resolve({ 
              success: true, 
              message: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ',
              data: {
                formId: 'test-form-id',
                title: formConfig.title,
                editUrl: 'https://docs.google.com/forms/d/test-form-id/edit',
                publicUrl: 'https://docs.google.com/forms/d/test-form-id/viewform',
                responseSheetId: 'test-sheet-id',
                responseSheetUrl: 'https://docs.google.com/spreadsheets/d/test-sheet-id',
                locationNumber: formConfig.locationNumber,
                qrCode: {
                  success: true,
                  publicImageUrl: 'https://via.placeholder.com/200x200/0ea5e9/ffffff?text=TEST+QR',
                  thumbnailUrl: 'https://via.placeholder.com/400x400/0ea5e9/ffffff?text=TEST+QR+THUMB',
                  base64ImageData: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP8/5+hnoEIwDiqkL4KAcT9GO0U4BxoAAAAAElFTkSuQmCC',
                  fileName: 'qr_test_001.png',
                  fileId: 'test-file-id',
                  qrCodeUrl: 'https://docs.google.com/forms/d/test-form-id/viewform'
                }
              }
            });
          }, 1000);
        } else {
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™'));
        }
      }
    });
  }

  function loadFormsList() {
    const loadingIndicator = document.getElementById('forms-loading');
    const formsList = document.getElementById('forms-list');
    
    loadingIndicator.style.display = 'block';
    
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            displayFormsList(result);
            resolve(result);
          })
          .withFailureHandler(function(error) {
            showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            reject(error);
          })
          .getCreatedFormsList();
      } catch (error) {
        // Google Apps Scriptç’°å¢ƒã§ãªã„å ´åˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
        if (DEBUG_MODE) {
          setTimeout(function() {
            const testResult = {
              success: true,
              forms: [
                {
                  id: 'test-form-1',
                  title: 'ãƒ†ã‚¹ãƒˆ ãƒ•ã‚©ãƒ¼ãƒ  1',
                  description: 'ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã™',
                  editUrl: 'https://docs.google.com/forms/d/test-form-1/edit',
                  publicUrl: 'https://docs.google.com/forms/d/test-form-1/viewform',
                  createdDate: new Date(),
                  responseCount: 5
                }
              ],
              totalCount: 1
            };
            displayFormsList(testResult);
            resolve(testResult);
          }, 1000);
        } else {
          showMessage('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™', 'error');
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™'));
        }
      }
    }).finally(function() {
      loadingIndicator.style.display = 'none';
    });
  }

  function displayFormsList(result) {
    const formsList = document.getElementById('forms-list');
    
    if (!result.success || !result.forms || result.forms.length === 0) {
      formsList.innerHTML = 
        '<div class="no-forms">' +
          '<i class="fas fa-inbox"></i>' +
          '<p>ä½œæˆæ¸ˆã¿ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>' +
        '</div>';
      return;
    }
    
    var formsHtml = '';
    for (var i = 0; i < result.forms.length; i++) {
      var form = result.forms[i];
      formsHtml += 
        '<div class="form-item">' +
          '<div class="form-info">' +
            '<h4>' + form.title + '</h4>' +
            '<p>' + (form.description || 'èª¬æ˜ãªã—') + '</p>' +
            '<div class="form-meta">' +
              '<span><i class="fas fa-calendar"></i> ' + new Date(form.createdDate).toLocaleDateString() + '</span>' +
              '<span><i class="fas fa-chart-bar"></i> å›ç­”: ' + form.responseCount + 'ä»¶</span>' +
            '</div>' +
          '</div>' +
          '<div class="form-actions">' +
            '<button class="btn btn-sm btn-primary" onclick="window.open(\'' + form.editUrl + '\', \'_blank\')">' +
              '<i class="fas fa-edit"></i> ç·¨é›†' +
            '</button>' +
            '<button class="btn btn-sm btn-secondary" onclick="window.open(\'' + form.publicUrl + '\', \'_blank\')">' +
              '<i class="fas fa-external-link-alt"></i> è¡¨ç¤º' +
            '</button>' +
            '<button class="btn btn-sm btn-danger" onclick="deleteForm(\'' + form.id + '\', \'' + form.title + '\')">' +
              '<i class="fas fa-trash"></i> å‰Šé™¤' +
            '</button>' +
          '</div>' +
        '</div>';
    }
    
    formsList.innerHTML = formsHtml;
  }

  function deleteForm(formId, formTitle) {
    if (!confirm('ãƒ•ã‚©ãƒ¼ãƒ ã€Œ' + formTitle + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
      return;
    }
    
    return new Promise(function(resolve, reject) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
              loadFormsList(); // ä¸€è¦§ã‚’æ›´æ–°
            } else {
              showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'error');
            }
            resolve(result);
          })
          .withFailureHandler(function(error) {
            showMessage('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            reject(error);
          })
          .deleteGoogleForm(formId);
      } catch (error) {
        if (DEBUG_MODE) {
          setTimeout(function() {
            showMessage('ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            loadFormsList();
            resolve({ success: true });
          }, 500);
        } else {
          showMessage('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™', 'error');
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒå¿…è¦ã§ã™'));
        }
      }
    });
  }

  // ========================================
  // UI ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  // ========================================
  function setButtonLoading(button, isLoading) {
    if (!button) return;
    
    if (isLoading) {
      button.classList.add('loading');
      button.disabled = true;
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-spinner';
      }
    } else {
      button.classList.remove('loading');
      button.disabled = false;
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-save';
      }
    }
  }
  
  function showMessage(message, type) {
    try {
      // DOM ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof document === 'undefined' || !document || !document.body) {
        console.log('showMessage: DOMæœªå¯¾å¿œç’°å¢ƒ', { message, type });
        return;
      }
      
      // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      try {
        const existingMessages = document.querySelectorAll('.success-message, .error-message');
        if (existingMessages && existingMessages.length > 0) {
          existingMessages.forEach(function(msg) {
            if (msg && msg.remove) {
              msg.remove();
            }
          });
        }
      } catch (queryError) {
        console.log('showMessage: æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼', queryError);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
      }
      
      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      const messageDiv = document.createElement('div');
      if (!messageDiv) {
        console.error('showMessage: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã®ä½œæˆã«å¤±æ•—');
        return;
      }
      
      messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
      var iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (type === 'error') {
        messageDiv.innerHTML = 
          '<div class="message-content">' +
            '<i class="fas ' + iconClass + '"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button class="message-close-btn" onclick="this.parentElement.remove()">' +
            'Ã—' +
          '</button>';
      } else {
        messageDiv.innerHTML = 
          '<i class="fas ' + iconClass + '"></i>' +
          '<span>' + message + '</span>';
      }
      
      if (document.body) {
        document.body.appendChild(messageDiv);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è‡ªå‹•å‰Šé™¤ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ‰‹å‹•å‰Šé™¤ï¼‰
        if (type === 'success') {
          setTimeout(function() {
            if (messageDiv && messageDiv.parentNode) {
              messageDiv.remove();
            }
          }, 3000);
        }
      }
      
    } catch (error) {
      console.error('showMessage ã‚¨ãƒ©ãƒ¼:', error, { message, type });
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('[' + type.toUpperCase() + '] ' + message);
    }
  }

  // ========================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // ========================================
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
      showMessage('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    }).catch(function(err) {
      showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  }

  function closeSuccessDialog() {
    const dialog = document.querySelector('.success-dialog-overlay');
    if (dialog) {
      dialog.remove();
    }
  }

  // ========================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    // Google Formä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    const googleFormCreationForm = document.getElementById('googleFormCreationForm');
    if (googleFormCreationForm) {
      googleFormCreationForm.addEventListener('submit', handleGoogleFormCreation);
    }
    
    // æ‹ ç‚¹ç®¡ç†ç•ªå·suffixå…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const locationSuffixInput = document.getElementById('location-suffix');
    if (locationSuffixInput) {
      locationSuffixInput.addEventListener('input', function() {
        updateCombinedLocationNumber();
      });
    }
    
    // åˆæœŸã®è³ªå•ã‚¿ã‚¤ãƒ—å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    updateQuestionOptions(0);
    
    if (DEBUG_MODE) {
      showDebugInfo('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†', {});
    }
  });

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’å…¬é–‹
  window.updateDeviceType = updateDeviceType;
  window.updateLocationNumber = updateLocationNumber;
  window.updateDeviceCategory = updateDeviceCategory;
  window.switchFormCreationMode = switchFormCreationMode;
  window.deleteForm = deleteForm;
  window.closeSuccessDialog = closeSuccessDialog;
  window.copyToClipboard = copyToClipboard;

</script> 