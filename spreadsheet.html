<!-- spreadsheet.html - スプレッドシートビューアーページコンポーネント -->
<div id="spreadsheet" class="page-content">
  <div class="container">
    <h1>スプレッドシートビューアー</h1>
    <div id="popupMessage" class="popup-message" style="display:none;"></div>
    
    <!-- データタイプ選択（データタイプマスタから動的に読み込み） -->
    <div class="data-type-selector">
      <label for="dataType">データタイプを選択：</label>
      <select id="dataType" onchange="if(window.handleDataTypeChange) window.handleDataTypeChange()">
        <option value="">読み込み中...</option>
      </select>
    </div>
    
    <!-- 拠点選択（通常データ選択時のみ表示） -->
    <div class="location-selector" style="display: none;">
      <label for="location">拠点を選択：</label>
      <select id="location" onchange="if(window.handleLocationChange) window.handleLocationChange()">
        <option value="">拠点を選択してください</option>
      </select>
      
      <label for="deviceType">データ種別：</label>
      <select id="deviceType" onchange="if(window.handleDeviceTypeChange) window.handleDeviceTypeChange()">
        <option value="terminal">端末マスタ</option>
        <option value="printer">プリンタマスタ</option>
      </select>
      
      <button id="refreshButton" class="refresh-button" onclick="if(window.refreshCurrentLocation) window.refreshCurrentLocation()" disabled>
        <i class="fas fa-sync-alt"></i>
        更新
      </button>
      <div id="lastUpdateTime" class="last-update-time" style="display: none;">
        <i class="fas fa-clock"></i>
        <span id="lastUpdateLocationName"></span>最終更新: <span id="lastUpdateTimeText">-</span>
      </div>
    </div>
    
    <!-- 監査データ用の詳細選択 -->
    <div class="audit-sheet-selector" style="display: none;">
      <label for="auditSheet">監査シートを選択：</label>
      <select id="auditSheet" onchange="if(window.handleAuditSheetChange) window.handleAuditSheetChange()">
        <option value="">選択してください</option>
        <option value="大阪">大阪</option>
        <option value="神戸">神戸</option>
        <option value="姫路">姫路</option>
      </select>
      <button id="refreshAuditButton" class="refresh-button" onclick="if(window.refreshAuditData) window.refreshAuditData()" disabled>
        <i class="fas fa-sync-alt"></i>
        更新
      </button>
      <div id="lastUpdateTimeAudit" class="last-update-time" style="display: none;">
        <i class="fas fa-clock"></i>
        <span id="lastUpdateLocationNameAudit"></span>最終更新: <span id="lastUpdateTimeAuditText">-</span>
      </div>
    </div>
    
    <!-- サマリーデータ用の更新ボタン -->
    <div class="summary-refresh-selector" style="display: none;">
      <label>サマリーデータ：</label>
      <button id="refreshSummaryButton" class="refresh-button" onclick="if(window.refreshSummaryData) window.refreshSummaryData()">
        <i class="fas fa-sync-alt"></i>
        更新
      </button>
      <div id="lastUpdateTimeSummary" class="last-update-time">
        <i class="fas fa-clock"></i>
        最終更新: <span id="lastUpdateTimeSummaryText">-</span>
      </div>
    </div>

    <div class="query-selector" style="display: none;">
      <label>表示内容：</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="queryType" value="all" checked onchange="if(window.handleQueryChange) window.handleQueryChange()">
          一覧
        </label>
        <label>
          <input type="radio" name="queryType" value="lending" onchange="if(window.handleQueryChange) window.handleQueryChange()">
          <span title="「預りユーザー機のシリアルNo.」に内容がある場合に表示">
            貸出中(ユーザー預り機有)
          </span>
        </label>
      </div>
    </div>
    
    <div id="loading" class="loading" style="display:none;">データを読み込み中...</div>
    <div id="error" class="error"></div>
    
    <div class="table-responsive">
      <div id="tableContainer"></div>
    </div>
    
    <!-- フロート横スクロールバー -->
    <div id="floatScrollbar" class="float-scrollbar">
      <div class="float-scrollbar-inner">
        <div class="float-scrollbar-content"></div>
      </div>
      <div class="float-scrollbar-indicator"></div>
    </div>

    <div id="debug" class="debug">
      <h3>デバッグ情報 <span style="color: var(--success-color); font-size: 0.8em;">(デバッグモード: ON)</span></h3>
      <div class="debug-controls">
        <button onclick="if(window.clearDebugInfo) window.clearDebugInfo()">ログをクリア</button>
        <button onclick="if(window.exportDebugInfo) window.exportDebugInfo()">ログをエクスポート</button>
        <button onclick="if(window.toggleDebugMode) window.toggleDebugMode()">デバッグモード切替</button>
      </div>
      <pre id="debugInfo"></pre>
    </div>
  </div>
</div>

<!-- スプレッドシートページ専用の初期化スクリプト -->
<script>
  // ページが表示された時に初期化を実行
  (function() {
    console.log('Spreadsheet page initialization script loaded');
    
    // グローバル関数として初期化関数を定義
    window.initSpreadsheetPage = function() {
      console.log('initSpreadsheetPage called');
      
      // データタイプドロップダウンを直接初期化
      const dataTypeSelect = document.getElementById('dataType');
      if (dataTypeSelect) {
        // データタイプマスタを直接読み込む
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          console.log('Loading data types directly via Google Apps Script');
          google.script.run
            .withSuccessHandler(function(response) {
              console.log('Data type response:', response);
              if (response.success && response.dataTypes) {
                // グローバル変数にも保存
                if (typeof window.dataTypeMasterData === 'undefined') {
                  window.dataTypeMasterData = [];
                }
                window.dataTypeMasterData = response.dataTypes;
                
                dataTypeSelect.innerHTML = '<option value="">データタイプを選択してください</option>';
                response.dataTypes.forEach(dataType => {
                  const option = document.createElement('option');
                  option.value = dataType.dataTypeId;
                  option.textContent = dataType.dataTypeName;
                  if (dataType.description) {
                    option.title = dataType.description;
                  }
                  // デフォルトでNORMALを選択
                  if (dataType.dataTypeId === 'NORMAL') {
                    option.selected = true;
                  }
                  dataTypeSelect.appendChild(option);
                });
                console.log('Data types loaded:', response.dataTypes.length);
                
                // デフォルトでNORMALが選択されている場合、UIを更新
                if (dataTypeSelect.value === 'NORMAL') {
                  // handleDataTypeChangeの呼び出しを遅延実行
                  setTimeout(() => {
                    if (typeof window.handleDataTypeChange === 'function') {
                      console.log('Calling handleDataTypeChange');
                      window.handleDataTypeChange();
                    } else {
                      console.log('handleDataTypeChange not found, manually updating UI');
                      // 手動でUIを更新
                      const normalDataType = response.dataTypes.find(dt => dt.dataTypeId === 'NORMAL');
                      if (normalDataType && typeof window.updateUIForDataType === 'function') {
                        window.updateUIForDataType(normalDataType);
                      }
                      // location selectorを表示
                      document.querySelector('.location-selector').style.display = 'block';
                      document.querySelector('.query-selector').style.display = 'block';
                    }
                  }, 500); // spreadsheet-functions.htmlが読み込まれるまで待つ
                }
                  
                  // データを読み込む
                  if (typeof window.loadDataBasedOnDataType === 'function') {
                    setTimeout(() => {
                      window.loadDataBasedOnDataType();
                    }, 100);
                  }
                }
              }
            })
            .withFailureHandler(function(error) {
              console.error('Failed to load data types:', error);
              dataTypeSelect.innerHTML = '<option value="">データタイプの読み込みに失敗しました</option>';
            })
            .getDataTypeMaster(true);
            
          // 拠点データも読み込む
          const locationSelect = document.getElementById('location');
          if (locationSelect) {
            console.log('Loading locations directly via Google Apps Script');
            google.script.run
              .withSuccessHandler(function(response) {
                console.log('Locations response:', response);
                if (response.success && response.locations) {
                  // 既存のオプションをクリア（最初の「拠点を選択してください」は残す）
                  while (locationSelect.options.length > 1) {
                    locationSelect.remove(1);
                  }
                  Object.entries(response.locations).forEach(([key, name]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = name;
                    locationSelect.appendChild(option);
                  });
                  console.log('Locations loaded:', Object.keys(response.locations).length);
                }
              })
              .withFailureHandler(function(error) {
                console.error('Failed to load locations:', error);
              })
              .getLocations();
          }
        }
      }
      
      // フロートスクロールバーも初期化
      if (typeof window.initializeFloatScrollbar === 'function') {
        setTimeout(() => {
          console.log('Initializing float scrollbar');
          window.initializeFloatScrollbar();
        }, 200);
      }
    };
  })();
</script> 