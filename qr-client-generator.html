<!-- QRコード生成用クライアントサイドHTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<div id="qrcode-container" style="display: none;"></div>

<script>
/**
 * クライアントサイドでQRコードを生成し、Base64画像として返す
 * @param {string} text - QRコードに埋め込むテキスト
 * @return {Promise<string>} Base64形式の画像データ
 */
function generateQRCodeClient(text) {
  return new Promise((resolve, reject) => {
    try {
      // 既存のQRコードをクリア
      const container = document.getElementById('qrcode-container');
      container.innerHTML = '';
      
      // QRコードを生成
      const qrcode = new QRCode(container, {
        text: text,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M
      });
      
      // 画像が生成されるまで少し待つ
      setTimeout(() => {
        try {
          const canvas = container.querySelector('canvas');
          if (canvas) {
            // CanvasをBase64に変換
            const dataUrl = canvas.toDataURL('image/png');
            resolve(dataUrl);
          } else {
            // Canvasが見つからない場合は、img要素を探す
            const img = container.querySelector('img');
            if (img && img.src) {
              resolve(img.src);
            } else {
              reject(new Error('QRコード画像が見つかりません'));
            }
          }
        } catch (e) {
          reject(e);
        }
      }, 100);
      
    } catch (error) {
      reject(error);
    }
  });
}

/**
 * 別のライブラリを使用したQRコード生成（フォールバック）
 */
function generateQRCodeAlternative(text) {
  // Google Charts APIを直接使用（クライアントサイドなら動作する可能性）
  const url = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(text)}`;
  
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    img.onload = function() {
      try {
        // 画像をCanvasに描画してBase64に変換
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        const dataUrl = canvas.toDataURL('image/png');
        resolve(dataUrl);
      } catch (e) {
        // CORSエラーの場合は、直接URLを返す
        resolve(url);
      }
    };
    
    img.onerror = function() {
      reject(new Error('画像の読み込みに失敗しました'));
    };
    
    img.src = url;
  });
}

/**
 * GASから呼び出されるメイン関数
 */
function generateQRFromGAS(text) {
  // まずqrcode.jsライブラリを試す
  generateQRCodeClient(text)
    .then(dataUrl => {
      // 成功したらGASに返す
      google.script.run
        .withSuccessHandler(() => console.log('QRコード送信成功'))
        .withFailureHandler(e => console.error('QRコード送信失敗:', e))
        .receiveQRCodeImage(dataUrl, text);
    })
    .catch(error => {
      console.error('qrcode.js失敗:', error);
      
      // フォールバックとして別の方法を試す
      generateQRCodeAlternative(text)
        .then(dataUrl => {
          google.script.run
            .withSuccessHandler(() => console.log('QRコード送信成功（代替方法）'))
            .withFailureHandler(e => console.error('QRコード送信失敗:', e))
            .receiveQRCodeImage(dataUrl, text);
        })
        .catch(finalError => {
          console.error('すべてのQRコード生成方法が失敗:', finalError);
          google.script.run
            .withFailureHandler(e => console.error('エラー報告失敗:', e))
            .reportQRGenerationError(finalError.toString());
        });
    });
}
</script>