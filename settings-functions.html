<!-- settings-functions.html - システム設定ページの機能 -->
<script>
  // ========================================
  // ページ初期化
  // ========================================
  function onSettingsPageShow() {
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('設定ページ初期化開始', {});
    }
    
    // 拠点マスタを読み込み
    loadLocationMasterForSettings();
    
    // 初期状態では拠点選択を促す
    showNoLocationMessage();
  }

  // ========================================
  // 拠点選択関連
  // ========================================
  let currentSelectedLocation = '';
  let locationMasterData = [];

  // 拠点マスタデータを読み込む
  function loadLocationMasterForSettings() {
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('拠点マスタデータ読み込み開始', {});
    }
    
    google.script.run
      .withSuccessHandler(function(locations) {
        locationMasterData = locations;
        populateLocationSelector(locations);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('拠点マスタデータ読み込み完了', { locations });
        }
      })
      .withFailureHandler(function(error) {
        console.error('拠点マスタデータの読み込みに失敗しました:', error);
        showSettingsError('拠点データの読み込みに失敗しました: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('拠点マスタデータ読み込みエラー', { error });
        }
      })
      .getLocationMaster();
  }
  
  // 拠点選択セレクトボックスを更新
  function populateLocationSelector(locations) {
    const locationSelect = document.getElementById('selectedLocation');
    if (!locationSelect) return;
    
    // 既存のオプションをクリア（デフォルトオプション以外）
    locationSelect.innerHTML = '<option value="">拠点を選択してください</option>';
    
    // 拠点データが存在する場合のみ追加
    if (locations && locations.length > 0) {
      locations.forEach(function(location) {
        // アクティブな拠点のみ表示
        if (location.status === 'active') {
          const option = document.createElement('option');
          option.value = location.locationId;
          option.textContent = location.locationName;
          locationSelect.appendChild(option);
        }
      });
    } else {
      // データが無い場合のメッセージ
      const option = document.createElement('option');
      option.value = '';
      option.textContent = '拠点データがありません';
      option.disabled = true;
      locationSelect.appendChild(option);
    }
  }

  function onLocationChange() {
    const selectedLocation = document.getElementById('selectedLocation').value;
    currentSelectedLocation = selectedLocation;
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('拠点選択変更', { selectedLocation });
    }
    
    if (selectedLocation) {
      showLocationSettings(selectedLocation);
      loadFormStorageSettings(selectedLocation);
    } else {
      showNoLocationMessage();
    }
  }

  function showLocationSettings(locationId) {
    // 拠点マスタデータから拠点名を取得
    let locationName = locationId;
    if (locationMasterData && locationMasterData.length > 0) {
      const location = locationMasterData.find(loc => loc.locationId === locationId);
      if (location) {
        locationName = location.locationName;
      }
    }
    
    // UI要素の表示/非表示を制御
    document.getElementById('no-location-message').style.display = 'none';
    document.getElementById('formStorageSettingsForm').style.display = 'block';
    document.getElementById('location-notice').style.display = 'block';
    document.getElementById('location-notice-text').textContent = `現在の設定対象: ${locationName}`;
  }

  function showNoLocationMessage() {
    // UI要素の表示/非表示を制御
    document.getElementById('no-location-message').style.display = 'block';
    document.getElementById('formStorageSettingsForm').style.display = 'none';
    document.getElementById('location-notice').style.display = 'none';
    
    // フォームをクリア
    const form = document.getElementById('formStorageSettingsForm');
    if (form) {
      form.reset();
    }
    
    currentSelectedLocation = '';
  }

  // ========================================
  // 設定タブ切り替え
  // ========================================
  function showSettingsTab(tabId) {
    // 全てのタブボタンからactiveクラスを削除
    document.querySelectorAll('.tab-button').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // 全ての設定セクションを非表示
    document.querySelectorAll('.settings-section').forEach(section => {
      section.classList.remove('active');
    });
    
    // 選択されたタブとセクションをアクティブ化
    document.getElementById(tabId + '-tab').classList.add('active');
    document.getElementById(tabId + '-settings').classList.add('active');
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('設定タブ切り替え', { tabId });
    }
  }

  // ========================================
  // フォーム保存先設定の読み込み
  // ========================================
  function loadFormStorageSettings(locationId) {
    if (!locationId) {
      if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
        showDebugInfo('拠点IDが指定されていません', { locationId });
      }
      return;
    }
    
    showSettingsLoading('設定を読み込み中...');
    
    google.script.run
      .withSuccessHandler(function(settings) {
        hideSettingsLoading();
        displayFormStorageSettings(settings);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('フォーム保存先設定読み込み完了', { locationId, settings });
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('設定の読み込みに失敗しました: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('フォーム保存先設定読み込みエラー', { locationId, error });
        }
      })
      .getFormStorageSettings(locationId);
  }

  // ========================================
  // フォーム保存先設定の表示
  // ========================================
  function displayFormStorageSettings(settings) {
    const form = document.getElementById('formStorageSettingsForm');
    if (!form) return;
    
    // 拠点フォルダIDフィールドに設定値を反映
    const locationFolderInput = document.getElementById('locationFolderId');
    if (locationFolderInput && settings) {
      locationFolderInput.value = settings.locationFolder || '';
    }
  }

  // ========================================
  // フォーム保存先設定の保存
  // ========================================
  function saveFormStorageSettings() {
    const form = document.getElementById('formStorageSettingsForm');
    if (!form) return;
    
    // 現在選択中の拠点を確認
    if (!currentSelectedLocation) {
      showSettingsError('拠点が選択されていません');
      return;
    }
    
    // フォームデータを収集
    const locationFolderId = document.getElementById('locationFolderId').value.trim();
    
    // バリデーション
    if (!validateFormStorageSettings(locationFolderId)) {
      return;
    }
    
    const settings = {
      locationFolder: locationFolderId
    };
    
    showSettingsLoading('設定を保存中...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideSettingsLoading();
        showSettingsSuccess('フォーム保存先設定が正常に保存されました');
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('フォーム保存先設定保存完了', { locationId: currentSelectedLocation, result });
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('設定の保存に失敗しました: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('フォーム保存先設定保存エラー', { locationId: currentSelectedLocation, error });
        }
      })
      .saveFormStorageSettings(currentSelectedLocation, settings);
  }

  // ========================================
  // フォーム保存先設定のバリデーション
  // ========================================
  function validateFormStorageSettings(locationFolderId) {
    // フォルダIDが設定されている必要がある
    if (!locationFolderId) {
      showSettingsError('フォルダIDを設定してください');
      return false;
    }
    
    // フォルダIDの形式チェック
    const folderIdPattern = /^[a-zA-Z0-9_-]+$/;
    
    if (!folderIdPattern.test(locationFolderId)) {
      showSettingsError('フォルダIDの形式が正しくありません');
      return false;
    }
    
    return true;
  }

  // ========================================
  // Google Drive フォルダIDの検証
  // ========================================
  function validateFolderId(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    const folderId = input.value.trim();
    
    if (!folderId) {
      showSettingsError('フォルダIDを入力してください');
      return;
    }
    
    // フォルダIDの形式チェック
    const folderIdPattern = /^[a-zA-Z0-9_-]+$/;
    if (!folderIdPattern.test(folderId)) {
      showSettingsError('フォルダIDの形式が正しくありません');
      return;
    }
    
    showSettingsLoading('フォルダIDを検証中...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideSettingsLoading();
        
        if (result.valid) {
          showSettingsSuccess(`フォルダ「${result.name}」への接続が確認できました`);
          input.classList.add('valid');
          input.classList.remove('invalid');
        } else {
          showSettingsError('フォルダにアクセスできません: ' + result.error);
          input.classList.add('invalid');
          input.classList.remove('valid');
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('フォルダIDの検証に失敗しました: ' + error.message);
        input.classList.add('invalid');
        input.classList.remove('valid');
      })
      .validateDriveFolderId(folderId);
  }

  // ========================================
  // 設定のリセット
  // ========================================
  function resetFormStorageSettings() {
    if (!currentSelectedLocation) {
      showSettingsError('拠点が選択されていません');
      return;
    }
    
    if (!confirm('フォーム保存先設定をリセットしてもよろしいですか？\n\n未保存の変更は失われます。')) {
      return;
    }
    
    // フォームをクリア
    const form = document.getElementById('formStorageSettingsForm');
    if (form) {
      form.reset();
      
      // バリデーションクラスを削除
      const input = document.getElementById('locationFolderId');
      if (input) {
        input.classList.remove('valid', 'invalid');
      }
    }
    
    showSettingsSuccess('設定をリセットしました');
  }

  // ========================================
  // UI通知関数
  // ========================================
  function showSettingsPopupMessage(message, type = 'info') {
    const popup = document.getElementById('settingsPopupMessage');
    if (!popup) {
      console.log(type + ': ' + message);
      return;
    }
    
    popup.textContent = message;
    popup.className = 'popup-message show';
    
    // メッセージタイプに応じてクラスを追加
    if (type === 'success') {
      popup.classList.add('success');
    } else if (type === 'error') {
      popup.classList.add('error');
    } else if (type === 'info') {
      popup.classList.add('info');
    }
    
    popup.style.display = 'block';
    
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
        popup.className = 'popup-message';
      }, 600);
    }, 3000);
  }

  function showSettingsLoading(message) {
    showSettingsPopupMessage(message, 'info');
  }

  function hideSettingsLoading() {
    // ローディング表示を非表示（3秒後に自動で消える）
    console.log('Settings loading completed');
  }

  function showSettingsSuccess(message) {
    showSettingsPopupMessage(message, 'success');
  }

  function showSettingsError(message) {
    showSettingsPopupMessage(message, 'error');
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function showDebugInfo(message, data) {
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      console.log('[Settings Debug]', message, data);
    }
  }
</script>