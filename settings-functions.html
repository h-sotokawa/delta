<!-- settings-functions.html - システム設定ページの機能 -->
<script>
  // ========================================
  // ページ初期化
  // ========================================
  function onSettingsPageShow() {
    console.log('onSettingsPageShow called');
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('設定ページ初期化開始', {});
    }
    
    // DOM要素の確認
    const commonFormsTab = document.getElementById('common-forms-tab');
    const commonFormsSettings = document.getElementById('common-forms-settings');
    
    console.log('共通フォームタブ要素:', commonFormsTab);
    console.log('共通フォーム設定セクション:', commonFormsSettings);
    
    // 共通フォームURL設定を初期読み込み
    loadCommonFormsSettings();
  }

  // ========================================
  // 設定タブ切り替え
  // ========================================
  function showSettingsTab(tabId) {
    console.log('showSettingsTab called with tabId:', tabId);
    
    // 共通フォームURLタブのみサポート
    if (tabId === 'common-forms') {
      console.log('Loading common forms settings...');
      loadCommonFormsSettings();
    }
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('設定タブ切り替え', { tabId });
    }
  }

  // ========================================
  // 共通フォームURL設定の読み込み
  // ========================================
  function loadCommonFormsSettings() {
    console.log('loadCommonFormsSettings called');
    showSettingsLoading('共通フォームURL設定を読み込み中...');
    
    google.script.run
      .withSuccessHandler(function(settings) {
        console.log('共通フォームURL設定読み込み成功:', settings);
        hideSettingsLoading();
        displayCommonFormsSettings(settings);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('共通フォームURL設定読み込み完了', { settings });
        }
      })
      .withFailureHandler(function(error) {
        console.error('共通フォームURL設定読み込みエラー:', error);
        hideSettingsLoading();
        showSettingsError('共通フォームURL設定の読み込みに失敗しました: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('共通フォームURL設定読み込みエラー', { error });
        }
      })
      .getCommonFormsSettings();
  }

  // ========================================
  // 共通フォームURL設定の表示
  // ========================================
  function displayCommonFormsSettings(settings) {
    console.log('displayCommonFormsSettings called with:', settings);
    
    const terminalUrlInput = document.getElementById('terminalCommonFormUrl');
    const printerUrlInput = document.getElementById('printerCommonFormUrl');
    
    console.log('terminalUrlInput element:', terminalUrlInput);
    console.log('printerUrlInput element:', printerUrlInput);
    
    if (terminalUrlInput && settings) {
      terminalUrlInput.value = settings.terminalCommonFormUrl || '';
      console.log('Set terminal URL to:', terminalUrlInput.value);
    }
    
    if (printerUrlInput && settings) {
      printerUrlInput.value = settings.printerCommonFormUrl || '';
      console.log('Set printer URL to:', printerUrlInput.value);
    }
  }

  // ========================================
  // 共通フォームURL設定の保存
  // ========================================
  function saveCommonFormsSettings() {
    const form = document.getElementById('commonFormsSettingsForm');
    if (!form) return;
    
    // フォームデータを収集
    const terminalUrl = document.getElementById('terminalCommonFormUrl').value.trim();
    const printerUrl = document.getElementById('printerCommonFormUrl').value.trim();
    
    // バリデーション
    if (!validateCommonFormsSettings(terminalUrl, printerUrl)) {
      return;
    }
    
    // 3段階確認プロセス
    if (!showTripleConfirmation()) {
      return;
    }
    
    const settings = {
      terminalCommonFormUrl: terminalUrl,
      printerCommonFormUrl: printerUrl
    };
    
    showSettingsLoading('共通フォームURL設定を保存中...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideSettingsLoading();
        showSettingsSuccess('共通フォームURL設定が正常に保存されました');
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('共通フォームURL設定保存完了', { result });
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('共通フォームURL設定の保存に失敗しました: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('共通フォームURL設定保存エラー', { error });
        }
      })
      .saveCommonFormsSettings(settings);
  }

  // ========================================
  // 3段階確認ダイアログ
  // ========================================
  function showTripleConfirmation() {
    // 第1段階確認
    const step1 = confirm(
      '⚠️ 重要な設定変更 ⚠️\n\n' +
      '共通フォームURLの設定を変更します。\n' +
      'この設定はシステム全体に影響します。\n\n' +
      '続行してもよろしいですか？'
    );
    
    if (!step1) {
      showSettingsError('設定の保存をキャンセルしました');
      return false;
    }
    
    // 第2段階確認
    const step2 = confirm(
      '🔧 管理者権限の確認 🔧\n\n' +
      'あなたはシステム管理者ですか？\n' +
      '管理者以外の方による設定変更は\n' +
      'システム障害の原因となる可能性があります。\n\n' +
      '本当に変更を続行しますか？'
    );
    
    if (!step2) {
      showSettingsError('設定の保存をキャンセルしました');
      return false;
    }
    
    // 第3段階確認（最終確認）
    const step3 = confirm(
      '⚡ 最終確認 ⚡\n\n' +
      '設定を保存すると、すぐにシステム全体に反映されます。\n' +
      '変更前の設定には戻せません。\n\n' +
      '✅ 設定内容を十分確認済み\n' +
      '✅ 管理者の承認を得ている\n' +
      '✅ 動作確認の準備ができている\n\n' +
      '最終的に保存を実行してもよろしいですか？'
    );
    
    if (!step3) {
      showSettingsError('設定の保存をキャンセルしました');
      return false;
    }
    
    // 全ての確認をクリアした場合
    showSettingsSuccess('3段階確認が完了しました。設定を保存します...');
    return true;
  }

  // ========================================
  // 共通フォームURL設定のバリデーション
  // ========================================
  function validateCommonFormsSettings(terminalUrl, printerUrl) {
    // 少なくとも一つのURLが設定されている必要がある
    if (!terminalUrl && !printerUrl) {
      showSettingsError('少なくとも一つの共通フォームURLを設定してください');
      return false;
    }
    
    // URLの形式チェック
    const urlPattern = /^https:\/\/docs\.google\.com\/forms\/d\/[a-zA-Z0-9_-]+/;
    
    if (terminalUrl && !urlPattern.test(terminalUrl)) {
      showSettingsError('端末用共通フォームURLの形式が正しくありません');
      return false;
    }
    
    if (printerUrl && !urlPattern.test(printerUrl)) {
      showSettingsError('プリンタ・その他用共通フォームURLの形式が正しくありません');
      return false;
    }
    
    return true;
  }

  // ========================================
  // Google FormsのURL検証
  // ========================================
  function validateFormUrl(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    const formUrl = input.value.trim();
    
    if (!formUrl) {
      showSettingsError('フォームURLを入力してください');
      return;
    }
    
    // URLの形式チェック
    const urlPattern = /^https:\/\/docs\.google\.com\/forms\/d\/[a-zA-Z0-9_-]+/;
    if (!urlPattern.test(formUrl)) {
      showSettingsError('Google FormsのURLの形式が正しくありません');
      return;
    }
    
    showSettingsLoading('フォームURLを検証中...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideSettingsLoading();
        
        if (result.valid) {
          showSettingsSuccess(`フォーム「${result.title}」への接続が確認できました`);
          input.classList.add('valid');
          input.classList.remove('invalid');
        } else {
          showSettingsError('フォームにアクセスできません: ' + result.error);
          input.classList.add('invalid');
          input.classList.remove('valid');
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('フォームURLの検証に失敗しました: ' + error.message);
        input.classList.add('invalid');
        input.classList.remove('valid');
      })
      .validateGoogleFormUrl(formUrl);
  }

  // ========================================
  // 共通フォームURL設定のリセット
  // ========================================
  function resetCommonFormsSettings() {
    if (!confirm('共通フォームURL設定をリセットしてもよろしいですか？\n\n未保存の変更は失われます。')) {
      return;
    }
    
    // フォームをクリア
    const form = document.getElementById('commonFormsSettingsForm');
    if (form) {
      form.reset();
      
      // バリデーションクラスを削除
      const terminalInput = document.getElementById('terminalCommonFormUrl');
      const printerInput = document.getElementById('printerCommonFormUrl');
      
      if (terminalInput) {
        terminalInput.classList.remove('valid', 'invalid');
      }
      
      if (printerInput) {
        printerInput.classList.remove('valid', 'invalid');
      }
    }
    
    showSettingsSuccess('共通フォームURL設定をリセットしました');
  }

  // ========================================
  // UI通知関数
  // ========================================
  function showSettingsPopupMessage(message, type = 'info') {
    const popup = document.getElementById('settingsPopupMessage');
    if (!popup) {
      console.log(type + ': ' + message);
      return;
    }
    
    popup.textContent = message;
    popup.className = 'popup-message show';
    
    // メッセージタイプに応じてクラスを追加
    if (type === 'success') {
      popup.classList.add('success');
    } else if (type === 'error') {
      popup.classList.add('error');
    } else if (type === 'info') {
      popup.classList.add('info');
    }
    
    popup.style.display = 'block';
    
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
        popup.className = 'popup-message';
      }, 600);
    }, 3000);
  }

  function showSettingsLoading(message) {
    showSettingsPopupMessage(message, 'info');
  }

  function hideSettingsLoading() {
    // ローディング表示を非表示（3秒後に自動で消える）
    console.log('Settings loading completed');
  }

  function showSettingsSuccess(message) {
    showSettingsPopupMessage(message, 'success');
  }

  function showSettingsError(message) {
    showSettingsPopupMessage(message, 'error');
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function showDebugInfo(message, data) {
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      console.log('[Settings Debug]', message, data);
    }
  }

  // ========================================
  // DOM読み込み完了時の初期化
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, registering settings functions...');
    
    // 関数をwindowオブジェクトに登録してグローバルに利用可能にする
    window.showSettingsTab = showSettingsTab;
    window.saveCommonFormsSettings = saveCommonFormsSettings;
    window.resetCommonFormsSettings = resetCommonFormsSettings;
    window.validateFormUrl = validateFormUrl;
    
    console.log('Settings functions registered globally');
    
    // DOM要素の存在確認
    const commonFormsTab = document.getElementById('common-forms-tab');
    const commonFormsSettings = document.getElementById('common-forms-settings');
    
    console.log('共通フォームタブ要素:', commonFormsTab);
    console.log('共通フォーム設定セクション:', commonFormsSettings);
    
    if (!commonFormsTab) {
      console.error('共通フォームタブ要素が見つかりません');
    }
    if (!commonFormsSettings) {
      console.error('共通フォーム設定セクション要素が見つかりません');
    }
  });
  
  // ========================================
  // グローバル関数の登録（即座に実行）
  // ========================================
  // 関数をwindowオブジェクトに登録してグローバルに利用可能にする
  window.showSettingsTab = showSettingsTab;
  window.saveCommonFormsSettings = saveCommonFormsSettings;
  window.resetCommonFormsSettings = resetCommonFormsSettings;
  window.validateFormUrl = validateFormUrl;
  
  console.log('Settings functions registered globally (immediate)');
</script>