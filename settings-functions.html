<!-- settings-functions.html - ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½ -->
<script>
  // ========================================
  // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
  // ========================================
  function onSettingsPageShow() {
    console.log('onSettingsPageShow called');
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('è¨­å®šãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹', {});
    }
    
    // DOMè¦ç´ ã®ç¢ºèª
    const commonFormsTab = document.getElementById('common-forms-tab');
    const commonFormsSettings = document.getElementById('common-forms-settings');
    
    console.log('å…±é€šãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–è¦ç´ :', commonFormsTab);
    console.log('å…±é€šãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³:', commonFormsSettings);
    
    // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’åˆæœŸèª­ã¿è¾¼ã¿
    loadCommonFormsSettings();
  }

  // ========================================
  // è¨­å®šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  // ========================================
  function showSettingsTab(tabId) {
    console.log('showSettingsTab called with tabId:', tabId);
    
    // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLã‚¿ãƒ–ã®ã¿ã‚µãƒãƒ¼ãƒˆ
    if (tabId === 'common-forms') {
      console.log('Loading common forms settings...');
      loadCommonFormsSettings();
    }
    
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      showDebugInfo('è¨­å®šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ', { tabId });
    }
  }

  // ========================================
  // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®èª­ã¿è¾¼ã¿
  // ========================================
  function loadCommonFormsSettings() {
    console.log('loadCommonFormsSettings called');
    showSettingsLoading('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    google.script.run
      .withSuccessHandler(function(settings) {
        console.log('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šèª­ã¿è¾¼ã¿æˆåŠŸ:', settings);
        hideSettingsLoading();
        displayCommonFormsSettings(settings);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†', { settings });
        }
      })
      .withFailureHandler(function(error) {
        console.error('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        hideSettingsLoading();
        showSettingsError('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', { error });
        }
      })
      .getCommonFormsSettings();
  }

  // ========================================
  // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®è¡¨ç¤º
  // ========================================
  function displayCommonFormsSettings(settings) {
    console.log('displayCommonFormsSettings called with:', settings);
    
    const terminalUrlInput = document.getElementById('terminalCommonFormUrl');
    const printerUrlInput = document.getElementById('printerCommonFormUrl');
    
    console.log('terminalUrlInput element:', terminalUrlInput);
    console.log('printerUrlInput element:', printerUrlInput);
    
    if (terminalUrlInput && settings) {
      terminalUrlInput.value = settings.terminalCommonFormUrl || '';
      console.log('Set terminal URL to:', terminalUrlInput.value);
    }
    
    if (printerUrlInput && settings) {
      printerUrlInput.value = settings.printerCommonFormUrl || '';
      console.log('Set printer URL to:', printerUrlInput.value);
    }
  }

  // ========================================
  // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®ä¿å­˜
  // ========================================
  function saveCommonFormsSettings() {
    const form = document.getElementById('commonFormsSettingsForm');
    if (!form) return;
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const terminalUrl = document.getElementById('terminalCommonFormUrl').value.trim();
    const printerUrl = document.getElementById('printerCommonFormUrl').value.trim();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateCommonFormsSettings(terminalUrl, printerUrl)) {
      return;
    }
    
    // 3æ®µéšç¢ºèªãƒ—ãƒ­ã‚»ã‚¹
    if (!showTripleConfirmation()) {
      return;
    }
    
    const settings = {
      terminalCommonFormUrl: terminalUrl,
      printerCommonFormUrl: printerUrl
    };
    
    showSettingsLoading('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’ä¿å­˜ä¸­...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideSettingsLoading();
        showSettingsSuccess('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ');
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šä¿å­˜å®Œäº†', { result });
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          showDebugInfo('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼', { error });
        }
      })
      .saveCommonFormsSettings(settings);
  }

  // ========================================
  // 3æ®µéšç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  // ========================================
  function showTripleConfirmation() {
    // ç¬¬1æ®µéšç¢ºèª
    const step1 = confirm(
      'âš ï¸ é‡è¦ãªè¨­å®šå¤‰æ›´ âš ï¸\n\n' +
      'å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLã®è¨­å®šã‚’å¤‰æ›´ã—ã¾ã™ã€‚\n' +
      'ã“ã®è¨­å®šã¯ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«å½±éŸ¿ã—ã¾ã™ã€‚\n\n' +
      'ç¶šè¡Œã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
    );
    
    if (!step1) {
      showSettingsError('è¨­å®šã®ä¿å­˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      return false;
    }
    
    // ç¬¬2æ®µéšç¢ºèª
    const step2 = confirm(
      'ğŸ”§ ç®¡ç†è€…æ¨©é™ã®ç¢ºèª ğŸ”§\n\n' +
      'ã‚ãªãŸã¯ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ã™ã‹ï¼Ÿ\n' +
      'ç®¡ç†è€…ä»¥å¤–ã®æ–¹ã«ã‚ˆã‚‹è¨­å®šå¤‰æ›´ã¯\n' +
      'ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã®åŸå› ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\n' +
      'æœ¬å½“ã«å¤‰æ›´ã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ'
    );
    
    if (!step2) {
      showSettingsError('è¨­å®šã®ä¿å­˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      return false;
    }
    
    // ç¬¬3æ®µéšç¢ºèªï¼ˆæœ€çµ‚ç¢ºèªï¼‰
    const step3 = confirm(
      'âš¡ æœ€çµ‚ç¢ºèª âš¡\n\n' +
      'è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã¨ã€ã™ãã«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«åæ˜ ã•ã‚Œã¾ã™ã€‚\n' +
      'å¤‰æ›´å‰ã®è¨­å®šã«ã¯æˆ»ã›ã¾ã›ã‚“ã€‚\n\n' +
      'âœ… è¨­å®šå†…å®¹ã‚’ååˆ†ç¢ºèªæ¸ˆã¿\n' +
      'âœ… ç®¡ç†è€…ã®æ‰¿èªã‚’å¾—ã¦ã„ã‚‹\n' +
      'âœ… å‹•ä½œç¢ºèªã®æº–å‚™ãŒã§ãã¦ã„ã‚‹\n\n' +
      'æœ€çµ‚çš„ã«ä¿å­˜ã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
    );
    
    if (!step3) {
      showSettingsError('è¨­å®šã®ä¿å­˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      return false;
    }
    
    // å…¨ã¦ã®ç¢ºèªã‚’ã‚¯ãƒªã‚¢ã—ãŸå ´åˆ
    showSettingsSuccess('3æ®µéšç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ä¿å­˜ã—ã¾ã™...');
    return true;
  }

  // ========================================
  // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================
  function validateCommonFormsSettings(terminalUrl, printerUrl) {
    // å°‘ãªãã¨ã‚‚ä¸€ã¤ã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹
    if (!terminalUrl && !printerUrl) {
      showSettingsError('å°‘ãªãã¨ã‚‚ä¸€ã¤ã®å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return false;
    }
    
    // URLã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    const urlPattern = /^https:\/\/docs\.google\.com\/forms\/d\/[a-zA-Z0-9_-]+/;
    
    if (terminalUrl && !urlPattern.test(terminalUrl)) {
      showSettingsError('ç«¯æœ«ç”¨å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      return false;
    }
    
    if (printerUrl && !urlPattern.test(printerUrl)) {
      showSettingsError('ãƒ—ãƒªãƒ³ã‚¿ãƒ»ãã®ä»–ç”¨å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      return false;
    }
    
    return true;
  }

  // ========================================
  // Google Formsã®URLæ¤œè¨¼
  // ========================================
  function validateFormUrl(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    const formUrl = input.value.trim();
    
    if (!formUrl) {
      showSettingsError('ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    // URLã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    const urlPattern = /^https:\/\/docs\.google\.com\/forms\/d\/[a-zA-Z0-9_-]+/;
    if (!urlPattern.test(formUrl)) {
      showSettingsError('Google Formsã®URLã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    showSettingsLoading('ãƒ•ã‚©ãƒ¼ãƒ URLã‚’æ¤œè¨¼ä¸­...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideSettingsLoading();
        
        if (result.valid) {
          showSettingsSuccess(`ãƒ•ã‚©ãƒ¼ãƒ ã€Œ${result.title}ã€ã¸ã®æ¥ç¶šãŒç¢ºèªã§ãã¾ã—ãŸ`);
          input.classList.add('valid');
          input.classList.remove('invalid');
        } else {
          showSettingsError('ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + result.error);
          input.classList.add('invalid');
          input.classList.remove('valid');
        }
      })
      .withFailureHandler(function(error) {
        hideSettingsLoading();
        showSettingsError('ãƒ•ã‚©ãƒ¼ãƒ URLã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        input.classList.add('invalid');
        input.classList.remove('valid');
      })
      .validateGoogleFormUrl(formUrl);
  }

  // ========================================
  // å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã®ãƒªã‚»ãƒƒãƒˆ
  // ========================================
  function resetCommonFormsSettings() {
    if (!confirm('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\næœªä¿å­˜ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
      return;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    const form = document.getElementById('commonFormsSettingsForm');
    if (form) {
      form.reset();
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      const terminalInput = document.getElementById('terminalCommonFormUrl');
      const printerInput = document.getElementById('printerCommonFormUrl');
      
      if (terminalInput) {
        terminalInput.classList.remove('valid', 'invalid');
      }
      
      if (printerInput) {
        printerInput.classList.remove('valid', 'invalid');
      }
    }
    
    showSettingsSuccess('å…±é€šãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }

  // ========================================
  // UIé€šçŸ¥é–¢æ•°
  // ========================================
  function showSettingsPopupMessage(message, type = 'info') {
    const popup = document.getElementById('settingsPopupMessage');
    if (!popup) {
      console.log(type + ': ' + message);
      return;
    }
    
    popup.textContent = message;
    popup.className = 'popup-message show';
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    if (type === 'success') {
      popup.classList.add('success');
    } else if (type === 'error') {
      popup.classList.add('error');
    } else if (type === 'info') {
      popup.classList.add('info');
    }
    
    popup.style.display = 'block';
    
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
        popup.className = 'popup-message';
      }, 600);
    }, 3000);
  }

  function showSettingsLoading(message) {
    showSettingsPopupMessage(message, 'info');
  }

  function hideSettingsLoading() {
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤ºï¼ˆ3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼‰
    console.log('Settings loading completed');
  }

  function showSettingsSuccess(message) {
    showSettingsPopupMessage(message, 'success');
  }

  function showSettingsError(message) {
    showSettingsPopupMessage(message, 'error');
  }

  // ========================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // ========================================
  function showDebugInfo(message, data) {
    if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
      console.log('[Settings Debug]', message, data);
    }
  }

  // ========================================
  // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, registering settings functions...');
    
    // é–¢æ•°ã‚’windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç™»éŒ²ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
    window.showSettingsTab = showSettingsTab;
    window.saveCommonFormsSettings = saveCommonFormsSettings;
    window.resetCommonFormsSettings = resetCommonFormsSettings;
    window.validateFormUrl = validateFormUrl;
    
    console.log('Settings functions registered globally');
    
    // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
    const commonFormsTab = document.getElementById('common-forms-tab');
    const commonFormsSettings = document.getElementById('common-forms-settings');
    
    console.log('å…±é€šãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–è¦ç´ :', commonFormsTab);
    console.log('å…±é€šãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³:', commonFormsSettings);
    
    if (!commonFormsTab) {
      console.error('å…±é€šãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    if (!commonFormsSettings) {
      console.error('å…±é€šãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  });
  
  // ========================================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã®ç™»éŒ²ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
  // ========================================
  // é–¢æ•°ã‚’windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç™»éŒ²ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
  window.showSettingsTab = showSettingsTab;
  window.saveCommonFormsSettings = saveCommonFormsSettings;
  window.resetCommonFormsSettings = resetCommonFormsSettings;
  window.validateFormUrl = validateFormUrl;
  
  console.log('Settings functions registered globally (immediate)');
</script>