<script>
// è¨­å®šç”»é¢ã®åˆæœŸåŒ–
function initializeSettings() {
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (window.debugLog) {
        window.debugLog('info', 'Initializing settings page');
    }
    
    // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
    loadCurrentSettings();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    setupSettingsEventListeners();
    
    // æ‹ ç‚¹åˆ¥é€šçŸ¥è¨­å®šã®èª­ã¿è¾¼ã¿
    loadLocationNotifications();
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
function setupSettingsEventListeners() {
    // ãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById('formUrlForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveFormUrls();
    });
    
    // ãƒ­ã‚°é€šçŸ¥è¨­å®šãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById('logNotificationForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveLogNotificationSettings();
    });
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¤ãƒƒãƒ
    document.getElementById('debugModeSwitch')?.addEventListener('change', function() {
        handleDebugModeChange(this.checked);
    });
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é€šçŸ¥è¨­å®š
    document.getElementById('globalNotificationEnabled')?.addEventListener('change', function() {
        saveGlobalNotificationSetting(this.checked);
    });
}

// ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
function loadCurrentSettings() {
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (window.debugLog) {
        window.debugLog('info', 'Loading current settings');
    }
    
    google.script.run.withSuccessHandler(function(settings) {
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        if (window.debugLog) {
            window.debugLog('success', 'Settings loaded', {
                debugMode: settings.debugMode,
                hasFormUrls: !!(settings.terminalFormUrl || settings.printerFormUrl),
                hasNotificationEmails: !!(settings.errorNotificationEmail || settings.alertNotificationEmail)
            });
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹
        const debugMode = settings.debugMode || false;
        document.getElementById('debugModeSwitch').checked = debugMode;
        updateDebugModeUI(debugMode);
        
        // ãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®š
        document.getElementById('terminalFormUrl').value = settings.terminalFormUrl || '';
        document.getElementById('printerFormUrl').value = settings.printerFormUrl || '';
        document.getElementById('qrPageUrl').value = settings.qrPageUrl || '';
        
        // ãƒ­ã‚°é€šçŸ¥è¨­å®š
        document.getElementById('errorNotificationEmail').value = settings.errorNotificationEmail || '';
        document.getElementById('alertNotificationEmail').value = settings.alertNotificationEmail || '';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é€šçŸ¥è¨­å®š
        document.getElementById('globalNotificationEnabled').checked = settings.statusChangeNotificationEnabled || false;
        
        // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
        document.getElementById('spreadsheetId').textContent = settings.spreadsheetId || '-';
        document.getElementById('lastSystemUpdate').textContent = settings.lastUpdate ? 
            new Date(settings.lastUpdate).toLocaleString('ja-JP') : '-';
            
    }).withFailureHandler(handleError)
    .getSystemSettings();
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ›´å‡¦ç†
function handleDebugModeChange(enabled) {
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (window.debugLog) {
        window.debugLog('info', 'Debug mode change requested', {
            newState: enabled
        });
    }
    
    showConfirmModal(
        `ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’${enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`,
        function() {
            updateDebugMode(enabled);
        },
        function() {
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯å…ƒã«æˆ»ã™
            document.getElementById('debugModeSwitch').checked = !enabled;
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            if (window.debugLog) {
                window.debugLog('info', 'Debug mode change cancelled');
            }
        }
    );
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
function updateDebugMode(enabled) {
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (window.debugLog) {
        window.debugLog('info', 'Updating debug mode', {
            enabled: enabled
        });
    }
    
    google.script.run.withSuccessHandler(function(result) {
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        if (window.debugLog) {
            window.debugLog(result.success ? 'success' : 'error', 'Debug mode update result', {
                success: result.success,
                enabled: enabled
            });
        }
        
        if (result.success) {
            updateDebugModeUI(enabled);
            showNotification(
                `ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’${enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ã—ã¾ã—ãŸã€‚`,
                'success'
            );
        } else {
            showNotification('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
            document.getElementById('debugModeSwitch').checked = !enabled;
        }
    }).withFailureHandler(handleError)
    .updateDebugMode(enabled);
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰UIã®æ›´æ–°
function updateDebugModeUI(debugMode) {
    const alert = document.getElementById('debugModeAlert');
    const message = document.getElementById('debugModeMessage');
    const formInputs = document.querySelectorAll('#terminalFormUrl, #printerFormUrl, #qrPageUrl');
    const logNotificationCard = document.getElementById('logNotificationCard');
    
    if (debugMode) {
        alert.className = 'alert alert-warning mb-4';
        message.innerHTML = '<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: æœ‰åŠ¹</strong><br>ç®¡ç†è€…å°‚ç”¨è¨­å®šãŒç·¨é›†å¯èƒ½ã§ã™ã€‚';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç·¨é›†å¯èƒ½ã«ã™ã‚‹
        formInputs.forEach(input => {
            input.removeAttribute('readonly');
            input.classList.remove('form-control-plaintext');
            input.classList.add('form-control');
        });
        
        // ãƒ­ã‚°é€šçŸ¥è¨­å®šã‚’è¡¨ç¤º
        logNotificationCard.classList.remove('d-none');
    } else {
        alert.className = 'alert alert-info mb-4';
        message.innerHTML = 'ğŸ”’ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ç„¡åŠ¹<br>è¨­å®šã®å¤‰æ›´ã«ã¯ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«ã™ã‚‹
        formInputs.forEach(input => {
            input.setAttribute('readonly', 'readonly');
            input.classList.remove('form-control');
            input.classList.add('form-control-plaintext');
        });
        
        // ãƒ­ã‚°é€šçŸ¥è¨­å®šã‚’éè¡¨ç¤º
        logNotificationCard.classList.add('d-none');
    }
}

// URLæ¤œè¨¼
function validateUrl(inputId) {
    const input = document.getElementById(inputId);
    const url = input.value.trim();
    
    if (!url) {
        showNotification('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
        return;
    }
    
    // URLå½¢å¼ã®æ¤œè¨¼
    try {
        const urlObj = new URL(url);
        
        // Google Formsã¾ãŸã¯Google Apps Script URLã‹ãƒã‚§ãƒƒã‚¯
        if (inputId !== 'qrPageUrl' && !url.includes('docs.google.com/forms')) {
            throw new Error('Google Formsã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
        if (inputId === 'qrPageUrl' && !url.includes('script.google.com')) {
            throw new Error('Google Apps Scriptã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // æ¤œè¨¼æˆåŠŸ
        input.classList.remove('validation-error');
        input.classList.add('validation-success');
        showNotification('URLã®å½¢å¼ã¯æœ‰åŠ¹ã§ã™ã€‚', 'success');
        
        // 3ç§’å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        setTimeout(() => {
            input.classList.remove('validation-success');
        }, 3000);
        
    } catch (error) {
        input.classList.remove('validation-success');
        input.classList.add('validation-error');
        showNotification(error.message || 'URLã®å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚', 'danger');
        
        // 3ç§’å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        setTimeout(() => {
            input.classList.remove('validation-error');
        }, 3000);
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ URLã®ä¿å­˜
function saveFormUrls() {
    const debugMode = document.getElementById('debugModeSwitch').checked;
    if (!debugMode) {
        showNotification('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã®ãŸã‚ã€è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚', 'warning');
        return;
    }
    
    const settings = {
        terminalFormUrl: document.getElementById('terminalFormUrl').value.trim(),
        printerFormUrl: document.getElementById('printerFormUrl').value.trim(),
        qrPageUrl: document.getElementById('qrPageUrl').value.trim()
    };
    
    // ä¿å­˜ä¸­ã®è¡¨ç¤º
    const saveBtn = document.getElementById('saveFormUrlBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
    
    google.script.run.withSuccessHandler(function(result) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        
        if (result.success) {
            showNotification('ãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
        } else {
            showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
        }
    }).withFailureHandler(function(error) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        handleError(error);
    }).saveFormUrlSettings(settings);
}

// ãƒ•ã‚©ãƒ¼ãƒ URLã®ãƒªã‚»ãƒƒãƒˆ
function resetFormUrls() {
    showConfirmModal(
        'ãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
        function() {
            document.getElementById('terminalFormUrl').value = '';
            document.getElementById('printerFormUrl').value = '';
            document.getElementById('qrPageUrl').value = '';
            showNotification('ãƒ•ã‚©ãƒ¼ãƒ URLè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚', 'info');
        }
    );
}

// ãƒ­ã‚°é€šçŸ¥è¨­å®šã®ä¿å­˜
function saveLogNotificationSettings() {
    const settings = {
        errorNotificationEmail: document.getElementById('errorNotificationEmail').value.trim(),
        alertNotificationEmail: document.getElementById('alertNotificationEmail').value.trim()
    };
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼
    if (!validateEmails(settings.errorNotificationEmail) || 
        !validateEmails(settings.alertNotificationEmail)) {
        return;
    }
    
    google.script.run.withSuccessHandler(function(result) {
        if (result.success) {
            showNotification('ãƒ­ã‚°é€šçŸ¥è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
        } else {
            showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
        }
    }).withFailureHandler(handleError)
    .saveLogNotificationSettings(settings);
}

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼
function validateEmails(emailString) {
    if (!emailString) return true; // ç©ºã®å ´åˆã¯è¨±å¯
    
    const emails = emailString.split(',').map(e => e.trim());
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    for (const email of emails) {
        if (!emailRegex.test(email)) {
            showNotification(`ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}`, 'danger');
            return false;
        }
    }
    
    return true;
}

// ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
function testEmail(type) {
    const emailField = type === 'error' ? 'errorNotificationEmail' : 'alertNotificationEmail';
    const emails = document.getElementById(emailField).value.trim();
    
    if (!emails) {
        showNotification('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
        return;
    }
    
    if (!validateEmails(emails)) {
        return;
    }
    
    // é€ä¿¡ä¸­ã®è¡¨ç¤º
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€ä¿¡ä¸­...';
    
    google.script.run.withSuccessHandler(function(result) {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (result.success) {
            showNotification('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚', 'success');
            
            // çµæœã‚’è¡¨ç¤º
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-email-result text-success';
            resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> é€ä¿¡å®Œäº†';
            btn.parentElement.appendChild(resultDiv);
            
            setTimeout(() => resultDiv.remove(), 5000);
        } else {
            showNotification('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
        }
    }).withFailureHandler(function(error) {
        btn.disabled = false;
        btn.innerHTML = originalText;
        handleError(error);
    }).sendTestEmail(type, emails);
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é€šçŸ¥è¨­å®šã®ä¿å­˜
function saveGlobalNotificationSetting(enabled) {
    google.script.run.withSuccessHandler(function(result) {
        if (result.success) {
            showNotification(
                `ã‚°ãƒ­ãƒ¼ãƒãƒ«é€šçŸ¥è¨­å®šã‚’${enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ã—ã¾ã—ãŸã€‚`,
                'success'
            );
            // æ‹ ç‚¹åˆ¥é€šçŸ¥è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
            loadLocationNotifications();
        } else {
            showNotification('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…ƒã«æˆ»ã™
            document.getElementById('globalNotificationEnabled').checked = !enabled;
        }
    }).withFailureHandler(handleError)
    .saveGlobalNotificationSetting(enabled);
}

// æ‹ ç‚¹åˆ¥é€šçŸ¥è¨­å®šã®èª­ã¿è¾¼ã¿
function loadLocationNotifications() {
    const tbody = document.getElementById('locationNotificationList');
    tbody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </td>
        </tr>
    `;
    
    google.script.run.withSuccessHandler(function(locations) {
        tbody.innerHTML = '';
        
        if (locations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                    </td>
                </tr>
            `;
            return;
        }
        
        locations.forEach(location => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${location.code} - ${location.name}</td>
                <td>
                    ${location.email || '<span class="text-muted">æœªè¨­å®š</span>'}
                </td>
                <td>
                    ${location.notificationEnabled ? 
                        '<i class="fas fa-check-circle notification-enabled"></i> æœ‰åŠ¹' : 
                        '<i class="fas fa-times-circle notification-disabled"></i> ç„¡åŠ¹'}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }).withFailureHandler(handleError)
    .getLocationList();
}

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ä¿å­˜
function saveSystemSettings() {
    const debugMode = document.getElementById('debugModeSwitch').checked;
    
    google.script.run.withSuccessHandler(function(result) {
        if (result.success) {
            showNotification('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
            // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°
            document.getElementById('lastSystemUpdate').textContent = 
                new Date().toLocaleString('ja-JP');
        } else {
            showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
        }
    }).withFailureHandler(handleError)
    .saveSystemSettings({ debugMode });
}

// ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
function showConfirmModal(message, onConfirm, onCancel) {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmMessage').textContent = message;
    
    const confirmBtn = document.getElementById('confirmButton');
    
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    newConfirmBtn.addEventListener('click', function() {
        modal.hide();
        if (onConfirm) onConfirm();
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function(e) {
        if (onCancel) onCancel();
    }, { once: true });
    
    modal.show();
}

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
function handleError(error) {
    console.error('è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
    showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(message, type = 'info', duration = 5000) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '70px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    if (duration > 0) {
        setTimeout(() => {
            alertDiv.remove();
        }, duration);
    }
}
</script>