# 代替機管理システム (Google Apps Script Web App)

## 概要
Google Apps Script (GAS) を使用した包括的な代替機管理システムです。スプレッドシートのデータを閲覧・編集できるWebアプリケーションとして動作し、高速なデータアクセスと直感的なユーザーインターフェースを提供します。さらに、拠点管理番号を基にしたGoogle Formsの自動作成機能により、代替機依頼プロセスを効率化します。

## 主な機能

### 基本機能
- **ダッシュボード**: 各機能へのナビゲーション
- **スプレッドシートビューアー**: 各拠点のデータを閲覧・編集（拠点管理番号をシート名として使用）
- **ドラッグ&ドロップ**: テーブルの列を自由に並び替え
- **ステータス管理**: 貸出機器のステータスをリアルタイムで更新

### 新機能（v2.0）
- **オープニング画面**: 起動時に美しいローディング画面を表示
- **データプリロード**: 全拠点のデータを事前読み込みして高速表示
- **更新ボタン**: 選択中拠点のデータを手動で最新化
- **エラーハンドリング**: スプレッドシートID未設定拠点の適切な処理
- **データフィルタリング**: 貸出中データがない場合の「なし」表示
- **パフォーマンス最適化**: プリロードデータ活用による高速表示

### 新機能（v2.1）
- **拠点管理番号シート対応**: 拠点管理番号（osaka_desktop、kobe等）を直接シート名として使用

### 新機能（v2.2）
- **拠点管理番号ドリルダウン機能**: mainシートの一覧から拠点管理番号をクリックして代替機フォーム回答シートを表示
- **戻るボタン**: 代替機フォーム回答シートから一覧へ簡単に戻れるナビゲーション
- **インタラクティブUI**: 拠点管理番号リンクのホバーエフェクトとクリック体験を向上
- **セル編集機能**: 代替機フォーム回答シート内の任意のセルをクリックして編集可能（mainシートは数式により自動更新のため編集不可）

### 新機能（v2.3）
- **監査データビューアー**: SPREADSHEET_ID_DESTINATIONから監査用シート（大阪、神戸、姫路）を表示
- **サマリーデータビューアー**: SPREADSHEET_ID_DESTINATIONからサマリーシートを表示
- **シートタイプ選択**: 通常データ、監査データ、サマリーを切り替え可能
- **読み取り専用表示**: 監査・サマリーデータは編集機能なしで表示

### 新機能（v3.0）- フォーム作成システム 🎉
- **Google Forms自動作成**: 拠点管理番号を基にGoogle Formsを動的に作成
- **代替機種別対応**: 端末（SV/CL）とプリンタ・その他の2種類をサポート
- **拠点別カスタマイズ**: 各拠点に特化した属性フィールドの動的生成
- **QRコード自動生成**: 高品質QRコード（600x600px、エラー訂正レベルH）の自動生成・保存
- **安全なQRコード表示**: Base64エンコード画像でCORS制限を回避し、確実な画像表示
- **柔軟な拠点管理番号検証**: プレフィックス（英字2文字以上）のみ検証、サフィックスは自由入力
- **フォーム設定最適化**: 回答受付無効、カスタム確認メッセージ、デバイス固有URL表示
- **作成済みフォーム管理**: フォーム一覧表示、削除機能
- **外部API連携**: QR Server APIによる高品質QRコード生成
- **読み取りテスト促進**: QRコード表示時に読み取り確認を促すUI

## ファイル構造
```
├── Index.html                       # メインのHTMLファイル
├── Code.gs                          # Google Apps Scriptのサーバーサイドコード
├── form-creation.gs                 # フォーム作成・QRコード生成機能
├── styles.html                      # グローバルスタイルシート
├── dashboard-styles.html            # ダッシュボード専用スタイル
├── spreadsheet-styles.html          # スプレッドシート専用スタイル
├── opening-screen-styles.html       # オープニング画面専用スタイル
├── form-creator-styles.html         # フォーム作成専用スタイル
├── navigation.html                  # ナビゲーションバーコンポーネント
├── dashboard.html                   # ダッシュボードページ
├── spreadsheet.html                 # スプレッドシートビューアーページ
├── form-creator.html                # フォーム作成ページ
├── opening-screen.html              # オープニング画面コンポーネント
├── coming-soon.html                 # 準備中ページテンプレート
├── main.html                        # メインJavaScriptコード
├── spreadsheet-functions.html       # スプレッドシート関連JavaScript
├── form-creator-functions.html      # フォーム作成関連JavaScript
├── opening-screen-functions.html    # オープニング画面・プリロード機能
├── drag-drop-functions.html         # ドラッグ&ドロップ関連JavaScript
└── README.md                        # このファイル
```

## セットアップ方法

### 1. プロジェクトの作成
1. [Google Apps Script](https://script.google.com/) にアクセス
2. 新しいプロジェクトを作成
3. すべてのファイルをプロジェクトにアップロード

### 2. スクリプトプロパティの設定
スクリプトプロパティに各拠点のスプレッドシートIDとフォーム作成関連の設定を行ってください：

#### 通常データ用スプレッドシート
| プロパティキー | 対応拠点 | 必須 |
|---|---|---|
| `SPREADSHEET_ID_SOURCE_OSAKA_DESKTOP` | 大阪(デスクトップ) | ○ |
| `SPREADSHEET_ID_SOURCE_OSAKA_LAPTOP` | 大阪(ノート、サーバー) | ○ |
| `SPREADSHEET_ID_SOURCE_KOBE` | 神戸(端末) | ○ |
| `SPREADSHEET_ID_SOURCE_HIMEJI` | 姫路(端末) | ○ |
| `SPREADSHEET_ID_SOURCE_OSAKA_PRINTER` | 大阪(プリンタ、その他) | ○ |
| `SPREADSHEET_ID_SOURCE_HYOGO_PRINTER` | 兵庫(プリンタ、その他) | ○ |

#### 監査・サマリーデータ用スプレッドシート
| プロパティキー | 用途 | 必須 |
|---|---|---|
| `SPREADSHEET_ID_DESTINATION` | 監査データ・サマリーデータ | ○ |

#### フォーム作成機能設定
| プロパティキー | 用途 | 必須 | 設定例 |
|---|---|---|---|
| `QR_CODE_FOLDER_KEY` | QRコード保存先GoogleドライブフォルダID | ○ | `1ABC...xyz` |
| `form_base_terminal` | 端末用フォームベースURL | ○ | `https://example.com/terminal?id=` |
| `form_base_printer` | プリンタ用フォームベースURL | ○ | `https://example.com/printer?id=` |

**注意**: 
- 未設定の拠点があっても動作しますが、該当拠点選択時にエラーメッセージが表示されます
- QRコード機能を使用する場合は`QR_CODE_FOLDER_KEY`の設定が必須です
- フォームベースURLは各代替機種別に対応したURLを設定してください

#### フォーム作成機能のクイックセットアップ
管理者用のヘルパー関数を使用して簡単にセットアップできます：

```javascript
// QRコード保存先フォルダIDを設定
setQRCodeFolderId('YOUR_FOLDER_ID');

// デバイスURLを設定
setDeviceUrls({
  terminal: 'https://example.com/terminal?id=',
  printer: 'https://example.com/printer?id='
});

// 設定確認
getQRCodeFolderSettings();
getDeviceUrlSettings();
```

### 2.1. スプレッドシート構造の要件
各拠点のスプレッドシートは以下の構造である必要があります：

- **mainシート**: 代替機一覧が集約されたメインシート（1行目にヘッダー行、2行目以降にデータ行）
- **代替機フォーム回答シート**: 各拠点の詳細データ用シート（例：`osaka_desktop`、`kobe`、`himeji`など）
- **列構成**: システムが期待する列構成に合わせてください

**機能の流れ:**
1. 拠点を選択するとmainシートの一覧が表示されます（数式により自動更新、編集不可）
2. 一覧内の拠点管理番号をクリックすると、その拠点管理番号と同名の代替機フォーム回答シートが表示されます
3. 代替機フォーム回答シート内の任意のセルをクリックして編集できます
4. 戻るボタンで一覧に戻ることができます（編集内容はmainシートに自動反映）

例）拠点管理番号が `osaka_desktop` の場合：
- mainシートの一覧で `osaka_desktop` をクリック
- スプレッドシート内の `osaka_desktop` 代替機フォーム回答シートの詳細データが表示される
- セルをクリックして内容を編集可能

### 3. デプロイ
1. Google Apps Scriptエディタで「デプロイ」→「新しいデプロイ」を選択
2. 種類を「ウェブアプリ」に設定
3. 実行ユーザーとアクセス権限を適切に設定
4. デプロイしてWebアプリURLを取得

## 使用方法

### 基本的な操作
1. **起動**: WebアプリURLにアクセス
2. **データ読み込み**: オープニング画面で全拠点データが自動読み込み
3. **拠点選択**: スプレッドシートビューアーで拠点を選択
4. **データ表示**: プリロードデータにより高速表示
5. **データ更新**: 更新ボタンで最新データを取得

### 高度な機能
- **フィルタリング**: 「一覧」「貸出中」でデータを絞り込み
- **拠点ドリルダウン**: 一覧から拠点管理番号をクリックして代替機フォーム回答シートを表示
- **セル編集**: 代替機フォーム回答シート内のセルをクリックして内容を編集（mainシートは数式により自動更新）
- **シートタイプ切り替え**: 
  - **通常データ**: 各拠点のSOURCEスプレッドシートから取得
  - **監査データ**: DESTINATIONスプレッドシートの監査用シート（大阪/神戸/姫路）から取得
  - **サマリー**: DESTINATIONスプレッドシートのサマリーシートから取得

### フォーム作成機能
1. **フォーム新規作成**: ナビゲーションから「フォーム編集」を選択
2. **代替機種別選択**: 端末（SV/CL）またはプリンタ・その他を選択
3. **拠点選択**: 選択した代替機種別に対応する拠点を選択
4. **拠点管理番号入力**: プレフィックス_サフィックス形式で入力（例：Osaka_001）
5. **詳細カテゴリ選択**: 代替機の詳細カテゴリを選択
6. **属性情報入力**: 代替機の詳細情報を入力
7. **フォーム作成**: 作成ボタンでGoogle Formsを自動生成
8. **QRコード確認**: 作成完了後、QRコードの読み取りテストを実施

#### 拠点管理番号の命名規則
- **形式**: `プレフィックス_サフィックス`
- **プレフィックス**: 英字2文字以上（例：Osaka、Tokyo、Hime）
- **サフィックス**: 制限なし（英数字、特殊文字、日本語も可）
- **有効例**: `Osaka_001`、`Tokyo_special-device`、`Hime_テスト用`

#### 作成済みフォーム管理
- **フォーム一覧**: 「作成済み管理」タブで確認可能
- **削除機能**: 不要なフォームを削除可能
- **更新機能**: 一覧を手動で更新可能

## 開発時の注意点

### プロジェクトルール

#### **スタイル・テーマ統一規則**
- **基調カラー**: ナビゲーションのハイライトカラー（`--highlight-color: #3b82f6`）に統一
- **グラデーション**: `--highlight-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)`を使用
- **シャドウ**: インタラクション時は`--shadow-blue: 0 4px 14px 0 rgba(59, 130, 246, 0.15)`を使用
- **一貫性**: 全てのボタン、リンク、フォーカス状態は同一カラーテーマで統一
- **カスタムカラー禁止**: CSS変数で定義されていない独自カラーの使用を避ける

#### **カラーパレット**
```css
--highlight-color: #3b82f6      /* メインのハイライトカラー */
--highlight-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)
--shadow-blue: 0 4px 14px 0 rgba(59, 130, 246, 0.15)
```

### デバッグモード
- **制御場所**: `main.html` の `DEBUG_MODE` 変数
- **開発時**: `DEBUG_MODE = true`（詳細ログ出力）
- **本番時**: `DEBUG_MODE = false`（パフォーマンス優先）

### パフォーマンス設定
- **サーバーサイド**: `Code.gs` の `DEBUG` 定数で制御
- **プリロード**: オープニング画面で自動実行
- **キャッシュ**: プリロードデータを活用して高速表示

### エラーハンドリング
- スプレッドシートID未設定拠点は警告表示
- 通信エラー時は適切なエラーメッセージ表示
- データなし時は「なし」メッセージ表示
- QRコード生成失敗時の詳細エラー情報表示

### 新機能の追加
- **ページ追加**: `navigation.html` にリンクを追加
- **スタイル追加**: 専用スタイルファイルを作成
- **JavaScript追加**: 機能別ファイルに分割

## システム要件
- Google Apps Script環境
- モダンブラウザ（Chrome、Firefox、Safari、Edge）
- インターネット接続
- QRコード機能使用時：QR Server API アクセス

## トラブルシューティング

### よくある問題

#### 基本機能関連
1. **オープニング画面が表示されない**
   - ブラウザのJavaScriptが有効か確認
   - ファイルが正しくアップロードされているか確認

2. **拠点データが表示されない**
   - スクリプトプロパティの設定を確認
   - スプレッドシートIDが正しいか確認
   - スプレッドシートの共有設定を確認

3. **更新ボタンが動作しない**
   - 拠点が選択されているか確認
   - ネットワーク接続を確認

4. **パフォーマンスが低下している**
   - DEBUG_MODE を false に設定
   - ブラウザのキャッシュをクリア

#### フォーム作成機能関連
5. **フォーム作成でエラーが発生する**
   - スクリプトプロパティ`QR_CODE_FOLDER_KEY`の設定を確認
   - フォルダIDが正しく、アクセス権限があるか確認
   - フォームベースURLが正しく設定されているか確認

6. **QRコードが表示されない**
   - GoogleドライブのQRコード保存先フォルダの共有設定を確認
   - ブラウザの開発者ツールでコンソールエラーを確認
   - Base64画像データの生成エラーがないか確認

7. **拠点管理番号のバリデーションエラー**
   - プレフィックスが英字2文字以上か確認
   - アンダースコア（_）で区切られているか確認
   - 特殊文字が含まれている場合は問題なし

8. **Cannot read properties of null エラー**
   - フォーム要素の存在確認が実装済み
   - ブラウザの開発者ツールで詳細を確認

### サポート情報
- **ログ確認**: デバッグモードでコンソールログを確認
- **エラー詳細**: エラーメッセージの詳細を確認
- **プリロード状況**: オープニング画面の進捗を確認
- **QRコード診断**: デバッグ関数（`debugQRCodeGeneration`、`testQRCodeGeneration`）を使用

### 管理者向けデバッグ関数
フォーム作成機能のトラブルシューティング用関数：

```javascript
// QRコード機能の総合診断
debugQRCodeGeneration('Test_001', 'terminal');

// QRコード設定の確認
checkQRCodeSettings();

// QRコード生成のテスト
testQRCodeGeneration();

// 拠点管理番号検証のテスト
testLocationNumberValidation();
```

## API連携情報

### 外部API
- **QR Server API**: `https://api.qrserver.com/v1/create-qr-code/`
  - 高品質QRコード生成（600x600px、エラー訂正レベルH）
  - 無料・安全・高速なQRコード生成サービス

### 内部API
- **Google Forms API**: フォーム作成、設定変更
- **Google Drive API**: QRコードファイル保存、共有設定
- **Google Sheets API**: スプレッドシートデータ操作

## セキュリティ考慮事項
- QRコードファイルは限定共有（リンク知っている人のみ）
- フォーム作成時の入力値検証
- スクリプトプロパティによる設定の分離
- エラー情報の適切な制限

## 今後の拡張予定
- [x] フォーム作成機能（完了）
- [ ] フォーム回答データの自動集計機能
- [ ] QRコード一括生成機能
- [ ] フォームテンプレート機能

## 更新履歴
- **v3.0**: フォーム作成システムを追加（Google Forms自動作成、QRコード生成、読み取りテスト機能）
- **v2.3**: 監査データ・サマリーデータビューアー機能を追加（SPREADSHEET_ID_DESTINATION対応）
- **v2.2**: 拠点管理番号ドリルダウン機能とナビゲーション機能を追加
- **v2.1**: 拠点管理番号をシート名として直接使用するよう機能改善
- **v2.0**: オープニング画面、プリロード機能、更新ボタン、エラーハンドリング強化
- **v1.0**: 基本的なスプレッドシートビューアー機能

## ライセンス
内部利用のみ