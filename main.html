<!-- main.html - メインJavaScriptコード -->
<script>
  // ========================================
  // グローバル変数
  // ========================================
  const DEBUG_MODE = true; // 本番環境では false に設定
  let currentLocation = '';
  let columnOrder = [];
  let draggedColumnIndex = -1;

  // ========================================
  // 初期化
  // ========================================
  window.onload = function () {
    showDebugInfo('ページ読み込み完了', {});

    if (DEBUG_MODE) {
      // デバッグモードの場合はオープニングをスキップして直接初期化
      showDebugInfo('デバッグモード: オープニングスキップ', {});
      // ダッシュボードページを明示的に表示
      showPage('dashboard');
      initializeLocations();
    } else {
      // 本番モードの場合はオープニング画面を表示してデータ一括読み込みを開始
      showOpeningScreenAndPreload();

      // スプレッドシートページの初期化（オープニング後に実行）
      setTimeout(() => {
        initializeLocations();
      }, 1000);
    }

    // デバッグモードがオフの場合はデバッグセクションを非表示
    if (!DEBUG_MODE) {
      const debugSection = document.getElementById('debug');
      if (debugSection) {
        debugSection.style.display = 'none';
      }
    }
  };

  // ========================================
  // ページ遷移機能
  // ========================================
  function showPage(pageId) {
    // 全てのページを非表示
    document.querySelectorAll('.page-content').forEach(page => {
      page.classList.remove('active');
    });

    // 全てのナビリンクからactiveクラスを削除
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });

    // 指定されたページを表示
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
      targetPage.classList.add('active');
    }

    // 対応するナビリンクにactiveクラスを追加
    const targetLink = document.querySelector(`[onclick="showPage('${pageId}'); return false;"]`);
    if (targetLink) {
      targetLink.classList.add('active');
    }

    // スプレッドシートページの場合、初期化処理を実行
    if (pageId === 'spreadsheet') {
      if (DEBUG_MODE) {
        showDebugInfo('showPage: スプレッドシートページ表示', { pageId });
      }
      
      // 新しい初期化関数を使用
      setTimeout(() => {
        if (typeof window.initSpreadsheetPage === 'function') {
          console.log('Calling initSpreadsheetPage');
          window.initSpreadsheetPage();
        } else {
          console.error('initSpreadsheetPage function not found');
          
          // フォールバック: 直接データを読み込む
          console.log('Fallback: Loading data directly');
          
          // データタイプマスタを直接読み込む
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(response) {
                if (response.success && response.dataTypes) {
                  const dataTypeSelect = document.getElementById('dataType');
                  if (dataTypeSelect) {
                    dataTypeSelect.innerHTML = '<option value="">データタイプを選択してください</option>';
                    response.dataTypes.forEach(dataType => {
                      const option = document.createElement('option');
                      option.value = dataType.dataTypeId;
                      option.textContent = dataType.dataTypeName;
                      dataTypeSelect.appendChild(option);
                    });
                    console.log('Data types loaded:', response.dataTypes.length);
                  }
                }
              })
              .withFailureHandler(function(error) {
                console.error('Failed to load data types:', error);
                const dataTypeSelect = document.getElementById('dataType');
                if (dataTypeSelect) {
                  dataTypeSelect.innerHTML = '<option value="">データタイプの読み込みに失敗しました</option>';
                }
              })
              .getDataTypeMaster(true);
              
            // 拠点マスタも読み込む
            google.script.run
              .withSuccessHandler(function(response) {
                if (response.success && response.locations) {
                  const locationSelect = document.getElementById('location');
                  if (locationSelect) {
                    locationSelect.innerHTML = '<option value="">拠点を選択してください</option>';
                    Object.entries(response.locations).forEach(([key, name]) => {
                      const option = document.createElement('option');
                      option.value = key;
                      option.textContent = name;
                      locationSelect.appendChild(option);
                    });
                    console.log('Locations loaded:', Object.keys(response.locations).length);
                  }
                }
              })
              .withFailureHandler(function(error) {
                console.error('Failed to load locations:', error);
              })
              .getLocations();
          }
        }
      }, 300);
    }

    // URL生成ページの場合、URL生成機能を初期化
    if (pageId === 'url-generator') {
      console.log('showPage: URL生成ページが選択されました');
      if (DEBUG_MODE) {
        showDebugInfo('showPage: URL生成ページ表示', { pageId });
      }
      setTimeout(() => {
        console.log('showPage: URL生成機能初期化を試行');
        console.log('window.onUrlGeneratorPageShow:', typeof window.onUrlGeneratorPageShow);
        if (typeof window.onUrlGeneratorPageShow === 'function') {
          console.log('showPage: onUrlGeneratorPageShow関数が見つかりました。実行します。');
          if (DEBUG_MODE) {
            showDebugInfo('showPage遅延実行: URL生成機能初期化', {});
          }
          window.onUrlGeneratorPageShow();
        } else if (typeof onUrlGeneratorPageShow === 'function') {
          console.log('showPage: グローバルonUrlGeneratorPageShow関数が見つかりました。実行します。');
          if (DEBUG_MODE) {
            showDebugInfo('showPage遅延実行: URL生成機能初期化', {});
          }
          onUrlGeneratorPageShow();
        } else {
          console.error('showPage: onUrlGeneratorPageShow関数が見つかりません');
          console.log('利用可能な関数:', Object.keys(window).filter(k => k.includes('onUrl')));
          if (DEBUG_MODE) {
            showDebugInfo('showPage: onUrlGeneratorPageShow関数が見つからない', {});
          }
          // 再試行
          setTimeout(() => {
            if (typeof window.onUrlGeneratorPageShow === 'function') {
              console.log('showPage: 再試行でonUrlGeneratorPageShow関数が見つかりました。実行します。');
              window.onUrlGeneratorPageShow();
            }
          }, 500);
        }
      }, 100);
    }

    // 機種マスタページの場合、機種マスタ機能を初期化
    if (pageId === 'model-master') {
      if (DEBUG_MODE) {
        showDebugInfo('showPage: 機種マスタページ表示', { pageId });
      }
      setTimeout(() => {
        if (typeof onModelMasterPageShow === 'function') {
          if (DEBUG_MODE) {
            showDebugInfo('showPage遅延実行: 機種マスタ機能初期化', {});
          }
          onModelMasterPageShow();
        } else {
          if (DEBUG_MODE) {
            showDebugInfo('showPage: onModelMasterPageShow関数が見つからない', {});
          }
        }
      }, 100);
    }

    // 拠点マスタページの場合、拠点マスタ機能を初期化
    if (pageId === 'location-master') {
      if (DEBUG_MODE) {
        showDebugInfo('showPage: 拠点マスタページ表示', { pageId });
      }
      setTimeout(() => {
        if (typeof onLocationMasterPageShow === 'function') {
          if (DEBUG_MODE) {
            showDebugInfo('showPage遅延実行: 拠点マスタ機能初期化', {});
          }
          onLocationMasterPageShow();
        } else {
          if (DEBUG_MODE) {
            showDebugInfo('showPage: onLocationMasterPageShow関数が見つからない', {});
          }
        }
      }, 100);
    }

    // データタイプマスタページの場合、データタイプマスタ機能を初期化
    if (pageId === 'data-type-master') {
      if (DEBUG_MODE) {
        showDebugInfo('showPage: データタイプマスタページ表示', { pageId });
      }
      setTimeout(() => {
        if (typeof onDataTypeMasterPageShow === 'function') {
          if (DEBUG_MODE) {
            showDebugInfo('showPage遅延実行: データタイプマスタ機能初期化', {});
          }
          onDataTypeMasterPageShow();
        } else {
          if (DEBUG_MODE) {
            showDebugInfo('showPage: onDataTypeMasterPageShow関数が見つからない', {});
          }
        }
      }, 100);
    }

    // 設定ページの場合、設定機能を初期化
    if (pageId === 'settings') {
      if (DEBUG_MODE) {
        showDebugInfo('showPage: 設定ページ表示', { pageId });
      }
      setTimeout(() => {
        if (typeof onSettingsPageShow === 'function') {
          if (DEBUG_MODE) {
            showDebugInfo('showPage遅延実行: 設定機能初期化', {});
          }
          onSettingsPageShow();
        } else {
          if (DEBUG_MODE) {
            showDebugInfo('showPage: onSettingsPageShow関数が見つからない', {});
          }
        }
      }, 100);
    }

    // スクロール位置をトップに
    window.scrollTo(0, 0);
  }

  // ========================================
  // デバッグ関連
  // ========================================
  function showDebugInfo(message, data) {
    if (!DEBUG_MODE) return;

    const debugInfo = document.getElementById('debugInfo');
    const timestamp = new Date().toISOString();
    const debugMessage = `[${timestamp}] ${message}\n${JSON.stringify(data, null, 2)}\n\n`;

    if (debugInfo) {
      debugInfo.textContent = (debugInfo.textContent || '') + debugMessage;
    } else {
      // Fallback to console if debugInfo element doesn't exist
      console.log(`[DEBUG] ${message}`, data);
    }
  }

  function showServerLogs(logs) {
    if (!DEBUG_MODE) return;
    if (!logs || !Array.isArray(logs)) return;

    const debugInfo = document.getElementById('debugInfo');
    logs.forEach(log => {
      const debugMessage = `[SERVER ${log.timestamp}] ${log.message}\n${JSON.stringify(log.data, null, 2)}\n\n`;

      if (debugInfo) {
        debugInfo.textContent = (debugInfo.textContent || '') + debugMessage;
      } else {
        // Fallback to console if debugInfo element doesn't exist
        console.log(`[SERVER DEBUG] ${log.message}`, log.data);
      }
    });
  }

  function clearDebugInfo() {
    if (!DEBUG_MODE) return;

    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
      debugInfo.textContent = '';
    }
  }

  function toggleDebugMode() {
    if (!DEBUG_MODE) return;

    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
      debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    }
  }

  function exportDebugInfo() {
    if (!DEBUG_MODE) return;

    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
      const debugText = debugInfo.textContent;
      const blob = new Blob([debugText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug_log_${new Date().getTime()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function convertSerialToDate(serial) {
    if (!serial || isNaN(serial)) return '';

    // 1900年1月1日からの経過日数を計算
    const date = new Date((serial - 25569) * 86400 * 1000);

    // 日付をフォーマット
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');

    return `${year}/${month}/${day}`;
  }

  function showPopupMessage(message) {
    const popup = document.getElementById('popupMessage');
    popup.textContent = message;
    popup.classList.add('show');
    popup.style.display = 'block';
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
      }, 600);
    }, 1800);
  }
</script>