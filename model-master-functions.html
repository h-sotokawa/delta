<!-- model-master-functions.html - 機種マスタ管理ページの機能 -->
<script>
  // ========================================
  // ページ読み込み後の初期化
  // ========================================
  function onModelMasterPageShow() {
    console.log('機種マスタページが表示されました');
    loadModelList();
    loadFilterCategories();
  }

  // ========================================
  // 機種追加機能
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    const modelAddForm = document.getElementById('modelAddForm');
    if (modelAddForm) {
      modelAddForm.addEventListener('submit', function(e) {
        e.preventDefault();
        addNewModel();
      });
    }

    const modelEditForm = document.getElementById('modelEditForm');
    if (modelEditForm) {
      modelEditForm.addEventListener('submit', function(e) {
        e.preventDefault();
        updateModel();
      });
    }
  });

  function addNewModel() {
    const form = document.getElementById('modelAddForm');
    const formData = new FormData(form);
    
    const modelData = {
      modelName: formData.get('modelName'),
      manufacturer: formData.get('manufacturer'),
      category: formData.get('category'),
      remarks: formData.get('remarks') || ''
    };

    console.log('新規機種登録データ:', modelData);

    if (!modelData.modelName || !modelData.manufacturer || !modelData.category) {
      showMessage('必須項目を入力してください', 'error');
      return;
    }

    // Google Apps Scriptで機種を追加
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種追加結果:', result);
        
        if (result.success) {
          showMessage('機種を登録しました', 'success');
          resetModelForm();
          loadModelList();
        } else {
          showMessage('機種の登録に失敗しました: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種追加でエラー:', error);
        showMessage('エラーが発生しました: ' + error.toString(), 'error');
      })
      .addModelMasterData(modelData);
  }

  function resetModelForm() {
    document.getElementById('modelAddForm').reset();
  }

  // ========================================
  // 機種一覧表示機能
  // ========================================
  function loadModelList() {
    const container = document.getElementById('model-list-container');
    
    container.innerHTML = `
      <div class="loading-placeholder">
        <i class="fas fa-spinner fa-spin"></i>
        <p>機種一覧を読み込み中...</p>
      </div>
    `;

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種一覧取得結果:', result);
        displayModelList(result);
      })
      .withFailureHandler(function(error) {
        console.error('機種一覧取得でエラー:', error);
        container.innerHTML = `
          <div class="error-placeholder">
            <i class="fas fa-exclamation-triangle"></i>
            <p>機種一覧の読み込みに失敗しました</p>
            <button class="btn btn-primary" onclick="loadModelList()">再読み込み</button>
          </div>
        `;
      })
      .getModelMasterData();
  }

  function displayModelList(result) {
    const container = document.getElementById('model-list-container');
    
    if (!result.success) {
      container.innerHTML = `
        <div class="error-placeholder">
          <i class="fas fa-exclamation-triangle"></i>
          <p>データの取得に失敗しました: ${result.error}</p>
        </div>
      `;
      return;
    }

    if (!result.data || result.data.length <= 1) {
      container.innerHTML = `
        <div class="empty-placeholder">
          <i class="fas fa-database"></i>
          <p>登録されている機種がありません</p>
          <p>上のフォームから機種を登録してください</p>
        </div>
      `;
      return;
    }

    // テーブルを作成
    let tableHtml = `
      <div class="table-container">
        <table class="model-table" id="modelTable">
          <thead>
            <tr>
              <th>機種名</th>
              <th>メーカー</th>
              <th>カテゴリ</th>
              <th>作成日時</th>
              <th>更新日時</th>
              <th>備考</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
    `;

    // データ行を追加（ヘッダー行をスキップ）
    for (let i = 1; i < result.data.length; i++) {
      const row = result.data[i];
      const rowIndex = i - 1; // ヘッダー行を除いたインデックス
      
      tableHtml += `
        <tr data-category="${row[2]}" data-search="${(row[0] + ' ' + row[1]).toLowerCase()}">
          <td>${row[0] || ''}</td>
          <td>${row[1] || ''}</td>
          <td>${row[2] || ''}</td>
          <td>${formatDate(row[3])}</td>
          <td>${formatDate(row[4])}</td>
          <td>${row[5] || ''}</td>
          <td class="action-buttons">
            <button class="btn btn-sm btn-info" onclick="editModel(${rowIndex}, ${JSON.stringify(row).replace(/"/g, '&quot;')})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteModel(${rowIndex}, '${row[0]}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }

    tableHtml += `
          </tbody>
        </table>
      </div>
      <div class="table-info">
        <p>登録件数: ${result.data.length - 1}件</p>
      </div>
    `;

    container.innerHTML = tableHtml;
  }

  // ========================================
  // フィルタリング機能
  // ========================================
  function loadFilterCategories() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          const filterSelect = document.getElementById('filter-category');
          filterSelect.innerHTML = '<option value="">すべてのカテゴリ</option>';
          
          result.categories.forEach(function(category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            filterSelect.appendChild(option);
          });
        }
      })
      .withFailureHandler(function(error) {
        console.error('カテゴリ取得でエラー:', error);
      })
      .getAvailableCategories();
  }

  function filterModelList() {
    const categoryFilter = document.getElementById('filter-category').value;
    const searchText = document.getElementById('search-text').value.toLowerCase();
    const table = document.getElementById('modelTable');
    
    if (!table) return;
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const category = row.getAttribute('data-category');
      const searchData = row.getAttribute('data-search');
      
      let showRow = true;
      
      // カテゴリフィルタ
      if (categoryFilter && category !== categoryFilter) {
        showRow = false;
      }
      
      // 検索フィルタ
      if (searchText && !searchData.includes(searchText)) {
        showRow = false;
      }
      
      row.style.display = showRow ? '' : 'none';
    }
  }

  // ========================================
  // 編集機能
  // ========================================
  function editModel(rowIndex, rowData) {
    console.log('編集対象:', rowIndex, rowData);
    
    document.getElementById('edit-row-index').value = rowIndex;
    document.getElementById('edit-model-name').value = rowData[0] || '';
    document.getElementById('edit-manufacturer').value = rowData[1] || '';
    document.getElementById('edit-category').value = rowData[2] || '';
    document.getElementById('edit-remarks').value = rowData[5] || '';
    
    document.getElementById('editModelModal').style.display = 'block';
  }

  function closeEditModal() {
    document.getElementById('editModelModal').style.display = 'none';
  }

  function updateModel() {
    const form = document.getElementById('modelEditForm');
    const formData = new FormData(form);
    
    const rowIndex = parseInt(formData.get('rowIndex'));
    const modelData = {
      modelName: formData.get('modelName'),
      manufacturer: formData.get('manufacturer'),
      category: formData.get('category'),
      remarks: formData.get('remarks') || ''
    };

    console.log('機種更新データ:', rowIndex, modelData);

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種更新結果:', result);
        
        if (result.success) {
          showMessage('機種情報を更新しました', 'success');
          closeEditModal();
          loadModelList();
        } else {
          showMessage('機種の更新に失敗しました: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種更新でエラー:', error);
        showMessage('エラーが発生しました: ' + error.toString(), 'error');
      })
      .updateModelMasterData(rowIndex, modelData);
  }

  // ========================================
  // 削除機能
  // ========================================
  function confirmDeleteModel(rowIndex, modelName) {
    if (confirm(`機種「${modelName}」を削除しますか？\n\nこの操作は取り消せません。`)) {
      deleteModel(rowIndex);
    }
  }

  function deleteModel(rowIndex) {
    console.log('機種削除:', rowIndex);

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種削除結果:', result);
        
        if (result.success) {
          showMessage('機種を削除しました', 'success');
          loadModelList();
        } else {
          showMessage('機種の削除に失敗しました: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種削除でエラー:', error);
        showMessage('エラーが発生しました: ' + error.toString(), 'error');
      })
      .deleteModelMasterData(rowIndex);
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function formatDate(dateValue) {
    if (!dateValue) return '';
    
    try {
      if (typeof dateValue === 'string') {
        return dateValue;
      }
      
      if (dateValue instanceof Date) {
        return dateValue.toLocaleString('ja-JP');
      }
      
      return dateValue.toString();
    } catch (error) {
      return '';
    }
  }

  function showMessage(message, type) {
    // 既存のメッセージがあれば削除
    const existingMessage = document.querySelector('.message-toast');
    if (existingMessage) {
      existingMessage.remove();
    }
    
    // メッセージ要素を作成
    const messageElement = document.createElement('div');
    messageElement.className = `message-toast ${type}`;
    messageElement.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
      <span>${message}</span>
    `;
    
    // ページに追加
    document.body.appendChild(messageElement);
    
    // 3秒後に自動削除
    setTimeout(() => {
      if (messageElement.parentNode) {
        messageElement.remove();
      }
    }, 3000);
  }

  // モーダルの外側クリックで閉じる
  window.onclick = function(event) {
    const modal = document.getElementById('editModelModal');
    if (event.target == modal) {
      closeEditModal();
    }
  }
</script>