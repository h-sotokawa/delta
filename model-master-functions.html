<!-- model-master-functions.html - 機種マスタ管理ページの機能 -->
<script>
  // ========================================
  // ページ読み込み後の初期化
  // ========================================
  function onModelMasterPageShow() {
    console.log('機種マスタページが表示されました');
    loadModelList();
    loadFilterCategories();
  }

  // 更新ボタンがクリックされた時の処理（HTMLから直接呼ばれる）
  function refreshModelData() {
    console.log('機種データの手動更新が要求されました');
    loadModelList();
    loadFilterCategories();
  }

  // ========================================
  // 機種追加機能
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    const modelAddForm = document.getElementById('modelAddForm');
    if (modelAddForm) {
      modelAddForm.addEventListener('submit', function(e) {
        e.preventDefault();
        addNewModel();
      });
    }

    const modelEditForm = document.getElementById('modelEditForm');
    if (modelEditForm) {
      modelEditForm.addEventListener('submit', function(e) {
        e.preventDefault();
        updateModel();
      });
    }
  });

  function addNewModel() {
    const form = document.getElementById('modelAddForm');
    const formData = new FormData(form);
    
    const modelData = {
      modelName: formData.get('modelName'),
      manufacturer: formData.get('manufacturer'),
      category: formData.get('category'),
      remarks: formData.get('remarks') || ''
    };

    console.log('新規機種登録データ:', modelData);

    if (!modelData.modelName || !modelData.manufacturer || !modelData.category) {
      showMessage('必須項目を入力してください', 'error');
      return;
    }

    // Google Apps Scriptで機種を追加
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種追加結果:', result);
        
        if (result.success) {
          showMessage('機種を登録しました', 'success');
          resetModelForm();
          loadModelList();
          // 新しいカテゴリが追加された可能性があるため、フィルタのカテゴリ一覧を更新
          loadFilterCategories();
        } else {
          showMessage('機種の登録に失敗しました: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種追加でエラー:', error);
        showMessage('エラーが発生しました: ' + error.toString(), 'error');
      })
      .addModelMasterData(modelData);
  }

  function resetModelForm() {
    document.getElementById('modelAddForm').reset();
  }

  // ========================================
  // 機種一覧表示機能
  // ========================================
  function loadModelList() {
    const container = document.getElementById('model-list-container');
    
    container.innerHTML = `
      <div class="loading-placeholder">
        <i class="fas fa-spinner fa-spin"></i>
        <p>機種一覧を読み込み中...</p>
      </div>
    `;

    console.log('機種マスタデータの取得を開始します');

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種一覧取得結果:', result);
        displayModelList(result);
      })
      .withFailureHandler(function(error) {
        console.error('機種一覧取得でエラー:', error);
        console.error('エラーの詳細:', {
          message: error.message,
          stack: error.stack,
          toString: error.toString()
        });
        
        container.innerHTML = `
          <div class="error-placeholder">
            <i class="fas fa-exclamation-triangle"></i>
            <p>機種一覧の読み込みに失敗しました</p>
            <p class="error-details">エラー: ${error.toString()}</p>
            <button class="btn btn-primary" onclick="loadModelList()">再読み込み</button>
          </div>
        `;
      })
      .getModelMasterData();
  }

  function displayModelList(result) {
    const container = document.getElementById('model-list-container');
    
    console.log('displayModelList: 結果の表示処理開始', result);
    
    if (!result) {
      console.error('displayModelList: 結果がnullまたはundefined');
      container.innerHTML = `
        <div class="error-placeholder">
          <i class="fas fa-exclamation-triangle"></i>
          <p>データが取得できませんでした</p>
          <button class="btn btn-primary" onclick="loadModelList()">再読み込み</button>
        </div>
      `;
      return;
    }

    if (!result.success) {
      console.error('displayModelList: 処理が失敗', result.error);
      container.innerHTML = `
        <div class="error-placeholder">
          <i class="fas fa-exclamation-triangle"></i>
          <p>データの取得に失敗しました</p>
          <p class="error-details">${result.error || '不明なエラー'}</p>
          <button class="btn btn-primary" onclick="loadModelList()">再読み込み</button>
        </div>
      `;
      return;
    }

    if (!result.data || result.data.length <= 1) {
      console.log('displayModelList: データなしまたはヘッダーのみ', {
        hasData: !!result.data,
        dataLength: result.data ? result.data.length : 0,
        message: result.message
      });
      
      container.innerHTML = `
        <div class="empty-placeholder">
          <i class="fas fa-database"></i>
          <p>登録されている機種がありません</p>
          <p>上のフォームから機種を登録してください</p>
          ${result.message ? `<p class="info-message">${result.message}</p>` : ''}
        </div>
      `;
      return;
    }

    // テーブルを作成
    let tableHtml = `
      <div class="table-container">
        <table class="model-table" id="modelTable">
          <thead>
            <tr>
              <th>機種ID</th>
              <th>機種名</th>
              <th>メーカー</th>
              <th>カテゴリ</th>
              <th>作成日</th>
              <th>更新日</th>
              <th>備考</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
    `;

    // データ行を追加（ヘッダー行をスキップ）
    for (let i = 1; i < result.data.length; i++) {
      const row = result.data[i];
      const actualRowNumber = i + 1; // スプレッドシートの実際の行番号（1から始まる）
      
      // エスケープ処理（機種ID追加により列番号を調整）
      const escapedModelName = (row[1] || '').toString().replace(/'/g, "\\'").replace(/"/g, '\\"');
      const escapedManufacturer = (row[2] || '').toString().replace(/'/g, "\\'").replace(/"/g, '\\"');
      
      tableHtml += `
        <tr data-category="${row[3]}" 
            data-search="${(row[1] + ' ' + row[2]).toLowerCase()}">
          <td class="model-id">${row[0] || ''}</td>
          <td>${row[1] || ''}</td>
          <td>${row[2] || ''}</td>
          <td>${row[3] || ''}</td>
          <td>${formatDate(row[4])}</td>
          <td>${formatDate(row[5])}</td>
          <td>${row[6] || ''}</td>
          <td class="action-buttons">
            <button class="btn btn-sm btn-info" onclick="editModel(${actualRowNumber}, ${JSON.stringify(row).replace(/"/g, '&quot;')})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteModel(${actualRowNumber}, '${escapedModelName}', '${escapedManufacturer}', 'dummy')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }

    tableHtml += `
          </tbody>
        </table>
      </div>
      <div class="table-info">
        <p>登録件数: ${result.data.length - 1}件</p>
      </div>
    `;

    container.innerHTML = tableHtml;
  }

  // ========================================
  // フィルタリング機能
  // ========================================
  function loadFilterCategories() {
    const filterSelect = document.getElementById('filter-category');
    const currentSelection = filterSelect ? filterSelect.value : '';
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success && filterSelect) {
          // 現在の選択を一時保存
          filterSelect.innerHTML = '<option value="">すべてのカテゴリ</option>';
          
          result.categories.forEach(function(category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            filterSelect.appendChild(option);
          });
          
          // 以前の選択を復元（まだ存在する場合）
          if (currentSelection && result.categories.includes(currentSelection)) {
            filterSelect.value = currentSelection;
          }
          
          console.log('カテゴリフィルタを更新しました:', {
            totalCategories: result.categories.length,
            categories: result.categories,
            restoredSelection: currentSelection
          });
        }
      })
      .withFailureHandler(function(error) {
        console.error('カテゴリ取得でエラー:', error);
      })
      .getAvailableCategories();
  }

  function filterModelList() {
    const categoryFilter = document.getElementById('filter-category').value;
    const searchText = document.getElementById('search-text').value.toLowerCase();
    const table = document.getElementById('modelTable');
    
    if (!table) return;
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const category = row.getAttribute('data-category');
      const searchData = row.getAttribute('data-search');
      
      let showRow = true;
      
      // カテゴリフィルタ
      if (categoryFilter && category !== categoryFilter) {
        showRow = false;
      }
      
      // 検索フィルタ
      if (searchText && !searchData.includes(searchText)) {
        showRow = false;
      }
      
      row.style.display = showRow ? '' : 'none';
    }
  }

  // ========================================
  // 編集機能
  // ========================================
  function editModel(actualRowNumber, rowData) {
    console.log('編集対象:', actualRowNumber, rowData);
    
    // バックエンド用のインデックスに変換
    const backendRowIndex = actualRowNumber - 2; // ヘッダー行とスプレッドシートの1-based indexを考慮
    
    document.getElementById('edit-row-index').value = backendRowIndex;
    document.getElementById('edit-model-id').value = rowData[0] || ''; // 機種ID (読み取り専用)
    document.getElementById('edit-model-name').value = rowData[1] || '';
    document.getElementById('edit-manufacturer').value = rowData[2] || '';
    document.getElementById('edit-category').value = rowData[3] || '';
    document.getElementById('edit-remarks').value = rowData[6] || '';
    
    // 編集前の値を検証用に保存（機種名とメーカーは列1と2に変更）
    document.getElementById('editModelModal').setAttribute('data-original-model', rowData[1] || '');
    document.getElementById('editModelModal').setAttribute('data-original-manufacturer', rowData[2] || '');
    document.getElementById('editModelModal').setAttribute('data-actual-row', actualRowNumber);
    
    document.getElementById('editModelModal').style.display = 'block';
  }

  function closeEditModal() {
    document.getElementById('editModelModal').style.display = 'none';
  }

  function updateModel() {
    const form = document.getElementById('modelEditForm');
    const formData = new FormData(form);
    
    const rowIndex = parseInt(formData.get('rowIndex'));
    const modelData = {
      modelName: formData.get('modelName'),
      manufacturer: formData.get('manufacturer'),
      category: formData.get('category'),
      remarks: formData.get('remarks') || ''
    };

    console.log('機種更新データ:', rowIndex, modelData);

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種更新結果:', result);
        
        if (result.success) {
          showMessage('機種情報を更新しました', 'success');
          closeEditModal();
          loadModelList();
          // カテゴリが変更された可能性があるため、フィルタのカテゴリ一覧を更新
          loadFilterCategories();
        } else {
          showMessage('機種の更新に失敗しました: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種更新でエラー:', error);
        showMessage('エラーが発生しました: ' + error.toString(), 'error');
      })
      .updateModelMasterData(rowIndex, modelData);
  }

  // ========================================
  // 削除機能
  // ========================================
  function confirmDeleteModel(actualRowNumber, modelName, manufacturer, rowId) {
    const displayText = `機種「${manufacturer} ${modelName}」を削除しますか？\n\nこの操作は取り消せません。`;
    
    if (confirm(displayText)) {
      deleteModel(modelName, manufacturer);
    }
  }

  function deleteModel(modelName, manufacturer) {
    console.log('機種削除実行:', {
      modelName,
      manufacturer
    });

    // 機種名とメーカー名を直接バックエンドに渡す
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('機種削除結果:', result);
        
        if (result.success) {
          showMessage(`機種「${manufacturer} ${modelName}」を削除しました`, 'success');
          loadModelList();
          // 削除されたカテゴリが最後の機種だった場合、フィルタのカテゴリ一覧から削除される可能性があるため更新
          loadFilterCategories();
        } else {
          showMessage('機種の削除に失敗しました: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('機種削除でエラー:', error);
        showMessage('エラーが発生しました: ' + error.toString(), 'error');
      })
      .deleteModelMasterData(modelName, manufacturer);
  }

  // ========================================
  // 診断機能
  // ========================================
  function runDiagnosis() {
    console.log('機種マスタ診断を開始します');
    showMessage('機種マスタの診断を実行中...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('診断結果:', result);
        
        if (result.success) {
          showMessage('診断が完了しました', 'success');
          console.log('診断詳細:', result.diagnostics);
          console.log('シート情報:', result.sheetInfo);
          console.log('関数テスト結果:', result.functionResult);
          
          // 診断後に自動でリストを再読み込み
          setTimeout(() => {
            loadModelList();
          }, 1000);
        } else {
          showMessage('診断でエラーが発生しました: ' + result.error, 'error');
          console.error('診断エラー:', result.diagnostics);
        }
      })
      .withFailureHandler(function(error) {
        console.error('診断実行でエラー:', error);
        showMessage('診断の実行に失敗しました: ' + error.toString(), 'error');
      })
      .diagnoseModelMaster();
  }

  // 日付修正機能
  function fixDateFormats() {
    if (!confirm('既存の日付データを年月日形式に修正しますか？\n\n時刻付きで記録されている日付が年月日のみに変更されます。')) {
      return;
    }
    
    console.log('既存日付データの修正を開始します');
    showMessage('既存の日付データを修正中...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('日付修正結果:', result);
        
        if (result.success) {
          showMessage(result.message, 'success');
          console.log('修正件数:', result.updatedCount);
          
          // 修正後にリストを再読み込み
          setTimeout(() => {
            loadModelList();
          }, 1000);
        } else {
          showMessage('日付修正でエラーが発生しました: ' + result.error, 'error');
          console.error('日付修正エラー:', result);
        }
      })
      .withFailureHandler(function(error) {
        console.error('日付修正実行でエラー:', error);
        showMessage('日付修正の実行に失敗しました: ' + error.toString(), 'error');
      })
      .fixExistingDateFormats();
  }

  // ========================================
  // ユーティリティ関数
  // ========================================
  function formatDate(dateValue) {
    if (!dateValue) return '';
    
    try {
      // 既に文字列の場合
      if (typeof dateValue === 'string') {
        // 先頭のアポストロフィがある場合は除去
        return dateValue.startsWith("'") ? dateValue.substring(1) : dateValue;
      }
      
      // Dateオブジェクトの場合は年月日形式にフォーマット
      if (dateValue instanceof Date) {
        const year = dateValue.getFullYear();
        const month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
        const day = dateValue.getDate().toString().padStart(2, '0');
        return `${year}/${month}/${day}`;
      }
      
      return dateValue.toString();
    } catch (error) {
      console.error('日付フォーマットエラー:', error, dateValue);
      return '';
    }
  }

  // 共通UIコンポーネントを使用するshowMessage関数
  function showMessage(message, type) {
    const options = {
      duration: 3000
    };
    
    switch(type) {
      case 'success':
        CommonUI.showSuccess(message, options);
        break;
      case 'error':
        CommonUI.showError(message, options);
        break;
      case 'info':
        CommonUI.showInfo(message, options);
        break;
      default:
        CommonUI.showInfo(message, options);
        break;
    }
  }

  // モーダルの外側クリックで閉じる
  window.onclick = function(event) {
    const modal = document.getElementById('editModelModal');
    if (event.target == modal) {
      closeEditModal();
    }
  }
</script>