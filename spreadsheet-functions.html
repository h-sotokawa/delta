<!-- spreadsheet-functions.html - スプレッドシート関連JavaScript -->
<script>
  // ========================================
  // スプレッドシート関連関数
  // ========================================
  
  // 拠点一覧を取得してプルダウンメニューに設定
  function initializeLocations() {
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          const locationSelect = document.getElementById('location');
          Object.entries(response.locations).forEach(([key, name]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = name;
            locationSelect.appendChild(option);
          });
        }
        // 初期表示時はローディング非表示
        document.getElementById('loading').style.display = 'none';
      })
      .withFailureHandler(function(error) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = '拠点一覧の取得に失敗しました: ' + error;
      })
      .getLocations();
  }

  // 拠点が変更されたときの処理
  function handleLocationChange() {
    const locationSelect = document.getElementById('location');
    const selectedLocation = locationSelect.value;
    const querySelector = document.querySelector('.query-selector');
    const refreshButton = document.getElementById('refreshButton');
    const errorDiv = document.getElementById('error');
    const tableContainer = document.getElementById('tableContainer');
    const loadingDiv = document.getElementById('loading');
    
    // エラーとテーブルを初期クリア
    errorDiv.textContent = '';
    tableContainer.innerHTML = '';
    loadingDiv.style.display = 'none';
    
    if (selectedLocation) {
      // プリロードデータがある場合は直接表示（高速化）
      if (typeof isDataPreloaded === 'function' && isDataPreloaded(selectedLocation)) {
        currentLocation = selectedLocation;
        querySelector.style.display = 'block';
        
        // 更新ボタンを有効化
        if (refreshButton) {
          refreshButton.disabled = false;
        }
        
        // 現在選択されているクエリタイプを取得して反映
        const queryType = document.querySelector('input[name="queryType"]:checked')?.value || 'all';
        loadSpreadsheet(selectedLocation, queryType);
        return;
      }
      
      // プリロードデータがない場合、またはプリロード中にエラーだった場合はスプレッドシートIDをチェック
      if (typeof preloadedData !== 'undefined' && 
          preloadedData.hasOwnProperty(selectedLocation) && 
          preloadedData[selectedLocation] === null) {
        // プリロード時にスプレッドシートIDが未設定だった場合
        currentLocation = '';
        querySelector.style.display = 'none';
        
        if (refreshButton) {
          refreshButton.disabled = true;
        }
        
        const locationName = (typeof LOCATION_NAMES_CLIENT !== 'undefined' ? 
          LOCATION_NAMES_CLIENT[selectedLocation] : selectedLocation) || selectedLocation;
        
        errorDiv.textContent = `${locationName}のスプレッドシートIDが設定されていません。システム管理者にお問い合わせください。`;
        tableContainer.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>設定エラー</h3>
            <p>${locationName}のスプレッドシートIDが設定されていません。</p>
            <p class="error-detail">この拠点のデータを表示するには、システム管理者にスプレッドシートIDの設定を依頼してください。</p>
          </div>
        `;
        
        // 拠点選択をリセット
        locationSelect.value = '';
        return;
      }
      
      // プリロードデータがない場合のみスプレッドシートIDをチェック
      loadingDiv.style.display = 'block';
      
      google.script.run
        .withSuccessHandler(function(response) {
          loadingDiv.style.display = 'none';
          
          if (response.success && response.exists) {
            // スプレッドシートIDが設定されている場合
            currentLocation = selectedLocation;
            querySelector.style.display = 'block';
            
            // 更新ボタンを有効化
            if (refreshButton) {
              refreshButton.disabled = false;
            }
            
            // 現在選択されているクエリタイプを取得して反映
            const queryType = document.querySelector('input[name="queryType"]:checked')?.value || 'all';
            loadSpreadsheet(selectedLocation, queryType);
            
          } else if (response.success && !response.exists) {
            // スプレッドシートIDが設定されていない場合
            currentLocation = '';
            querySelector.style.display = 'none';
            
            // 更新ボタンを無効化
            if (refreshButton) {
              refreshButton.disabled = true;
            }
            
            errorDiv.textContent = `${response.locationName}のスプレッドシートIDが設定されていません。システム管理者にお問い合わせください。`;
            tableContainer.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>設定エラー</h3>
                <p>${response.locationName}のスプレッドシートIDが設定されていません。</p>
                <p class="error-detail">この拠点のデータを表示するには、システム管理者にスプレッドシートIDの設定を依頼してください。</p>
              </div>
            `;
            
            // 拠点選択をリセット
            locationSelect.value = '';
            
          } else {
            // チェック処理でエラーが発生した場合
            currentLocation = '';
            querySelector.style.display = 'none';
            
            if (refreshButton) {
              refreshButton.disabled = true;
            }
            
            errorDiv.textContent = `拠点設定の確認に失敗しました: ${response.error}`;
            locationSelect.value = '';
          }
        })
        .withFailureHandler(function(error) {
          loadingDiv.style.display = 'none';
          currentLocation = '';
          querySelector.style.display = 'none';
          
          if (refreshButton) {
            refreshButton.disabled = true;
          }
          
          errorDiv.textContent = `拠点設定の確認に失敗しました: ${error}`;
          locationSelect.value = '';
        })
        .checkSpreadsheetIdExists(selectedLocation);
        
    } else {
      // 拠点が選択されていない場合
      currentLocation = '';
      querySelector.style.display = 'none';
      
      // 更新ボタンを無効化
      if (refreshButton) {
        refreshButton.disabled = true;
      }
    }
  }

  // クエリタイプが変更されたときの処理
  function handleQueryChange() {
    if (currentLocation) {
      const queryType = document.querySelector('input[name="queryType"]:checked').value;
      loadSpreadsheet(currentLocation, queryType);
    }
  }

  // スプレッドシートデータを読み込む
  function loadSpreadsheet(location, queryType) {
    // プリロードされたデータがある場合はそれを使用
    if (typeof loadSpreadsheetWithPreload === 'function') {
      loadSpreadsheetWithPreload(location, queryType);
      return;
    }
    
    // 以下は既存のロジック（プリロード機能がない場合のフォールバック）
    if (DEBUG_MODE) {
      showDebugInfo('データ取得開始（フォールバック）', { location, queryType });
    }
    
    const errorDiv = document.getElementById('error');
    const tableContainer = document.getElementById('tableContainer');
    const loadingDiv = document.getElementById('loading');

    loadingDiv.style.display = 'block';
    errorDiv.textContent = '';
    tableContainer.innerHTML = '';

    try {
      if (!google || !google.script || !google.script.run) {
        throw new Error('Google Apps Scriptの実行環境が正しく初期化されていません');
      }

      if (DEBUG_MODE) {
        showDebugInfo('getSpreadsheetData関数の呼び出し開始', { location, queryType });
      }
      google.script.run
        .withSuccessHandler(function(response) {
          if (DEBUG_MODE) {
            showDebugInfo('サーバーからの応答', response);
          }
          loadingDiv.style.display = 'none';
          
          if (!response) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'エラーが発生しました : スプレッドシート内の日時の表示形式を"書式なし"に変更してください';
            tableContainer.innerHTML = '';
            return;
          }
          
          if (response.success) {
            if (DEBUG_MODE) {
              showDebugInfo('データ表示開始', response.data);
            }
            displayData(response.data, queryType);
            errorDiv.textContent = '';
          } else {
            const errorMessage = response.error || '不明なエラーが発生しました';
            const errorDetails = response.errorDetails || {};
            if (DEBUG_MODE) {
              showDebugInfo('エラー発生', { 
                error: errorMessage,
                details: errorDetails
              });
            }
            errorDiv.textContent = 'エラー: ' + errorMessage;
            tableContainer.innerHTML = '';
          }

          if (response.logs && DEBUG_MODE) {
            showServerLogs(response.logs);
          }
        })
        .withFailureHandler(function(error) {
          if (DEBUG_MODE) {
            showDebugInfo('サーバーエラー', { 
              error: error,
              errorType: typeof error,
              errorString: String(error),
              errorStack: error.stack
            });
          }
          loadingDiv.style.display = 'none';
          errorDiv.textContent = 'エラーが発生しました: ' + error;
          tableContainer.innerHTML = '';
        })
        .getSpreadsheetData(location, queryType);
    } catch (error) {
      if (DEBUG_MODE) {
        showDebugInfo('クライアントサイドエラー', {
          error: error,
          errorType: typeof error,
          errorString: String(error),
          errorStack: error.stack
        });
      }
      loadingDiv.style.display = 'none';
      errorDiv.textContent = 'クライアントサイドでエラーが発生しました: ' + error;
      tableContainer.innerHTML = '';
    }
  }

  // データを表示する
  function displayData(data, queryType) {
    if (!data || data.length === 0) {
      showDebugInfo('データが空', {});
      const tableContainer = document.getElementById('tableContainer');
      tableContainer.innerHTML = '<p>データがありません</p>';
      return;
    }

    showDebugInfo('テーブル作成開始', { rows: data.length, columns: data[0].length });
    
    // 新しいcreateTable関数を使用
    createTable(data, queryType);
  }

  // ステータス更新関数
  function updateStatus(rowIndex, newStatus) {
    showDebugInfo('ステータス更新開始', { rowIndex, newStatus });
    
    // 空文字列の場合はnullに変換
    const statusToUpdate = newStatus === '' ? null : newStatus;
    
    // ステータス変更の確認ダイアログ
    let label = '';
    switch (statusToUpdate) {
      case null:
      case '':
        label = '空欄'; break;
      case '1.返却可能':
        label = '1.返却可能'; break;
      case '2.商談/金銭的な理由により返却不可':
        label = '2.商談/金銭的な理由により返却不可'; break;
      case '3.お客様にて返却拒否':
        label = '3.お客様にて返却拒否'; break;
      case '4.HW延長保守にて貸出':
        label = '4.HW延長保守にて貸出'; break;
      default:
        label = statusToUpdate;
    }
    if (!window.confirm(`${label}に変更しますか？`)) {
      return;
    }
    google.script.run
      .withSuccessHandler(function(response) {
        showDebugInfo('ステータス更新成功', response);
        if (response.success) {
          showPopupMessage('ステータスを更新しました');
          // 更新成功時の処理
          loadSpreadsheet(currentLocation, document.querySelector('input[name="queryType"]:checked').value);
        } else {
          // エラー時の処理
          const errorDiv = document.getElementById('error');
          errorDiv.textContent = 'ステータスの更新に失敗しました: ' + (response.error || '不明なエラー');
        }
      })
      .withFailureHandler(function(error) {
        showDebugInfo('ステータス更新エラー', { error });
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = 'エラーが発生しました: ' + error;
      })
      .updateMachineStatus(rowIndex, statusToUpdate, currentLocation);
  }

  // 現在選択されている拠点のデータを更新
  function refreshCurrentLocation() {
    if (!currentLocation) {
      showPopupMessage('拠点が選択されていません');
      return;
    }

    const refreshButton = document.getElementById('refreshButton');
    const queryType = document.querySelector('input[name="queryType"]:checked')?.value || 'all';
    
    // ボタンのローディング状態を設定
    if (refreshButton) {
      refreshButton.classList.add('loading');
      refreshButton.disabled = true;
    }

    showDebugInfo('手動更新開始', { location: currentLocation, queryType });
    
    // プリロードデータをクリア（強制的に最新データを取得）
    if (preloadedData && preloadedData[currentLocation]) {
      delete preloadedData[currentLocation];
      showDebugInfo('プリロードデータをクリア', { location: currentLocation });
    }

    const errorDiv = document.getElementById('error');
    const tableContainer = document.getElementById('tableContainer');
    const loadingDiv = document.getElementById('loading');

    loadingDiv.style.display = 'block';
    errorDiv.textContent = '';
    tableContainer.innerHTML = '';

    try {
      if (!google || !google.script || !google.script.run) {
        throw new Error('Google Apps Scriptの実行環境が正しく初期化されていません');
      }

      showDebugInfo('最新データ取得開始', { location: currentLocation, queryType });
      google.script.run
        .withSuccessHandler(function(response) {
          showDebugInfo('更新データ取得成功', response);
          loadingDiv.style.display = 'none';
          
          // ボタンのローディング状態を解除
          if (refreshButton) {
            refreshButton.classList.remove('loading');
            refreshButton.disabled = false;
          }
          
          if (!response) {
            errorDiv.textContent = 'エラーが発生しました : スプレッドシート内の日時の表示形式を"書式なし"に変更してください';
            tableContainer.innerHTML = '';
            return;
          }
          
          if (response.success) {
            // プリロードデータも更新
            if (typeof preloadedData !== 'undefined') {
              preloadedData[currentLocation] = response;
            }
            
            showDebugInfo('最新データ表示開始', response.data);
            displayData(response.data, queryType);
            errorDiv.textContent = '';
            showPopupMessage('データを更新しました');
          } else {
            const errorMessage = response.error || '不明なエラーが発生しました';
            showDebugInfo('更新エラー発生', { error: errorMessage });
            errorDiv.textContent = 'エラー: ' + errorMessage;
            tableContainer.innerHTML = '';
          }

          if (response.logs) {
            showServerLogs(response.logs);
          }
        })
        .withFailureHandler(function(error) {
          showDebugInfo('更新通信エラー', { error });
          loadingDiv.style.display = 'none';
          
          // ボタンのローディング状態を解除
          if (refreshButton) {
            refreshButton.classList.remove('loading');
            refreshButton.disabled = false;
          }
          
          errorDiv.textContent = 'エラーが発生しました: ' + error;
          tableContainer.innerHTML = '';
        })
        .getSpreadsheetData(currentLocation, queryType);
    } catch (error) {
      showDebugInfo('更新処理エラー', { error });
      loadingDiv.style.display = 'none';
      
      // ボタンのローディング状態を解除
      if (refreshButton) {
        refreshButton.classList.remove('loading');
        refreshButton.disabled = false;
      }
      
      errorDiv.textContent = 'クライアントサイドでエラーが発生しました: ' + error;
      tableContainer.innerHTML = '';
    }
  }

  // 拠点管理番号の列インデックスを推定する関数
  function findLocationCodeColumnIndex(headers) {
    // 一般的な拠点管理番号列名のパターンを検索
    const locationColumnNames = ['拠点管理番号', '拠点コード', '拠点', 'location', 'site_code'];
    for (let i = 0; i < headers.length; i++) {
      const header = headers[i].toString().toLowerCase();
      for (const pattern of locationColumnNames) {
        if (header.includes(pattern.toLowerCase())) {
          return i;
        }
      }
    }
    return -1; // 見つからない場合
  }

  // 代替機フォーム回答シートのデータを読み込む
  function loadLocationSheet(locationCode) {
    if (!currentLocation) {
      showPopupMessage('拠点が選択されていません');
      return;
    }

    // 現在の代替機フォーム回答シート名を保存
    currentLocationSheetName = locationCode;

    showDebugInfo('代替機フォーム回答シート読み込み開始', { currentLocation, locationCode });

    const errorDiv = document.getElementById('error');
    const tableContainer = document.getElementById('tableContainer');
    const loadingDiv = document.getElementById('loading');

    loadingDiv.style.display = 'block';
    errorDiv.textContent = '';
    tableContainer.innerHTML = '';

    google.script.run
      .withSuccessHandler(function(response) {
        loadingDiv.style.display = 'none';
        
        if (response.success) {
          showDebugInfo('代替機フォーム回答シート読み込み成功', response);
          
          // 戻るボタンを表示
          const backButton = `
            <div class="sheet-navigation">
              <button onclick="backToMainView()" class="back-button">
                <i class="fas fa-arrow-left"></i>
                一覧に戻る
              </button>
              <h3>代替機フォーム回答シート: ${locationCode}</h3>
            </div>
          `;
          
          // 代替機フォーム回答シート表示モードでcreateTableを呼び出し
          createTable(response.data, 'all', backButton, 'location-sheet');
        } else {
          errorDiv.textContent = `代替機フォーム回答シート「${locationCode}」の読み込みに失敗しました: ${response.error}`;
          showDebugInfo('代替機フォーム回答シート読み込みエラー', response);
        }
      })
      .withFailureHandler(function(error) {
        loadingDiv.style.display = 'none';
        errorDiv.textContent = `代替機フォーム回答シート「${locationCode}」の読み込み中にエラーが発生しました: ${error}`;
        showDebugInfo('代替機フォーム回答シート読み込み通信エラー', { error });
      })
      .getLocationSheetData(currentLocation, locationCode, 'all');
  }

  // 一覧画面に戻る
  function backToMainView() {
    // 代替機フォーム回答シート名をクリア
    currentLocationSheetName = null;
    
    const queryType = document.querySelector('input[name="queryType"]:checked')?.value || 'all';
    loadSpreadsheet(currentLocation, queryType);
  }

  // 動的列幅調整関数
  function adjustColumnWidths(data, displayMode = 'main') {
    if (!data || data.length === 0) return;
    
    // 各列の最大文字数を計算
    const columnWidths = [];
    const minWidth = 60;  // 最小幅
    const maxWidth = 400; // 最大幅
    const charWidthFactor = 8; // 1文字あたりのピクセル数（目安）
    
    // ヘッダー行を含む全データをチェック
    for (let colIndex = 0; colIndex < data[0].length; colIndex++) {
      let maxLength = 0;
      
      // ヘッダー行の文字数をチェック
      const headerText = data[0][colIndex]?.toString() || '';
      maxLength = Math.max(maxLength, headerText.length);
      
      // データ行の文字数をチェック
      for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
        const cellText = data[rowIndex][colIndex]?.toString() || '';
        maxLength = Math.max(maxLength, cellText.length);
      }
      
      // 文字数から推定幅を計算（最小値・最大値の制限あり）
      let estimatedWidth = Math.max(minWidth, maxLength * charWidthFactor);
      estimatedWidth = Math.min(maxWidth, estimatedWidth);
      
      // 特別な調整
      if (colIndex === 0 && displayMode === 'main') {
        // 項番列は固定幅
        estimatedWidth = 60;
      } else if (colIndex === 0) {
        // A列（ステータス列など）
        estimatedWidth = Math.max(120, estimatedWidth);
      }
      
      columnWidths.push(estimatedWidth);
    }
    
    showDebugInfo('動的列幅計算結果', { columnWidths });
    
    // CSSスタイルを動的に適用
    const table = document.querySelector('#tableContainer table');
    if (table) {
      // 項番列がある場合の調整
      let columnOffset = displayMode === 'main' ? 1 : 0;
      
      // ヘッダー行に幅を適用
      const headerCells = table.querySelectorAll('th');
      headerCells.forEach((th, index) => {
        if (index === 0 && displayMode === 'main') {
          // 項番列
          th.style.width = '60px';
          th.style.minWidth = '60px';
        } else {
          // データ列
          const dataColumnIndex = index - columnOffset;
          if (dataColumnIndex >= 0 && dataColumnIndex < columnWidths.length) {
            th.style.width = columnWidths[dataColumnIndex] + 'px';
            th.style.minWidth = columnWidths[dataColumnIndex] + 'px';
          }
        }
      });
      
      // データ行に幅を適用
      const dataCells = table.querySelectorAll('td');
      dataCells.forEach((td, index) => {
        const columnIndex = index % headerCells.length;
        if (columnIndex === 0 && displayMode === 'main') {
          // 項番列
          td.style.width = '60px';
          td.style.minWidth = '60px';
        } else {
          // データ列
          const dataColumnIndex = columnIndex - columnOffset;
          if (dataColumnIndex >= 0 && dataColumnIndex < columnWidths.length) {
            td.style.width = columnWidths[dataColumnIndex] + 'px';
            td.style.minWidth = columnWidths[dataColumnIndex] + 'px';
          }
        }
      });
    }
  }

  function createTable(data, queryType, prependContent = '', displayMode = 'main') {
    const tableContainer = document.getElementById('tableContainer');
    
    // 拠点管理番号の列インデックスを取得
    const locationCodeColumnIndex = findLocationCodeColumnIndex(data[0]);
    
    // 空の列をチェックする関数
    function isColumnEmpty(columnIndex) {
      // 代替機フォーム回答シート表示モードの場合は空列チェックを無効化
      if (displayMode === 'location-sheet') {
        return false;
      }
      
      for (let i = 1; i < data.length; i++) {
        // クエリタイプに応じてフィルタリング
        if (queryType === 'all' || 
            (queryType === 'lending' && 
             ((currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ? 
              (data[i][2] && data[i][2].includes('貸出')) : 
              (data[i][3] && data[i][3].includes('貸出') && data[i][9])))) {
          if (data[i][columnIndex] && data[i][columnIndex].toString().trim() !== '') {
            return false;
          }
        }
      }
      return true;
    }

    // 貸出中フィルタリング時のデータ存在チェック
    let hasLendingData = false;
    if (queryType === 'lending') {
      for (let i = 1; i < data.length; i++) {
        const isLending = (currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ?
          (data[i][2] && data[i][2].includes('貸出')) :
          (data[i][3] && data[i][3].includes('貸出') && data[i][9]);
        
        if (isLending) {
          hasLendingData = true;
          break;
        }
      }
      
      // 貸出中データがない場合
      if (!hasLendingData) {
        showDebugInfo('貸出中データなし', {});
        tableContainer.innerHTML = prependContent + `
          <div class="no-data-message">
            <i class="fas fa-info-circle"></i>
            <p>貸出中（ユーザー預り機有）のデータはありません</p>
          </div>
        `;
        return;
      }
    }

    // 空の列をログに記録
    const emptyColumns = [];
    for (let i = 0; i < data[0].length; i++) {
      if (isColumnEmpty(i)) {
        emptyColumns.push({ index: i, header: data[0][i] || '(空)' });
      }
    }
    showDebugInfo('空の列を検出', { emptyColumns });

    let table = '<table>';
    
    // ヘッダー行
    table += '<tr>';
    // メインモードの場合のみ項番列を追加
    if (displayMode === 'main') {
      table += '<th>#</th>'; // 項番列を追加
    }
    
    data[0].forEach((cell, index) => {
      // 一覧表示の場合はA列を非表示、貸出中(ユーザー預り機有)の場合はA列を表示
      if (index === 0 && queryType === 'all' && displayMode === 'main') {
        return;
      }
      
      // 空の列は表示しない（代替機フォーム回答シートモードでは全て表示）
      if (isColumnEmpty(index)) {
        return;
      }
      
      table += `<th>${cell}</th>`;
    });
    table += '</tr>';

    // データ行
    let rowNumber = 1; // 項番用のカウンター
    for (let i = 1; i < data.length; i++) {
      // クエリタイプに応じて表示する行をフィルタリング
      if (queryType === 'all' || 
          (queryType === 'lending' && 
           ((currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ? 
            (data[i][2] && data[i][2].includes('貸出')) : 
            (data[i][3] && data[i][3].includes('貸出') && data[i][9])))) {  // プリンタ以外は10列目のチェックを維持
        table += '<tr>';
        
        // メインモードの場合のみ項番を追加
        if (displayMode === 'main') {
          table += `<td>${rowNumber}</td>`; // 項番を追加
        }
        rowNumber++; // 項番をインクリメント
        
        data[i].forEach((cell, index) => {
          // 一覧表示の場合はA列を非表示、貸出中(ユーザー預り機有)の場合はA列を表示
          if (index === 0 && queryType === 'all' && displayMode === 'main') {
            return;
          }
          
          // 空の列は表示しない（代替機フォーム回答シートモードでは全て表示）
          if (isColumnEmpty(index)) {
            return;
          }
          
          if (index === 0 && displayMode === 'main') {
            // プリンタロケーションの場合はC列、それ以外はD列の"貸出"をチェック
            const isLending = (currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ?
              (data[i][2] && data[i][2].includes('貸出')) :
              (data[i][3] && data[i][3].includes('貸出'));

            // プリンタロケーションの場合は10列目のチェックを除外
            const shouldShowDropdown = (currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ?
              isLending :
              (isLending && data[i][9]);

            if (!shouldShowDropdown) {
              table += `<td>${cell || ''}</td>`;
            } else {
              const currentValue = cell || '';
              table += `<td>
                <select onchange="updateStatus(${i}, this.value)" class="status-select">
                  <option value="" ${currentValue === '' ? 'selected' : ''}></option>
                  <option value="1.返却可能" ${currentValue === '1.返却可能' ? 'selected' : ''}>1.返却可能</option>
                  <option value="2.商談/金銭的な理由により返却不可" ${currentValue === '2.商談/金銭的な理由により返却不可' ? 'selected' : ''}>2.商談/金銭的な理由により返却不可</option>
                  <option value="3.お客様にて返却拒否" ${currentValue === '3.お客様にて返却拒否' ? 'selected' : ''}>3.お客様にて返却拒否</option>
                  <option value="4.HW延長保守にて貸出" ${currentValue === '4.HW延長保守にて貸出' ? 'selected' : ''}>4.HW延長保守にて貸出</option>
                </select>
              </td>`;
            }
          } else if (index === locationCodeColumnIndex && locationCodeColumnIndex !== -1 && displayMode === 'main') {
            // 拠点管理番号列をクリック可能にする（メインモードのみ）
            const cellValue = cell || '';
            if (cellValue.toString().trim() !== '') {
              table += `<td><a href="#" onclick="loadLocationSheet('${cellValue}'); return false;" class="location-link">${cellValue}</a></td>`;
            } else {
              table += `<td>${cellValue}</td>`;
            }
          } else {
            table += `<td>${cell || ''}</td>`;
          }
        });
        table += '</tr>';
      }
    }

    table += '</table>';
    tableContainer.innerHTML = prependContent + table;
    
    // 代替機フォーム回答シート表示時のみセルクリック編集機能を有効化
    // mainシートは数式でデータを取得するため編集不可
    if (displayMode === 'location-sheet') {
      enableCellEditing(data);
    }
    
    // ドラッグ&ドロップ機能を有効化
    setupColumnDragAndDrop();
    
    // 動的列幅調整を実行
    setTimeout(() => {
      adjustColumnWidths(data, displayMode);
    }, 100); // DOM更新後に実行
    
    showDebugInfo('テーブル作成完了', { displayMode });
  }

  // セルクリック編集機能を有効化（代替機フォーム回答シート専用）
  function enableCellEditing(data) {
    // 編集機能の初期化
    initializeCellEditing();
    
    const table = document.querySelector('#tableContainer table');
    if (!table) return;
    
    // データセル（ヘッダー以外）にクリックイベントを追加
    // mainシートは数式でデータを取得するため、代替機フォーム回答シートのみ編集可能
    const dataCells = table.querySelectorAll('td');
    dataCells.forEach((cell, index) => {
      const table = cell.closest('table');
      const headerCells = table.querySelectorAll('th');
      const columnCount = headerCells.length;
      
      const rowIndex = Math.floor(index / columnCount) + 1; // データ行番号（1から開始）
      const columnIndex = index % columnCount; // 列番号（0から開始）
      
      // セルをクリック可能にする
      cell.style.cursor = 'pointer';
      cell.title = 'クリックして編集';
      cell.classList.add('editable-cell');
      
      cell.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // 既に編集中の場合は何もしない
        if (cell.classList.contains('editing')) {
          return;
        }
        
        const currentValue = cell.textContent || '';
        startCellEdit(cell, rowIndex, columnIndex, currentValue);
      });
    });
    
    showDebugInfo('代替機フォーム回答シートのセル編集機能有効化完了', { 
      totalCells: dataCells.length,
      dataRows: data.length - 1 
    });
  }

  // 現在編集中のセル情報を格納する変数
  let currentEditingCell = null;
  
  // 現在表示中の代替機フォーム回答シート名を保持する変数
  let currentLocationSheetName = null;

  // セル編集機能の初期化
  function initializeCellEditing() {
    // 編集中の場合は既存の編集をキャンセル
    if (currentEditingCell) {
      cancelCellEdit();
    }
  }

  // セル編集開始
  function startCellEdit(cell, rowIndex, columnIndex, currentValue) {
    // 他の編集中セルがあればキャンセル
    if (currentEditingCell) {
      cancelCellEdit();
    }
    
    showDebugInfo('セル編集開始', { rowIndex, columnIndex, currentValue });
    
    // 元のセル内容を保存
    const originalContent = cell.innerHTML;
    const originalValue = currentValue || '';
    
    // 編集状態の情報を保存
    currentEditingCell = {
      cell: cell,
      rowIndex: rowIndex,
      columnIndex: columnIndex,
      originalContent: originalContent,
      originalValue: originalValue
    };
    
    // 編集UIを作成
    const editContainer = document.createElement('div');
    editContainer.className = 'cell-edit-container';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-edit-input';
    input.value = originalValue;
    
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'cell-edit-buttons';
    
    const confirmButton = document.createElement('button');
    confirmButton.className = 'cell-edit-confirm';
    confirmButton.innerHTML = '<i class="fas fa-check"></i>';
    confirmButton.title = '確定';
    confirmButton.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      confirmCellEdit(input.value);
    };
    
    const cancelButton = document.createElement('button');
    cancelButton.className = 'cell-edit-cancel';
    cancelButton.innerHTML = '<i class="fas fa-times"></i>';
    cancelButton.title = 'キャンセル';
    cancelButton.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      cancelCellEdit();
    };
    
    buttonContainer.appendChild(confirmButton);
    buttonContainer.appendChild(cancelButton);
    editContainer.appendChild(input);
    editContainer.appendChild(buttonContainer);
    
    // セルの内容を編集UIに置き換え
    cell.innerHTML = '';
    cell.appendChild(editContainer);
    cell.classList.add('editing');
    
    // 入力フィールドにフォーカス
    input.focus();
    input.select();
    
    // Enterキーで確定、Escapeキーでキャンセル
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        confirmCellEdit(input.value);
      } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelCellEdit();
      }
    });
  }

  // セル編集の確認
  function confirmCellEdit(newValue) {
    if (!currentEditingCell) return;
    
    const { rowIndex, columnIndex, originalValue } = currentEditingCell;
    
    // 値に変更がない場合はキャンセル
    if (newValue === originalValue) {
      cancelCellEdit();
      return;
    }
    
    // 確認ダイアログを表示
    const confirmMessage = `
      セルの内容を変更しますか？
      
      変更前: "${originalValue}"
      変更後: "${newValue}"
    `;
    
    if (!window.confirm(confirmMessage)) {
      return;
    }
    
    showDebugInfo('セル更新開始', { rowIndex, columnIndex, originalValue, newValue });
    
    // ローディング状態に変更
    const { cell } = currentEditingCell;
    cell.innerHTML = '<div class="cell-updating"><i class="fas fa-spinner fa-spin"></i> 更新中...</div>';
    
    // 現在の代替機フォーム回答シート名を取得
    const locationSheetName = getCurrentLocationSheetName();
    if (!locationSheetName) {
      showDebugInfo('代替機フォーム回答シート名が取得できません', { currentLocationSheetName });
      cancelCellEdit();
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = '代替機フォーム回答シート名を取得できませんでした。画面を再読み込みしてください。';
      return;
    }
    
    showDebugInfo('セル更新実行', { 
      location: currentLocation, 
      locationSheetName: locationSheetName,
      rowIndex, 
      columnIndex, 
      originalValue, 
      newValue 
    });
    
    // サーバーにセル更新を送信
    google.script.run
      .withSuccessHandler(function(response) {
        showDebugInfo('セル更新成功', response);
        
        if (response.success) {
          // 成功時は新しい値を表示
          cell.innerHTML = newValue || '';
          cell.classList.remove('editing');
          showPopupMessage('セルを更新しました');
          
          // 編集状態をクリア
          currentEditingCell = null;
          
          // プリロードデータ（メインシート）を更新
          updatePreloadedData();
          
          // 代替機フォーム回答シートの自動更新を実行（少し遅延させて）
          setTimeout(() => {
            refreshLocationSheet();
          }, 1000);
          
        } else {
          // エラー時は元の値に戻す
          const errorMessage = response.error || '不明なエラーが発生しました';
          showDebugInfo('セル更新エラー', { error: errorMessage });
          cancelCellEdit();
          
          const errorDiv = document.getElementById('error');
          errorDiv.textContent = 'セルの更新に失敗しました: ' + errorMessage;
        }
      })
      .withFailureHandler(function(error) {
        showDebugInfo('セル更新通信エラー', { error });
        cancelCellEdit();
        
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = 'セルの更新中にエラーが発生しました: ' + error;
      })
      .updateLocationSheetCell(currentLocation, locationSheetName, rowIndex, columnIndex, newValue);
  }

  // セル編集のキャンセル
  function cancelCellEdit() {
    if (!currentEditingCell) return;
    
    const { cell, originalContent } = currentEditingCell;
    
    // 元の内容に戻す
    cell.innerHTML = originalContent;
    cell.classList.remove('editing');
    
    // 編集状態をクリア
    currentEditingCell = null;
    
    showDebugInfo('セル編集キャンセル', {});
  }

  // 現在の代替機フォーム回答シート名を取得
  function getCurrentLocationSheetName() {
    // グローバル変数から代替機フォーム回答シート名を取得
    return currentLocationSheetName;
  }

  // 代替機フォーム回答シートの自動更新
  function refreshLocationSheet() {
    const locationSheetName = getCurrentLocationSheetName();
    if (locationSheetName) {
      loadLocationSheet(locationSheetName);
    }
  }

  // プリロードデータ（メインシート）を更新する関数
  function updatePreloadedData() {
    if (!currentLocation) {
      showDebugInfo('プリロードデータ更新: 拠点が選択されていません', {});
      return;
    }

    showDebugInfo('プリロードデータ更新開始', { location: currentLocation });

    // プリロードデータがある場合のみ更新
    if (typeof preloadedData !== 'undefined' && preloadedData[currentLocation]) {
      // メインシートの最新データを取得
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            // プリロードデータを更新
            preloadedData[currentLocation] = response;
            showDebugInfo('プリロードデータ更新成功', { 
              location: currentLocation, 
              dataSize: response.data.length 
            });
          } else {
            showDebugInfo('プリロードデータ更新エラー', { 
              location: currentLocation, 
              error: response.error 
            });
          }
        })
        .withFailureHandler(function(error) {
          showDebugInfo('プリロードデータ更新通信エラー', { 
            location: currentLocation, 
            error: error 
          });
        })
        .getSpreadsheetData(currentLocation, 'all');
    } else {
      showDebugInfo('プリロードデータ更新スキップ', { 
        location: currentLocation,
        reason: 'プリロードデータが存在しません'
      });
    }
  }
</script> 