<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>スプレッドシートビューアー</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-color: #1e293b;
        --primary-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        --secondary-color: #64748b;
        --secondary-gradient: linear-gradient(135deg, #64748b 0%, #475569 100%);
        --accent-color: #0f172a;
        --accent-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        --highlight-color: #3b82f6;
        --highlight-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        --success-color: #10b981;
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-color: #f59e0b;
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-accent: #64748b;
        --text-light: #94a3b8;
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-accent: #f1f5f9;
        --bg-dark: #0f172a;
        --border-color: #e2e8f0;
        --border-accent: #cbd5e0;
        --border-dark: #334155;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-blue: 0 4px 14px 0 rgba(59, 130, 246, 0.15);
        --border-radius: 6px;
        --border-radius-lg: 10px;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic Medium', 'Meiryo', 'MS PGothic', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        background: var(--bg-primary);
        background-image: 
          linear-gradient(90deg, rgba(30, 41, 59, 0.02) 1px, transparent 1px),
          linear-gradient(rgba(30, 41, 59, 0.02) 1px, transparent 1px);
        background-size: 40px 40px;
        min-height: 100vh;
        color: var(--text-primary);
        line-height: 1.6;
        font-feature-settings: "palt" 1;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-weight: 400;
      }

      .container {
        max-width: 95vw;
        margin: 24px auto 0 auto;
        background: var(--bg-secondary);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        padding: 48px 56px;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
      }

      .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--highlight-gradient);
      }

      h1 {
        text-align: center;
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 32px;
        margin-top: 0;
        color: var(--primary-color);
        letter-spacing: -0.025em;
        font-feature-settings: "palt" 1, "kern" 1;
        position: relative;
      }

      h1::after {
        content: '';
        position: absolute;
        bottom: -12px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: var(--highlight-color);
      }

      .location-selector, .query-selector {
        margin: 24px 0;
        padding: 20px 24px;
        background: var(--bg-accent);
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        gap: 20px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        position: relative;
      }

      .location-selector::before, .query-selector::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--highlight-color);
      }

      .location-selector:hover, .query-selector:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .location-selector label, .query-selector label {
        font-weight: 500;
        margin-right: 12px;
        color: var(--text-primary);
        font-size: 1rem;
        letter-spacing: 0.025em;
      }

      .location-selector select, .query-selector select {
        padding: 10px 14px;
        font-size: 14px;
        border: 1px solid var(--border-accent);
        border-radius: var(--border-radius);
        min-width: 200px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: var(--transition);
        font-weight: 500;
      }

      .location-selector select:focus, .query-selector select:focus {
        outline: none;
        border-color: var(--highlight-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .radio-group {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
      }

      .radio-group label {
        font-weight: 400;
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: var(--transition);
        background: transparent;
        border: 1px solid transparent;
        letter-spacing: 0.025em;
      }

      .radio-group label:hover {
        background: rgba(59, 130, 246, 0.08);
        border-color: var(--highlight-color);
      }

      .radio-group input[type="radio"] {
        margin-right: 8px;
        accent-color: var(--highlight-color);
        transform: scale(1.1);
      }

      .table-responsive {
        width: 100%;
        overflow-x: auto;
        margin: 16px 0 32px 0;
        border-radius: var(--border-radius);
        background: transparent;
      }

      .table-responsive:has(table) {
        box-shadow: var(--shadow-lg);
      }

      table {
        width: 100%;
        min-width: 1500px;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      #tableContainer {
        background: transparent !important;
      }

      th, td {
        border: none;
        border-bottom: 1px solid var(--border-color);
        padding: 16px 12px;
        text-align: left;
        font-size: 15px;
        transition: var(--transition);
      }

      th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        letter-spacing: 0.05em;
        font-size: 12px;
        position: sticky;
        top: 0;
        z-index: 10;
        font-feature-settings: "palt" 1;
        padding: 16px 20px;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border-dark);
      }

      th:first-child {
        border-top-left-radius: var(--border-radius);
      }

      th:last-child {
        border-top-right-radius: var(--border-radius);
      }

      th:nth-child(1), td:nth-child(1) { min-width: 60px; text-align: center; font-weight: 600; }
      th:nth-child(2), td:nth-child(2) { min-width: 180px; }
      th:nth-child(3), td:nth-child(3) { min-width: 160px; }
      th:nth-child(4), td:nth-child(4) { min-width: 160px; }
      th:nth-child(5), td:nth-child(5) { min-width: 120px; }
      th:nth-child(6), td:nth-child(6) { min-width: 120px; }
      th:nth-child(7), td:nth-child(7) { min-width: 120px; }
      th:nth-child(8), td:nth-child(8) { min-width: 120px; }
      th:nth-child(9), td:nth-child(9) { min-width: 120px; }
      th:nth-child(10), td:nth-child(10) { min-width: 120px; }
      th:nth-child(11), td:nth-child(11) { min-width: 120px; }
      th:nth-child(12), td:nth-child(12) { min-width: 120px; }

      tr:nth-child(even) td {
        background: var(--bg-accent);
      }

      tr:hover td {
        background: rgba(59, 130, 246, 0.04);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .status-select {
        padding: 8px 12px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
      }

      .status-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .error {
        color: #e53e3e;
        margin-top: 16px;
        text-align: center;
        padding: 16px;
        background: transparent;
        border-radius: var(--border-radius);
        border: none;
        font-weight: 500;
      }

      .error:not(:empty) {
        background: linear-gradient(135deg, rgba(229, 62, 62, 0.1) 0%, rgba(229, 62, 62, 0.05) 100%);
        border: 1px solid rgba(229, 62, 62, 0.2);
      }

      .loading {
        text-align: center;
        margin: 32px 0;
        color: var(--text-secondary);
        font-size: 18px;
        font-weight: 500;
      }

      .loading::after {
        content: '';
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-left: 10px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .debug {
        margin-top: 32px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(113, 128, 150, 0.05) 0%, rgba(113, 128, 150, 0.02) 100%);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
      }

      .debug h3 {
        margin-top: 0;
        color: var(--text-primary);
        font-weight: 500;
        letter-spacing: 0.025em;
      }

      .debug pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
        background: var(--bg-primary);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.5;
      }

      .debug-controls {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
      }

      .debug-controls button {
        padding: 8px 16px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-accent);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        text-transform: none;
        letter-spacing: 0;
        font-size: 13px;
      }

      .debug-controls button:hover {
        background: var(--highlight-color);
        color: white;
        border-color: var(--highlight-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .debug-controls button:active {
        transform: translateY(0);
      }

      .popup-message {
        position: fixed;
        top: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success-gradient);
        color: white;
        padding: 16px 24px;
        border-radius: var(--border-radius);
        font-size: 14px;
        font-weight: 600;
        box-shadow: var(--shadow-xl);
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .popup-message.show {
        display: block;
        opacity: 1;
        transform: translateX(-50%) translateY(10px);
      }
      
      /* ドラッグ&ドロップ用のスタイル */
      th {
        cursor: move;
        user-select: none;
        position: relative;
        touch-action: none;
      }
      
      th.dragging {
        opacity: 0.7;
        background: var(--secondary-gradient);
        transform: scale(1.05);
        z-index: 1000;
      }
      
      th.drag-over {
        background: var(--warning-gradient);
        border-left: 4px solid var(--primary-color);
        transform: scale(1.02);
      }
      
      .drag-indicator {
        position: absolute;
        top: 0;
        left: -2px;
        width: 4px;
        height: 100%;
        background: var(--primary-gradient);
        display: none;
        border-radius: 2px;
      }

      /* レスポンシブデザイン */
      @media (max-width: 900px) {
        .container {
          padding: 24px 16px;
          margin: 20px auto;
        }
        
        h1 {
          font-size: 2rem;
        }
        
        .location-selector, .query-selector {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        
        .location-selector select, .query-selector select {
          min-width: 100%;
        }
        
        .table-responsive {
          margin-left: 16px;
          margin-right: 16px;
        }
        
        table {
          min-width: 900px;
        }
        
        th, td {
          font-size: 14px;
          padding: 12px 8px;
        }
      }

      @media (max-width: 600px) {
        .container {
          padding: 16px 8px;
          margin: 10px auto;
        }
        
        h1 {
          font-size: 1.75rem;
        }
        
        .table-responsive {
          margin-left: 8px;
          margin-right: 8px;
        }
        
        table {
          min-width: 600px;
        }
        
        th, td {
          font-size: 16px;
          padding: 14px 6px;
        }
        
        td select.status-select {
          font-size: 16px !important;
          padding: 10px 8px;
        }
        
        td select.status-select option {
          font-size: 16px !important;
        }
        
        .radio-group {
          flex-direction: column;
          gap: 12px;
        }
      }

      /* アニメーション効果 */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .container {
        animation: fadeInUp 0.6s ease-out;
      }

      .location-selector, .query-selector {
        animation: fadeInUp 0.6s ease-out 0.1s both;
      }

      .table-responsive {
        animation: fadeInUp 0.6s ease-out 0.2s both;
      }

      /* スクロールバーのスタイリング */
      .table-responsive::-webkit-scrollbar {
        height: 8px;
      }

      .table-responsive::-webkit-scrollbar-track {
        background: var(--bg-primary);
        border-radius: 4px;
      }

      .table-responsive::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 4px;
      }

      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-gradient);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>スプレッドシートビューアー</h1>
      <div id="popupMessage" class="popup-message" style="display:none;"></div>
      <div class="location-selector">
        <label for="location">拠点を選択：</label>
        <select id="location" onchange="handleLocationChange()">
          <option value="">拠点を選択してください</option>
        </select>
      </div>
      <div class="query-selector" style="display: none;">
        <label>表示内容：</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="queryType" value="all" checked onchange="handleQueryChange()">
            一覧
          </label>
          <label>
            <input type="radio" name="queryType" value="lending" onchange="handleQueryChange()">
            貸出中(ユーザー預り機有)
          </label>
        </div>
      </div>
      <div id="loading" class="loading" style="display:none;">データを読み込み中...</div>
      <div id="error" class="error"></div>
      <div class="table-responsive">
        <div id="tableContainer"></div>
      </div>
      <div id="debug" class="debug">
        <h3>デバッグ情報</h3>
        <div class="debug-controls">
          <button onclick="clearDebugInfo()">ログをクリア</button>
          <button onclick="toggleDebugInfo()">ログの表示/非表示</button>
        </div>
        <pre id="debugInfo"></pre>
      </div>
    </div>

    <script>
      // デバッグ情報を表示する関数
      function showDebugInfo(message, data) {
        const debugInfo = document.getElementById('debugInfo');
        const timestamp = new Date().toISOString();
        const debugMessage = `[${timestamp}] ${message}\n${JSON.stringify(data, null, 2)}\n\n`;
        debugInfo.textContent = (debugInfo.textContent || '') + debugMessage;
      }

      // サーバーログを表示する関数
      function showServerLogs(logs) {
        if (!logs || !Array.isArray(logs)) return;
        
        const debugInfo = document.getElementById('debugInfo');
        logs.forEach(log => {
          const debugMessage = `[SERVER ${log.timestamp}] ${log.message}\n${JSON.stringify(log.data, null, 2)}\n\n`;
          debugInfo.textContent = (debugInfo.textContent || '') + debugMessage;
        });
      }

      // デバッグ情報をクリアする関数
      function clearDebugInfo() {
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.textContent = '';
      }

      // デバッグ情報の表示/非表示を切り替える関数
      function toggleDebugInfo() {
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
      }

      // シリアル値を日付文字列に変換する関数
      function convertSerialToDate(serial) {
        if (!serial || isNaN(serial)) return '';
        
        // 1900年1月1日からの経過日数を計算
        const date = new Date((serial - 25569) * 86400 * 1000);
        
        // 日付をフォーマット
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}/${month}/${day}`;
      }

      // 拠点一覧を取得してプルダウンメニューに設定
      function initializeLocations() {
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              const locationSelect = document.getElementById('location');
              Object.entries(response.locations).forEach(([key, name]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = name;
                locationSelect.appendChild(option);
              });
            }
            // 初期表示時はローディング非表示
            document.getElementById('loading').style.display = 'none';
          })
          .withFailureHandler(function(error) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '拠点一覧の取得に失敗しました: ' + error;
          })
          .getLocations();
      }

      // 現在選択されている拠点を保持
      let currentLocation = '';
      
      // 列の順序を保持する配列
      let columnOrder = [];
      let draggedColumnIndex = -1;

      // 拠点が変更されたときの処理
      function handleLocationChange() {
        const locationSelect = document.getElementById('location');
        const selectedLocation = locationSelect.value;
        const querySelector = document.querySelector('.query-selector');
        
        if (selectedLocation) {
          currentLocation = selectedLocation;
          querySelector.style.display = 'block';
          // 現在選択されているクエリタイプを取得して反映
          const queryType = document.querySelector('input[name="queryType"]:checked')?.value || 'all';
          loadSpreadsheet(selectedLocation, queryType);
        } else {
          currentLocation = '';
          querySelector.style.display = 'none';
          const tableContainer = document.getElementById('tableContainer');
          tableContainer.innerHTML = '';
        }
      }

      // クエリタイプが変更されたときの処理
      function handleQueryChange() {
        if (currentLocation) {
          const queryType = document.querySelector('input[name="queryType"]:checked').value;
          loadSpreadsheet(currentLocation, queryType);
        }
      }

      // ページ読み込み時に拠点一覧を初期化
      window.onload = function() {
        showDebugInfo('ページ読み込み完了', {});
        initializeLocations();
      };

      // ドラッグ&ドロップ関連の関数
      function setupColumnDragAndDrop() {
        const table = document.querySelector('table');
        if (!table) return;
        
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
          // 項番列（最初の列）はドラッグ不可
          if (index === 0) return;
          
          header.draggable = true;
          header.addEventListener('dragstart', handleDragStart);
          header.addEventListener('dragover', handleDragOver);
          header.addEventListener('drop', handleDrop);
          header.addEventListener('dragend', handleDragEnd);
          header.addEventListener('dragenter', handleDragEnter);
          header.addEventListener('dragleave', handleDragLeave);
        });
      }

      function handleDragStart(e) {
        draggedColumnIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.outerHTML);
        showDebugInfo('ドラッグ開始', { columnIndex: draggedColumnIndex });
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      }

      function handleDragEnter(e) {
        e.preventDefault();
        if (e.target.tagName === 'TH' && !e.target.classList.contains('dragging')) {
          e.target.classList.add('drag-over');
        }
      }

      function handleDragLeave(e) {
        if (e.target.tagName === 'TH') {
          e.target.classList.remove('drag-over');
        }
      }

      function handleDrop(e) {
        e.preventDefault();
        const targetColumnIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
        
        if (draggedColumnIndex !== targetColumnIndex && draggedColumnIndex !== -1) {
          reorderColumns(draggedColumnIndex, targetColumnIndex);
          showDebugInfo('列の並び替え', { from: draggedColumnIndex, to: targetColumnIndex });
        }
        
        // クリーンアップ
        document.querySelectorAll('th').forEach(th => {
          th.classList.remove('drag-over');
        });
      }

      function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('th').forEach(th => {
          th.classList.remove('drag-over');
        });
        draggedColumnIndex = -1;
      }

      function reorderColumns(fromIndex, toIndex) {
        const table = document.querySelector('table');
        if (!table) return;
        
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(row => {
          const cells = Array.from(row.children);
          if (cells.length > Math.max(fromIndex, toIndex)) {
            const draggedCell = cells[fromIndex];
            const targetCell = cells[toIndex];
            
            if (fromIndex < toIndex) {
              // 右に移動
              targetCell.parentNode.insertBefore(draggedCell, targetCell.nextSibling);
            } else {
              // 左に移動
              targetCell.parentNode.insertBefore(draggedCell, targetCell);
            }
          }
        });
        
        // ドラッグ&ドロップを再設定
        setupColumnDragAndDrop();
      }

      function loadSpreadsheet(location, queryType) {
        showDebugInfo('データ取得開始', { location, queryType });
        
        const errorDiv = document.getElementById('error');
        const tableContainer = document.getElementById('tableContainer');
        const loadingDiv = document.getElementById('loading');

        loadingDiv.style.display = 'block';
        errorDiv.textContent = '';
        tableContainer.innerHTML = '';

        try {
          if (!google || !google.script || !google.script.run) {
            throw new Error('Google Apps Scriptの実行環境が正しく初期化されていません');
          }

          showDebugInfo('getSpreadsheetData関数の呼び出し開始', { location, queryType });
          google.script.run
            .withSuccessHandler(function(response) {
              showDebugInfo('サーバーからの応答', response);
              loadingDiv.style.display = 'none';
              
              if (!response) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'エラーが発生しました : スプレッドシート内の日時の表示形式を"書式なし"に変更してください';
                tableContainer.innerHTML = '';
                return;
              }
              
              if (response.success) {
                showDebugInfo('データ表示開始', response.data);
                displayData(response.data, queryType);
                errorDiv.textContent = '';
              } else {
                const errorMessage = response.error || '不明なエラーが発生しました';
                const errorDetails = response.errorDetails || {};
                showDebugInfo('エラー発生', { 
                  error: errorMessage,
                  details: errorDetails
                });
                errorDiv.textContent = 'エラー: ' + errorMessage;
                tableContainer.innerHTML = '';
              }

              if (response.logs) {
                showServerLogs(response.logs);
              }
            })
            .withFailureHandler(function(error) {
              showDebugInfo('サーバーエラー', { 
                error: error,
                errorType: typeof error,
                errorString: String(error),
                errorStack: error.stack
              });
              loadingDiv.style.display = 'none';
              errorDiv.textContent = 'エラーが発生しました: ' + error;
              tableContainer.innerHTML = '';
            })
            .getSpreadsheetData(location, queryType);
        } catch (error) {
          showDebugInfo('クライアントサイドエラー', {
            error: error,
            errorType: typeof error,
            errorString: String(error),
            errorStack: error.stack
          });
          loadingDiv.style.display = 'none';
          errorDiv.textContent = 'クライアントサイドでエラーが発生しました: ' + error;
          tableContainer.innerHTML = '';
        }
      }

      function displayData(data, queryType) {
        const tableContainer = document.getElementById('tableContainer');
        if (!data || data.length === 0) {
          showDebugInfo('データが空', {});
          tableContainer.innerHTML = '<p>データがありません</p>';
          return;
        }

        showDebugInfo('テーブル作成開始', { rows: data.length, columns: data[0].length });

        // 空の列を検出する関数
        function isColumnEmpty(columnIndex) {
          // ヘッダーが空かチェック
          if (!data[0][columnIndex] || data[0][columnIndex].trim() === '') {
            return true;
          }
          
          // データ行で該当する列に内容があるかチェック
          for (let i = 1; i < data.length; i++) {
            // 表示される行のみをチェック
            if (queryType === 'all' || 
                (queryType === 'lending' && 
                 ((currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ? 
                  (data[i][2] && data[i][2].includes('貸出')) : 
                  (data[i][3] && data[i][3].includes('貸出') && data[i][9])))) {
              if (data[i][columnIndex] && data[i][columnIndex].toString().trim() !== '') {
                return false;
              }
            }
          }
          return true;
        }

        // 空の列をログに記録
        const emptyColumns = [];
        for (let i = 0; i < data[0].length; i++) {
          if (isColumnEmpty(i)) {
            emptyColumns.push({ index: i, header: data[0][i] || '(空)' });
          }
        }
        showDebugInfo('空の列を検出', { emptyColumns });

        let table = '<table>';
        
        // ヘッダー行
        table += '<tr>';
        table += '<th>#</th>'; // 項番列を追加
        data[0].forEach((cell, index) => {
          // 一覧表示の場合はA列を非表示、貸出中(ユーザー預り機有)の場合はA列を表示
          if (index === 0 && queryType === 'all') {
            return;
          }
          
          // 空の列は表示しない
          if (isColumnEmpty(index)) {
            return;
          }
          
          table += `<th>${cell}</th>`;
        });
        table += '</tr>';

        // データ行
        let rowNumber = 1; // 項番用のカウンター
        for (let i = 1; i < data.length; i++) {
          // クエリタイプに応じて表示する行をフィルタリング
          if (queryType === 'all' || 
              (queryType === 'lending' && 
               ((currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ? 
                (data[i][2] && data[i][2].includes('貸出')) : 
                (data[i][3] && data[i][3].includes('貸出') && data[i][9])))) {  // プリンタ以外は10列目のチェックを維持
            table += '<tr>';
            table += `<td>${rowNumber}</td>`; // 項番を追加
            rowNumber++; // 項番をインクリメント
            data[i].forEach((cell, index) => {
              // 一覧表示の場合はA列を非表示、貸出中(ユーザー預り機有)の場合はA列を表示
              if (index === 0 && queryType === 'all') {
                return;
              }
              
              // 空の列は表示しない
              if (isColumnEmpty(index)) {
                return;
              }
              
              if (index === 0) {
                // プリンタロケーションの場合はC列、それ以外はD列の"貸出"をチェック
                const isLending = (currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ?
                  (data[i][2] && data[i][2].includes('貸出')) :
                  (data[i][3] && data[i][3].includes('貸出'));

                // プリンタロケーションの場合は10列目のチェックを除外
                const shouldShowDropdown = (currentLocation === 'osaka_printer' || currentLocation === 'hyogo_printer') ?
                  isLending :
                  (isLending && data[i][9]);

                if (!shouldShowDropdown) {
                  table += `<td>${cell || ''}</td>`;
                } else {
                  const currentValue = cell || '';
                  table += `<td>
                    <select onchange="updateStatus(${i}, this.value)" class="status-select">
                      <option value="" ${currentValue === '' ? 'selected' : ''}></option>
                      <option value="1.返却可能" ${currentValue === '1.返却可能' ? 'selected' : ''}>1.返却可能</option>
                      <option value="2.商談/金銭的な理由により返却不可" ${currentValue === '2.商談/金銭的な理由により返却不可' ? 'selected' : ''}>2.商談/金銭的な理由により返却不可</option>
                      <option value="3.お客様にて返却拒否" ${currentValue === '3.お客様にて返却拒否' ? 'selected' : ''}>3.お客様にて返却拒否</option>
                      <option value="4.HW延長保守にて貸出" ${currentValue === '4.HW延長保守にて貸出' ? 'selected' : ''}>4.HW延長保守にて貸出</option>
                    </select>
                  </td>`;
                }
              } else {
                table += `<td>${cell || ''}</td>`;
              }
            });
            table += '</tr>';
          }
        }

        table += '</table>';
        tableContainer.innerHTML = table;
        
        // ドラッグ&ドロップ機能を有効化
        setupColumnDragAndDrop();
        
        showDebugInfo('テーブル作成完了', {});
      }

      // ポップアップメッセージを表示する関数
      function showPopupMessage(message) {
        const popup = document.getElementById('popupMessage');
        popup.textContent = message;
        popup.classList.add('show');
        popup.style.display = 'block';
        setTimeout(() => {
          popup.classList.remove('show');
          setTimeout(() => {
            popup.style.display = 'none';
          }, 600);
        }, 1800);
      }

      // ステータス更新関数
      function updateStatus(rowIndex, newStatus) {
        showDebugInfo('ステータス更新開始', { rowIndex, newStatus });
        
        // 空文字列の場合はnullに変換
        const statusToUpdate = newStatus === '' ? null : newStatus;
        
        // ステータス変更の確認ダイアログ
        let label = '';
        switch (statusToUpdate) {
          case null:
          case '':
            label = '空欄'; break;
          case '1.返却可能':
            label = '1.返却可能'; break;
          case '2.商談/金銭的な理由により返却不可':
            label = '2.商談/金銭的な理由により返却不可'; break;
          case '3.お客様にて返却拒否':
            label = '3.お客様にて返却拒否'; break;
          case '4.HW延長保守にて貸出':
            label = '4.HW延長保守にて貸出'; break;
          default:
            label = statusToUpdate;
        }
        if (!window.confirm(`${label}に変更しますか？`)) {
          return;
        }
        google.script.run
          .withSuccessHandler(function(response) {
            showDebugInfo('ステータス更新成功', response);
            if (response.success) {
              showPopupMessage('ステータスを更新しました');
              // 更新成功時の処理
              loadSpreadsheet(currentLocation, document.querySelector('input[name="queryType"]:checked').value);
            } else {
              // エラー時の処理
              const errorDiv = document.getElementById('error');
              errorDiv.textContent = 'ステータスの更新に失敗しました: ' + (response.error || '不明なエラー');
            }
          })
          .withFailureHandler(function(error) {
            showDebugInfo('ステータス更新エラー', { error });
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'エラーが発生しました: ' + error;
          })
          .updateMachineStatus(rowIndex, statusToUpdate, currentLocation);
      }
    </script>
  </body>
</html> 