# 機能要件定義書

## 1. ダッシュボード機能

### 1.1 概要
システムのメイン画面として、各機能への入口と全体状況の概要を提供する。

### 1.2 機能詳細

#### 1.2.1 基本表示
- **機能カード表示**: 各主要機能への直感的なアクセス
- **アイコン・説明**: 機能の目的が明確に分かるUI
- **レスポンシブ対応**: PCおよびモバイルでの適切な表示

#### 1.2.2 ナビゲーション
- **ヘッダーナビ**: 全ページ共通のナビゲーション
- **アクティブ状態表示**: 現在選択中の機能の明示
- **パンくずリスト**: 現在位置の把握

## 2. スプレッドシートビューアー機能

### 2.1 概要
Google Sheetsのデータを拠点別に表示し、リアルタイムでの機器情報確認を可能にする。

### 2.2 機能詳細

#### 2.2.1 拠点選択機能
- **拠点ドロップダウン**: 利用可能拠点の一覧表示
- **拠点マスタ連携**: 拠点マスタからの動的データ取得
- **デフォルト拠点**: 前回選択拠点の記憶

#### 2.2.2 データタイプ選択機能
- **データタイプマスタ連携**: マスタ管理されたデータタイプの動的取得
- **アクティブなタイプのみ表示**: 有効なデータタイプのみドロップダウンに表示
- **表示順序制御**: マスタで定義された順序での表示
- **自動更新**: データタイプ変更時の表示自動更新
- **タイプ別表示設定**: データタイプごとの最適な表示形式
- **ステータス連動表示**: 通常データタイプでのステータス別表示列切り替え
- **接頭辞ベースフィルタリング**: ステータスの接頭辞数字（例：「1.貸出中」の「1」）に基づく列の動的フィルタリング
- **2段階ネストフィルタリング**: 「3.社内にて保管中」選択時の社内ステータス（3-0.社内ステータス）による更なる列分岐表示
- **動的ネストフィルタリング**: 利用可能な列から3-X-*パターンを動的検出し、事前定義なしで新しい社内ステータスに対応
- **通常データ表示列順序**: 項番(#)、拠点管理番号、カテゴリ、機種名、ステータス、ステータス連動列の順で固定表示

#### 2.2.3 データ表示機能
- **統合テーブル表示**: 端末・プリンタ・その他マスタからの統合表示
- **機器種別表示**: 各データに機器種別を動的付与
- **カラムソート**: 各列での昇順・降順ソート
- **フィルタリング**: 拠点・機器種別・データタイプによる絞り込み
- **ページネーション**: 大量データの分割表示

#### 2.2.4 リアルタイム更新
- **自動リフレッシュ**: 定期的なデータ同期
- **手動更新**: ユーザー操作による即座更新
- **更新時刻表示**: 最終更新時刻の明示

#### 2.2.5 データ操作
- **行選択**: 複数行の選択機能
- **詳細表示**: 行クリックによる詳細情報表示
- **エクスポート**: CSVファイルでのデータ出力

#### 2.2.6 預り機ステータス管理

**概要**: 
「0-4.ステータス」が"1.貸出中"かつ「1-4.ユーザー機の預り有無」が"有り"の場合に設定可能な副ステータス管理機能

**基本機能**:
- **条件判定**: 設定可能条件の自動判定・UI制御
- **ステータス表示**: 現在の預り機ステータスの表示
- **条件付き編集**: 条件を満たす場合のみ編集可能
- **ステータス選択肢**: 事前定義されたステータス値からの選択
- **自動クリア**: 前提条件が変更された場合の自動ステータスクリア

**編集機能**:
- **インライン編集**: テーブル内での直接編集
- **一括更新**: 条件を満たす複数選択行での一括ステータス変更
- **バリデーション**: 設定条件チェック・整合性確認
- **変更履歴**: ステータス変更日時・変更者・変更理由の記録

**UI/UX機能**:
- **視覚的フィードバック**: 編集可否の明確な表示（グレーアウト等）
- **条件表示**: 設定条件の説明・ガイダンス
- **エラー防止**: 無効な操作の事前ブロック
- **通知機能**: ステータス変更時の関係者への自動通知

**レポート機能**:
- **集計表示**: 預り機ステータス別集計（サマリーカード）
- **変更履歴レポート**: ステータス変更の履歴分析
- **条件別フィルタ**: 預り機ありデータのみの表示機能

#### 2.2.7 ステータス変更通知機能

**概要**:
Google Formsの回答がステータス収集シートに保存される際に、自動的にステータス変更を検知し、関係者への通知を行う機能

**重要なデータフロー**:
1. **フォーム → 収集シート**: Google Formsの回答は「端末ステータス収集」「プリンタステータス収集」等の収集シートに保存される
2. **収集シート → マスタシート**: マスタシートはトリガー処理で収集シートから最新データを自動取得
3. **通知トリガー**: onFormSubmitトリガーは収集シートに設定され、フォーム回答時のみ実行される

**通知トリガー（収集シートへのフォーム送信時のみ）**:
- **端末フォーム回答時**: 端末用Google Formsが「端末ステータス収集」シートに回答を送信した時
- **プリンタフォーム回答時**: プリンタ用Google Formsが「プリンタステータス収集」シートに回答を送信した時
- **その他フォーム回答時**: その他機器用Google Formsが「その他ステータス収集」シートに回答を送信した時

**注意**: スプレッドシートビューアーでの直接編集では通知は発生しません

**通知対象**:
- **ステータス変更**: 「0-4.ステータス」フィールドの値変更（前回の値と比較）
- **新規登録**: 新しい拠点管理番号での初回登録
- **既存更新**: 既存の拠点管理番号での情報更新（ステータス変更を含む）

**通知内容**:
```
件名: [代替機管理] 機器ステータス変更通知 - {拠点名}

{拠点名} 拠点の皆様

代替機管理システムより、機器のステータス変更をお知らせします。

■ 変更内容
拠点管理番号: {拠点管理番号}
機器種別: {機器種別}
機種名: {機種名}
製造番号: {製造番号}

変更項目: ステータス
変更前: {変更前ステータス}
変更後: {変更後ステータス}

■ 変更者情報
変更者: {フォーム回答者}
変更日時: {フォーム回答日時}

■ 機器詳細URL
{共通フォームURL}

---
このメールは代替機管理システムより自動送信されています。
```

**通知制御**:
- **グローバル設定**: PropertiesServiceの`STATUS_CHANGE_NOTIFICATION_ENABLED`でシステム全体の通知ON/OFF
- **拠点別設定**: 拠点マスタの「ステータス変更通知」列で拠点ごとの通知ON/OFF
- **送信条件**: 両方の設定がONの場合のみ通知送信
- **送信先**: 拠点マスタのグループメールアドレス

**通知タイミング**:
- **即座通知**: Google Formsの回答処理完了直後
- **重複防止**: 同一拠点管理番号で同じステータス値の場合は通知しない
- **エラー処理**: 通知送信失敗時のリトライ機能

**通知ログ**:
- **送信履歴**: 通知送信の成功/失敗を記録
- **送信内容**: 送信したメールの内容を保存
- **受信確認**: 必要に応じて受信確認機能（オプション）

## 3. URL生成機能

### 3.1 概要
拠点管理番号を自動生成し、Google Formsへの事前入力URLを作成する主要機能。

### 3.2 機能詳細

#### 3.2.1 拠点管理番号生成
- **自動生成ロジック**: `拠点コード_カテゴリ_モデル_製造番号_連番`
- **フォーム入力**: 拠点・カテゴリ・モデル・製造番号・連番の入力
- **リアルタイム表示**: 入力に応じた即座のプレビュー
- **バリデーション**: 各入力項目の形式チェック

#### 3.2.2 フォームURL生成
- **事前入力URL**: Google Formsへの拠点管理番号事前入力
- **フォームタイプ別**: 端末用・プリンタ用の適切なフォーム選択
- **エラーハンドリング**: URL生成失敗時の適切な通知

#### 3.2.3 QRコード機能
- **QR用URL生成**: 中間ページ経由のQRコード対応URL
- **QRコード表示**: 生成されたQRコードの画面表示
- **印刷対応**: QRコードの印刷機能

#### 3.2.4 マスタ連携
- **自動保存**: 生成したURLのマスタデータ保存
- **重複チェック**: 既存データの上書き確認
- **新規登録**: デバイス情報の自動追加
- **属性保存**: URL生成時に入力した情報をマスタに記録
  - カテゴリ
  - 機種名
  - 製造番号
  - 資産管理番号（端末系のみ）
  - OS（端末系のみ）
  - ソフトウェア（端末系のみ）

### 3.3 入力項目詳細

#### 3.3.1 拠点選択
- **データソース**: 拠点マスタ
- **表示形式**: `拠点コード - 拠点名`
- **必須項目**: Yes

#### 3.3.2 デバイスカテゴリ
- **データソース**: 機種マスタから動的取得
- **選択肢**: Desktop、Laptop、Server、Tablet、Printer、Router、Hub、Other（機種マスタで定義されたカテゴリ）
- **動的表示**: 選択に応じたモデル一覧更新
- **必須項目**: Yes

#### 3.3.3 モデル選択
- **データソース**: 機種マスタ（カテゴリフィルタ済み）
- **表示形式**: `メーカー - 機種名`
- **必須項目**: Yes

#### 3.3.4 製造番号
- **入力形式**: 英数字・ハイフン
- **パターン**: `[A-Za-z0-9-]+`
- **必須項目**: Yes

#### 3.3.5 連番
- **入力形式**: 数値（1-999）
- **デフォルト値**: 1
- **必須項目**: Yes

### 3.4 端末属性入力（端末系カテゴリのみ）

端末系カテゴリ（Server、Desktop、Laptop）選択時に表示される追加入力項目。

#### 3.4.1 ソフトウェア
- **入力形式**: 英数字、スペース、ピリオド、ハイフン、アンダースコア
- **パターン**: `[A-Za-z0-9\s._-]+`
- **必須項目**: Yes（端末系の場合）
- **例**: Office 2021

#### 3.4.2 OS
- **入力形式**: 英数字、スペース、ピリオド、ハイフン、アンダースコア
- **パターン**: `[A-Za-z0-9\s._-]+`
- **必須項目**: Yes（端末系の場合）
- **例**: Windows 11

#### 3.4.3 資産管理番号
- **入力形式**: 英数字、ハイフン、アンダースコア
- **パターン**: `[A-Za-z0-9_-]+`
- **必須項目**: Yes（端末系の場合）
- **説明**: 会社の資産管理番号
- **例**: IT-2024-0001
- **入力形式**: 数値（1-999）
- **デフォルト値**: 1
- **必須項目**: Yes

## 4. マスタデータ管理機能

### 4.1 拠点マスタ管理

#### 4.1.1 拠点情報管理
- **基本情報**: 拠点ID、拠点コード、拠点名
- **グループメール**: 課のグループメールアドレス管理
- **通知設定**: ステータス変更通知のON/OFF設定
- **ステータス**: 有効/無効の状態管理
- **日時情報**: 作成日・更新日の自動記録

#### 4.1.2 操作機能
- **新規追加**: 拠点情報の追加
- **編集**: 既存拠点情報の修正
- **削除**: 拠点の無効化
- **一覧表示**: 全拠点の一覧表示・検索

### 4.2 機種マスタ管理

#### 4.2.1 機種情報管理
- **基本情報**: 機種名、メーカー、カテゴリ
- **分類**: Desktop、Laptop、Server、Tablet、Printer、Router、Hub、Other等
- **日時情報**: 作成日・更新日の自動記録

#### 4.2.2 操作機能
- **新規追加**: 機種情報の追加
- **編集**: 既存機種情報の修正
- **カテゴリ管理**: カテゴリの英語・日本語対応

### 4.3 データタイプマスタ管理

#### 4.3.1 データタイプ情報管理
- **基本情報**: データタイプID、データタイプ名、説明
- **表示順序**: ドロップダウンでの表示順序管理
- **ステータス**: 有効/無効の状態管理
- **日時情報**: 作成日・更新日の自動記録

#### 4.3.2 操作機能
- **新規追加**: データタイプの追加
- **編集**: 既存データタイプ情報の修正
- **削除**: データタイプの無効化
- **一覧表示**: 全データタイプの一覧表示・並び替え

#### 4.3.3 初期データ
- **通常データ**: 日常的な機器管理データ（ID: NORMAL）
- **監査データ**: 監査・検査用データ（ID: AUDIT）- 担当者、資産管理番号、貸出情報、ユーザー預り機情報、備考等を含む
- **サマリー**: 集計・要約データ（ID: SUMMARY）- カテゴリ別カード表示、拠点別台数集計、視覚的ステータス表示、レスポンシブデザイン対応

### 4.4 機器マスタ管理

#### 4.4.1 端末マスタ
- **基本情報**: 拠点管理番号、機種名、メーカー、カテゴリ
- **技術情報**: 製造番号、資産管理番号（必須）、ソフトウェア、OS
- **URL情報**: 共通フォームURL、QRコードURL
- **ステータス**: 利用状況、配置場所
- **自動記録**: URL生成時に入力された情報（カテゴリ、機種名、製造番号、資産管理番号、OS、ソフトウェア）の自動保存

#### 4.4.2 プリンタマスタ
- **基本情報**: 拠点管理番号、機種名、メーカー
- **技術情報**: 製造番号
- **URL情報**: 共通フォームURL、QRコードURL
- **自動記録**: URL生成時に入力された情報（カテゴリ、機種名、製造番号）の自動保存

#### 4.4.3 その他マスタ
- **基本情報**: 拠点管理番号、機種名、メーカー、カテゴリ
- **URL情報**: 共通フォームURL
- **自動記録**: URL生成時に入力された情報（カテゴリ、機種名、製造番号）の自動保存

## 5. システム設定機能

### 5.1 共通フォームURL設定

#### 5.1.1 設定項目
- **端末用フォームURL**: SV・CLカテゴリ用Google FormsのURL
- **プリンタ用フォームURL**: プリンタ・その他カテゴリ用URL
- **QR中間ページURL**: QRコード経由アクセス用の中間ページURL

#### 5.1.2 管理機能
- **設定保存**: PropertiesServiceでの永続化
- **バリデーション**: URL形式の検証
- **管理者権限**: 3段階確認プロセスによる誤操作防止

### 5.2 システム動作設定

#### 5.2.1 デバッグモード
- **開発用設定**: デバッグ情報の表示・非表示
- **本番環境**: 本番運用時の設定切り替え
- **パフォーマンス**: システムレスポンスの最適化
- **設定制御**: debugMode有効時のみ編集可能な設定項目の制御

### 5.3 通知設定

#### 5.3.1 ログ通知設定（開発用）
- **エラー通知メール**: システムエラー発生時の通知先メールアドレス
- **アラート通知メール**: 重要イベント・警告の通知先メールアドレス  
- **通知レベル**: 通知するエラーレベルの設定（FATAL/ERROR/WARN）
- **通知頻度**: 同一エラーの通知間隔設定
- **表示制御**: debugModeが有効な場合のみUIに表示・設定可能
- **アクセス制御**: debugMode有効時のみ編集可能

#### 5.3.2 ステータス変更通知設定（運用）
- **通知対象**: 機器の預り機ステータス変更時の通知
- **通知先**: 各拠点のグループメールアドレス（拠点マスタで管理）
- **通知設定**: 拠点マスタでON/OFF設定を管理
- **通知内容**: ステータス変更内容、変更者、変更日時、理由
- **表示制御**: 設定画面に拠点一覧と通知設定を表示
- **データ管理**: 拠点マスタのステータス変更通知フィールドで管理

#### 5.3.3 通知メール管理
- **メールアドレス検証**: 有効なメールアドレス形式の検証
- **複数アドレス対応**: カンマ区切りでの複数メールアドレス登録（ログ通知のみ）
- **テスト送信**: 設定したメールアドレスへのテスト送信機能
- **グループメール**: 拠点マスタで各拠点のグループメールアドレスを管理
- **通知設定統合**: 拠点マスタでメールアドレスと通知ON/OFF設定を一元管理

### 5.4 設定アクセス制御

#### 5.4.1 debugMode依存設定
- **編集可能条件**: debugModeがtrueの場合のみ以下の設定を編集可能
  - 共通フォームURL（端末用・プリンタ用）
  - QR中間ページURL
  - ログ通知設定（エラー通知・アラート通知）
- **ログ通知の表示制御**: debugModeがfalseの場合、ログ通知設定セクション全体を非表示
- **ステータス変更通知**: debugModeに関係なく常に表示・編集可能
- **読み取り専用表示**: debugModeがfalseの場合、URL設定は表示のみ
- **視覚的フィードバック**: 編集不可時のグレーアウト表示

## 6. 共通機能

### 6.1 エラーハンドリング
- **エラー表示**: ユーザーフレンドリーなエラーメッセージ
- **ログ記録**: システムログの自動記録
- **リカバリ**: エラー時の適切な復旧処理

### 6.2 パフォーマンス最適化
- **プリロード**: バックグラウンドでのデータ先読み
- **キャッシュ**: 頻繁アクセスデータのキャッシュ化
- **レスポンス**: ユーザー操作に対する即座フィードバック

### 6.3 UI/UX
- **レスポンシブデザイン**: PC・モバイル対応
- **アクセシビリティ**: 標準的なWebアクセシビリティ対応
- **直感的操作**: 専門知識不要のユーザーインターフェース

### 6.4 日時処理

#### 6.4.1 日時形式標準
- **保存形式**: Google Apps Scriptのデフォルト形式で保存
- **タイムゾーン**: 日本時間（Asia/Tokyo）で統一
- **例**: `2025/06/13 19:41:58`

#### 6.4.2 日時表示処理
- **フロントエンド対応**: JavaScriptでの日時形式パース・表示
- **相対時間表示**: 「1時間前」「昨日」などの人間的な表示オプション
- **ソート対応**: 日時フィールドでの正確なソート機能

#### 6.4.3 日時入力処理
- **自動設定**: 作成日・更新日の自動記録
- **手動入力**: 必要に応じた日時の手動設定
- **バリデーション**: 日時形式の妥当性チェック