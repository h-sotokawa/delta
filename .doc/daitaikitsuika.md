# 代替機登録機能（URL生成）- 要件定義書

## 1. 基本機能要件

### 1.1 機能名
代替機登録

### 1.2 目的
共通フォームURLに拠点管理番号をパラメータとして追加し、マスタデータに保存する

### 1.3 従来との違い
- **従来**: 動的にGoogle Formを作成していた
- **新方式**: 事前に作成された共通フォームURLに拠点管理番号を追加する

## 2. 拠点管理番号の生成

### 2.1 フォーマット仕様
- **形式**: `拠点_カテゴリ_モデル_製造番号_連番`
- **例**: `大阪_デスクトップPC_ThinkCentre_ABC123_001`

### 2.2 必要な入力項目
- 拠点（選択）
- デバイスカテゴリ（選択）
- モデル（選択）
- 製造番号（入力）
- 連番（数値入力、デフォルト: 1）
- **【端末系のみ】ソフト（テキスト入力・必須）**
- **【端末系のみ】OS（テキスト入力・必須）**

## 3. データソース

### 3.1 マスタデータ
- **拠点データ**: 拠点マスタから取得（locationId, locationName, locationCode）
- **カテゴリデータ**: 機種マスタから動的に取得（重複排除）
- **モデルデータ**: 選択されたカテゴリに基づいて機種マスタからフィルタリング
- **ソフトデータ**: 手入力（例: ReceptyNEXT、MRN等を自由に入力）
- **OSデータ**: 手入力（例: Windows 11、Windows Server 2022等を自由に入力）

## 4. 共通フォームURL設定

### 4.1 取得元
設定画面（settings）で定義済みの共通フォームURLを使用
- `getCommonFormsSettings()` 関数で取得
- `terminalCommonFormUrl`: 端末用共通フォームURL
- `printerCommonFormUrl`: プリンタ・その他用共通フォームURL

### 4.2 URL形式
取得したURLに以下のパラメータを追加
- `entry.XXXXXXXXX=拠点管理番号`
- 端末系の場合：`entry.YYYYYYYYY=ソフト情報&entry.ZZZZZZZZZ=OS情報`

## 5. 保存先マスタの振り分け

### 5.1 マスタタイプ
- **端末マスタ**: デスクトップPC、サーバー、ノートPCのみ
- **プリンタマスタ**: プリンタ
- **その他マスタ**: 上記以外のすべてのカテゴリ

## 6. 保存処理

### 6.1 保存内容
- 生成されたURLを該当するマスタシートの「共通フォームURL」列に保存
- 端末マスタの場合、「ソフト」列と「OS」列にも情報を保存
- 拠点管理番号で該当行を検索し、各列に値を設定
- 必要な列が存在しない場合は新規作成

## 7. UI要件

### 7.1 基本構成
- **画面タイトル**: 「代替機登録」
- **説明文**: 「代替機の登録用URLを生成し、マスタデータに保存します」
- 各入力フィールドの変更時に拠点管理番号を自動生成・表示

### 7.2 端末系選択時の追加フィールド
- ソフト入力（テキストエリア、複数行入力可、プレースホルダー: "例: ReceptyNEXT, MRN"）
- OS入力（テキストフィールド、プレースホルダー: "例: Windows 11"）

### 7.3 生成結果表示
- 拠点管理番号
- 保存先マスタ
- 生成されたURL
- ソフト（端末系の場合）
- OS（端末系の場合）

### 7.4 機能ボタン
- URLのコピー機能
- エラーメッセージの表示

## 8. QRコード表示機能

### 8.1 生成要件
- **生成タイミング**: URL生成・保存が成功した時点
- **表示位置**: 結果表示セクション内
- **QRコードライブラリ**: Google Charts APIを使用（外部依存を最小化）
- **サイズ**: 200x200px程度

### 8.2 機能
- QRコードの表示
- QRコード画像のダウンロード機能

## 9. 保守性を高める設計要件

### 9.1 設定の外部化
- カテゴリとマスタの対応関係を設定オブジェクトで管理
- 新しいカテゴリ追加時は設定の変更のみで対応可能

### 9.2 関数の単一責任
- 各関数は一つの機能に特化
- 拠点データ取得、カテゴリ取得、モデル取得を独立した関数に
- バリデーション、URL生成、保存処理を分離

### 9.3 エラーハンドリングの統一
- すべての非同期処理に統一的なエラーハンドリング
- エラーメッセージの一元管理
- フォールバック処理の明確化

## 10. 設定管理（拡張性のため）

### 10.1 カテゴリマッピング
```javascript
// カテゴリとマスタの対応関係
const CATEGORY_MASTER_MAP = {
  'デスクトップPC': { masterType: 'terminal', masterName: '端末マスタ', hasAttributes: true },
  'サーバー': { masterType: 'terminal', masterName: '端末マスタ', hasAttributes: true },
  'ノートPC': { masterType: 'terminal', masterName: '端末マスタ', hasAttributes: true },
  'プリンタ': { masterType: 'printer', masterName: 'プリンタマスタ', hasAttributes: false },
  // その他はデフォルトでその他マスタ
};
```

### 10.2 設定キー対応
```javascript
// マスタタイプと設定キーの対応
const MASTER_TYPE_CONFIG = {
  'terminal': 'terminalCommonFormUrl',
  'printer': 'printerCommonFormUrl',
  'other': 'printerCommonFormUrl'  // その他もプリンタ用URLを使用
};
```

## 11. モジュール構成

### 11.1 ファイル構成
- **device-registration.html**: UIレイアウト
- **device-registration-styles.html**: スタイル定義
- **device-registration-functions.html**: フロントエンド処理
- **device-registration-config.html**: 設定管理（新規）
- **device-registration.gs**: バックエンド処理
- **device-registration-config.gs**: バックエンド設定（新規）

## 12. エラー処理とフォールバック

### 12.1 エラー種別と対応
- 共通フォームURL未設定時：設定画面への誘導メッセージ
- 拠点データ読み込み失敗時：静的データで補完
- カテゴリデータ読み込み失敗時：エラー表示
- URL生成失敗時：詳細なエラーメッセージ
- QRコード生成失敗時：URLのみ表示
- **端末系でソフト・OS未入力時：エラーメッセージ表示**

## 13. 処理フロー

### 13.1 初期化フロー
1. ページ初期化時に`getCommonFormsSettings()`で共通フォームURL設定を取得
2. 取得した設定を画面上で保持し、URL未設定の場合は警告表示

### 13.2 登録処理フロー
1. カテゴリ選択時、端末系の場合はソフト・OS入力フィールドを表示
2. URL生成時は保持している設定から適切なURLを選択
3. 端末系の場合、ソフトとOS情報もURLパラメータに追加
4. マスタ保存時、端末系の場合はソフト・OS情報も保存

## 14. ナビゲーション設定

### 14.1 メニュー設定
- **メニュー項目名**: 「代替機登録」
- **アイコン**: `fa-laptop-medical` または `fa-plus-circle`
- **説明**: 「代替機の登録用URLを生成」

## 15. 条件付き表示ロジック

### 15.1 端末系の判定
カテゴリで「デスクトップPC」「サーバー」「ノートPC」を選択時：
- ソフト入力フィールドを表示（必須）
- OS入力フィールドを表示（必須）

### 15.2 その他の場合
その他のカテゴリ選択時：
- ソフト・OS入力フィールドを非表示

## 16. 入力フィールド詳細

### 16.1 ソフト入力
- **タイプ**: テキストエリア（textarea）
- **行数**: 3行
- **プレースホルダー**: "インストールされているソフトを入力（例: ReceptyNEXT, MRN）"
- **必須**: はい（端末系選択時）
- **必須マーク**: 赤色の * を表示

### 16.2 OS入力
- **タイプ**: テキストフィールド（input type="text"）
- **プレースホルダー**: "OSを入力（例: Windows 11）"
- **必須**: はい（端末系選択時）
- **必須マーク**: 赤色の * を表示

## 17. バリデーション規則

### 17.1 端末系選択時のバリデーション
- ソフトが未入力の場合：「ソフトを入力してください」エラー表示
- OSが未入力の場合：「OSを入力してください」エラー表示
- いずれかが未入力の場合、URL生成処理を中止

### 17.2 共通バリデーション
- 拠点が未選択の場合：「拠点を選択してください」エラー表示
- カテゴリが未選択の場合：「デバイスカテゴリを選択してください」エラー表示
- モデルが未選択の場合：「モデルを選択してください」エラー表示
- 製造番号が未入力の場合：「製造番号を入力してください」エラー表示
- 連番が未入力の場合：「連番を入力してください」エラー表示

---

## 付録：技術仕様

### 日時処理の標準仕様
このシステムでは、Google Sheetsへの日時保存において**書式なしテキスト形式**を採用しています。

```javascript
// ✅ 正しい実装
const today = "'" + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy/MM/dd');

// 列の書式設定
dateRange.setNumberFormat('@'); // '@' = テキスト形式
```

### 拠点管理番号の生成例
```javascript
// 例: 大阪_デスクトップPC_ThinkCentre_ABC123_001
const locationNumber = `${locationName}_${category}_${model}_${serialNumber}_${String(sequenceNumber).padStart(3, '0')}`;
```

この要件定義書により、端末系の代替機登録時に必要な属性情報（ソフト、OS）を確実に取得し、データの完全性を保ちながら、将来的な拡張にも対応可能な構造となります。