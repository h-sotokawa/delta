<div class="page-header">
    <h1><i class="fas fa-table"></i> スプレッドシートビューアー</h1>
    <div class="description">拠点別機器データの統合表示と管理</div>
</div>

<div class="controls-section card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="locationSelect" class="form-label">拠点選択</label>
                <select class="form-select" id="locationSelect">
                    <option value="">読み込み中...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="deviceTypeSelect" class="form-label">デバイス種別</label>
                <select class="form-select" id="deviceTypeSelect">
                    <option value="">全て</option>
                    <option value="端末">端末</option>
                    <option value="プリンタ">プリンタ</option>
                    <option value="その他">その他</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dataTypeSelect" class="form-label">データタイプ</label>
                <select class="form-select" id="dataTypeSelect">
                    <option value="">読み込み中...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> 更新
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i> エクスポート
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row g-3 mt-2">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="検索...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <span class="text-muted">最終更新: <span id="lastUpdate">-</span></span>
            </div>
        </div>
    </div>
</div>

<div class="data-section">
    <div class="card">
        <div class="card-body">
            <div class="table-toolbar mb-3">
                <button class="btn btn-sm btn-outline-primary" onclick="toggleSelectAll()">
                    <i class="fas fa-check-square"></i> 全選択
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="editSelectedStatus()" id="editStatusBtn" disabled>
                    <i class="fas fa-edit"></i> ステータス編集
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="showSummary()">
                    <i class="fas fa-chart-bar"></i> 集計表示
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover" id="dataTable">
                    <thead class="table-dark">
                        <tr id="tableHeader">
                            <th width="40">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>読み込み中...</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="2" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <nav aria-label="ページネーション">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- ステータス編集モーダル -->
<div class="modal fade" id="statusEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> 預り機ステータス編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statusEditContent">
                    <!-- 動的にコンテンツが挿入される -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveStatusChanges()">保存</button>
            </div>
        </div>
    </div>
</div>

<style>
/* スプレッドシートビューアー専用スタイル */
.controls-section {
    position: sticky;
    top: 56px;
    z-index: 100;
    background-color: white;
}

.table-toolbar {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

#dataTable {
    font-size: 0.9rem;
}

#dataTable th {
    position: sticky;
    top: 0;
    background-color: #212529;
    z-index: 10;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
}

#dataTable th:hover {
    background-color: #2c3e50;
}

#dataTable th i {
    margin-left: 0.5rem;
    font-size: 0.8rem;
}

#dataTable tbody tr:hover {
    background-color: rgba(0,0,0,0.05);
}

#dataTable tbody tr.selected {
    background-color: rgba(52, 152, 219, 0.1);
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-badge.status-active {
    background-color: #d4edda;
    color: #155724;
}

.status-badge.status-inactive {
    background-color: #f8d7da;
    color: #721c24;
}

.status-badge.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.device-type-badge {
    display: inline-block;
    padding: 0.2rem 0.4rem;
    border-radius: 0.2rem;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.5rem;
}

.device-type-badge.terminal {
    background-color: #3498db;
    color: white;
}

.device-type-badge.printer {
    background-color: #e74c3c;
    color: white;
}

.device-type-badge.other {
    background-color: #95a5a6;
    color: white;
}

/* ページネーション */
.pagination {
    margin-top: 1rem;
}

/* モバイル対応 */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .controls-section {
        position: relative;
        top: auto;
    }
    
    .table-toolbar {
        flex-wrap: wrap;
    }
}

/* ステータス編集モーダル */
.condition-check {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.condition-check .condition-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.condition-check .condition-item i {
    margin-right: 0.5rem;
    width: 20px;
}

.condition-met {
    color: #28a745;
}

.condition-not-met {
    color: #dc3545;
}

.editable-count {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-bottom: 1rem;
}

.status-history {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
}

.status-history-item {
    border-bottom: 1px solid #e9ecef;
    padding: 0.5rem 0;
}

.status-history-item:last-child {
    border-bottom: none;
}
</style>

<script>
// スプレッドシートビューアーの初期化
function initializeSpreadsheetViewer() {
    // 拠点リストの読み込み
    loadLocations();
    
    // データタイプリストの読み込み
    loadDataTypes();
    
    // イベントリスナーの設定
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('locationSelect').addEventListener('change', refreshData);
    document.getElementById('deviceTypeSelect').addEventListener('change', filterTable);
    document.getElementById('dataTypeSelect').addEventListener('change', refreshData);
    
    // 初期データの読み込み
    refreshData();
}

// 拠点リストの読み込み
function loadLocations() {
    google.script.run.withSuccessHandler(function(locations) {
        const select = document.getElementById('locationSelect');
        select.innerHTML = '<option value="">全ての拠点</option>';
        
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.id;
            option.textContent = `${location.code} - ${location.name}`;
            select.appendChild(option);
        });
    }).withFailureHandler(handleError)
    .getLocationList();
}

// データタイプリストの読み込み
function loadDataTypes() {
    google.script.run.withSuccessHandler(function(dataTypes) {
        const select = document.getElementById('dataTypeSelect');
        select.innerHTML = '';
        
        dataTypes.forEach(dataType => {
            const option = document.createElement('option');
            option.value = dataType.id;
            option.textContent = dataType.name;
            if (dataType.id === 'NORMAL') {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }).withFailureHandler(handleError)
    .getDataTypeList();
}

// データの更新
function refreshData() {
    const locationId = document.getElementById('locationSelect').value;
    const dataTypeId = document.getElementById('dataTypeSelect').value;
    
    // ローディング表示
    document.getElementById('tableBody').innerHTML = `
        <tr>
            <td colspan="100" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
            </td>
        </tr>
    `;
    
    // データの取得
    google.script.run.withSuccessHandler(displayData)
        .withFailureHandler(handleError)
        .getSpreadsheetData(locationId, dataTypeId);
    
    // 最終更新時刻の更新
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleString('ja-JP');
}

// データの表示
function displayData(result) {
    if (!result || !result.headers || !result.data) {
        document.getElementById('tableBody').innerHTML = `
            <tr>
                <td colspan="100" class="text-center text-muted">
                    データがありません
                </td>
            </tr>
        `;
        return;
    }
    
    // ヘッダーの設定
    const headerRow = document.getElementById('tableHeader');
    headerRow.innerHTML = `
        <th width="40">
            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
        </th>
    `;
    
    result.headers.forEach((header, index) => {
        const th = document.createElement('th');
        th.innerHTML = `
            ${header}
            <i class="fas fa-sort"></i>
        `;
        th.onclick = () => sortTable(index + 1);
        headerRow.appendChild(th);
    });
    
    // データの設定
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    result.data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = rowIndex;
        
        // チェックボックス
        const checkTd = document.createElement('td');
        checkTd.innerHTML = `<input type="checkbox" class="row-checkbox" onchange="updateSelectionButtons()">`;
        tr.appendChild(checkTd);
        
        // データセル
        row.forEach((cell, cellIndex) => {
            const td = document.createElement('td');
            
            // デバイス種別の場合はバッジを付ける
            if (result.headers[cellIndex] === 'デバイス種別') {
                td.innerHTML = getDeviceTypeBadge(cell) + cell;
            }
            // ステータスの場合はバッジを付ける
            else if (result.headers[cellIndex].includes('ステータス')) {
                td.innerHTML = getStatusBadge(cell);
            }
            else {
                td.textContent = cell || '';
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
    
    // ページネーションの設定（仮実装）
    updatePagination(1, 1);
}

// デバイス種別バッジの取得
function getDeviceTypeBadge(type) {
    const badges = {
        '端末': '<span class="device-type-badge terminal">端末</span>',
        'プリンタ': '<span class="device-type-badge printer">プリンタ</span>',
        'その他': '<span class="device-type-badge other">その他</span>'
    };
    return badges[type] || '';
}

// ステータスバッジの取得
function getStatusBadge(status) {
    if (!status) return '';
    
    let className = 'status-badge';
    if (status.includes('貸出中')) {
        className += ' status-active';
    } else if (status.includes('保管中')) {
        className += ' status-pending';
    } else {
        className += ' status-inactive';
    }
    
    return `<span class="${className}">${status}</span>`;
}

// 全選択/解除
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.row-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        checkbox.closest('tr').classList.toggle('selected', selectAll);
    });
    
    updateSelectionButtons();
}

// 選択状態の更新
function updateSelectionButtons() {
    const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
    const editBtn = document.getElementById('editStatusBtn');
    
    editBtn.disabled = selectedCount === 0;
    editBtn.innerHTML = `<i class="fas fa-edit"></i> ステータス編集 ${selectedCount > 0 ? `(${selectedCount})` : ''}`;
}

// テーブルのソート
function sortTable(columnIndex) {
    // 簡易的なソート実装（後で詳細実装）
    console.log('Sort column:', columnIndex);
}

// テーブルのフィルタリング
function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const deviceType = document.getElementById('deviceTypeSelect').value;
    const rows = document.querySelectorAll('#tableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const deviceTypeCell = row.cells[2]?.textContent || ''; // デバイス種別の列インデックスを調整
        
        const matchesSearch = !searchValue || text.includes(searchValue);
        const matchesDeviceType = !deviceType || deviceTypeCell.includes(deviceType);
        
        row.style.display = matchesSearch && matchesDeviceType ? '' : 'none';
    });
}

// ページネーションの更新
function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // 前へボタン
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">前へ</a>`;
    pagination.appendChild(prevLi);
    
    // ページ番号
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // 次へボタン
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">次へ</a>`;
    pagination.appendChild(nextLi);
}

// ページ移動
function goToPage(page) {
    console.log('Go to page:', page);
    // 実装予定
}

// ステータス編集
function editSelectedStatus() {
    const selectedRows = document.querySelectorAll('.row-checkbox:checked');
    if (selectedRows.length === 0) return;
    
    // モーダルの表示
    const modal = new bootstrap.Modal(document.getElementById('statusEditModal'));
    
    // 編集可能な行の判定（仮実装）
    const editableCount = selectedRows.length; // 実際は条件判定が必要
    
    document.getElementById('statusEditContent').innerHTML = `
        <div class="condition-check">
            <h6>設定条件チェック:</h6>
            <div class="condition-item condition-met">
                <i class="fas fa-check-circle"></i>
                0-4.ステータス: 1.貸出中
            </div>
            <div class="condition-item condition-met">
                <i class="fas fa-check-circle"></i>
                1-4.ユーザー機の預り有無: 有り
            </div>
            <div class="mt-2">
                → 預り機ステータス編集可能
            </div>
        </div>
        
        <div class="editable-count">
            選択項目: ${selectedRows.length}台（条件満たす: ${editableCount}台）
        </div>
        
        <div class="mb-3">
            <label for="newStatus" class="form-label">新しい預り機ステータス</label>
            <select class="form-select" id="newStatus">
                <option value="">選択してください</option>
                <option value="1">1.返却可能</option>
                <option value="2">2.商談や金額の問題で返却不可</option>
                <option value="3">3.お客様による返却拒否</option>
                <option value="4">4.HW延長保守中</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="changeReason" class="form-label">変更理由</label>
            <textarea class="form-control" id="changeReason" rows="3" placeholder="変更理由を入力してください"></textarea>
        </div>
    `;
    
    modal.show();
}

// ステータス変更の保存
function saveStatusChanges() {
    const newStatus = document.getElementById('newStatus').value;
    const changeReason = document.getElementById('changeReason').value;
    
    if (!newStatus || !changeReason) {
        alert('新しいステータスと変更理由を入力してください。');
        return;
    }
    
    // 実装予定
    console.log('Save status changes:', { newStatus, changeReason });
    
    // モーダルを閉じる
    bootstrap.Modal.getInstance(document.getElementById('statusEditModal')).hide();
    
    // データをリフレッシュ
    refreshData();
}

// データのエクスポート
function exportData() {
    const locationId = document.getElementById('locationSelect').value;
    const dataTypeId = document.getElementById('dataTypeSelect').value;
    
    google.script.run.withSuccessHandler(function(url) {
        window.open(url, '_blank');
    }).withFailureHandler(handleError)
    .exportSpreadsheetData(locationId, dataTypeId);
}

// 集計表示
function showSummary() {
    // 実装予定
    console.log('Show summary');
    alert('集計表示機能は開発中です。');
}
</script>